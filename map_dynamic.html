<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Premium Retail Trainer Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  :root{
    --blue:#2f71ff; --violet:#6a1b9a; --gray:#9ea3a8; --ring:#d0d7de;
    --pa:#6c5ce7; --p:#2ecc71; --a:#f39c12; --u:#e74c3c;
    --bg:#fff; --fg:#111; --muted:#6b7280; --border:#e5e7eb; --panel:#fff;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  body{display:flex;flex-direction:column;min-width:320px}

  .topbar{position:sticky; top:0; background:var(--panel); display:flex;flex-wrap:wrap;gap:10px;align-items:center; padding:8px 10px;border-bottom:1px solid #eef0f3;z-index:10; box-shadow:0 4px 14px rgba(0,0,0,.04)}
  .search-wrap{display:flex;gap:8px;align-items:center;min-width:280px;flex:1}
  .searchbox{position:relative;flex:1}
  .searchbox input{width:100%;border:1px solid #d0d7de;border-radius:10px;padding:10px 12px 10px 64px;font-size:14px;background:var(--bg);color:var(--fg)}
  .badge-left{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:12px;font-weight:800;letter-spacing:.3px;background:#eef6ff;color:#0b5bd3;border:1px solid #cfe6ff;border-radius:999px;padding:3px 8px;display:none}
  .badge-left.show{display:inline-block}
  .results{position:absolute;left:0;right:0;top:calc(100% + 6px);background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.18);display:none;z-index:20;max-height:360px;overflow:auto}
  .results.show{display:block}
  .res{display:flex;gap:10px;padding:10px;cursor:pointer;align-items:flex-start}
  .res:hover{background:#f6f8fa}
  #searchResults .res.active{ background:#e7f0ff }
  .res .kind{flex:0 0 auto;font-size:11px;font-weight:800;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:#374151;background:var(--panel)}
  .res .text .sub{color:var(--muted);font-size:12px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .btn{border:1px solid #d0d7de;background:var(--panel);border-radius:10px;padding:8px 10px;font-weight:600;cursor:pointer;color:var(--fg); box-shadow:0 2px 8px rgba(0,0,0,.04)}
  .btn.link{border-color:transparent;text-decoration:underline}
  .toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:var(--panel);white-space:nowrap}
  .toggle input{width:16px;height:16px;accent-color:var(--blue)}
  .range{display:flex;align-items:center;gap:8px;white-space:nowrap}
  .range small{color:var(--muted)}

  .filters{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:10px;padding:8px 10px;border-top:1px solid #eef0f3;border-bottom:1px solid #eef0f3;background:var(--panel); border-radius:12px; margin:6px 10px; box-shadow:0 6px 20px rgba(0,0,0,.06)}
  .picker{display:flex;flex-direction:column;gap:6px}
  .picker input{padding:6px 8px;font-size:13px;border:1px solid #d0d7de;border-radius:8px;background:var(--bg);color:var(--fg)}
  select[multiple]{height:110px;border:1px solid #d0d7de;border-radius:8px;padding:6px 8px;background:var(--bg);color:var(--fg)}

  .summary{display:flex;gap:10px;align-items:center;padding:6px 10px;border-bottom:1px solid #eef0f3;background:var(--panel)}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:var(--panel);}

  .dot{width:10px;height:10px;border-radius:50%}
  .muted{color:var(--muted);margin-left:auto}

  .mapwrap{position:relative;flex:1;min-height:460px;display:flex;overflow:hidden}
  #map{flex:1}

  .sidepanel{width:380px;max-width:90vw;flex:0 0 380px;background:var(--panel);border-left:1px solid var(--border);box-shadow:-4px 0 18px rgba(0,0,0,.12);display:none;flex-direction:column;z-index:6}
  .sidepanel.show{display:flex}
  .sp-head{padding:10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
  .sp-head h3{margin:0;font-size:16px;line-height:1.2;flex:1}
  .sp-body{padding:10px;display:flex;flex-direction:column;gap:10px;height:calc(100vh - 220px);overflow:hidden}
  .sp-actions{display:flex;gap:8px;flex-wrap:wrap}
  .sp-counts{display:flex;gap:8px;flex-wrap:wrap}
  .sp-chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:3px 8px}
  .sp-quick{display:flex;gap:6px;flex-wrap:wrap}
  .sp-list{flex:1;min-height:160px;border:1px solid var(--border);border-radius:8px;padding:0;display:flex;flex-direction:column;overflow:auto; box-shadow: inset 0 0 0 2px rgba(0,0,0,.02)}
  .sp-list input{margin:8px;border:1px solid var(--border);border-radius:8px;padding:6px 8px}
  .sp-list input{position: sticky; top: 0; z-index: 3; background: var(--panel); border-bottom-left-radius: 0; border-bottom-right-radius: 0; box-shadow: 0 4px 6px rgba(0,0,0,.04);}

  .sp-rows{position:relative;height:auto;will-change:transform;}
  .row{position:relative;display:flex;gap:8px;align-items:flex-start;padding:10px;border-bottom:1px solid var(--border);background:var(--panel);cursor:pointer;min-height:78px}
  .row .text{flex:1;min-width:0}
  .row .title{font-weight:800;line-height:1.25}
  .row .addr{color:var(--muted);font-size:12px;line-height:1.25; white-space:normal}
  .row .num{min-width:62px;font-variant-numeric:tabular-nums;color:var(--muted)}
  .row.active{background:#e7f0ff}

  .floating{position:absolute;left:10px;top:10px;z-index:402;display:flex;gap:8px;flex-wrap:wrap}
  .floating .btn,.floating .toggle{padding:6px 8px;font-size:12px}

  .legend{position:absolute;top:10px;right:10px;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:8px 10px;box-shadow:0 6px 18px rgba(0,0,0,.12);z-index:401}

  .dropdown-menu{position:absolute;right:0;top:calc(100% + 4px);background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:6px;z-index:5;max-height:70vh;overflow:auto;box-sizing:border-box;display:none;min-width:240px}

  .busy{position:fixed;inset:0;background:rgba(255,255,255,.5);display:flex;align-items:center;justify-content:center;z-index:9999}
  .busy[hidden]{display:none}
  .spin{width:36px;height:36px;border-radius:50%;border:4px solid rgba(0,0,0,.15);border-top-color:var(--blue);animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  .marker-cluster.marker-pa div{background:var(--pa);border:2px solid #fff}
  .marker-cluster.marker-p  div{background:var(--p); border:2px solid #fff}
  .marker-cluster.marker-a  div{background:var(--a); border:2px solid #fff}

  .hub{width:20px;height:20px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.25)}
  .hub.confirmed{background:var(--violet)}
  .hub.pending{background:#9ea3a8}
  .hub.acosta{ background: var(--a); }
  .hl{width:22px;height:22px;border-radius:50%;border:2px solid #111;background:rgba(0,0,0,.05);box-shadow:0 0 0 1px rgba(0,0,0,.25)}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:5000}
  .modal.show{display:flex}
  .card{background:#fff;border-radius:12px;max-width:900px;width:92vw;box-shadow:0 20px 50px rgba(0,0,0,.25);border:1px solid var(--border)}
  .card header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
  .card header h3{margin:0;font-size:18px;flex:1}
  .card .body{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .kbd{display:inline-block;border:1px solid #cfd3d7;border-bottom-width:3px;border-radius:6px;padding:2px 6px;font-weight:700;background:#fff}

  /* Saved views thumbnails */
  .view-row{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:4px 0}
  .view-thumb{flex:0 0 auto;border:1px solid var(--border);border-radius:6px;width:96px;height:64px;background:#f9fafb}
  .view-actions{display:flex;gap:6px;align-items:center}

  /* Empty state overlay */
  .empty-state{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:401;pointer-events:none}
  .empty-card{pointer-events:auto;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.12);padding:14px 16px;max-width:520px}
  .empty-card h4{margin:0 0 6px 0}
  .empty-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .empty-state[hidden]{display:none !important;}

  /* Compare/Venn panel (kept, optional) */
  .compare-panel{position:absolute;left:10px;bottom:120px;z-index:402;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:none;min-width:280px;box-shadow:0 10px 24px rgba(0,0,0,.12)}
  .compare-panel.show{display:block}
  .compare-grid{display:grid;grid-template-columns:1fr auto;gap:6px;align-items:baseline}

  /* Toasts */
  .toasts{position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:6000}
  .toast{background:#111;color:#fff;padding:10px 12px;border-radius:10px;min-width:220px;box-shadow:0 12px 24px rgba(0,0,0,.32)}
  .toast .bar{height:4px;background:#555;margin-top:8px;border-radius:999px;overflow:hidden}
  .toast .bar>div{height:100%;width:0;background:#2f71ff}
  .toast .row{display:flex;align-items:center;gap:8px}
  .toast button{margin-left:auto;background:transparent;border:1px solid rgba(255,255,255,0.3);color:#fff;border-radius:8px;padding:4px 8px;cursor:pointer}

  /* Screen-reader only */
  .sr-only{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,1px,1px); white-space:nowrap; border:0;}

  /* High-contrast theme */
  :root[data-contrast="high"]{ --bg:#fff; --fg:#000; --muted:#222; --border:#000; --panel:#fff; }
  :root[data-contrast="high"] .btn{ border-color:#000; box-shadow:none; }
  :root[data-contrast="high"] .toggle{ border-color:#000; }
  :root[data-contrast="high"] .chip{ border-color:#000; }

  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce){
    .spin{ animation:none !important; }
    html{ scroll-behavior:auto; }
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="search-wrap" title="Type a store #, city/state, or hub name. Tip: type ‘near’ for nearby stores.">
    <div class="searchbox">
      <span id="searchBadge" class="badge-left">SEARCH</span>
      <input id="searchBox" type="text" placeholder="Type a store #, city/state, hub name… (tip: 'near Dallas')" autocomplete="off" aria-label="Search store or city" aria-controls="searchResults" />
      <div id="searchResults" class="results" role="listbox"></div>
    </div>
    <div id="srStatus" class="sr-only" role="status" aria-live="polite"></div>
    <button id="searchClear" class="btn" type="button" title="Clear search">Clear</button>
  </div>

  <label class="toggle" title="Show Premium confirmed hubs"><input id="showConfirmed" type="checkbox" checked />Premium (confirmed)</label>
  <label class="toggle" title="Show Premium pending offers"><input id="showPending" type="checkbox" checked />Premium (pending)</label>
  <label class="toggle" title="Show Acosta trainers"><input id="showAcosta" type="checkbox" checked />Acosta</label>

  <div class="range" title="Hub radius used for lists, rings, overlap">
    <span>Radius</span>
    <input id="radius" type="range" min="25" max="150" step="5" value="75" aria-label="Hub radius (mi)"/>
    <b id="radiusLbl">75</b><small>mi</small>
  </div>

  <label class="toggle" title="Increase contrast for readability">
    <input id="tgContrast" type="checkbox" />High contrast
  </label>

  <button id="fitBtn" class="btn" type="button" title="Fit map to filtered stores">Fit to Results</button>
  <button id="homeBtn" class="btn" type="button" title="Reset to starting view (keeps filters)">Home</button>
  <button id="resetBtn" class="btn" type="button" title="Reset all filters and view">Reset</button>

  <!-- Export -->
  <div class="dropdown" id="exportDrop" style="position:relative">
    <button class="btn" type="button" title="Download CSV/Geo for filtered stores or panel list">Export ▾</button>
    <div class="dropdown-menu">
      <button id="exportStores" class="btn" type="button" style="display:block;width:100%;margin:4px 0" title="Export all filtered stores on the map">
        Export filtered stores (CSV)
      </button>
      <button id="exportGeo" class="btn" type="button" style="display:block;width:100%;margin:4px 0" title="Export visible hubs+rings+filtered stores">
        Export GeoJSON
      </button>
      <button id="exportKml" class="btn" type="button" style="display:block;width:100%;margin:4px 0" title="Export visible hubs+rings+filtered stores">
        Export KML
      </button>
      <label class="toggle" style="margin:6px 4px;display:flex"><input id="autoReset" type="checkbox" />Auto-reset after export/print</label>
    </div>
  </div>

  <!-- Saved Views -->
  <div class="dropdown" id="viewsDrop" style="position:relative">
    <button class="btn" type="button" title="Save or recall views">Views ▾</button>
    <div class="dropdown-menu" id="viewsMenu">
      <button id="viewSave" class="btn" type="button" style="display:block;width:100%">Save current view…</button>
      <div style="border-top:1px solid var(--border);margin:6px 0"></div>
      <div id="viewList" style="min-width:220px"></div>
    </div>
  </div>

  <button id="helpBtn" class="btn" type="button" title="Quick tips and shortcuts">Help</button>

  <!-- Restored actions -->
  <button id="rollupBtn" class="btn" type="button" title="Summarize coverage by RM/AM">Roll-Up</button>
  <button id="gapBtn" class="btn" type="button" title="Find uncovered stores within visible rings">Gap Finder</button>
</div>

<div class="pillbar" id="activeChips"></div>

<!-- Filters -->
<div class="filters" title="Use these to narrow stores; search also matches store # and city/state.">
  <div class="picker">
    <input id="covSearch" type="text" placeholder="Search coverage…" />
    <select id="covFilter" multiple>
      <option value="All" selected>All</option>
      <option>Premium + Acosta</option>
      <option>Premium Only</option>
      <option>Acosta Only</option>
      <option>Uncovered</option>
    </select>
  </div>
  <div class="picker">
    <input id="rmSearch" type="text" placeholder="Filter regional managers…" />
    <select id="rmFilter" multiple><option value="All" selected>All</option></select>
  </div>
  <div class="picker">
    <input id="amSearch" type="text" placeholder="Filter area managers…" />
    <select id="amFilter" multiple><option value="All" selected>All</option></select>
  </div>
  <div class="picker">
    <input id="hubSearch" type="text" placeholder="Filter hubs…" />
    <select id="hubFilter" multiple aria-label="Filter by hubs"></select>
  </div>
</div>

<div id="dataStatus" style="padding:6px 10px;color:var(--fg);font-size:12px"></div>

<div class="summary" id="summary">
  <span class="chip"><span class="dot" style="background:var(--pa)"></span>P+A: <b id="k_pa">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--p)"></span>Premium: <b id="k_p">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--a)"></span>Acosta: <b id="k_a">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--u)"></span>Uncov: <b id="k_u">0</b></span>
  <span class="chip">Total: <b id="k_total">0</b></span>
  <span class="chip">Hubs — <b id="k_confirmed">0</b> confirmed / <b id="k_pending">0</b> pending</span>
  <span class="muted" id="inView">In view: 0</span>
</div>
<div class="summary" id="datasetBadge"></div>

<div class="mapwrap">
  <div id="map" role="region" aria-label="Coverage Map"></div>

  <div class="floating">
    <label class="toggle" title="Density of stores"><input id="tgHeat" type="checkbox" />Heatmap</label>
    <!-- Heatmap density controls -->
    <span id="heatControls" style="display:none;gap:6px;align-items:center" class="toggle">
      <label style="font-size:12px">R
        <input id="heatRadius" type="range" min="5" max="60" step="1" value="25" style="width:120px">
      </label>
      <label style="font-size:12px">I
        <input id="heatIntensity" type="range" min="1" max="10" step="1" value="6" style="width:120px">
      </label>
    </span>

    <label class="toggle" title="Show hub radius circles"><input id="tgRings" type="checkbox" />Hub radii</label>
    <label class="toggle" title="Highlight stores covered by 2+ hubs"><input id="tgOverlap" type="checkbox" />Overlap</label>
    <label class="toggle" title="Pin hubs to compare coverage"><input id="tgCompare" type="checkbox" />Compare</label>
    <label class="toggle" title="Filter: only stores inside any visible hub radius"><input id="tgWithin" type="checkbox" />Within hubs</label>
    <label class="toggle" title="Turn clustering on/off (useful when zoomed in)"><input id="tgCluster" type="checkbox" checked />Cluster</label>
    <button id="sandboxBtn" class="btn" type="button" title="Test a new hub location">New-hub sandbox</button>
  </div>

  <!-- Compare/Venn panel (optional UI preserved) -->
  <div id="comparePanel" class="compare-panel" aria-live="polite">
    <div style="font-weight:800;margin-bottom:6px">Compare (2 pins)</div>
    <div id="compareBody" style="font-size:13px"></div>
    <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
      <button id="cmpExport" class="btn" type="button">Export CSV</button>
      <button id="cmpClear" class="btn" type="button">Clear pins</button>
    </div>
  </div>

  <div class="sidepanel" id="sidepanel" role="dialog" aria-modal="true" aria-labelledby="spTitle" tabindex="-1">
    <div class="sp-head">
      <h3 id="spTitle">Hub</h3>
      <button id="spCollapse" class="btn" type="button" title="Collapse panel">⟨</button>
      <button id="spPinBtn" class="btn" type="button" title="Pin for compare">Pin</button>
      <button id="spLink" class="btn" type="button" title="Copy link to this hub">Link</button>
      <button id="spClose" class="btn" type="button" title="Close panel">Close</button>
    </div>
    <div class="sp-body">
      <div id="spMeta" class="sp-meta" style="font-size:13px"></div>
      <div class="sp-actions">
        <button id="spExport" class="btn" type="button" title="Download CSV of this list">Export list (CSV)</button>
        <button id="spPrint" class="btn" type="button" title="Print this list">Print store list</button>
      </div>
      <div class="sp-quick" title="Change hub radius quickly">
        Radius: 
        <button class="btn" type="button" data-r="50">50</button>
        <button class="btn" type="button" data-r="75">75</button>
        <button class="btn" type="button" data-r="100">100</button><small> mi</small>
      </div>
      <div id="spCounts" class="sp-counts"></div>
      <div class="sp-list" id="spListWrap">
        <input id="spSearch" type="text" placeholder="Search stores in list…" />
        <div id="spRows" class="sp-rows"></div>
      </div>
    </div>
  </div>

  <!-- Empty state overlay -->
  <div id="emptyState" class="empty-state" hidden>
    <div class="empty-card">
      <h4>No stores match your filters</h4>
      <div class="muted">Try widening your radius, turning off “Within hubs”, or clearing a filter.</div>
      <div class="empty-actions">
        <button id="clearLastFilter" class="btn" type="button">Clear last filter</button>
        <button id="emptyReset" class="btn" type="button">Reset all</button>
      </div>
    </div>
  </div>
</div>

<!-- Help modal -->
<div class="modal" id="helpModal" aria-modal="true" role="dialog">
  <div class="card">
    <header>
      <h3>Help & Shortcuts</h3>
      <button id="helpClose" class="btn" type="button">Close</button>
    </header>
    <div class="body">
      <div>
        <h4>Keyboard</h4>
        <p><span class="kbd">Ctrl</span> / <span class="kbd">⌘</span> + <span class="kbd">K</span> — Focus search</p>
        <p><span class="kbd">?</span> — Open help</p>
        <p><span class="kbd">Esc</span> — Close side panel / modals</p>
        <p><span class="kbd">[</span> <span class="kbd">]</span> — Radius −/+ 5mi</p>
        <p><span class="kbd">↑</span> <span class="kbd">↓</span> + <span class="kbd">Enter</span> — Pick search result</p>
        <p><span class="kbd">H</span> — Home (map only)</p>
        <p><span class="kbd">F</span> — Focus side-panel search (when open)</p>
      </div>
      <div>
        <h4>Tips</h4>
        <ul>
          <li>Type <b>near</b> or <b>near Dallas</b> to jump the map and suggest nearby stores.</li>
          <li>Use <b>Within hubs</b> to see only stores covered by visible hubs.</li>
          <li>Pin hubs to compare coverage; <b>Overlap</b> highlights shared stores.</li>
          <li>Side panel shows counts & metrics; click a store to zoom to it.</li>
          <li>Use <b>Views</b> to save/restore your favorite setups.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div id="busy" class="busy" hidden><div class="spin"></div></div>
<div id="toasts" class="toasts"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script>
(async function(){
  // ---------- CONFIG ----------
  const DATA_URL    = './store_data.json?v=' + Date.now();
  const ACOSTA_URL  = './acosta_geocoded.json?v=' + Date.now();
  const PREMIUM_URL = './premium_trainers_master.json?v=' + Date.now();

  const FALLBACK_STORES = [
    { storeNumberStr:"1234", storeName:"Walmart", address:"701 W 51st St", city:"Austin", state:"TX", coverageType:"Uncovered", areaManager:"", regionalManager:"", trainerCity:"", lat:30.309, lng:-97.742 },
    { storeNumberStr:"5678", storeName:"Walmart", address:"10 S Riverside", city:"Chicago", state:"IL", coverageType:"Uncovered", areaManager:"", regionalManager:"", trainerCity:"", lat:41.882, lng:-87.639 }
  ];

  const COLORS = {
    "Premium + Acosta": getCSS('--pa'),
    "Premium Only":     getCSS('--p'),
    "Acosta Only":      getCSS('--a'),
    "Uncovered":        getCSS('--u')
  };
  const DEFAULT_RADIUS = 75;
  const LS_STATE = 'prt_state_v9';
  const LS_VIEWS = 'prt_views_v2';
  const LS_LAST_QUERY = 'prt_last_query';
  const HOME_VIEW = { center:[39.5,-98.35], zoom:5 };
  const AUTO_RESET = ()=> id('autoReset')?.checked;

  // Revision storage key (dataset badge)
  const REV_KEY = 'prt_dataset_revs_v1';

  // Hub sets
  let premiumConfirmed = [];
  let premiumPending   = [];
  let acostaHubs       = [];

  // Stores
  let allStores = [];
  let filteredStores = [];
  const markerByStore = new Map();

  let PENDING_OPEN_HUB_ID = null;
  let PENDING_PIN_IDS = [];

  // Map/layers
  const map = L.map('map', { zoomControl: true, inertia: true }).setView(HOME_VIEW.center, HOME_VIEW.zoom);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, attribution: '© OpenStreetMap' }).addTo(map);
  const hubPane = map.createPane('hubPane'); hubPane.style.zIndex = 650; hubPane.style.pointerEvents = 'auto';

  const markers = L.markerClusterGroup({
    disableClusteringAtZoom: 12,
    spiderfyOnMaxZoom: false,
    maxClusterRadius: z => z >= 9 ? 50 : 70,
    iconCreateFunction: clusterIconByDominantCoverage,
    chunkedLoading: true,
    chunkInterval: 50,
    chunkDelay: 25
  });
  const plainMarkers = L.layerGroup();
  const targetLayer    = L.layerGroup().addTo(map);
  const ringLayer      = L.layerGroup().addTo(map);
  const highlightLayer = L.layerGroup().addTo(map);
  const hubLayer       = L.layerGroup().addTo(map);
  const heatLayerHolder = { layer: null };
  map.addLayer(markers);

  // UI refs
  const STATUS = id('dataStatus'); const busy = id('busy');
  const showConfirmed = id('showConfirmed');
  const showPending   = id('showPending');
  const showAcosta    = id('showAcosta');
  const radius        = id('radius');  const radiusLbl = id('radiusLbl');
  const tgHeat = id('tgHeat'), tgRings=id('tgRings'), tgOverlap=id('tgOverlap'), tgCompare=id('tgCompare'), tgWithin=id('tgWithin'), tgCluster=id('tgCluster');
  const heatControls = id('heatControls'); const heatRadius = id('heatRadius'); const heatIntensity = id('heatIntensity');
  const covFilter = id('covFilter'); const covSearch = id('covSearch');
  const rmFilter  = id('rmFilter');  const rmSearch  = id('rmSearch');
  const amFilter  = id('amFilter');  const amSearch  = id('amSearch');
  const hubFilter = id('hubFilter'); const hubSearch = id('hubSearch');
  const k = { pa:id('k_pa'), p:id('k_p'), a:id('k_a'), u:id('k_u'), total:id('k_total'), confirmed:id('k_confirmed'), pending:id('k_pending'), inView:id('inView') };

  // Side panel refs
  const sidepanel = id('sidepanel');
  const spTitle = id('spTitle'); const spMeta = id('spMeta'); const spCounts = id('spCounts');
  const spRowsEl = id('spRows'); const spSearch = id('spSearch');
  const spLink = id('spLink');

  const spClose = id('spClose'); const spExport = id('spExport'); const spPinBtn = id('spPinBtn'); const spPrint = id('spPrint'); const spCollapse = id('spCollapse');
  let spHub = null; let spRows = []; let spFilter = '';

  // UX/analysis globals
  let compareMode = false;
  let pinnedHubs = [];
  let lastFilterChanged = null;
  const debouncedRun = (() => { let t; return () => { clearTimeout(t); t = setTimeout(runFilter, 90); }; })();

  const getName = r => String(
    r.CandidateName ?? r.Candidate ?? r.RepName ?? r.repName ??
    r.TrainerName ?? r['Trainer Name'] ??
    r.Premium_Trainer ?? r.PremiumTrainer ??
    r.name ?? r.Name ?? ''
  ).trim();

  // Restore high-contrast preference
  const tgContrast = id('tgContrast');
  if (tgContrast){
    const cc = localStorage.getItem('prt_contrast') === 'high';
    tgContrast.checked = cc;
    if (cc) document.documentElement.setAttribute('data-contrast','high');
    tgContrast.onchange = ()=>{
      if (tgContrast.checked){
        document.documentElement.setAttribute('data-contrast','high');
        localStorage.setItem('prt_contrast','high');
      }else{
        document.documentElement.removeAttribute('data-contrast');
        localStorage.removeItem('prt_contrast');
      }
    };
  }

  setTimeout(()=> map.invalidateSize(), 120);

  // Event wiring — visibility affects coverage
  showConfirmed.onchange = handleHubVisibilityChange;
  showPending.onchange   = handleHubVisibilityChange;
  showAcosta.onchange    = handleHubVisibilityChange;

  on('input', radius,   ()=>{
    radiusLbl.textContent = radius.value; // classification fixed at 75mi; radius only affects rings/lists/overlap
    debouncedRun();
    updateRings();
    buildHubFilterOptions();
    if (tgOverlap.checked) drawOverlap();
    if (spHub) openSidepanel(spHub);
    refreshComparePanel();
    saveState();
  });

  on('input', covSearch, ()=> filterSelect(covFilter, covSearch.value));
  on('input', rmSearch,  ()=> filterSelect(rmFilter,  rmSearch.value));
  on('input', amSearch,  ()=> filterSelect(amFilter,  amSearch.value));
  on('input', hubSearch, ()=> filterSelect(hubFilter, hubSearch.value));

  on('change', rmFilter,  ()=>{ normalizeAll(rmFilter);  lastFilterChanged='rmFilter'; cascadeAM(); runFilter(); fitToResults(); saveState(); renderChips(); buildHubFilterOptions(); });
  on('change', amFilter,  ()=>{ normalizeAll(amFilter);  lastFilterChanged='amFilter'; runFilter(); fitToResults(); saveState(); renderChips(); buildHubFilterOptions(); });
  on('change', covFilter, ()=>{ normalizeAll(covFilter); lastFilterChanged='covFilter'; runFilter(); saveState(); renderChips(); buildHubFilterOptions(); });
  on('change', hubFilter, ()=>{ lastFilterChanged='hubFilter'; runFilter(); fitToResults(); saveState(); renderChips(); });

  id('fitBtn').onclick  = ()=>{ fitToResults(); saveState(); };
  id('homeBtn').onclick = ()=>{ map.setView(HOME_VIEW.center, HOME_VIEW.zoom); };
  id('resetBtn').onclick= ()=>{ resetAll(); runFilter(); saveState(); renderChips(); };

  // Dropdowns & views
  const exportDrop = id('exportDrop'); const menu = exportDrop.querySelector('.dropdown-menu');
  exportDrop.querySelector('button').onclick = ()=> toggleDropdown(menu);
  on('click', document.body, (e)=>{ if (!exportDrop.contains(e.target)) menu.style.display='none'; }, true);
  id('exportStores').onclick  = ()=>{ exportStoresCsv(); if(AUTO_RESET()) { resetAll(); runFilter(); renderChips(); } };
  id('exportGeo').onclick     = ()=>{ exportGeoLike('geojson'); if(AUTO_RESET()) { resetAll(); runFilter(); renderChips(); } };
  id('exportKml').onclick     = ()=>{ exportGeoLike('kml');     if(AUTO_RESET()) { resetAll(); runFilter(); renderChips(); } };

  const viewsDrop = id('viewsDrop'); const viewsMenu = id('viewsMenu'); const viewList = id('viewList');
  viewsDrop.querySelector('button').onclick = ()=> toggleDropdown(viewsMenu);
  on('click', document.body, (e)=>{ if (!viewsDrop.contains(e.target)) viewsMenu.style.display='none'; }, true);
  id('viewSave').onclick = saveCurrentView;
  rebuildViewsMenu();

  // Floating toggles
  tgHeat.onchange   = ()=>{ if (tgHeat.checked) { updateHeat(); heatControls.style.display='inline-flex'; } else { clearHeat(); heatControls.style.display='none'; } saveState(); };
  heatRadius.oninput    = ()=> updateHeat();
  heatIntensity.oninput = ()=> updateHeat();

  tgRings.onchange  = ()=>{ updateRings(); saveState(); };
  tgOverlap.onchange= ()=>{ if (tgOverlap.checked) drawOverlap(); else highlightLayer.clearLayers(); saveState(); };
  tgCompare.onchange= ()=>{ compareMode = tgCompare.checked; pinnedHubs=[]; highlightLayer.clearLayers(); refreshComparePanel(); alert(compareMode ? 'Compare mode on: click hub markers to pin them.' : 'Compare mode off.'); saveState(); };
  tgWithin.onchange = ()=>{ lastFilterChanged='tgWithin'; runFilter(); fitToResults(); saveState(); };
  tgCluster.onchange= ()=>{ refreshLayerMode(); };

  // Keyboard
  const searchBox = id('searchBox'), searchBadge = id('searchBadge'), searchResults = id('searchResults');
  const searchWrap = document.querySelector('.searchbox');
  id('searchClear').onclick = ()=>{ searchBox.value=''; localStorage.removeItem(LS_LAST_QUERY); searchBadge.classList.remove('show'); hideResults(); clearTarget(); runFilter(); };
  window.addEventListener('keydown',(e)=>{
    const tag = (e.target && e.target.tagName || '').toLowerCase();
    const typing = tag==='input' || tag==='textarea' || e.isComposing;

    if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); searchBox.focus(); searchBox.select(); }
    if (!typing && (e.key === '?' || (e.shiftKey && e.key === '/'))){ e.preventDefault(); id('helpModal').classList.add('show'); }
    if (e.key.toLowerCase() === 'h'){ map.setView(HOME_VIEW.center, HOME_VIEW.zoom); }
    if (e.key.toLowerCase() === 'f' && sidepanel.classList.contains('show')){ spSearch.focus(); spSearch.select(); }

    if (e.key === 'Escape'){
      const openModal = document.querySelector('.modal.show');
      if (openModal){ openModal.classList.remove('show'); return; }
      if (sidepanel.classList.contains('show')){ hideSidepanel(); return; }
      hideResults();
    }

    if (!typing && (e.key === '[' || e.key === ']')){
      const cur = Number(radius.value)||75;
      const next = e.key === '[' ? Math.max(25, cur-5) : Math.min(150, cur+5);
      if (next !== cur){
        radius.value = next; radiusLbl.textContent = next;
        debouncedRun(); updateRings(); if (spHub) openSidepanel(spHub); refreshComparePanel(); saveState();
      }
    }
  });

  // Side panel actions
  spClose.onclick = ()=> hideSidepanel();
  spCollapse.onclick = ()=> hideSidepanel();
  spSearch.addEventListener('input', ()=>{ spFilter = spSearch.value.trim().toLowerCase(); renderSidepanelList(); });
  spExport.onclick = ()=>{ exportSidepanelCsv(); if(AUTO_RESET()){ resetAll(); runFilter(); renderChips(); } };
  spPrint.onclick  = ()=>{ printSidepanelList();  if(AUTO_RESET()){ resetAll(); runFilter(); renderChips(); } };
  spPinBtn.onclick = ()=> togglePinFromPanel();
  document.querySelectorAll('.sp-quick .btn[data-r]').forEach(b=>{
    b.addEventListener('click', ()=>{
      radius.value = b.dataset.r; radiusLbl.textContent=b.dataset.r;
      runFilter(); updateRings(); if (spHub) openSidepanel(spHub); refreshComparePanel(); saveState();
    });
  });

  // Map events
  markers.on('clustermouseover', (e)=>{
    const cts = coverageCounts(e.layer.getAllChildMarkers());
    const total = Object.values(cts).reduce((a,b)=>a+b,0)||1;
    const pct = k => Math.round((cts[k]||0)*100/total);
    const html = `
      <div style="font-size:12px">
        <div><b>${total}</b> stores</div>
        <div><span class="dot" style="background:${COLORS["Premium + Acosta"]}"></span> P+A: <b>${cts["Premium + Acosta"]||0}</b> (${pct("Premium + Acosta")}%)</div>
        <div><span class="dot" style="background:${COLORS["Premium Only"]}"></span> Premium: <b>${cts["Premium Only"]||0}</b> (${pct("Premium Only")}%)</div>
        <div><span class="dot" style="background:${COLORS["Acosta Only"]}"></span> Acosta: <b>${cts["Acosta Only"]||0}</b> (${pct("Acosta Only")}%)</div>
        <div><span class="dot" style="background:${COLORS["Uncovered"]}"></span> Uncovered: <b>${cts["Uncovered"]||0}</b> (${pct("Uncovered")}%)</div>
      </div>`;
    e.layer.bindTooltip(html, {direction:'top', offset:[0,-12], opacity:0.95, sticky:true}).openTooltip();
  });
  markers.on('clustermouseout', (e)=>{ e.layer.closeTooltip(); });
  markers.on('clusterclick', (e)=>{ map.fitBounds(e.layer.getBounds()); });
  map.on('moveend zoomend', ()=>{
    updateInViewCount();
    if (id('tgHeat').checked) requestIdleCallback?.(updateHeat) ?? updateHeat();
    saveState();
  });

  // ---------- Normalization helpers ----------
  function normalizeStores(rows){
    const out = [];
    const seen = new Set();
    const toStr = v => (v == null ? '' : String(v)).trim();
    const toNum = v => { const n = Number(v); return Number.isFinite(n) ? n : NaN; };
    for (const r of (Array.isArray(rows) ? rows : [])) {
      const rawStore =
        r.storeNumberStr ?? r.storeNumber ?? r.StoreNumber ?? r.StoreNum ??
        r["Store #"] ?? r["Store"] ?? r["Store Number"] ?? r.store ??
        r.SiteID ?? r.SiteId ?? r["Site ID"] ?? r.StoreID ?? r.StoreId ?? "";
      const storeNumberStr = toStr(rawStore).replace(/\D+/g, "");
      const storeName = toStr(r.storeName ?? r["Store Name"] ?? r.Name ?? r.name) || "Walmart";
      const address = toStr(r.address ?? r.Address ?? r.addr ?? r["Street Address"]);
      const city    = toStr(r.city ?? r.City);
      const state   = toStr(r.state ?? r.State).slice(0, 2).toUpperCase();
      const areaManager = toStr(r.areaManager ?? r["Area Manager"] ?? r.AreaManager ?? r.AM ?? r["Area Mgr"]);
      const regionalManager = toStr(r.regionalManager ?? r["Regional Manager"] ?? r.RegionalManager ?? r.RM ?? r["Region Mgr"]);
      const trainerCity = toStr(r.trainerCity ?? r["Trainer City"] ?? r.HubCity ?? r["Hub City"] ??
                                r.Assigned_Premium ?? r["Assigned_Premium"]);
      const coverageType = toStr(r.coverageType ?? r.Coverage ?? r["Coverage Type"] ?? r.Coverage_Type) || "Uncovered";
      const lat = toNum(r.lat ?? r.latitude ?? r.Latitude ?? r.Lat ?? r.lat_dd ?? r["Latitude__c"]);
      const lng = toNum(r.lng ?? r.longitude ?? r.Longitude ?? r.Lon ?? r.lng_dd ?? r["Longitude__c"]);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;
      const key = storeNumberStr || `${lat.toFixed(6)},${lng.toFixed(6)}`;
      if (seen.has(key)) continue;
      seen.add(key);
      out.push({ storeNumberStr: storeNumberStr || key, storeName, address, city, state,
                 coverageType, areaManager, regionalManager, trainerCity, lat, lng });
    }
    return out;
  }

  // ---------- Load data ----------
  showBusy(true); let spinnerFailSafe = setTimeout(()=>showBusy(false), 7000);
  try {
    // STORES
    STATUS.textContent = `Loading ${DATA_URL} …`;
    let storeRaw = null;
    try{
      const resp = await fetch(DATA_URL, { cache:'no-store' });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const text = await resp.text();
      storeRaw = JSON.parse(text.replace(/^\uFEFF/,''));
      if (!Array.isArray(storeRaw)) throw new Error('store_data.json must be a JSON array');
    }catch(fetchErr){
      console.warn('Data fetch failed, using fallback stores:', fetchErr);
      STATUS.innerHTML = `<span style="color:#a15b00;font-weight:600">Loaded fallback test data</span> — place <code>store_data.json</code> next to this file to load real data.`;
      storeRaw = FALLBACK_STORES;
    }
    allStores = normalizeStores(storeRaw);
    STATUS.textContent += `  |  ${allStores.length.toLocaleString()} stores ready`;

    populateRM(allStores); populateAM(allStores);

    // ACOSTA
    try {
      const aResp = await fetch(ACOSTA_URL, { cache: 'no-store' });
      if (!aResp.ok) throw new Error(`HTTP ${aResp.status} for ${ACOSTA_URL}`);
      const aJson = await aResp.json();
      const rows = Array.isArray(aJson) ? aJson : [];
      acostaHubs = rows
        .map(r => ({
          lat: Number(r.Latitude ?? r.latitude ?? r.lat),
          lng: Number(r.Longitude ?? r.longitude ?? r.lng),
          name: String(r.RepName ?? r.name ?? 'Acosta Rep'),
          city: String(r.City ?? ''), state: String(r.State ?? '')
        }))
        .filter(r => Number.isFinite(r.lat) && Number.isFinite(r.lng))
        .map(r => ({
          id: 'ac_' + slug(`${r.name}-${r.city}-${r.state}`),
          name: r.name, fullName: `${r.name} — ${r.city}, ${r.state}`,
          coords: [r.lat, r.lng], status: 'acosta'
        }));
      STATUS.textContent += `  |  Acosta hubs: ${acostaHubs.length}`;
    } catch (e) {
      STATUS.innerHTML += `  |  <span style="color:#b42318">Acosta failed</span>`;
      console.error('Acosta load error:', e);
      acostaHubs = [];
    }

    // PREMIUM hubs (confirmed + pending/open/proposed)
    try {
      const pResp = await fetch(PREMIUM_URL, { cache: 'no-store' });
      const pJson = await pResp.json();
      const rows = Array.isArray(pJson)
        ? pJson
        : [
            ...(pJson.confirmed || []),
            ...(pJson.pending  || []),
            ...(pJson.open     || []),
            ...(pJson.recruit  || []),
            ...(pJson.cities   || []),
          ];

      const hubs = rows.map(toHub).filter(Boolean);
      const merged = coalesceHubs(hubs);
      premiumConfirmed = merged.filter(h => h.status === 'confirmed');
      premiumPending   = merged.filter(h => h.status === 'pending');

    } catch (e) {
      console.warn('Premium file missing/invalid', e);
      premiumConfirmed = [];
      premiumPending   = [];
    }

    // Build initial UI state
    buildSearchIndex();
    buildHubFilterOptions();

    if (!tryLoadSnapshot()){ tryLoadLocal(); }

    // Coverage classification (fixed at 75mi)
    recomputeCoverage();

    // Draw
    runFilter(); renderChips(); renderHubs(); updateRings();

    // Dataset badge (simple fingerprints + revisions)
    const storesFp  = `stores:${allStores.length}`;
    const premiumFp = `premium:${premiumConfirmed.length + premiumPending.length}`;
    const acostaFp  = `acosta:${acostaHubs.length}`;
    updateDatasetBadge(storesFp, premiumFp, acostaFp);

  } catch(err){
    STATUS.innerHTML = `<span style="color:#b42318;font-weight:600">Init error:</span> ${escape(err?.message || String(err))}`;
    console.error(err);
  } finally { clearTimeout(spinnerFailSafe); showBusy(false); }

  if (PENDING_PIN_IDS.length){
    pinnedHubs = visibleHubs().filter(h => PENDING_PIN_IDS.includes(h.id));
    if (tgOverlap.checked) drawOverlap();
  }
  if (PENDING_OPEN_HUB_ID){
    const h = visibleHubs().find(x => x.id === PENDING_OPEN_HUB_ID);
    if (h) openSidepanel(h);
    PENDING_OPEN_HUB_ID = null;
  }

  // ---------- Search ----------
  var searchIdx = []; let resIndex = -1; let targetPin=null; const targetIcon = L.divIcon({className:'', html:'<div style="background:#2f71ff;border:2px solid #fff;border-radius:50%;width:18px;height:18px;box-shadow:0 0 0 1px rgba(0,0,0,.25)"></div>', iconSize:[18,18], iconAnchor:[9,9]});
  const hoverIcon  = L.divIcon({className:'', html:'<div class="hl"></div>', iconSize:[22,22], iconAnchor:[11,11]});
  let hoverMarker=null;

  function buildSearchIndex(){
    searchIdx = allStores.map(s => ({
      kind:'STORE', store:s, lat:s.lat, lng:s.lng,
      text: (`store ${s.storeNumberStr} ${s.storeName||''} ${s.address||''} ${s.city} ${s.state} ${s.coverageType||''} ${s.areaManager||''} ${s.regionalManager||''}`).toLowerCase()
    }));
    const q0 = localStorage.getItem(LS_LAST_QUERY)||'';
    if (q0) { id('searchBox').value = q0; handleSearchInput(); }
  }
  function showHover(lat,lng){ if(hoverMarker) highlightLayer.removeLayer(hoverMarker); hoverMarker=L.marker([lat,lng],{icon:hoverIcon}).addTo(highlightLayer); }
  function hideHover(){ if(hoverMarker){ highlightLayer.removeLayer(hoverMarker); hoverMarker=null; } }
  function clearTarget(){ if (targetPin){ targetLayer.removeLayer(targetPin); targetPin=null; } }
  function hideResults(){ searchResults.classList.remove('show'); searchResults.innerHTML=''; searchResults._data=[]; resIndex=-1; id('searchBox').setAttribute('aria-activedescendant',''); }

  function showResults(list){
    const live = id('srStatus'); if (live) live.textContent = `${list.length} result${list.length===1?'':'s'}`;
    if (!list.length){ hideResults(); return; }
    searchResults.innerHTML = list.map((r,i)=>`
      <div class="res" id="res_${i}" data-i="${i}" role="option" title="Open this result">
        <div class="kind">${r.kind}</div>
        <div class="text">
          <div>${escape(r.label)}</div>
          ${r.kind==='STORE'
            ? `<div class="sub">${escape(r.store.address||'')} · ${escape(r.store.city||'')}, ${escape(r.store.state||'')} · ${escape(r.store.coverageType||'')}</div>`
            : (r.kind==='NEAR' ? `<div class="sub">${escape(r.store.address||'')} · ${escape(r.store.city||'')}, ${escape(r.store.state||'')}</div>` : '')
          }
        </div>
      </div>`).join('');
    searchResults.classList.add('show');
    Array.from(searchResults.querySelectorAll('.res')).forEach(el=>{
      el.addEventListener('mouseenter', ()=>{ const d = searchResults._data[Number(el.dataset.i)]; if(d && d.lat) showHover(d.lat,d.lng); });
      el.addEventListener('mouseleave', hideHover);
      el.addEventListener('click', ()=>{ const d = searchResults._data[Number(el.dataset.i)]; selectResult(d); });
    });
    searchResults._data = list; resIndex=-1;
  }

  function toResFromStore(s,score,kind='STORE'){ return { kind, store:s, label:`Store ${s.storeNumberStr} — ${s.storeName||''}, ${s.city}, ${s.state}`, lat:s.lat, lng:s.lng, score }; }
  function toCityRes(city,state,lat,lng,score){ return { kind:'CITY', label:`${city}, ${state}`, lat, lng, score }; }

  function smartNearest(center,limit=8){
    return allStores.map(s => [distMiles(center.lat,center.lng,s.lat,s.lng), s]).sort((a,b)=>a[0]-b[0]).slice(0,limit).map((x,i)=>toResFromStore(x[1], 80-i,'NEAR'));
  }

  // Fuzzy helpers + “near <city>”
  function fuzzyScore(hay, needle){
    hay = (hay||'').toLowerCase(); needle = (needle||'').toLowerCase().trim();
    if (!needle) return 0;
    if (hay.includes(needle)) return 100;
    const toks = needle.split(/\s+/).filter(Boolean);
    if (!toks.length) return 0;
    const hits = toks.reduce((a,t)=>a + (hay.includes(t)?1:0), 0);
    return hits ? 60 + hits*10 : 0;
  }
  function findCityCenter(query){
    const m = (query||'').match(/^\s*(.+?)(?:,\s*([A-Za-z]{2}))?\s*$/);
    if (!m) return null;
    const qCity  = (m[1]||'').toLowerCase();
    const qState = (m[2]||'').toUpperCase();
    const groups = new Map();
    allStores.forEach(s=>{
      const city = (s.city||'').toLowerCase();
      const st   = (s.state||'').toUpperCase();
      const cityHit  = city === qCity || city.includes(qCity);
      const stateHit = !qState || st === qState;
      if (cityHit && stateHit){
        const key = `${city}|${st}`;
        const g = groups.get(key) || {city:s.city, state:s.state, lat:0, lng:0, n:0};
        g.lat += s.lat; g.lng += s.lng; g.n += 1; groups.set(key, g);
      }
    });
    if (!groups.size) return null;
    const best = Array.from(groups.values()).sort((a,b)=>b.n-a.n)[0];
    return { city: best.city, state: best.state, lat: best.lat/best.n, lng: best.lng/best.n, n: best.n };
  }

  function highlightResult(){
    Array.from(searchResults.querySelectorAll('.res')).forEach((el,i)=>{
      el.classList.toggle('active', i===resIndex);
    });
    const active = searchResults.querySelector(`#res_${resIndex}`);
    if (active) searchBox.setAttribute('aria-activedescendant', active.id);
  }
  function selectResult(d){
    hideResults(); hideHover();
    if(!d) return;
    if(d.kind==='STORE' || d.kind==='NEAR'){ openStorePopup(d.store); return; }
    if(d.kind==='CITY' || d.kind==='HUB'){
      const latlng = [d.lat,d.lng];
      showPinPopup(latlng, `
        <div style="font-size:13px;line-height:1.35;min-width:220px">
          <div style="font-weight:800;margin-bottom:4px">${escape(d.label)}</div>
          <div style="color:var(--muted)">Lat: ${Number(d.lat).toFixed(4)}, Lng: ${Number(d.lng).toFixed(4)}</div>
        </div>
      `);
      map.panInside(latlng, { paddingTopLeft:[20,20], paddingBottomRight:[20,20] });
      return;
    }
  }
  function showPinPopup(latlng, html){
    if(!targetPin){ targetPin = L.marker(latlng,{icon:targetIcon}).addTo(targetLayer); }
    else { targetPin.setLatLng(latlng); }
    const p = L.popup({autoClose:true, closeOnClick:true, maxWidth:320}).setLatLng(latlng).setContent(html);
    p.openOn(map);
  }

  function handleSearchInput(){
    if (!allStores.length){ hideResults(); return; }
    const qraw = (searchBox.value||'').trim();
    const q = qraw.toLowerCase();
    localStorage.setItem(LS_LAST_QUERY, qraw);

    const nearCity = q.match(/^near\s+(.+)$/i);

    if (!q || q === 'near' || q === 'near me'){
      searchBadge.textContent = 'NEAR';
      searchBadge.classList.add('show');
      showResults(smartNearest(map.getCenter(), 8));
      return;
    }
    if (nearCity){
      const center = findCityCenter(nearCity[1]);
      if (center){
        map.setView([center.lat, center.lng], Math.max(map.getZoom(), 8));
        showResults(smartNearest({lat:center.lat, lng:center.lng}, 8));
        searchBadge.textContent = 'NEAR'; searchBadge.classList.add('show');
        showPinPopup([center.lat, center.lng], `
          <div style="font-size:13px;line-height:1.35;min-width:220px">
            <div style="font-weight:800;margin-bottom:4px">Near ${escape(center.city)}, ${escape(center.state)}</div>
            <div style="color:var(--muted)">${center.n} reference stores • ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}</div>
          </div>`);
        return;
      }
    }

    const items = [];
    const numInside = q.match(/\b(\d{3,6})\b/);
    if (numInside){
      const s = allStores.find(x => x.storeNumberStr === numInside[1]);
      if (s) items.push(toResFromStore(s, 120));
    }

    const cityHits = new Map();
    allStores.forEach(s=>{
      const score = fuzzyScore(`${s.city}, ${s.state}`, q);
      if (score>=70){
        const key = `${s.city}|${s.state}`;
        const v = cityHits.get(key) || { city:s.city, state:s.state, lat:0, lng:0, n:0, score };
        v.lat += s.lat; v.lng += s.lng; v.n += 1; v.score = Math.max(v.score, score);
        cityHits.set(key, v);
      }
    });
    Array.from(cityHits.values())
      .sort((a,b)=> b.score - a.score || b.n - a.n)
      .slice(0,8)
      .forEach(c => items.push(toCityRes(c.city, c.state, c.lat/c.n, c.lng/c.n, 85)));

    searchIdx.forEach(it => {
      const score = fuzzyScore(it.text, q);
      if (score >= 70) items.push(toResFromStore(it.store, score));
    });

    visibleHubs().forEach(h=>{
      const score = fuzzyScore(h.fullName||h.name, q);
      if (score>=70) items.push({ kind:'HUB', label:h.fullName||h.name, lat:h.coords[0], lng:h.coords[1], score });
    });

    const seen=new Set(), out=[];
    items.sort((a,b)=>b.score-a.score).forEach(it=>{
      const k=it.kind+'|'+it.label+'|'+it.lat+'|'+it.lng;
      if(!seen.has(k)){ seen.add(k); out.push(it); }
    });

    if (out.length) { searchBadge.textContent = 'SEARCH'; searchBadge.classList.add('show'); }
    else { searchBadge.classList.remove('show'); }
    showResults(out.slice(0,60));
  }

  searchBox.addEventListener('input', handleSearchInput);
  searchBox.addEventListener('keydown', (e)=>{
    const items = searchResults._data || [];
    if (e.key === 'ArrowDown'){ e.preventDefault(); resIndex = Math.min(items.length-1,resIndex+1); highlightResult(); }
    if (e.key === 'ArrowUp'){ e.preventDefault(); resIndex = Math.max(0,resIndex-1); highlightResult(); }
    if (e.key === 'Enter'){ e.preventDefault(); if (resIndex>=0 && items[resIndex]) { selectResult(items[resIndex]); } }
    if (e.key === 'Escape'){ hideResults(); }
  });
  document.addEventListener('click', (e)=>{ if (!searchWrap.contains(e.target)) hideResults(); });

  // ---------- Filtering & markers ----------
  function storeFilter(s){
    const covSel = Array.from(covFilter.selectedOptions).map(o=>o.value);
    const covOK  = covSel.includes('All') || covSel.includes(s.coverageType || '');

    const rmSel = Array.from(rmFilter.selectedOptions).map(o=>o.value);
    const amSel = Array.from(amFilter.selectedOptions).map(o=>o.value);
    const rmOK  = rmSel.includes('All') || rmSel.includes(s.regionalManager || '');
    const amOK  = amSel.includes('All') || amSel.includes(s.areaManager || '');

    // Hubs (value = hub IDs)
    const hubSel = Array.from(hubFilter.selectedOptions).map(o=>o.value);
    let hubOK = true;
    if (hubSel.length){
      const r = Number(radius.value) || DEFAULT_RADIUS;
      const hubsNow = [...premiumConfirmed, ...premiumPending, ...acostaHubs];
      const selHubs = hubsNow.filter(h => hubSel.includes(h.id));
      hubOK = selHubs.some(h => distMiles(s.lat, s.lng, h.coords[0], h.coords[1]) <= r);
    }

    // “Within hubs” toggle
    let withinOK = true;
    if (tgWithin.checked){
      const r = Number(radius.value) || DEFAULT_RADIUS;
      withinOK = visibleHubs().some(h => distMiles(s.lat, s.lng, h.coords[0], h.coords[1]) <= r);
    }

    return covOK && rmOK && amOK && hubOK && withinOK;
  }

  function runFilter(){
    markerByStore.clear();
    if(tgCluster.checked){ markers.clearLayers(); } else { plainMarkers.clearLayers(); }

    filteredStores = allStores.filter(storeFilter);

    const ms = filteredStores.map(s=>{
      const m = L.circleMarker([s.lat,s.lng], {
        radius:5, weight:1, fillOpacity:.9, color:'#fff',
        fillColor: COLORS[s.coverageType] || '#999'
      });
      m.store = s;
      m.bindPopup(storePopupHTML(s));
      markerByStore.set(s.storeNumberStr, m);
      return m;
    });

    if (tgCluster.checked){ markers.addLayers(ms); }
    else { plainMarkers.addLayer(L.layerGroup(ms)); }

    updateCounts();

    // NEW: rebuild RM/AM options with counts (fixes "not defined" error)
    rebuildRMOptionsWithCounts();
    rebuildAMOptionsWithCounts();

    buildHubFilterOptions();

    updateInViewCount();
    if (id('tgHeat').checked) updateHeat();
    if (id('tgRings').checked) updateRings();

    id('emptyState').hidden = filteredStores.length !== 0;
  }

  function updateCounts(){
    const total = filteredStores.length;
    const by = { 'Premium + Acosta':0, 'Premium Only':0, 'Acosta Only':0, 'Uncovered':0 };
    filteredStores.forEach(s => { by[s.coverageType] = (by[s.coverageType] || 0) + 1; });
    const pct = (n) => total ? Math.round(n * 100 / total) + '%' : '0%';

    k.pa.textContent = `${by['Premium + Acosta']||0} (${pct(by['Premium + Acosta']||0)})`;
    k.p.textContent  = `${by['Premium Only']||0} (${pct(by['Premium Only']||0)})`;
    k.a.textContent  = `${by['Acosta Only']||0} (${pct(by['Acosta Only']||0)})`;
    k.u.textContent  = `${by['Uncovered']||0} (${pct(by['Uncovered']||0)})`;

    k.total.textContent    = total;
    k.confirmed.textContent = premiumConfirmed.length;
    k.pending.textContent   = premiumPending.length;
  }

  function updateInViewCount(){
    const b=map.getBounds();
    const inV=filteredStores.filter(s=>b.contains([s.lat,s.lng])).length;
    k.inView.textContent=`In view: ${inV}`;
  }

  function refreshLayerMode(){
    if (tgCluster.checked){
      if (map.hasLayer(plainMarkers)) map.removeLayer(plainMarkers);
      if (!map.hasLayer(markers)) map.addLayer(markers);
    } else {
      if (map.hasLayer(markers)) map.removeLayer(markers);
      if (!map.hasLayer(plainMarkers)) map.addLayer(plainMarkers);
    }
    runFilter();
  }

  // ---------- Hubs ----------
  function visibleHubs(){
    const out = [];
    if (showConfirmed.checked) out.push(...premiumConfirmed);
    if (showPending.checked)   out.push(...premiumPending);
    if (showAcosta.checked)    out.push(...acostaHubs);
    return out;
  }
  function hubDisplay(h){ return h.label || h.fullName || h.name; }

  function copyHubLink(){
    if(!spHub) return;
    saveState();
    const st = JSON.parse(localStorage.getItem(LS_STATE) || '{}');
    st.openHubId     = spHub.id;
    st.pinnedHubIds  = pinnedHubs.map(h => h.id);
    const hash = btoa(unescape(encodeURIComponent(JSON.stringify(st))));
    const url  = `${location.origin}${location.pathname}#${hash}`;
    navigator.clipboard?.writeText(url);
    alert('Hub link copied to clipboard.');
  }
  spLink.onclick = copyHubLink;

  function renderHubs(){
    hubLayer.clearLayers();
    const vis = visibleHubs();
    vis.forEach(h=>{
      const cls =
        h.status === 'confirmed' ? 'confirmed' :
        h.status === 'pending'   ? 'pending'   : 'acosta';
      const icon = L.divIcon({
        className: '',
        html: `<div class="hub ${cls}"></div>`,
        iconSize: [20,20],
        iconAnchor: [10,10]
      });
      const m = L.marker(h.coords, { icon, title: hubDisplay(h), pane: 'hubPane' }).addTo(hubLayer);
      m.hub = h;
      m.on('click', ()=> compareMode ? togglePin(h) : openSidepanel(h));
      m.on('mouseover', ()=> m.bindTooltip(hubDisplay(h), {direction:'top', offset:[0,-8]}).openTooltip());
      m.on('mouseout',  ()=> m.closeTooltip());
    });
  }

  // RINGS with label + crosshair
  function updateRings(){
    ringLayer.clearLayers();
    if(!tgRings.checked) return;

    const rMi = Number(radius.value) || DEFAULT_RADIUS;
    const rMeters = rMi * 1609.344;

    visibleHubs().forEach(h=>{
      const circle = L.circle(h.coords, { radius:rMeters, color:'#333', weight:1, fill:false, opacity:.4 });
      ringLayer.addLayer(circle);

      const [lat,lng] = h.coords;
      const dLat = (rMi/69); // degree approximation
            const top = [lat + dLat, lng];
      // Ring label
      const lblIcon = L.divIcon({
        className: '',
        html: `<div style="font:600 11px/1 system-ui,Segoe UI,Roboto,Arial;color:#111;background:#fff;border:1px solid #d0d7de;border-radius:999px;padding:2px 6px;box-shadow:0 2px 6px rgba(0,0,0,.1)">${rMi} mi</div>`
      });
      L.marker(top, { icon: lblIcon, interactive:false }).addTo(ringLayer);

      // Subtle crosshair at center
      const chSize = 600; // meters per arm
      const north = L.latLng(lat + (chSize/111320), lng);
      const south = L.latLng(lat - (chSize/111320), lng);
      const east  = L.latLng(lat, lng + (chSize/(40075000*Math.cos(lat*Math.PI/180)/360)));
      const west  = L.latLng(lat, lng - (chSize/(40075000*Math.cos(lat*Math.PI/180)/360)));
      L.polyline([north, south], {color:'#333', weight:1, opacity:0.25}).addTo(ringLayer);
      L.polyline([east, west],   {color:'#333', weight:1, opacity:0.25}).addTo(ringLayer);
    });
  }

  // ---------- Coverage (fixed at 75mi for classification) ----------
  function recomputeCoverage(){
    const R_FIXED = 75; // mi
    for (const s of allStores){
      const nearPrem = nearestHubWithin(s.lat, s.lng, [...premiumConfirmed, ...premiumPending], R_FIXED);
      const nearAc   = nearestHubWithin(s.lat, s.lng, acostaHubs, R_FIXED);

      if (nearPrem && nearAc) s.coverageType = 'Premium + Acosta';
      else if (nearPrem)      s.coverageType = 'Premium Only';
      else if (nearAc)        s.coverageType = 'Acosta Only';
      else                    s.coverageType = 'Uncovered';

      s.trainerCity = nearPrem ? (nearPrem.fullName || nearPrem.name) : (nearAc ? (nearAc.fullName || nearAc.name) : '');
    }
  }
  function nearestHubWithin(lat,lng,hubs,mi){
    let best=null, dmin=1e9;
    for(const h of hubs){
      const d = distMiles(lat,lng,h.coords[0],h.coords[1]);
      if (d<=mi && d<dmin){ dmin=d; best=h; }
    }
    return best;
  }

  // ---------- Overlap highlighting (2+ hubs) ----------
  function drawOverlap(){
    highlightLayer.clearLayers();
    const rMi = Number(radius.value)||DEFAULT_RADIUS;
    const hubs = visibleHubs();
    if (!hubs.length) return;

    const counts = new Map(); // key -> how many hubs cover
    for (const h of hubs){
      for (const s of filteredStores){
        if (distMiles(s.lat,s.lng,h.coords[0],h.coords[1])<=rMi){
          const k = s.storeNumberStr;
          counts.set(k, (counts.get(k)||0)+1);
        }
      }
    }
    const overlaps = filteredStores.filter(s => (counts.get(s.storeNumberStr)||0)>=2);
    overlaps.forEach(s=>{
      L.circleMarker([s.lat,s.lng], {radius:7, weight:2, color:'#000', fillColor:'#fff', fillOpacity:.9}).addTo(highlightLayer);
    });
  }

  // ---------- Sidepanel ----------
  function openSidepanel(h){
    spHub = h;
    spTitle.textContent = hubDisplay(h);
    const rMi = Number(radius.value)||DEFAULT_RADIUS;

    const inside = filteredStores
      .map(s => ({ s, d: distMiles(s.lat, s.lng, h.coords[0], h.coords[1]) }))
      .filter(x => x.d <= rMi)
      .sort((a,b)=>a.d-b.d)
      .map(x => ({...x.s, _dist: x.d}));

    spCounts.innerHTML = `
      <span class="sp-chip"><b>${inside.length}</b> in ${rMi} mi</span>
      <span class="sp-chip"><span class="dot" style="background:${COLORS["Premium + Acosta"]}"></span>${inside.filter(x=>x.coverageType==='Premium + Acosta').length}</span>
      <span class="sp-chip"><span class="dot" style="background:${COLORS["Premium Only"]}"></span>${inside.filter(x=>x.coverageType==='Premium Only').length}</span>
      <span class="sp-chip"><span class="dot" style="background:${COLORS["Acosta Only"]}"></span>${inside.filter(x=>x.coverageType==='Acosta Only').length}</span>
      <span class="sp-chip"><span class="dot" style="background:${COLORS["Uncovered"]}"></span>${inside.filter(x=>x.coverageType==='Uncovered').length}</span>
    `;
    spMeta.innerHTML = `
      <div><b>Status:</b> ${escape(h.status||'')}</div>
      <div><b>Coords:</b> ${h.coords[0].toFixed(5)}, ${h.coords[1].toFixed(5)}</div>
    `;

    spRows = inside;
    spFilter = '';
    spSearch.value='';
    renderSidepanelList();

    // Focus trap basics
    sidepanel.classList.add('show');
    sidepanel.focus();
    map.panInside(h.coords, {paddingTopLeft:[380,40], paddingBottomRight:[20,40]});
  }
  function renderSidepanelList(){
    const rows = spFilter
      ? spRows.filter(r => ((r.storeNumberStr||'') + ' ' + (r.address||'') + ' ' + (r.city||'') + ' ' + (r.state||'')).toLowerCase().includes(spFilter))
      : spRows;

    spRowsEl.innerHTML = rows.map(r => `
      <div class="row" data-id="${escape(r.storeNumberStr)}" role="button" tabindex="0">
        <div class="num">${escape(r.storeNumberStr)}</div>
        <div class="text">
          <div class="title">${escape(r.storeName||'Walmart')}</div>
          <div class="addr">${escape(r.address||'')} — ${escape(r.city||'')}, ${escape(r.state||'')}</div>
          <div class="addr">Coverage: <b>${escape(r.coverageType||'')}</b> • Dist: ${r._dist?.toFixed(1)||'?'} mi</div>
        </div>
      </div>`).join('');

    Array.from(spRowsEl.querySelectorAll('.row')).forEach(el=>{
      el.addEventListener('click', ()=> {
        const idd = el.getAttribute('data-id');
        const s = spRows.find(x => x.storeNumberStr === idd);
        if (s) openStorePopup(s, true);
        Array.from(spRowsEl.querySelectorAll('.row')).forEach(n=>n.classList.remove('active'));
        el.classList.add('active');
      });
      el.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') { e.preventDefault(); el.click(); } });
    });
  }
  function hideSidepanel(){ sidepanel.classList.remove('show'); spHub=null; }

  function storePopupHTML(s){
    return `
      <div style="min-width:240px;font-size:13px;line-height:1.35">
        <div style="font-weight:800">${escape(s.storeName||'Walmart')} • ${escape(s.storeNumberStr||'')}</div>
        <div style="color:#374151">${escape(s.address||'')}</div>
        <div style="color:#374151">${escape(s.city||'')}, ${escape(s.state||'')}</div>
        <div style="margin-top:6px">Coverage: <b>${escape(s.coverageType||'')}</b></div>
        ${s.areaManager ? `<div>AM: ${escape(s.areaManager)}</div>` : ''}
        ${s.regionalManager ? `<div>RM: ${escape(s.regionalManager)}</div>` : ''}
        ${s.trainerCity ? `<div>Nearest hub: ${escape(s.trainerCity)}</div>` : ''}
      </div>`;
  }
  function openStorePopup(s, pan=true){
    const m = markerByStore.get(s.storeNumberStr);
    if (m){ m.openPopup(); if (pan) map.panInside([s.lat,s.lng], {paddingTopLeft:[20,20], paddingBottomRight:[20,20]}); }
    else {
      const p = L.popup({maxWidth:320}).setLatLng([s.lat,s.lng]).setContent(storePopupHTML(s));
      p.openOn(map);
      if (pan) map.panInside([s.lat,s.lng], {paddingTopLeft:[20,20], paddingBottomRight:[20,20]});
    }
  }

  // ---------- Hub utilities ----------
  function toHub(r){
    const name =
      getName(r) ||
      r.HubName || r['Hub Name'] || r.City || r.city ||
      r.CandidateCity || r['Candidate City'] ||
      r.Premium_Trainer || r.PremiumTrainer || r.Trainer || r.name;
    const city = r.City || r.city || '';
    const state = (r.State || r.state || '').toString().slice(0,2).toUpperCase();
    const lat = Number(r.Latitude ?? r.lat ?? r.Lat);
    const lng = Number(r.Longitude ?? r.lng ?? r.Lon);
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) return null;

    let status = (r.status || r.Status || '').toString().toLowerCase();
    if (!status) status = (r.confirmed || r.isConfirmed) ? 'confirmed' : (r.pending || r.isPending) ? 'pending' : 'pending';

    const full = name && state ? `${name} — ${city ? (city+', ') : ''}${state}` : (city && state ? `${city}, ${state}` : name || 'Hub');
    return {
      id: slug(`${name||city||'hub'}-${city}-${state}-${lat.toFixed(5)}-${lng.toFixed(5)}`),
      name: name || city || 'Hub',
      fullName: full,
      label: full,
      coords: [lat,lng],
      status
    };
  }
  function coalesceHubs(hubs){
    const out=[]; const seen=new Set();
    hubs.forEach(h=>{
      const k = `${h.coords[0].toFixed(4)}|${h.coords[1].toFixed(4)}|${h.name}|${h.status}`;
      if (seen.has(k)) return; seen.add(k); out.push(h);
    });
    return out;
  }

  function clusterIconByDominantCoverage(cluster){
    const counts = coverageCounts(cluster.getAllChildMarkers());
    const total = Object.values(counts).reduce((a,b)=>a+b,0)||1;
    const dominant = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'Uncovered';
    const cls = dominant==='Premium + Acosta' ? 'marker-pa' : dominant==='Premium Only' ? 'marker-p' : dominant==='Acosta Only' ? 'marker-a' : '';
    return new L.DivIcon({
      html:`<div><span>${total}</span></div>`,
      className:`marker-cluster ${cls}`,
      iconSize:new L.Point(40,40)
    });
  }
  function coverageCounts(ms){
    const c = { 'Premium + Acosta':0, 'Premium Only':0, 'Acosta Only':0, 'Uncovered':0 };
    ms.forEach(m => { c[m.store?.coverageType || 'Uncovered']++; });
    return c;
  }

  // ---------- Filters: RM/AM populate & cascade ----------
  function populateRM(rows){
    const rms = Array.from(new Set(rows.map(r=>r.regionalManager).filter(Boolean))).sort();
    rmFilter.innerHTML = `<option value="All" selected>All</option>` + rms.map(x=>`<option>${escape(x)}</option>`).join('');
  }
  function populateAM(rows){
    const ams = Array.from(new Set(rows.map(r=>r.areaManager).filter(Boolean))).sort();
    amFilter.innerHTML = `<option value="All" selected>All</option>` + ams.map(x=>`<option>${escape(x)}</option>`).join('');
  }
  function rebuildRMOptionsWithCounts(){
    const sel = new Set(Array.from(rmFilter.selectedOptions).map(o=>o.value));
    const groups = new Map();
    filteredStores.forEach(s => { const k = s.regionalManager||''; groups.set(k, (groups.get(k)||0)+1); });
    const all = Array.from(groups.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
    rmFilter.innerHTML = `<option value="All"${sel.has('All')?' selected':''}>All</option>` +
      all.map(([k,v]) => `<option${sel.has(k)?' selected':''}>${escape(k)}</option>`).join('');
  }
  function rebuildAMOptionsWithCounts(){
    const sel = new Set(Array.from(amFilter.selectedOptions).map(o=>o.value));
    const groups = new Map();
    filteredStores.forEach(s => { const k = s.areaManager||''; groups.set(k, (groups.get(k)||0)+1); });
    const all = Array.from(groups.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
    amFilter.innerHTML = `<option value="All"${sel.has('All')?' selected':''}>All</option>` +
      all.map(([k,v]) => `<option${sel.has(k)?' selected':''}>${escape(k)}</option>`).join('');
  }
  function cascadeAM(){
    // If specific RMs are selected, limit AM list to those present under the selected RMs
    const rmSel = new Set(Array.from(rmFilter.selectedOptions).map(o=>o.value));
    if (rmSel.has('All')) return;
    const allowed = new Set(allStores.filter(s => rmSel.has(s.regionalManager||'')).map(s => s.areaManager||''));
    const opts = Array.from(amFilter.options);
    opts.forEach(o => { if (o.value==='All') return; o.disabled = !allowed.has(o.value); if (o.disabled) o.selected=false; });
  }

  // ---------- Hub filter options (IDs, pending names fixed) ----------
  function buildHubFilterOptions(){
    const rMi = Number(radius.value)||DEFAULT_RADIUS;
    const all = visibleHubs();
    const opts = all.map(h => ({ id:h.id, label: hubDisplay(h)})).sort((a,b)=>a.label.localeCompare(b.label));
    const selIds = new Set(Array.from(hubFilter.selectedOptions).map(o=>o.value));
    hubFilter.innerHTML = opts.map(o => `<option value="${escape(o.id)}"${selIds.has(o.id)?' selected':''}>${escape(o.label)}</option>`).join('');
  }

  // ---------- Fit/Reset/Chips ----------
  function fitToResults(){
    const pts = filteredStores.map(s=>[s.lat,s.lng]);
    if (!pts.length){ map.setView(HOME_VIEW.center, HOME_VIEW.zoom); return; }
    const b = L.latLngBounds(pts);
    map.fitBounds(b, { padding:[40,40] });
  }
  function resetAll(){
    covFilter.value = 'All';
    Array.from([rmFilter,amFilter,hubFilter]).forEach(sel=>{
      Array.from(sel.options).forEach(o=>{ o.selected = (o.value==='All'); });
    });
    tgWithin.checked = false; tgOverlap.checked = false; tgRings.checked = false; tgHeat.checked = false;
    heatControls.style.display='none'; clearHeat(); highlightLayer.clearLayers(); ringLayer.clearLayers();
    searchBox.value=''; localStorage.removeItem(LS_LAST_QUERY);
    hideResults(); clearTarget();
  }

  function renderChips(){
    const bar = id('activeChips');
    const chips = [];
    const sel = (selEl,label) => {
      const vals = Array.from(selEl.selectedOptions).map(o=>o.value).filter(v=>v!=='All');
      if (vals.length) chips.push(`${label}: ${vals.join(' • ')}`);
    };
    sel(covFilter,'Coverage');
    sel(rmFilter,'RM');
    sel(amFilter,'AM');
    sel(hubFilter,'Hubs');
    bar.textContent = chips.join('  ·  ');
  }

  // ---------- Export ----------
  function exportStoresCsv(){
    const rows = filteredStores.map(s=>({
      Store:s.storeNumberStr, Name:s.storeName, Address:s.address, City:s.city, State:s.state,
      Coverage:s.coverageType, AM:s.areaManager, RM:s.regionalManager, NearestHub:s.trainerCity
    }));
    const csv = toCSV(rows);
    downloadText(`filtered_stores_${Date.now()}.csv`, csv);
    toast('Exported filtered stores.');
  }
  function exportSidepanelCsv(){
    if (!spHub){ alert('Open a hub first.'); return; }
    const rows = spRows.map(s=>({
      Store:s.storeNumberStr, Name:s.storeName, Address:s.address, City:s.city, State:s.state,
      Coverage:s.coverageType, Distance_mi:s._dist?.toFixed(2)||'', AM:s.areaManager, RM:s.regionalManager
    }));
    const csv = toCSV(rows);
    downloadText(`hub_${slug(spHub.name||'hub')}_${Date.now()}.csv`, csv);
    toast('Exported hub list.');
  }
  function printSidepanelList(){
    if (!spHub){ alert('Open a hub first.'); return; }
    const html = `
      <html><head><title>${escape(spHub.name||'Hub')} — Store List</title>
      <style>body{font:13px system-ui} table{border-collapse:collapse;width:100%} th,td{border:1px solid #ccc;padding:6px}</style>
      </head><body>
      <h2>${escape(spHub.name||'Hub')} — ${Number(radius.value)||DEFAULT_RADIUS} mi</h2>
      <table><thead><tr>
        <th>Store</th><th>Name</th><th>Address</th><th>City</th><th>State</th><th>Coverage</th><th>Distance (mi)</th>
      </tr></thead><tbody>
      ${spRows.map(s=>`<tr>
        <td>${escape(s.storeNumberStr)}</td>
        <td>${escape(s.storeName||'')}</td>
        <td>${escape(s.address||'')}</td>
        <td>${escape(s.city||'')}</td>
        <td>${escape(s.state||'')}</td>
        <td>${escape(s.coverageType||'')}</td>
        <td>${s._dist?.toFixed(2)||''}</td>
      </tr>`).join('')}
      </tbody></table></body></html>`;
    const w = window.open('', '_blank'); w.document.write(html); w.document.close(); w.focus(); w.print();
  }

  function exportGeoLike(kind){
    const rMi = Number(radius.value)||DEFAULT_RADIUS;
    const features = [];

    // Stores in filter
    filteredStores.forEach(s=>{
      features.push({
        type:'Feature',
        properties:{ type:'store', store:s.storeNumberStr, name:s.storeName, address:s.address, city:s.city, state:s.state, coverage:s.coverageType },
        geometry:{ type:'Point', coordinates:[s.lng, s.lat] }
      });
    });

    // Visible hubs + rings
    visibleHubs().forEach(h=>{
      features.push({
        type:'Feature',
        properties:{ type:'hub', name:h.fullName || h.name, status:h.status },
        geometry:{ type:'Point', coordinates:[h.coords[1], h.coords[0]] }
      });
      // Circle as approx polygon
      features.push(circleFeature(h.coords[0], h.coords[1], rMi, { type:'ring', name:h.fullName||h.name }));
    });

    const fc = { type:'FeatureCollection', features };
    if (kind==='geojson'){
      downloadText(`export_${Date.now()}.geojson`, JSON.stringify(fc));
      toast('Exported GeoJSON.');
    } else {
      const kml = geojsonToKml(fc);
      downloadText(`export_${Date.now()}.kml`, kml);
      toast('Exported KML.');
    }
  }

  // ---------- Compare ----------
  function togglePinFromPanel(){ if (spHub) togglePin(spHub); }
  function togglePin(h){
    const i = pinnedHubs.findIndex(x=>x.id===h.id);
    if (i>=0) pinnedHubs.splice(i,1); else pinnedHubs.push(h);
    refreshComparePanel();
  }
  function refreshComparePanel(){
    const panel = id('comparePanel');
    if (!tgCompare.checked){ panel.classList.remove('show'); return; }
    panel.classList.add('show');
    const names = pinnedHubs.map(h=>escape(hubDisplay(h)));
    id('compareBody').innerHTML = `
      <div class="compare-grid">
        <div>Pinned:</div><div><b>${names.join(' vs ')||'—'}</b></div>
      </div>
      <div class="compare-grid">
        <div>Radius:</div><div>${Number(radius.value)||DEFAULT_RADIUS} mi</div>
      </div>
      <div class="compare-grid">
        <div>Overlap mode:</div><div>${tgOverlap.checked?'On':'Off'}</div>
      </div>
    `;
    id('cmpClear').onclick = ()=>{ pinnedHubs=[]; refreshComparePanel(); };
    id('cmpExport').onclick = ()=>{
      if (pinnedHubs.length<1){ alert('Pin at least one hub.'); return; }
      const rMi = Number(radius.value)||DEFAULT_RADIUS;
      const rows = [];
      pinnedHubs.forEach(h=>{
        const inside = filteredStores.filter(s=>distMiles(s.lat,s.lng,h.coords[0],h.coords[1])<=rMi);
        inside.forEach(s=>rows.push({Hub:hubDisplay(h), Store:s.storeNumberStr, City:s.city, State:s.state, Coverage:s.coverageType}));
      });
      downloadText(`compare_${Date.now()}.csv`, toCSV(rows));
      toast('Exported compare CSV.');
    };
  }

  // ---------- Saved views / snapshot ----------
  function saveCurrentView(){
    const nm = prompt('Name this view'); if (!nm) return;
    const st = snapshotState();
    const views = JSON.parse(localStorage.getItem(LS_VIEWS)||'[]');
    views.push({ name:nm, when:Date.now(), st });
    localStorage.setItem(LS_VIEWS, JSON.stringify(views));
    rebuildViewsMenu(); toast('View saved.');
  }
  function snapshotState(){
    return {
      center: map.getCenter(), zoom: map.getZoom(),
      cov: Array.from(covFilter.selectedOptions).map(o=>o.value),
      rm: Array.from(rmFilter.selectedOptions).map(o=>o.value),
      am: Array.from(amFilter.selectedOptions).map(o=>o.value),
      hub: Array.from(hubFilter.selectedOptions).map(o=>o.value),
      toggles: {
        heat: tgHeat.checked, rings: tgRings.checked, overlap: tgOverlap.checked, compare: tgCompare.checked, within: tgWithin.checked, cluster: tgCluster.checked
      },
      radius: Number(radius.value)||DEFAULT_RADIUS
    };
  }
  function applySnapshot(s){
    if (!s) return;
    radius.value = s.radius||DEFAULT_RADIUS; radiusLbl.textContent=radius.value;
    setMulti(covFilter, s.cov); setMulti(rmFilter, s.rm); setMulti(amFilter, s.am); setMulti(hubFilter, s.hub);
    tgHeat.checked=s.toggles.heat; tgRings.checked=s.toggles.rings; tgOverlap.checked=s.toggles.overlap; tgCompare.checked=s.toggles.compare; tgWithin.checked=s.toggles.within; tgCluster.checked=s.toggles.cluster;
    compareMode = tgCompare.checked;
    map.setView(s.center, s.zoom);
  }
  function setMulti(sel, arr){ if (!arr?.length) return; Array.from(sel.options).forEach(o=>o.selected = arr.includes(o.value)); }
  function rebuildViewsMenu(){
    const list = id('viewList');
    const views = JSON.parse(localStorage.getItem(LS_VIEWS)||'[]');
    if (!views.length){ list.innerHTML = `<div class="muted">No saved views</div>`; return; }
    list.innerHTML = views.map((v,i)=>`
      <div class="view-row">
        <div><b>${escape(v.name)}</b><div class="muted" style="font-size:11px">${new Date(v.when).toLocaleString()}</div></div>
        <div class="view-actions">
          <button class="btn" data-i="${i}" data-act="load">Load</button>
          <button class="btn" data-i="${i}" data-act="del">Delete</button>
        </div>
      </div>`).join('');
    list.querySelectorAll('button').forEach(b=>{
      b.onclick = ()=>{
        const i = Number(b.dataset.i); const act = b.dataset.act;
        const views = JSON.parse(localStorage.getItem(LS_VIEWS)||'[]');
        if (act==='load'){ applySnapshot(views[i]?.st); runFilter(); renderChips(); updateRings(); if(tgOverlap.checked) drawOverlap(); }
        if (act==='del'){ views.splice(i,1); localStorage.setItem(LS_VIEWS, JSON.stringify(views)); rebuildViewsMenu(); }
      };
    });
  }

  function saveState(){ localStorage.setItem(LS_STATE, JSON.stringify(snapshotState())); }
  function tryLoadLocal(){
    const raw = localStorage.getItem(LS_STATE); if (!raw) return false;
    try { applySnapshot(JSON.parse(raw)); return true; } catch { return false; }
  }
  function tryLoadSnapshot(){
    if (!location.hash?.length) return false;
    try{
      const st = JSON.parse(decodeURIComponent(escape(atob(location.hash.slice(1)))));
      applySnapshot(st); // also may include openHubId/pinnedHubIds
      PENDING_OPEN_HUB_ID = st.openHubId || null;
      PENDING_PIN_IDS = st.pinnedHubIds || [];
      return true;
    }catch{ return false; }
  }

  // ---------- Heatmap ----------
  function updateHeat(){
    const pts = filteredStores.map(s=>[s.lat, s.lng, Number(heatIntensity.value||6)/10]);
    clearHeat();
    heatLayerHolder.layer = L.heatLayer(pts, { radius: Number(heatRadius.value||25), blur: 15, maxZoom:17 }).addTo(map);
  }
  function clearHeat(){ if (heatLayerHolder.layer){ map.removeLayer(heatLayerHolder.layer); heatLayerHolder.layer=null; } }

  // ---------- Roll-Up & Gap Finder (basic versions) ----------
  id('rollupBtn').onclick = ()=>{
    const byRM = new Map();
    filteredStores.forEach(s=>{
      const k = s.regionalManager||'(none)';
      const v = byRM.get(k) || { total:0, pa:0, p:0, a:0, u:0 };
      v.total++; if(s.coverageType==='Premium + Acosta') v.pa++; else if(s.coverageType==='Premium Only') v.p++; else if(s.coverageType==='Acosta Only') v.a++; else v.u++;
      byRM.set(k,v);
    });
    const rows = Array.from(byRM.entries()).map(([rm,v])=>({ RM:rm, Total:v.total, 'P+A':v.pa, Premium:v.p, Acosta:v.a, Uncovered:v.u }));
    downloadText(`rollup_${Date.now()}.csv`, toCSV(rows));
    toast('Exported roll-up by RM.');
  };

  id('gapBtn').onclick = ()=>{
    if (!visibleHubs().length){ alert('Toggle on some hubs first.'); return; }
    const rMi = Number(radius.value)||DEFAULT_RADIUS;
    const g = filteredStores.filter(s=>{
      const covered = visibleHubs().some(h => distMiles(s.lat,s.lng,h.coords[0],h.coords[1])<=rMi);
      return !covered;
    });
    if (!g.length){ toast('No uncovered stores within visible radii.'); return; }
    const csv = toCSV(g.map(s=>({Store:s.storeNumberStr, City:s.city, State:s.state, Address:s.address, Coverage:s.coverageType})));
    downloadText(`gaps_${Date.now()}.csv`, csv);
    toast(`Exported ${g.length} uncovered stores.`);
  };

  // ---------- Help modal ----------
  id('helpBtn').onclick = ()=> id('helpModal').classList.add('show');
  id('helpClose').onclick = ()=> id('helpModal').classList.remove('show');

  // ---------- Utils ----------
  function circleFeature(lat,lng,mi,props){
    // approximate circle with 64 points
    const R = 6371000; const m = mi*1609.344; const d= m/R;
    const pts = [];
    for (let i=0;i<64;i++){
      const brg = i*(360/64)*Math.PI/180;
      const lat2 = Math.asin(Math.sin(lat*Math.PI/180)*Math.cos(d)+Math.cos(lat*Math.PI/180)*Math.sin(d)*Math.cos(brg))*180/Math.PI;
      const lng2 = (lng*Math.PI/180 + Math.atan2(Math.sin(brg)*Math.sin(d)*Math.cos(lat*Math.PI/180), Math.cos(d)-Math.sin(lat*Math.PI/180)*Math.sin(lat2*Math.PI/180)))*180/Math.PI;
      pts.push([lng2, lat2]);
    }
    pts.push(pts[0]);
    return { type:'Feature', properties:props||{}, geometry:{ type:'Polygon', coordinates:[pts] } };
  }

  function geojsonToKml(fc){
    // minimal KML: points + polygons
    const esc = s=>String(s??'').replace(/[<&>]/g,m=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[m]));
    const placemarks = fc.features.map(f=>{
      if (f.geometry.type==='Point'){
        const [lng,lat] = f.geometry.coordinates;
        const name = esc(f.properties?.name||f.properties?.store||'Point');
        const desc = esc(JSON.stringify(f.properties));
        return `<Placemark><name>${name}</name><description>${desc}</description><Point><coordinates>${lng},${lat},0</coordinates></Point></Placemark>`;
      }
      if (f.geometry.type==='Polygon'){
        const coords = f.geometry.coordinates[0].map(([lng,lat])=>`${lng},${lat},0`).join(' ');
        const name = esc(f.properties?.name||'Ring');
        const desc = esc(JSON.stringify(f.properties));
        return `<Placemark><name>${name}</name><description>${desc}</description><Polygon><outerBoundaryIs><LinearRing><coordinates>${coords}</coordinates></LinearRing></outerBoundaryIs></Polygon></Placemark>`;
      }
      return '';
    }).join('');
    return `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2"><Document>${placemarks}</Document></kml>`;
  }

  function updateDatasetBadge(...parts){
    const b = id('datasetBadge');
    const revs = JSON.parse(localStorage.getItem(REV_KEY)||'[]');
    const fp = parts.join(' | ');
    revs.push({ when: Date.now(), fp });
    localStorage.setItem(REV_KEY, JSON.stringify(revs.slice(-8)));
    b.textContent = `Datasets • ${fp}`;
  }

  function filterSelect(sel, q){
    const s = q.trim().toLowerCase();
    Array.from(sel.options).forEach(o=>{
      if (o.value==='All') return;
      const hit = o.textContent.toLowerCase().includes(s);
      o.hidden = s && !hit;
    });
  }
  function normalizeAll(sel){
    // If any non-All are selected, turn off All
    const any = Array.from(sel.selectedOptions).some(o=>o.value!=='All');
    if (any){ Array.from(sel.options).forEach(o=>{ if (o.value==='All') o.selected=false; }); }
    else { Array.from(sel.options).forEach(o=>{ if (o.value==='All') o.selected=true; }); }
  }

  function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function id(x){ return document.getElementById(x); }
  function on(ev, el, fn){ el && el.addEventListener(ev, fn); }
  function distMiles(lat1,lon1,lat2,lon2){
    const R=3958.761; const dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }
  function slug(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
  function escape(s){ return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function toCSV(rows){
    if (!rows.length) return '';
    const keys = Object.keys(rows[0]);
    const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
    return [keys.join(','), ...rows.map(r=>keys.map(k=>esc(r[k])).join(','))].join('\n');
  }
  function downloadText(name, text){
    const blob = new Blob([text], {type:'text/plain'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
  }
  function toggleDropdown(menu){ menu.style.display = (menu.style.display==='block') ? 'none' : 'block'; }

  function showBusy(v){ busy.hidden = !v; }

  // ---------- Final initial fit ----------
  fitToResults();

})(); // IIFE
</script>
</body>
</html>
