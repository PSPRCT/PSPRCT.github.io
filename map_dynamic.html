<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Premium Retail Trainer Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  :root{
    --blue:#2f71ff; --violet:#6a1b9a; --gray:#f6f7fb; --ink:#1f2937; --muted:#6b7280;
    --border:#e5e7eb; --bg:#ffffff;
  }
  html, body { height:100%; margin:0; }
  body { display:flex; flex-direction:column; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); background:var(--gray); }
  #topbar{
    background:var(--bg); border-bottom:1px solid var(--border);
    padding:10px 12px; display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center;
    position:sticky; top:0; z-index:500;
  }
  #brand { font-weight:600; color:var(--violet); letter-spacing:.2px; }
  #searchWrap{
    grid-column:1 / -1; display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  }
  .text { height:38px; padding:0 12px; border:1px solid var(--border); border-radius:10px; outline:none; width:320px; max-width:70vw; }
  .btn {
    height:38px; padding:0 14px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer;
  }
  .btn.primary{ background:var(--blue); color:#fff; border-color:transparent; }
  .btn.ghost{ background:#fff; color:#111; }
  #map { flex:1; }
  .pillbar { display:flex; gap:6px; flex-wrap:wrap; }
  .pill { background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; padding:6px 10px; border-radius:999px; font-size:12px; }
  .leaflet-popup-content { margin: 8px 12px; }
</style>
</head>
<body>

  <div id="topbar">
    <div id="brand">Premium Retail Trainer Map</div>

    <div id="searchWrap">
      <!-- Live search with Store marker -->
      <input id="searchBox" class="text" type="text" list="searchOptions" placeholder="Search store #, city, or 'City, ST'…" autocomplete="off" />
      <datalist id="searchOptions"></datalist>
      <button id="searchGo" class="btn ghost" title="Not required">Go</button>
      <button id="searchClear" class="btn" title="Clear search (Esc also clears)">Clear</button>

      <div id="pillBar" class="pillbar" aria-label="Active filters"></div>
    </div>
  </div>

  <div id="map"></div>

  <!-- Leaflet libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
  /***********************
   * DATA HOOK
   * Expects window.STORES = [
   *   { storeNumber: 1234, name: "Walmart Supercenter", city: "Murfreesboro", state:"TN", lat: 35.85, lng: -86.39 },
   *   ...
   * ]
   * If you already load stores elsewhere, keep doing that. This file will detect it.
   ************************/
  const STORES = Array.isArray(window.STORES) ? window.STORES : [];

  /***********************
   * MAP INIT
   ************************/
  const map = L.map('map', {
    minZoom: 3,
    maxZoom: 19,
    worldCopyJump: true
  }).setView([38.5, -96.0], 5);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'&copy; OpenStreetMap'
  }).addTo(map);

  // Store markers (clustered)
  const storeCluster = L.markerClusterGroup({ disableClusteringAtZoom: 12, maxClusterRadius: 60 });

  // Make standard store marker
  function makeStoreMarker(s){
    const m = L.marker([s.lat, s.lng], {
      title: `Store ${s.storeNumber} — ${s.city}, ${s.state}`
    });
    const label = `
      <div style="font-weight:700; margin-bottom:4px;">Store ${escapeHtml(String(s.storeNumber))}</div>
      <div>${escapeHtml(s.name || 'Walmart')}</div>
      <div style="color:#6b7280">${escapeHtml(s.city || '')}, ${escapeHtml(s.state || '')}</div>
    `;
    m.bindPopup(label);
    return m;
  }

  // Render any provided stores
  if (STORES.length){
    for (const s of STORES){
      if (isFinite(s.lat) && isFinite(s.lng)) storeCluster.addLayer(makeStoreMarker(s));
    }
    map.addLayer(storeCluster);
  }

  /***********************
   * TARGET PIN (single blue dot for search)
   ************************/
  const targetLayer = L.layerGroup().addTo(map);
  let targetPin = null;
  const targetIcon = L.divIcon({
    className: '',
    html: '<div style="background:#2f71ff;border:2px solid #fff;border-radius:50%;width:18px;height:18px;box-shadow:0 0 0 1px rgba(0,0,0,.25)"></div>',
    iconSize: [18, 18],
    iconAnchor: [9, 9]
  });

  function dropTarget(lat, lng, labelHtml){
    if (targetPin) targetLayer.removeLayer(targetPin);
    targetPin = L.marker([lat, lng], { icon: targetIcon }).addTo(targetLayer);
    targetPin.bindPopup(labelHtml);
    targetPin.openPopup();
  }
  function clearTarget(){
    if (targetPin){ targetLayer.removeLayer(targetPin); targetPin = null; }
  }

  /***********************
   * SEARCH (live — no Enter required)
   ************************/
  const searchBox  = document.getElementById('searchBox');
  const searchGo   = document.getElementById('searchGo');
  const searchClr  = document.getElementById('searchClear');
  const dataList   = document.getElementById('searchOptions');
  const pillBar    = document.getElementById('pillBar');

  // Build datalist options (stores)
  function rebuildDatalist(){
    if (!STORES.length) return;
    const top = STORES.slice(0, 2000); // cap to keep list snappy
    const opts = [];
    for (const s of top){
      const label = `Store ${s.storeNumber} — ${s.city}, ${s.state}`;
      const opt = document.createElement('option');
      opt.value = label;
      opts.push(opt);
    }
    dataList.replaceChildren(...opts);
  }
  rebuildDatalist();

  // Utility: escape
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Small index for store number → store
  const storeByNum = (() => {
    const idx = new Map();
    for (const s of STORES){
      const n = String(s.storeNumber || '').trim();
      if (n) idx.set(n, s);
    }
    return idx;
  })();

  // Core resolver: returns {lat,lng,labelHtml} or null
  function guessTargetFor(q){
    if (!q) return null;
    const raw = q.trim();
    const txt = raw.toLowerCase();

    // Pattern 1: "store 1234" or just "1234" if exactly matches known store
    const m = txt.match(/store\s*#?\s*(\d+)/) || txt.match(/^\s*(\d{3,6})\s*$/);
    if (m){
      const num = m[1];
      const s = storeByNum.get(num);
      if (s && isFinite(s.lat) && isFinite(s.lng)){
        return {
          lat: s.lat, lng: s.lng,
          labelHtml: `
            <div style="font-weight:700;margin-bottom:4px;">Store ${escapeHtml(String(s.storeNumber))}</div>
            <div>${escapeHtml(s.name || 'Walmart')}</div>
            <div style="color:#6b7280">${escapeHtml(s.city || '')}, ${escapeHtml(s.state || '')}</div>
          `
        };
      }
    }

    // Pattern 2: "City, ST"
    const cityState = raw.match(/^\s*([^,]+)\s*,\s*([A-Za-z]{2})\s*$/);
    if (cityState){
      const city = cityState[1].toLowerCase();
      const st   = cityState[2].toUpperCase();
      // find first store in that city/state (or compute centroid)
      const matches = STORES.filter(s => (s.city||'').toLowerCase()===city && (s.state||'').toUpperCase()===st && isFinite(s.lat) && isFinite(s.lng));
      if (matches.length){
        // center on average
        const {lat, lng} = centroid(matches);
        return {
          lat, lng,
          labelHtml: `<div style="font-weight:700;">${escapeHtml(cityState[1])}, ${escapeHtml(st)}</div><div style="color:#6b7280">${matches.length} store(s)</div>`
        };
      }
    }

    // Pattern 3: bare city OR partial match on city/state/name
    if (txt.length >= 2){
      const matches = STORES.filter(s => {
        const blob = `${s.city||''}, ${s.state||''} ${s.name||''} store ${s.storeNumber||''}`.toLowerCase();
        return blob.includes(txt) && isFinite(s.lat) && isFinite(s.lng);
      }).slice(0, 200);
      if (matches.length){
        const {lat, lng} = centroid(matches);
        const first = matches[0];
        return {
          lat, lng,
          labelHtml: `<div style="font-weight:700;">${escapeHtml(raw)}</div><div style="color:#6b7280">${matches.length} matching store(s). Nearest: Store ${escapeHtml(String(first.storeNumber))} — ${escapeHtml(first.city)}, ${escapeHtml(first.state)}</div>`
        };
      }
    }

    return null;
  }

  function centroid(points){
    let lat=0, lng=0, n=0;
    for (const p of points){ if (isFinite(p.lat) && isFinite(p.lng)){ lat+=p.lat; lng+=p.lng; n++; } }
    if (!n) return {lat: 38.5, lng:-96.0};
    return {lat: lat/n, lng: lng/n};
  }

  // Live search handlers
  function handleLiveSearch(){
    const q = (searchBox.value || '').trim();
    if (!q){ clearTarget(); renderPills([]); return; }
    const found = guessTargetFor(q);
    if (found){
      map.setView([found.lat, found.lng], Math.max(map.getZoom(), 11));
      dropTarget(found.lat, found.lng, found.labelHtml);
      renderPills([q]); // show what we’re focused on
    }
  }

  function renderPills(items){
    pillBar.replaceChildren(...(items||[]).map(txt => {
      const el = document.createElement('div');
      el.className = 'pill';
      el.textContent = txt;
      return el;
    }));
  }

  // Wire events – no Enter needed
  searchBox.addEventListener('input', handleLiveSearch);
  searchBox.addEventListener('change', handleLiveSearch); // picks from datalist
  searchBox.addEventListener('keydown', (e) => {
    if (e.key === 'Escape'){
      searchBox.value = '';
      clearTarget();
      renderPills([]);
    }
  });
  searchGo.addEventListener('click', handleLiveSearch); // optional
  searchClr.addEventListener('click', () => {
    searchBox.value = '';
    clearTarget();
    renderPills([]);
    searchBox.focus();
  });

  // Focus on load for quick typing
  window.addEventListener('load', () => { searchBox.focus({ preventScroll:true }); });

  </script>

  <!--
    If you inject store data separately, keep doing that (window.STORES = [...] before this script).
    Example (remove this block in production):

    <script>
      window.STORES = [
        { storeNumber: 1027, name: "Walmart Supercenter", city:"Murfreesboro", state:"TN", lat:35.845, lng:-86.390 },
        { storeNumber: 2115, name: "Walmart Supercenter", city:"Birmingham", state:"AL", lat:33.520, lng:-86.803 }
      ];
    </script>
  -->
</body>
</html>
