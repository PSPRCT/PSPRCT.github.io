<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Premium Retail Trainer Map (All-in-one)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  :root{
    --blue:#2f71ff; --violet:#6a1b9a; --gray:#9ea3a8; --ring:#d0d7de;
    --pa:#6c5ce7; --p:#2ecc71; --a:#f39c12; --u:#e74c3c;
    --bg:#fff; --fg:#111; --muted:#6b7280; --border:#e5e7eb; --panel:#fff;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  body{display:flex;flex-direction:column;min-width:320px}

  .topbar{position:sticky; top:0; background:var(--panel); display:flex;flex-wrap:wrap;gap:10px;align-items:center; padding:8px 10px;border-bottom:1px solid #eef0f3;z-index:10; box-shadow:0 4px 14px rgba(0,0,0,.04)}
  .search-wrap{display:flex;gap:8px;align-items:center;min-width:280px;flex:1}
  .searchbox{position:relative;flex:1}
  .searchbox input{width:100%;border:1px solid #d0d7de;border-radius:10px;padding:10px 12px 10px 64px;font-size:14px;background:var(--bg);color:var(--fg)}
  .badge-left{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:12px;font-weight:800;letter-spacing:.3px;background:#eef6ff;color:#0b5bd3;border:1px solid #cfe6ff;border-radius:999px;padding:3px 8px;display:none}
  .badge-left.show{display:inline-block}
  .results{position:absolute;left:0;right:0;top:calc(100% + 6px);background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.18);display:none;z-index:20;max-height:360px;overflow:auto}
  .results.show{display:block}
  .res{display:flex;gap:10px;padding:10px;cursor:pointer;align-items:flex-start}
  .res:hover{background:#f6f8fa}
  #searchResults .res.active{ background:#e7f0ff }
  .res .kind{flex:0 0 auto;font-size:11px;font-weight:800;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:#374151;background:var(--panel)}
  .res .text .sub{color:var(--muted);font-size:12px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .btn{border:1px solid #d0d7de;background:var(--panel);border-radius:10px;padding:8px 10px;font-weight:600;cursor:pointer;color:var(--fg); box-shadow:0 2px 8px rgba(0,0,0,.04)}
  .btn.link{border-color:transparent;text-decoration:underline}
  .toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:var(--panel);white-space:nowrap}
  .toggle input{width:16px;height:16px;accent-color:var(--blue)}
  .range{display:flex;align-items:center;gap:8px;white-space:nowrap}
  .range small{color:var(--muted)}

  .pillbar{display:none}

  .filters{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:10px;padding:8px 10px;border-top:1px solid #eef0f3;border-bottom:1px solid #eef0f3;background:var(--panel); border-radius:12px; margin:6px 10px; box-shadow:0 6px 20px rgba(0,0,0,.06)}
  .picker{display:flex;flex-direction:column;gap:6px}
  .picker input{padding:6px 8px;font-size:13px;border:1px solid #d0d7de;border-radius:8px;background:var(--bg);color:var(--fg)}
  select[multiple]{height:110px;border:1px solid #d0d7de;border-radius:8px;padding:6px 8px;background:var(--bg);color:var(--fg)}

  .summary{display:flex;gap:10px;align-items:center;padding:6px 10px;border-bottom:1px solid #eef0f3;background:var(--panel)}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:var(--panel);}
  .dot{width:10px;height:10px;border-radius:50%}
  .muted{color:var(--muted);margin-left:auto}

  .mapwrap{position:relative;flex:1;min-height:460px;display:flex;overflow:hidden}
  #map{flex:1}
  /* ensure the map always has room even if flex calc goes weird */
#map { min-height: 480px; }


  .sidepanel{width:380px;max-width:90vw;flex:0 0 380px;background:var(--panel);border-left:1px solid var(--border);box-shadow:-4px 0 18px rgba(0,0,0,.12);display:none;flex-direction:column;z-index:6}
  .sidepanel.show{display:flex}
  .sp-head{padding:10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
  .sp-head h3{margin:0;font-size:16px;line-height:1.2;flex:1}
  .sp-body{padding:10px;display:flex;flex-direction:column;gap:10px;height:calc(100vh - 220px);overflow:hidden}
  .sp-actions{display:flex;gap:8px;flex-wrap:wrap}
  .sp-counts{display:flex;gap:8px;flex-wrap:wrap}
  .sp-chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:3px 8px}
  .sp-quick{display:flex;gap:6px;flex-wrap:wrap}
  .sp-list{flex:1;min-height:160px;border:1px solid var(--border);border-radius:8px;padding:0;display:flex;flex-direction:column;overflow:auto; box-shadow: inset 0 0 0 2px rgba(0,0,0,.02)}
  .sp-list input{margin:8px;border:1px solid var(--border);border-radius:8px;padding:6px 8px}
  .sp-list input{position: sticky; top: 0; z-index: 3; background: var(--panel); border-bottom-left-radius: 0; border-bottom-right-radius: 0; box-shadow: 0 4px 6px rgba(0,0,0,.04);}
  .sp-rows{position:static;height:auto}
  .row{position:relative;display:flex;gap:8px;align-items:flex-start;padding:10px;border-bottom:1px solid var(--border);background:var(--panel);cursor:pointer;min-height:56px}
  .row .title{font-weight:800;line-height:1.25}
  .row .addr{color:var(--muted);font-size:12px;line-height:1.25}
  .row .num{min-width:62px;font-variant-numeric:tabular-nums;color:var(--muted)}
  .row.active{background:#e7f0ff}

  .floating{position:absolute;left:10px;top:10px;z-index:402;display:flex;gap:8px;flex-wrap:wrap}
  .floating .btn,.floating .toggle{padding:6px 8px;font-size:12px}

  .legend{position:absolute;top:10px;right:10px;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:8px 10px;box-shadow:0 6px 18px rgba(0,0,0,.12);z-index:401}

  .sandbox{position:absolute;left:10px;bottom:10px;z-index:402;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:none;min-width:260px;box-shadow:0 10px 24px rgba(0,0,0,.12)}
  .sandbox.show{display:block}

  .dropdown-menu{position:absolute;right:0;top:calc(100% + 4px);background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:6px;z-index:5;max-height:70vh;overflow:auto;box-sizing:border-box;display:none;min-width:240px}

  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 12px;border-radius:10px;display:none;z-index:5001;max-width:92vw}
  .toast.show{display:flex;gap:10px;align-items:center}
  .toast .btn{background:#fff;color:#111;border-color:#fff}

  .busy{position:fixed;inset:0;background:rgba(255,255,255,.5);display:flex;align-items:center;justify-content:center;z-index:9999}
  .busy[hidden]{display:none}
  .spin{width:36px;height:36px;border-radius:50%;border:4px solid rgba(0,0,0,.15);border-top-color:var(--blue);animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  .marker-cluster.marker-pa div{background:var(--pa);border:2px solid #fff}
  .marker-cluster.marker-p  div{background:var(--p); border:2px solid #fff}
  .marker-cluster.marker-a  div{background:var(--a); border:2px solid #fff}

  .hub{width:20px;height:20px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.25)}
  .hub.confirmed{background:var(--violet)}
  .hub.pending{background:#9ea3a8}
  .hub.acosta{ background: var(--a); }
  .hl{width:22px;height:22px;border-radius:50%;border:2px solid #111;background:rgba(0,0,0,.05);box-shadow:0 0 0 1px rgba(0,0,0,.25)}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:5000}
  .modal.show{display:flex}
  .card{background:#fff;border-radius:12px;max-width:980px;width:92vw;box-shadow:0 20px 50px rgba(0,0,0,.25);border:1px solid var(--border)}
  .card header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
  .card header h3{margin:0;font-size:18px;flex:1}
  .card .body{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .kbd{display:inline-block;border:1px solid #cfd3d7;border-bottom-width:3px;border-radius:6px;padding:2px 6px;font-weight:700;background:#fff}
  .body .section{border:1px dashed #e5e7eb;border-radius:8px;padding:10px}

  .view-row{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:4px 0}
  .view-thumb{flex:0 0 auto;border:1px solid var(--border);border-radius:6px;width:96px;height:64px;background:#f9fafb}
  .view-actions{display:flex;gap:6px;align-items:center}

  .empty-state{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:401;pointer-events:none}
  .empty-card{pointer-events:auto;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.12);padding:14px 16px;max-width:520px}
  .empty-card h4{margin:0 0 6px 0}
  .empty-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .empty-state[hidden]{display:none !important;}

  .compare-panel{position:absolute;left:10px;bottom:120px;z-index:402;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:none;min-width:280px;box-shadow:0 10px 24px rgba(0,0,0,.12)}
  .compare-panel.show{display:block}
  .compare-grid{display:grid;grid-template-columns:1fr auto;gap:6px;align-items:baseline}

  @media (max-width:720px){ .card .body{grid-template-columns:1fr;} }
  @media (max-width: 1100px){ .filters{grid-template-columns:repeat(2,minmax(220px,1fr));} }
  @media (max-width: 640px){ .filters{grid-template-columns:1fr;} }
</style>
</head>
<body>

<div class="topbar">
  <div class="search-wrap" title="Type a store #, city/state, or hub name. Tip: type ‘near’ for nearby stores.">
    <div class="searchbox">
      <span id="searchBadge" class="badge-left">SEARCH</span>
      <input id="searchBox" type="text" placeholder="Type a store #, city/state, hub name… (tip: 'near Dallas')" autocomplete="off" aria-label="Search store or city" />
      <div id="searchResults" class="results" role="listbox"></div>
    </div>
    <button id="searchClear" class="btn" type="button" title="Clear search">Clear</button>
  </div>

  <label class="toggle" title="Show Premium confirmed hubs"><input id="showConfirmed" type="checkbox" checked />Premium (confirmed)</label>
  <label class="toggle" title="Show Premium pending offers/proposed hubs"><input id="showPending" type="checkbox" checked />Premium (pending)</label>
  <label class="toggle" title="Show Acosta trainers"><input id="showAcosta" type="checkbox" />Acosta</label>

  <div class="range" title="Hub radius used for coverage, lists, rings, overlap">
    <span>Radius</span>
    <input id="radius" type="range" min="25" max="150" step="5" value="75" />
    <b id="radiusLbl">75</b><small>mi</small>
  </div>

  <button id="fitBtn" class="btn" type="button" title="Fit map to filtered stores">Fit to Results</button>
  <button id="homeBtn" class="btn" type="button" title="Reset to starting view (keeps filters)">Home</button>
  <button id="resetBtn" class="btn" type="button" title="Reset all filters and view">Reset</button>

  <!-- Export -->
  <div class="dropdown" id="exportDrop" style="position:relative">
    <button class="btn" type="button" title="Download CSV of filtered stores or panel list">Export ▾</button>
    <div class="dropdown-menu">
      <button id="exportStores" class="btn" type="button" style="display:block;width:100%;margin:4px 0" title="Export all filtered stores on the map">
        Export filtered stores (CSV)
      </button>
      <label class="toggle" style="margin:6px 4px;display:flex"><input id="autoReset" type="checkbox" />Auto-reset after export/print</label>
    </div>
  </div>

  <!-- Saved Views -->
  <div class="dropdown" id="viewsDrop" style="position:relative">
    <button class="btn" type="button" title="Save or recall views">Views ▾</button>
    <div class="dropdown-menu" id="viewsMenu">
      <button id="viewSave" class="btn" type="button" style="display:block;width:100%">Save current view…</button>
      <div style="border-top:1px solid var(--border);margin:6px 0"></div>
      <div id="viewList" style="min-width:220px"></div>
    </div>
  </div>

  <!-- Source chooser -->
  <div class="dropdown" id="sourceDrop" style="position:relative">
    <button class="btn" type="button" title="Select data source">Source ▾</button>
    <div class="dropdown-menu" id="sourceMenu">
      <div style="padding:6px 8px;font-weight:700">Data source</div>
      <button class="btn" id="srcLocal"  type="button" style="display:block;width:100%">Local JSON (default)</button>
      <button class="btn" id="srcURL"    type="button" style="display:block;width:100%">External Sheet / CSV / JSON…</button>
      <div style="border-top:1px solid var(--border);margin:6px 0"></div>
      <button class="btn link" id="srcClear" type="button" style="display:block;width:100%">Use default & clear saved source</button>
    </div>
  </div>

  <!-- Analysis buttons -->
  <button id="gapBtn" class="btn" type="button" title="Find cities with uncovered clusters">Gap finder</button>
  <button id="rollupBtn" class="btn" type="button" title="Totals by RM/AM">Rollups</button>

  <button id="helpBtn" class="btn" type="button" title="Quick tips and changelog">Help</button>
</div>

<div class="filters" title="Use these to narrow stores; search also matches store # and city/state.">
  <div class="picker">
    <input id="covSearch" type="text" placeholder="Search coverage…" />
    <select id="covFilter" multiple>
      <option value="All" selected>All</option>
      <option>Premium + Acosta</option>
      <option>Premium Only</option>
      <option>Acosta Only</option>
      <option>Uncovered</option>
    </select>
  </div>
  <div class="picker">
    <input id="rmSearch" type="text" placeholder="Filter regional managers…" />
    <select id="rmFilter" multiple><option value="All" selected>All</option></select>
  </div>
  <div class="picker">
    <input id="amSearch" type="text" placeholder="Filter area managers…" />
    <select id="amFilter" multiple><option value="All" selected>All</option></select>
  </div>
  <div class="picker">
    <input id="hubSearch" type="text" placeholder="Filter hubs…" />
    <select id="hubFilter" multiple>
      <option value="All" selected>All</option>
    </select>
  </div>
</div>

<div id="dataStatus" style="padding:6px 10px;color:var(--fg);font-size:12px"></div>

<div class="summary" id="summary">
  <span class="chip"><span class="dot" style="background:var(--pa)"></span>P+A: <b id="k_pa">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--p)"></span>Premium: <b id="k_p">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--a)"></span>Acosta: <b id="k_a">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--u)"></span>Uncov: <b id="k_u">0</b></span>
  <span class="chip">Total: <b id="k_total">0</b></span>
  <span class="chip">
    Hubs —
    <b id="k_confirmed">0</b> confirmed /
    <b id="k_offer">0</b> offer /
    <b id="k_proposed">0</b> proposed
  </span>
  <span class="chip" id="acostaChip" hidden>Acosta hubs: <b id="k_acosta_hubs">0</b></span>
  <span class="muted" id="inView">In view: 0</span>
</div>
<div class="summary" id="datasetBadge"></div>

<div class="mapwrap">
  <div id="map" role="region" aria-label="Coverage Map"></div>

  <div class="floating">
    <label class="toggle" title="Density of stores"><input id="tgHeat" type="checkbox" />Heatmap</label>
    <label class="toggle" title="Show hub radius circles"><input id="tgRings" type="checkbox" />Hub radii</label>
    <label class="toggle" title="Highlight stores covered by 2+ hubs"><input id="tgOverlap" type="checkbox" />Overlap</label>
    <label class="toggle" title="Pin hubs to compare coverage"><input id="tgCompare" type="checkbox" />Compare</label>
    <label class="toggle" title="Filter: only stores inside any visible hub radius"><input id="tgWithin" type="checkbox" />Within hubs</label>
    <label class="toggle" title="Turn clustering on/off (useful when zoomed in)"><input id="tgCluster" type="checkbox" checked />Cluster</label>
    <button id="sandboxBtn" class="btn" type="button" title="Test a new hub location">New-hub sandbox</button>
  </div>

  <!-- Compare/Venn panel -->
  <div id="comparePanel" class="compare-panel">
    <div style="font-weight:800;margin-bottom:6px">Compare (2 pins)</div>
    <div id="compareBody" style="font-size:13px"></div>
    <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
      <button id="cmpExport" class="btn" type="button">Export CSV</button>
      <button id="cmpClear" class="btn" type="button">Clear pins</button>
    </div>
  </div>

  <div class="sidepanel" id="sidepanel">
    <div class="sp-head">
      <h3 id="spTitle">Hub</h3>
      <button id="spCollapse" class="btn" type="button" title="Collapse panel">⟨</button>
      <button id="spPinBtn" class="btn" type="button" title="Pin for compare">Pin</button>
      <button id="spLink" class="btn" type="button" title="Copy link to this hub">Link</button>
      <button id="spClose" class="btn" type="button" title="Close panel">Close</button>
    </div>
    <div class="sp-body">
      <div id="spMeta" class="sp-meta" style="font-size:13px"></div>
      <div class="sp-actions">
        <button id="spExport" class="btn" type="button" title="Download CSV of this list">Export list (CSV)</button>
        <button id="spPrint" class="btn" type="button" title="Print this list">Print store list</button>
      </div>
      <div class="sp-quick" title="Change hub radius quickly">
        Radius:
        <button class="btn" type="button" data-r="50">50</button>
        <button class="btn" type="button" data-r="75">75</button>
        <button class="btn" type="button" data-r="100">100</button><small> mi</small>
      </div>
      <div id="spCounts" class="sp-counts"></div>
      <div class="sp-list" id="spListWrap">
        <input id="spSearch" type="text" placeholder="Search stores in list…" />
        <div id="spRows" class="sp-rows"></div>
      </div>
    </div>
  </div>

  <!-- Sandbox panel -->
  <div id="sandboxPanel" class="sandbox">
    <div style="font-weight:800;margin-bottom:6px">Sandbox hub</div>
    <div id="sbMeta" style="font-size:12px;color:var(--muted);margin-bottom:6px">Click “New-hub sandbox”, then drag the pin.</div>
    <div id="sbNear" style="font-size:13px;"></div>
    <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
      <button id="sbSaveCsv" class="btn" type="button">Save as CSV row</button>
      <button id="sbSaveJson" class="btn" type="button">Save as JSON</button>
      <button id="sbClose" class="btn" type="button">Close</button>
    </div>
  </div>

  <!-- Empty state overlay -->
  <div id="emptyState" class="empty-state" hidden>
    <div class="empty-card">
      <h4>No stores match your filters</h4>
      <div class="muted">Try widening your radius, turning off “Within hubs”, or clearing a filter.</div>
      <div class="empty-actions">
        <button id="clearLastFilter" class="btn" type="button">Clear last filter</button>
        <button id="emptyReset" class="btn" type="button">Reset all</button>
      </div>
    </div>
  </div>
</div>

<!-- Help modal -->
<div class="modal" id="helpModal" aria-modal="true" role="dialog">
  <div class="card">
    <header>
      <h3>Help, Tips & Changelog</h3>
      <button id="helpClose" class="btn" type="button">Close</button>
    </header>
    <div class="body">
      <div class="section">
        <h4>Keyboard</h4>
        <p><span class="kbd">Ctrl</span> / <span class="kbd">⌘</span> + <span class="kbd">K</span> — Focus search</p>
        <p><span class="kbd">↑</span> <span class="kbd">↓</span> + <span class="kbd">Enter</span> — Pick search result</p>
        <p><span class="kbd">H</span> — Home (map only)</p>
        <p><span class="kbd">F</span> — Focus side-panel search (when open)</p>
      </div>
      <div class="section">
        <h4>Tips</h4>
        <ul>
          <li>Type <b>near</b> or <b>near Dallas</b> to jump the map and suggest nearby stores.</li>
          <li>Use <b>Within hubs</b> to see only stores covered by visible hubs.</li>
          <li>Pin hubs to compare coverage; <b>Overlap</b> highlights shared stores.</li>
          <li>Side panel shows counts & metrics; click a store to zoom to it.</li>
          <li>Use <b>Views</b> to save/restore your favorite setups.</li>
        </ul>
      </div>
      <div class="section">
        <h4>Changelog (local)</h4>
        <div id="changelog" style="max-height:45vh;overflow:auto;font-family:ui-monospace,Consolas,monospace;font-size:12px;background:#fafbfc;padding:8px;border-radius:8px;border:1px solid var(--border)"></div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <button class="btn" id="chgClear">Clear history</button>
          <button class="btn" id="chgExport">Export</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Gap Finder modal -->
<div class="modal" id="gapModal" aria-modal="true" role="dialog">
  <div class="card">
    <header>
      <h3>Gap finder</h3>
      <button id="gapClose" class="btn" type="button">Close</button>
    </header>
    <div class="body" style="grid-template-columns:1fr;">
      <div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;align-items:center">
          <label class="toggle" title="Only show clusters at least this big">Min uncovered
            <input id="gapMin" type="number" value="10" style="width:80px;margin-left:8px">
          </label>
          <label class="toggle" title="Radius around each city center">Radius (mi)
            <input id="gapMiles" type="number" value="50" style="width:80px;margin-left:8px">
          </label>
          <button id="gapRun" class="btn" type="button">Run</button>
          <button id="gapExport" class="btn" type="button">Export CSV</button>
        </div>
        <div id="gapResults" style="max-height:65vh;overflow:auto"></div>
      </div>
    </div>
  </div>
</div>

<!-- Rollups modal -->
<div class="modal" id="rollupModal" aria-modal="true" role="dialog">
  <div class="card">
    <header>
      <h3>Manager rollups</h3>
      <button id="rollupClose" class="btn" type="button">Close</button>
    </header>
    <div class="body" style="grid-template-columns:1fr;">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
        <label class="toggle"><input type="radio" name="rollBy" id="rollByRM" checked> By Regional Manager</label>
        <label class="toggle"><input type="radio" name="rollBy" id="rollByAM"> By Area Manager</label>
        <button id="rollExport" class="btn" type="button">Export CSV</button>
      </div>
      <div id="rollTable" style="max-height:65vh;overflow:auto"></div>
    </div>
  </div>
</div>

<div id="busy" class="busy" hidden><div class="spin"></div></div>
<div id="toast" class="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <script>
  // Loud error banner so silent runtime errors can’t hide
  (function(){
    const banner = document.createElement('div');
    banner.id = 'errBanner';
    banner.style.cssText = 'position:fixed;left:10px;bottom:10px;z-index:99999;background:#111;color:#fff;padding:8px 10px;border-radius:8px;max-width:90vw;display:none';
    document.addEventListener('DOMContentLoaded', ()=>document.body.appendChild(banner));
    function show(msg){
      banner.textContent = 'Error: ' + msg;
      banner.style.display = 'block';
    }
    window.addEventListener('error', e=> show(e.message || String(e)));
    window.addEventListener('unhandledrejection', e=> show((e.reason && e.reason.message) || String(e.reason)));
  })();
</script>

<script>
async function main(){



  // ========== CONFIG ==========
  // Default local JSON filenames (next to this HTML)
  const DATA_URL_DEFAULT    = './store_data.json';
  const ACOSTA_URL_DEFAULT  = './acosta_geocoded.json';
  const PREMIUM_URL_DEFAULT = './premium_trainers_master.json';

  // LocalStorage keys
  const LS_STATE  = 'prt_state_v10';
  const LS_VIEWS  = 'prt_views_v2';
  const LS_LAST_QUERY = 'prt_last_query';
  const LS_SOURCE = 'prt_source_v1'; // {mode:'local'|'url', stores:'...', premium:'...', acosta:'...'}
  const LS_CACHE  = 'prt_cache_v1';  // { url : {ct:'application/json', body:'...', ts:...}, ... }
  const LS_CHANGELOG = 'prt_changelog_v1';
  const REV_KEY = 'prt_dataset_revs_v1';

  // Map constants
  const COLORS = {
    "Premium + Acosta": getCSS('--pa'),
    "Premium Only":     getCSS('--p'),
    "Acosta Only":      getCSS('--a'),
    "Uncovered":        getCSS('--u')
  };
  const DEFAULT_RADIUS = 75;
  const HOME_VIEW = { center:[39.5,-98.35], zoom:5 };
const AUTO_RESET = ()=> !!(id('autoReset') && id('autoReset').checked);

  // Fallback small dataset so UI still works without files
  const FALLBACK_STORES = [
    { storeNumberStr:"1234", storeName:"Walmart", address:"701 W 51st St", city:"Austin", state:"TX", coverageType:"Uncovered", areaManager:"", regionalManager:"", trainerCity:"", lat:30.309, lng:-97.742 },
    { storeNumberStr:"5678", storeName:"Walmart", address:"10 S Riverside", city:"Chicago", state:"IL", coverageType:"Uncovered", areaManager:"", regionalManager:"", trainerCity:"", lat:41.882, lng:-87.639 }
  ];

  // ========== STATE ==========
  let premiumConfirmed = [];
  let premiumPending   = [];
  let acostaHubs       = [];

  let allStores = [];
  let filteredStores = [];
  const markerByStore = new Map();

  let PENDING_OPEN_HUB_ID = null;
  let PENDING_PIN_IDS = [];

  let compareMode = false;
  let pinnedHubs = [];
  let lastFilterChanged = null;
  const debouncedRun = (() => { let t; return () => { clearTimeout(t); t = setTimeout(runFilter, 90); }; })();

  // ========== MAP ==========
  const map = L.map('map', { zoomControl: true, inertia: true }).setView(HOME_VIEW.center, HOME_VIEW.zoom);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, attribution: '© OpenStreetMap' }).addTo(map);
  const hubPane = map.createPane('hubPane'); hubPane.style.zIndex = 650; hubPane.style.pointerEvents = 'auto';

  const markers = L.markerClusterGroup({
    disableClusteringAtZoom: 12,
    spiderfyOnMaxZoom: false,
    maxClusterRadius: z => z >= 9 ? 50 : 70,
    iconCreateFunction: clusterIconByDominantCoverage,
    chunkedLoading: true,
    chunkInterval: 50,
    chunkDelay: 25
  });
  const plainMarkers = L.layerGroup();
  const targetLayer    = L.layerGroup().addTo(map);
  const ringLayer      = L.layerGroup().addTo(map);
  const highlightLayer = L.layerGroup().addTo(map);
  const hubLayer       = L.layerGroup().addTo(map);
  const heatLayerHolder = { layer: null };
  map.addLayer(markers);

  // ========== UI REFS ==========
  const STATUS = id('dataStatus'); const busy = id('busy'); const toast = id('toast');
  const showConfirmed = id('showConfirmed');
  const showPending   = id('showPending');
  const showAcosta    = id('showAcosta'); showAcosta.checked = false; // default OFF
  const acostaChip = id('acostaChip');
  const radius        = id('radius');  const radiusLbl = id('radiusLbl');
  const tgHeat = id('tgHeat'), tgRings=id('tgRings'), tgOverlap=id('tgOverlap'), tgCompare=id('tgCompare'), tgWithin=id('tgWithin'), tgCluster=id('tgCluster');
  const covFilter = id('covFilter'); const covSearch = id('covSearch');
  const rmFilter  = id('rmFilter');  const rmSearch  = id('rmSearch');
  const amFilter  = id('amFilter');  const amSearch  = id('amSearch');
  const hubFilter = id('hubFilter'); const hubSearch = id('hubSearch');
  const k = {
    pa:id('k_pa'), p:id('k_p'), a:id('k_a'), u:id('k_u'),
    total:id('k_total'),
    confirmed:id('k_confirmed'),
    offer:id('k_offer'),
    proposed:id('k_proposed'),
    inView:id('inView'),
    acostaHubs: id('k_acosta_hubs')
  };

  // Side panel refs
  const sidepanel = id('sidepanel');
  const spTitle = id('spTitle'); const spMeta = id('spMeta'); const spCounts = id('spCounts');
  const spRowsEl = id('spRows'); const spSearch = id('spSearch');
  const spLink = id('spLink');

  const spClose = id('spClose'); const spExport = id('spExport'); const spPinBtn = id('spPinBtn'); const spPrint = id('spPrint'); const spCollapse = id('spCollapse');
  let spHub = null; let spRows = []; let spFilter = '';

  // Sandbox refs
  const sandboxBtn = id('sandboxBtn'); const sbPanel = id('sandboxPanel'); const sbNear = id('sbNear'); const sbMeta = id('sbMeta'); const sbSaveCsv = id('sbSaveCsv'); const sbSaveJson = id('sbSaveJson'); const sbClose = id('sbClose');
  let sandboxMarker = null; let sandboxCircle = null;

  setTimeout(()=> map.invalidateSize(), 120);

  // ========== SOURCE PICKER UI ==========
  const sourceDrop = id('sourceDrop'); const sourceMenu = id('sourceMenu');
  sourceDrop.querySelector('button').onclick = ()=> toggleDropdown(sourceMenu);
  on('click', document.body, (e)=>{ if (!sourceDrop.contains(e.target)) sourceMenu.style.display='none'; }, true);
  id('srcLocal').onclick = ()=>{ saveSource({mode:'local'}); location.reload(); };
  id('srcURL').onclick   = async ()=>{
    const stores = prompt('Paste URL for STORES (CSV or JSON). Leave blank to keep current.');
    const premium= prompt('Paste URL for PREMIUM hubs (JSON preferred; CSV allowed). Leave blank to keep current.');
    const acosta = prompt('Paste URL for ACOSTA hubs (CSV or JSON). Leave blank to keep current.');
    const next = loadSource() || {mode:'local'};
    if (stores) next.stores = stores;
    if (premium) next.premium = premium;
    if (acosta) next.acosta = acosta;
    next.mode = 'url';
    saveSource(next); location.reload();
  };
  id('srcClear').onclick = ()=>{ localStorage.removeItem(LS_SOURCE); location.reload(); };

  // ========== HELP / MODALS ==========
  id('helpBtn').onclick  = ()=>{ renderChangelog(); id('helpModal').classList.add('show'); };
  id('helpClose').onclick= ()=> id('helpModal').classList.remove('show');
  id('chgClear').onclick = ()=>{ localStorage.removeItem(LS_CHANGELOG); renderChangelog(); };
  id('chgExport').onclick= ()=>{ const json = localStorage.getItem(LS_CHANGELOG)||'[]'; downloadText(json, `changelog_${Date.now()}.json`, 'application/json'); };

  // ========== CORE WIRING ==========
  showConfirmed.onchange = handleHubVisibilityChange;
  showPending.onchange   = handleHubVisibilityChange;
  showAcosta.onchange    = handleHubVisibilityChange;

  on('input', radius,   ()=>{
    radiusLbl.textContent = radius.value;
    recomputeCoverage();
    debouncedRun();
    updateRings();
    buildHubFilterOptions();

    if (tgOverlap.checked) drawOverlap();
    if (sandboxMarker) refreshSandbox();
    if (spHub) openSidepanel(spHub);
    refreshComparePanel();
    saveState();
  });

  on('input', covSearch, ()=> filterSelect(covFilter, covSearch.value));
  on('input', rmSearch,  ()=> filterSelect(rmFilter,  rmSearch.value));
  on('input', amSearch,  ()=> filterSelect(amFilter,  amSearch.value));
  on('input', hubSearch, ()=> filterSelect(hubFilter, hubSearch.value));

  on('change', rmFilter,  ()=>{ lastFilterChanged='rmFilter'; cascadeAM(); runFilter(); fitToResults(); saveState(); renderChips(); buildHubFilterOptions(); });
  on('change', amFilter,  ()=>{ lastFilterChanged='amFilter'; cascadeRM(); runFilter(); fitToResults(); saveState(); renderChips(); buildHubFilterOptions(); });
  on('change', covFilter, ()=>{ lastFilterChanged='covFilter'; runFilter(); saveState(); renderChips(); buildHubFilterOptions(); });
  on('change', hubFilter, ()=>{ lastFilterChanged='hubFilter'; runFilter(); fitToResults(); saveState(); renderChips(); });

  id('fitBtn').onclick  = ()=>{ fitToResults(); saveState(); };
  id('homeBtn').onclick = ()=>{ map.setView(HOME_VIEW.center, HOME_VIEW.zoom); };
  id('resetBtn').onclick= ()=>{ resetAll(); runFilter(); saveState(); renderChips(); };

  const exportDrop = id('exportDrop'); const menu = exportDrop.querySelector('.dropdown-menu');
  exportDrop.querySelector('button').onclick = ()=> toggleDropdown(menu);
  on('click', document.body, (e)=>{ if (!exportDrop.contains(e.target)) menu.style.display='none'; }, true);
  id('exportStores').onclick  = ()=>{ exportStoresCsv(); if(AUTO_RESET()) { resetAll(); runFilter(); renderChips(); } };

  const viewsDrop = id('viewsDrop'); const viewsMenu = id('viewsMenu'); const viewList = id('viewList');
  viewsDrop.querySelector('button').onclick = ()=> toggleDropdown(viewsMenu);
  on('click', document.body, (e)=>{ if (!viewsDrop.contains(e.target)) viewsMenu.style.display='none'; }, true);
  id('viewSave').onclick = saveCurrentView;
  rebuildViewsMenu();

  tgHeat.onchange   = ()=>{ if (tgHeat.checked) updateHeat(); else clearHeat(); saveState(); };
  tgRings.onchange  = ()=>{ updateRings(); saveState(); };
  tgOverlap.onchange= ()=>{ if (tgOverlap.checked) drawOverlap(); else highlightLayer.clearLayers(); saveState(); };
  tgCompare.onchange= ()=>{ compareMode = tgCompare.checked; pinnedHubs=[]; highlightLayer.clearLayers(); refreshComparePanel(); alert(compareMode ? 'Compare mode on: click hub markers to pin them.' : 'Compare mode off.'); saveState(); };
  tgWithin.onchange = ()=>{ lastFilterChanged='tgWithin'; runFilter(); fitToResults(); saveState(); };
  tgCluster.onchange= ()=>{ refreshLayerMode(); };

  // keyboard helpers
  const searchBox = id('searchBox'), searchBadge = id('searchBadge'), searchResults = id('searchResults');
  const searchWrap = document.querySelector('.searchbox');
  id('searchClear').onclick = ()=>{ searchBox.value=''; localStorage.removeItem(LS_LAST_QUERY); searchBadge.classList.remove('show'); hideResults(); clearTarget(); runFilter(); };
  window.addEventListener('keydown',(e)=>{
    if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); searchBox.focus(); searchBox.select(); }
    if (e.key.toLowerCase() === 'h'){ map.setView(HOME_VIEW.center, HOME_VIEW.zoom); }
    if (e.key.toLowerCase() === 'f' && sidepanel.classList.contains('show')){ spSearch.focus(); spSearch.select(); }
  });

  // sidepanel actions
  spClose.onclick = ()=> hideSidepanel();
  spCollapse.onclick = ()=> hideSidepanel();
  spSearch.addEventListener('input', ()=>{ spFilter = spSearch.value.trim().toLowerCase(); renderSidepanelList(); });
  spExport.onclick = ()=>{ exportSidepanelCsv(); if(AUTO_RESET()){ resetAll(); runFilter(); renderChips(); } };
  spPrint.onclick  = ()=>{ printSidepanelList();  if(AUTO_RESET()){ resetAll(); runFilter(); renderChips(); } };
  spPinBtn.onclick = ()=> togglePinFromPanel();
  document.querySelectorAll('.sp-quick .btn[data-r]').forEach(b=>{
    b.addEventListener('click', ()=>{
      radius.value = b.dataset.r; radiusLbl.textContent=b.dataset.r;
      recomputeCoverage(); runFilter(); updateRings(); if (spHub) openSidepanel(spHub); refreshComparePanel(); saveState();
    });
  });

  // map events
  markers.on('clustermouseover', (e)=>{
    const cts = coverageCounts(e.layer.getAllChildMarkers());
    const total = Object.values(cts).reduce((a,b)=>a+b,0)||1;
    const pct = k => Math.round((cts[k]||0)*100/total);
    const html = `
      <div style="font-size:12px">
        <div><b>${total}</b> stores</div>
        <div><span class="dot" style="background:${COLORS["Premium + Acosta"]}"></span> P+A: <b>${cts["Premium + Acosta"]||0}</b> (${pct("Premium + Acosta")}%)</div>
        <div><span class="dot" style="background:${COLORS["Premium Only"]}"></span> Premium: <b>${cts["Premium Only"]||0}</b> (${pct("Premium Only")}%)</div>
        <div><span class="dot" style="background:${COLORS["Acosta Only"]}"></span> Acosta: <b>${cts["Acosta Only"]||0}</b> (${pct("Acosta Only")}%)</div>
        <div><span class="dot" style="background:${COLORS["Uncovered"]}"></span> Uncovered: <b>${cts["Uncovered"]||0}</b> (${pct("Uncovered")}%)</div>
      </div>`;
    e.layer.bindTooltip(html, {direction:'top', offset:[0,-12], opacity:0.95, sticky:true}).openTooltip();
  });
  markers.on('clustermouseout', (e)=>{ e.layer.closeTooltip(); });
  markers.on('clusterclick', (e)=>{ map.fitBounds(e.layer.getBounds()); });
map.on('moveend zoomend', () => {
  updateInViewCount();
  if (id('tgHeat').checked) {
    (window.requestIdleCallback || ((fn) => setTimeout(fn, 0)))(updateHeat);
  }
  saveState();
});


  // ========== LOAD DATA (with abortable fetch, retry, cached fallback) ==========
  showBusy(true); let spinnerFailSafe = setTimeout(()=>showBusy(false), 7000);
  try {
    const src = loadSource();
    const srcMode = src?.mode || 'local';

    const URLS = {
      stores: srcMode==='url' && src?.stores ? src.stores : DATA_URL_DEFAULT,
      acosta: srcMode==='url' && src?.acosta ? src.acosta : ACOSTA_URL_DEFAULT,
      premium:srcMode==='url' && src?.premium? src.premium: PREMIUM_URL_DEFAULT
    };

    badgeSource(srcMode, URLS);

    // STORES
    STATUS.textContent = `Loading stores…`;
    let storeRaw = null;
    try{
      storeRaw = await loadAny(URLS.stores, { expect:['application/json','text/csv'], cacheKey:'stores' });
      storeRaw = await normalizeInputTable(storeRaw);
      if (!Array.isArray(storeRaw)) throw new Error('Stores must be array-like rows');
    }catch(fetchErr){
      warnToast(`Stores failed: ${fetchErr.message}`, [
        {label:'Use fallback', action:()=>{}}
      ]);
      STATUS.innerHTML = `<span style="color:#a15b00;font-weight:600">Loaded fallback test data</span> — provide <code>store_data.json</code> or choose Source ▾`;
      storeRaw = FALLBACK_STORES;
    }
    allStores = normalizeStores(storeRaw);
    STATUS.textContent += `  |  ${allStores.length.toLocaleString()} stores ready`;
    populateRM(allStores); populateAM(allStores);

    // ACOSTA
    let acOk = true;
    try {
      const aRaw = await loadAny(URLS.acosta, { expect:['application/json','text/csv'], cacheKey:'acosta' });
      const aRows = Array.isArray(aRaw) ? aRaw : await normalizeInputTable(aRaw);
      acostaHubs = (aRows||[])
        .map(r => ({
          lat: Number(r.Latitude ?? r.latitude ?? r.lat),
          lng: Number(r.Longitude ?? r.longitude ?? r.lng),
          name: String(r.RepName ?? r.name ?? 'Acosta Rep'),
          city: String(r.City ?? ''), state: String(r.State ?? '')
        }))
        .filter(r => Number.isFinite(r.lat) && Number.isFinite(r.lng))
        .map(r => ({
          id: 'ac_' + slug(`${r.name}-${r.city}-${r.state}`),
          name: r.name, fullName: `${r.name} — ${r.city}, ${r.state}`,
          coords: [r.lat, r.lng], status: 'acosta'
        }));
      STATUS.textContent += `  |  Acosta hubs: ${acostaHubs.length}`;
    } catch (e) {
      STATUS.innerHTML += `  |  <span style="color:#b42318">Acosta failed</span>`;
      console.error('Acosta load error:', e);
      acostaHubs = [];
      acOk = false;
    }

    // PREMIUM hubs …
    try {
      const pRaw = await loadAny(URLS.premium, { expect:['application/json','text/csv'], cacheKey:'premium' });
      const pJson = Array.isArray(pRaw) ? pRaw : await normalizeInputTable(pRaw);

      const rows = Array.isArray(pJson)
        ? pJson
        : [];

      const txt = v => String(v ?? '').toLowerCase();

      const statusText = r => {
        const fields = [
          r.Status, r.status, r.HubStatus, r.Hub_Status,
          r.TrainerStatus, r.Trainer_Status, r.CandidateStatus, r.AssignmentStatus
        ];
        return fields.map(txt).find(Boolean) || '';
      };

      const getCity = r => String(
        r.City ?? r.city ??
        r.Hub_City ?? r['Hub City'] ??
        r.ProposedCity ?? r['Proposed City'] ??
        r.TargetCity ?? r['Target City'] ??
        r.CandidateCity ?? r['Candidate City'] ??
        r.HubCity ?? ''
      ).trim();

      const getState = r => String(
        r.State ?? r.state ??
        r.Hub_State ?? r['Hub State'] ??
        r.ProposedState ?? r['Proposed State'] ??
        r.TargetState ?? r['Target State'] ??
        r.CandidateState ?? r['Candidate State'] ??
        r.HubState ?? ''
      ).trim();

      const getCoords = r => {
        const lat = Number(r.Latitude  ?? r.latitude  ?? r.lat ?? r.Lat ?? r.lat_dd ?? r.Latitude__c);
        const lng = Number(r.Longitude ?? r.longitude ?? r.lng ?? r.Lon ?? r.lng_dd ?? r.Longitude__c);
        return (Number.isFinite(lat) && Number.isFinite(lng)) ? [lat, lng] : null;
      };

      const getName = r => String(
        r.CandidateName ?? r.Candidate ?? r.RepName ?? r.repName ??
        r.TrainerName ?? r['Trainer Name'] ??
        r.Premium_Trainer ?? r.PremiumTrainer ??
        r.name ?? r.Name ?? ''
      ).trim();

      const classify = r => {
        const s = statusText(r);
        const hasName = !!getName(r);
        if (hasName && !/(offer|propos|recruit|pend)/i.test(s)) {
          return { status: 'confirmed', statusSub: 'confirmed' };
        }
        if (/(offer)/i.test(s))      return { status: 'pending', statusSub: 'pending_offer' };
        if (/(propos|plan|target)/i.test(s))   return { status: 'pending', statusSub: 'proposed' };
        if (/(recruit|source|pipeline|open)/i.test(s)) return { status: 'pending', statusSub: 'open' };
        return { status: 'pending', statusSub: hasName ? 'pending_candidate' : 'proposed' };
      };

      const pretty = sub => ({
        confirmed:          'Confirmed',
        pending_offer:      'Pending Offer',
        pending_candidate:  'Pending',
        proposed:           'Proposed',
        open:               'Open'
      }[sub] || 'Pending');

      function coordsFromCityState(city, state){
        if (!city || !state) return null;
        const rows = allStores.filter(s =>
          (s.city||'').toLowerCase() === city.toLowerCase() &&
          (s.state||'').toUpperCase() === state.toUpperCase()
        );
        if (rows.length){
          const lat = rows.reduce((a,b)=>a+b.lat,0)/rows.length;
          const lng = rows.reduce((a,b)=>a+b.lng,0)/rows.length;
          return [lat, lng];
        }
        return null;
      }

      const toHub = (r) => {
        let coords = getCoords(r);
        let city   = getCity(r);
        let state  = getState(r);
        let nm     = getName(r);

        if (!coords && city && state) coords = coordsFromCityState(city, state);
        if (!coords) return null;
        let [lat, lng] = coords;

        const { status, statusSub } = classify(r);
        const statusLabel = pretty(statusSub);
        const trainerBit  = nm ? ` — ${nm}` : '';
        const place = city && state ? `${city}, ${state}` : (city || state || '');
        const label = `${place} (${statusLabel}${trainerBit})`;

        return {
          id: `${status[0]}_${slug(`${city||''}-${state||''}-${lat.toFixed(3)}-${lng.toFixed(3)}-${nm||''}`)}`,
          name: nm || 'Proposed',
          label, fullName: label,
          coords: [lat, lng],
          status, statusSub, statusLabel,
          city, state
        };
      };

      const hubs = rows.map(toHub).filter(Boolean);
      premiumConfirmed = hubs.filter(h => h.status === 'confirmed');
      premiumPending   = hubs.filter(h => h.status === 'pending');

    } catch (e) {
      console.warn('Premium file missing/invalid', e);
      premiumConfirmed = [];
      premiumPending   = [];
    }

    buildSearchIndex();
    buildHubFilterOptions();

    if (!tryLoadSnapshot()){ tryLoadLocal(); }

    recomputeCoverage();

    runFilter(); renderChips(); renderHubs(); updateRings();

    const storesFp  = `stores:${allStores.length}`;
    const premiumFp = `premium:${premiumConfirmed.length + premiumPending.length}`;
    const acostaFp  = `acosta:${acostaHubs.length}`;
    updateDatasetBadge(storesFp, premiumFp, acostaFp, srcMode);

    // Log to changelog
    pushChangelog({
      when: new Date().toISOString(),
      who:  'local user',
      what: {
        stores: allStores.length,
        premium_confirmed: premiumConfirmed.length,
        premium_pending: premiumPending.length,
        acosta: acostaHubs.length
      },
      source: srcMode
    });
} catch (err) {
  const msg = (err && err.message) || String(err);
  STATUS.innerHTML =
    `<span style="color:#b42318;font-weight:600">Init error:</span> ${escapeHtml(msg)}`;
  console.error(err);
} finally {
  clearTimeout(spinnerFailSafe);
  showBusy(false);
}



  if (PENDING_PIN_IDS.length){
    pinnedHubs = visibleHubs().filter(h => PENDING_PIN_IDS.includes(h.id));
    if (tgOverlap.checked) drawOverlap();
    refreshComparePanel();
  }
  if (PENDING_OPEN_HUB_ID){
    const h = visibleHubs().find(x => x.id === PENDING_OPEN_HUB_ID);
    if (h) openSidepanel(h);
    PENDING_OPEN_HUB_ID = null;
  }

  // ========== SEARCH ==========
  var searchIdx = []; let resIndex = -1; let targetPin=null; const targetIcon = L.divIcon({className:'', html:'<div style="background:#2f71ff;border:2px solid #fff;border-radius:50%;width:18px;height:18px;box-shadow:0 0 0 1px rgba(0,0,0,.25)"></div>', iconSize:[18,18], iconAnchor:[9,9]});
  const hoverIcon  = L.divIcon({className:'', html:'<div class="hl"></div>', iconSize:[22,22], iconAnchor:[11,11]});
  let hoverMarker=null;

  function buildSearchIndex(){
    searchIdx = allStores.map(s => ({
      kind:'STORE', store:s, lat:s.lat, lng:s.lng,
      text: (`store ${s.storeNumberStr} ${s.storeName||''} ${s.address||''} ${s.city} ${s.state} ${s.coverageType||''} ${s.areaManager||''} ${s.regionalManager||''}`).toLowerCase()
    }));
  }
  function showHover(lat,lng){ if(hoverMarker) highlightLayer.removeLayer(hoverMarker); hoverMarker=L.marker([lat,lng],{icon:hoverIcon}).addTo(highlightLayer); }
  function hideHover(){ if(hoverMarker){ highlightLayer.removeLayer(hoverMarker); highlightLayer.clearLayers(); hoverMarker=null; } }
  function clearTarget(){ if (targetPin){ targetLayer.removeLayer(targetPin); targetPin=null; } }
  function hideResults(){ searchResults.classList.remove('show'); searchResults.innerHTML=''; searchResults._data=[]; resIndex=-1; }

  function showResults(list){
    if (!list.length){ hideResults(); return; }
    searchResults.innerHTML = list.map((r,i)=>`
      <div class="res" data-i="${i}" role="option" title="Open this result">
        <div class="kind">${r.kind}</div>
        <div class="text">
          <div>${escape(r.label)}</div>
          ${r.kind==='STORE'
            ? `<div class="sub">${escape(r.store.address||'')} · ${escape(r.store.city||'')}, ${escape(r.store.state||'')} · ${escape(r.store.coverageType||'')}</div>`
            : (r.kind==='NEAR' ? `<div class="sub">${escape(r.store.address||'')} · ${escape(r.store.city||'')}, ${escape(r.store.state||'')}</div>` : '')
          }
        </div>
      </div>`).join('');
    searchResults.classList.add('show');
    Array.from(searchResults.querySelectorAll('.res')).forEach(el=>{
      el.addEventListener('mouseenter', ()=>{ const d = searchResults._data[Number(el.dataset.i)]; if(d && d.lat) showHover(d.lat,d.lng); });
      el.addEventListener('mouseleave', hideHover);
      el.addEventListener('click', ()=>{ const d = searchResults._data[Number(el.dataset.i)]; selectResult(d); });
    });
    searchResults._data = list; resIndex=-1;
  }

  function toResFromStore(s,score,kind='STORE'){ return { kind, store:s, label:`Store ${s.storeNumberStr} — ${s.storeName||''}, ${s.city}, ${s.state}`, lat:s.lat, lng:s.lng, score }; }
  function toCityRes(city,state,lat,lng,score){ return { kind:'CITY', label:`${city}, ${state}`, lat, lng, score }; }

  function smartNearest(center,limit=8){
    return allStores.map(s => [distMiles(center.lat,center.lng,s.lat,s.lng), s]).sort((a,b)=>a[0]-b[0]).slice(0,limit).map((x,i)=>toResFromStore(x[1], 80-i,'NEAR'));
  }

  function fuzzyScore(hay, needle){
    hay = (hay||'').toLowerCase(); needle = (needle||'').toLowerCase().trim();
    if (!needle) return 0;
    if (hay.includes(needle)) return 100;
    const toks = needle.split(/\s+/).filter(Boolean);
    const hits = toks.reduce((a,t)=>a + (hay.includes(t)?1:0), 0);
    return hits ? 60 + hits*10 : 0;
  }
  function findCityCenter(query){
    const m = (query||'').match(/^\s*(.+?)(?:,\s*([A-Za-z]{2}))?\s*$/);
    if (!m) return null;
    const qCity  = (m[1]||'').toLowerCase();
    const qState = (m[2]||'').toUpperCase();
    const groups = new Map();
    allStores.forEach(s=>{
      const city = (s.city||'').toLowerCase();
      const st   = (s.state||'').toUpperCase();
      const cityHit  = city === qCity || city.includes(qCity);
      const stateHit = !qState || st === qState;
      if (cityHit && stateHit){
        const key = `${city}|${st}`;
        const g = groups.get(key) || {city:s.city, state:s.state, lat:0, lng:0, n:0};
        g.lat += s.lat; g.lng += s.lng; g.n += 1; groups.set(key, g);
      }
    });
    if (!groups.size) return null;
    const best = Array.from(groups.values()).sort((a,b)=>b.n-a.n)[0];
    return { city: best.city, state: best.state, lat: best.lat/best.n, lng: best.lng/best.n, n: best.n };
  }

  function highlightResult(){
    Array.from(searchResults.querySelectorAll('.res')).forEach((el,i)=>{
      el.classList.toggle('active', i===resIndex);
      if(i===resIndex){
        el.scrollIntoView({block:'nearest'});
        const d=searchResults._data[i]; if(d && d.lat) showHover(d.lat,d.lng);
      }
    });
  }
  function selectResult(d){
    hideResults(); hideHover();
    if(!d) return;
    if(d.kind==='STORE' || d.kind==='NEAR'){ openStorePopup(d.store); return; }
    if(d.kind==='CITY' || d.kind==='HUB'){
      const latlng = [d.lat,d.lng];
      showPinPopup(latlng, `
        <div style="font-size:13px;line-height:1.35;min-width:220px">
          <div style="font-weight:800;margin-bottom:4px">${escape(d.label)}</div>
          <div style="color:var(--muted)">Lat: ${Number(d.lat).toFixed(4)}, Lng: ${Number(d.lng).toFixed(4)}</div>
        </div>
      `);
      map.panInside(latlng, { paddingTopLeft:[20,20], paddingBottomRight:[20,20] });
      return;
    }
  }
  function showPinPopup(latlng, html){
    if(!targetPin){ targetPin = L.marker(latlng,{icon:targetIcon}).addTo(targetLayer); }
    else { targetPin.setLatLng(latlng); }
    const p = L.popup({autoClose:true, closeOnClick:true, maxWidth:320}).setLatLng(latlng).setContent(html);
    p.openOn(map);
  }

  function handleSearchInput(){
    if (!allStores.length){ hideResults(); return; }
    const qraw = (searchBox.value||'').trim();
    const q = qraw.toLowerCase();
    localStorage.setItem(LS_LAST_QUERY, qraw);

    const nearCity = q.match(/^near\s+(.+)$/i);

    if (!q || q === 'near' || q === 'near me'){
      searchBadge.textContent = 'NEAR';
      searchBadge.classList.add('show');
      showResults(smartNearest(map.getCenter(), 8));
      return;
    }
    if (nearCity){
      const center = findCityCenter(nearCity[1]);
      if (center){
        map.setView([center.lat, center.lng], Math.max(map.getZoom(), 8));
        showResults(smartNearest({lat:center.lat, lng:center.lng}, 8));
        searchBadge.textContent = 'NEAR'; searchBadge.classList.add('show');
        showPinPopup([center.lat, center.lng], `
          <div style="font-size:13px;line-height:1.35;min-width:220px">
            <div style="font-weight:800;margin-bottom:4px">Near ${escape(center.city)}, ${escape(center.state)}</div>
            <div style="color:var(--muted)">${center.n} reference stores • ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}</div>
          </div>`);
        return;
      }
    }

    const items = [];
    const numInside = q.match(/\b(\d{3,6})\b/);
    if (numInside){
      const s = allStores.find(x => x.storeNumberStr === numInside[1]);
      if (s) items.push(toResFromStore(s, 120));
    }

    const cityHits = new Map();
    allStores.forEach(s=>{
      const score = fuzzyScore(`${s.city}, ${s.state}`, q);
      if (score>=70){
        const key = `${s.city}|${s.state}`;
        const v = cityHits.get(key) || { city:s.city, state:s.state, lat:0, lng:0, n:0, score };
        v.lat += s.lat; v.lng += s.lng; v.n += 1; v.score = Math.max(v.score, score);
        cityHits.set(key, v);
      }
    });
    Array.from(cityHits.values())
      .sort((a,b)=> b.score - a.score || b.n - a.n)
      .slice(0,8)
      .forEach(c => items.push(toCityRes(c.city, c.state, c.lat/c.n, c.lng/c.n, 85)));

    searchIdx.forEach(it => {
      const score = fuzzyScore(it.text, q);
      if (score >= 70) items.push(toResFromStore(it.store, score));
    });

    visibleHubs().forEach(h=>{
      const score = fuzzyScore(h.fullName||h.name, q);
      if (score>=70) items.push({ kind:'HUB', label:h.fullName||h.name, lat:h.coords[0], lng:h.coords[1], score });
    });

    const seen=new Set(), out=[];
    items.sort((a,b)=>b.score-a.score).forEach(it=>{
      const k=it.kind+'|'+it.label+'|'+it.lat+'|'+it.lng;
      if(!seen.has(k)){ seen.add(k); out.push(it); }
    });

    if (out.length) { searchBadge.textContent = 'SEARCH'; searchBadge.classList.add('show'); }
    else { searchBadge.classList.remove('show'); }
    showResults(out.slice(0,60));
  }

  searchBox.addEventListener('input', handleSearchInput);
  searchBox.addEventListener('keydown', (e)=>{
    const items = searchResults._data || [];
    if (e.key === 'ArrowDown'){ e.preventDefault(); resIndex = Math.min(items.length-1,resIndex+1); highlightResult(); }
    if (e.key === 'ArrowUp'){ e.preventDefault(); resIndex = Math.max(0,resIndex-1); highlightResult(); }
    if (e.key === 'Enter'){ e.preventDefault(); if (resIndex>=0 && items[resIndex]) { selectResult(items[resIndex]); } }
    if (e.key === 'Escape'){ hideResults(); }
  });
  document.addEventListener('click', (e)=>{ if (!searchWrap.contains(e.target)) hideResults(); });

  // ========== FILTERING & MARKERS ==========
  function storeFilter(s){
    const covSel = Array.from(covFilter.selectedOptions).map(o=>o.value);
    const covOK  = covSel.includes('All') || covSel.includes(s.coverageType || '');

    const rmSel = Array.from(rmFilter.selectedOptions).map(o=>o.value);
    const amSel = Array.from(amFilter.selectedOptions).map(o=>o.value);
    const rmOK  = rmSel.includes('All') || rmSel.includes(s.regionalManager || '');
    const amOK  = amSel.includes('All') || amSel.includes(s.areaManager || '');

    const hubSel = Array.from(hubFilter.selectedOptions).map(o=>o.value);
    let hubOK = true;
    // "All" means no constraint
    if (hubSel.length && !hubSel.includes('All')){
      const r = Number(radius.value) || DEFAULT_RADIUS;
      const hubsNow = visibleHubs();
      const selHubs = hubsNow.filter(h => hubSel.includes(h.id));
      hubOK = selHubs.some(h => distMiles(s.lat, s.lng, h.coords[0], h.coords[1]) <= r);
    }

    let withinOK = true;
    if (tgWithin.checked){
      const r = Number(radius.value) || DEFAULT_RADIUS;
      withinOK = visibleHubs().some(h => distMiles(s.lat, s.lng, h.coords[0], h.coords[1]) <= r);
    }

    return covOK && rmOK && amOK && hubOK && withinOK;
  }

  function runFilter(){
    markerByStore.clear();
    if(tgCluster.checked){ markers.clearLayers(); } else {
      plainMarkers.clearLayers();
    }

    filteredStores = allStores.filter(storeFilter);

    // add markers
    const addTo = tgCluster.checked ? markers : plainMarkers;
    if (!tgCluster.checked) { map.addLayer(plainMarkers); }

    filteredStores.forEach(s=>{
      const m = L.circleMarker([s.lat,s.lng], {
        radius: 5,
        weight: 1,
        color: '#fff',
        fillOpacity: .95,
        fillColor: COLORS[s.coverageType] || '#888'
      }).bindTooltip(`Store ${escapeHtml(s.storeNumberStr)} — ${escapeHtml(s.city)}, ${escapeHtml(s.state)}`, {direction:'top', offset:[0,-10]})
       .on('click', ()=> openStorePopup(s));
      addTo.addLayer(m);
      markerByStore.set(s, m);
    });

    updateSummaryCounts();
    updateInViewCount();
    updateEmptyOverlay();
    if (tgHeat.checked) updateHeat();

    // keep rings current relative to filter visibility
    updateRings();
  }

  function refreshLayerMode(){
    if (tgCluster.checked){
      map.removeLayer(plainMarkers);
      if(!map.hasLayer(markers)) map.addLayer(markers);
      runFilter();
    } else {
      map.removeLayer(markers);
      if(!map.hasLayer(plainMarkers)) map.addLayer(plainMarkers);
      runFilter();
    }
  }

  function updateEmptyOverlay(){
    const empty = id('emptyState');
    empty.hidden = filteredStores.length > 0;
  }

  function fitToResults(){
    const arr = filteredStores;
    if (!arr.length) return;
    const b = L.latLngBounds(arr.map(s=>[s.lat,s.lng]));
    map.fitBounds(b.pad(0.15));
  }

  function openStorePopup(s){
    const latlng = [s.lat, s.lng];
    const html = `
      <div style="font-size:13px;min-width:240px;line-height:1.35">
        <div style="font-weight:800;margin-bottom:4px">Store ${escapeHtml(s.storeNumberStr)} — ${escapeHtml(s.storeName||'')}</div>
        <div>${escapeHtml(s.address||'')}</div>
        <div>${escapeHtml(s.city||'')}, ${escapeHtml(s.state||'')}</div>
        <div style="margin-top:6px"><span class="dot" style="background:${COLORS[s.coverageType]||'#888'}"></span> ${escapeHtml(s.coverageType||'')}</div>
        ${(s.areaManager||s.regionalManager) ? `<div class="muted" style="margin-top:6px">AM: ${escapeHtml(s.areaManager||'—')} • RM: ${escapeHtml(s.regionalManager||'—')}</div>`:''}
      </div>`;
    L.popup({autoClose:true, closeOnClick:true, maxWidth:320}).setLatLng(latlng).setContent(html).openOn(map);
    // ensure visible if clustering
    const m = markerByStore.get(s);
    if (m && markers.hasLayer(m)) markers.zoomToShowLayer(m, ()=> m.openPopup && m.openPopup());
  }

  // ===== COVERAGE & HUBS =====
  function visibleHubs(){
    const list = [];
    if (showConfirmed.checked) list.push(...premiumConfirmed);
    if (showPending.checked)   list.push(...premiumPending);
    if (showAcosta.checked)    list.push(...acostaHubs);
    return list;
  }

  function recomputeCoverage(){
    // coverageType precedence:
    // 1) Premium + Acosta if inside any premium AND any acosta
    // 2) Premium Only     if inside any premium (confirmed or pending)
    // 3) Acosta Only      if inside any acosta
    // 4) Uncovered        else
    const r = Number(radius.value)||DEFAULT_RADIUS;
    allStores.forEach(s=>{
      const inPrem = pointInAnyHub(s.lat,s.lng, [...premiumConfirmed, ...premiumPending], r);
      const inAco  = pointInAnyHub(s.lat,s.lng, acostaHubs, r);
      let type = 'Uncovered';
      if (inPrem && inAco) type = 'Premium + Acosta';
      else if (inPrem)     type = 'Premium Only';
      else if (inAco)      type = 'Acosta Only';
      s.coverageType = type;
    });
  }

  function pointInAnyHub(lat,lng,hubs,r){
    if (!hubs || !hubs.length) return false;
    for (const h of hubs){
      const [hlat,hlng] = h.coords;
      if (distMiles(lat,lng,hlat,hlng) <= r) return true;
    }
    return false;
  }

  function renderHubs(){
    hubLayer.clearLayers();
    const hubs = visibleHubs();
    hubs.forEach(h=>{
      const el = document.createElement('div');
      el.className = 'hub ' + (
        h.status === 'acosta' ? 'acosta' :
        h.status === 'confirmed' ? 'confirmed' : 'pending'
      );
      const icon = L.divIcon({className:'', html:el, iconSize:[20,20], iconAnchor:[10,10]});
      const m = L.marker(h.coords, {icon, pane:'hubPane'})
        .on('click', ()=> compareMode ? togglePinned(h) : openSidepanel(h))
        .bindTooltip(escapeHtml(h.fullName||h.name), {direction:'top', offset:[0,-12], opacity:0.95, sticky:true});
      m.addTo(hubLayer);
    });
  }

  function updateRings(){
    ringLayer.clearLayers();
    if (!tgRings.checked) return;
    const r = Number(radius.value)||DEFAULT_RADIUS;
    visibleHubs().forEach(h=>{
      L.circle(h.coords, { radius: r*1609.34, color:'#000', weight:1, opacity:.25, fill:false }).addTo(ringLayer);
      // ring label
      const lbl = L.divIcon({className:'', html:`<div style="transform:translate(-50%,-50%);font-size:11px;font-weight:800;background:#fff;border:1px solid var(--border);padding:2px 6px;border-radius:999px;box-shadow:0 2px 6px rgba(0,0,0,.12)"> ${r} mi </div>`});
      const p = destPoint(h.coords[0], h.coords[1], r, 0); // north
      L.marker([p.lat, p.lng], {icon:lbl, interactive:false}).addTo(ringLayer);
      // subtle crosshair
      const cross = L.divIcon({className:'', html:'<div style="width:10px;height:10px;border:2px solid rgba(0,0,0,.35);border-radius:50%"></div>'});
      L.marker(h.coords, {icon:cross, interactive:false}).addTo(ringLayer);
    });
  }

  function drawOverlap(){
    highlightLayer.clearLayers();
    if (!tgOverlap.checked) return;
    const r = Number(radius.value)||DEFAULT_RADIUS;
    // mark stores that are inside 2+ visible hubs
    filteredStores.forEach(s=>{
      const count = visibleHubs().reduce((n,h)=> n + (distMiles(s.lat,s.lng,h.coords[0],h.coords[1])<=r ? 1 : 0), 0);
      if (count >= 2){
        L.circleMarker([s.lat,s.lng], {radius:7, color:'#000', weight:2, fill:false}).addTo(highlightLayer);
      }
    });
  }

  function refreshComparePanel(){
    const panel = id('comparePanel');
    if (!compareMode || pinnedHubs.length<1){ panel.classList.remove('show'); return; }
    panel.classList.add('show');
    id('cmpClear').onclick = ()=>{ pinnedHubs=[]; refreshComparePanel(); drawOverlap(); };
    id('cmpExport').onclick = ()=> exportCompareCsv();

    const r = Number(radius.value)||DEFAULT_RADIUS;
    const groups = pinnedHubs.map(h => ({
      hub: h,
      stores: allStores.filter(s => distMiles(s.lat,s.lng,h.coords[0],h.coords[1])<=r)
    }));
    let html = '';
    if (groups.length===1){
      html = `<div>${escapeHtml(groups[0].hub.fullName||groups[0].hub.name)}: <b>${groups[0].stores.length}</b> stores</div>`;
    } else if (groups.length>=2){
      const a = groups[0], b = groups[1];
      const aOnly = a.stores.filter(s => !b.stores.includes(s));
      const bOnly = b.stores.filter(s => !a.stores.includes(s));
      const both  = a.stores.filter(s => b.stores.includes(s));
      html = `
        <div class="compare-grid">
          <div><b>${escapeHtml(a.hub.fullName||a.hub.name)}</b></div><div><b>${a.stores.length}</b></div>
          <div><b>${escapeHtml(b.hub.fullName||b.hub.name)}</b></div><div><b>${b.stores.length}</b></div>
          <div>Shared</div><div><b>${both.length}</b></div>
          <div>Unique to 1st</div><div><b>${aOnly.length}</b></div>
          <div>Unique to 2nd</div><div><b>${bOnly.length}</b></div>
        </div>`;
    }
    id('compareBody').innerHTML = html;
  }

  function togglePinned(h){
    const ix = pinnedHubs.findIndex(x=>x.id===h.id);
    if (ix>=0) pinnedHubs.splice(ix,1);
    else {
      if (pinnedHubs.length>=2) pinnedHubs.shift();
      pinnedHubs.push(h);
    }
    refreshComparePanel();
    if (tgOverlap.checked) drawOverlap();
  }

  // ===== HUB FILTER OPTIONS (cascades & Acosta toggle) =====
  function buildHubFilterOptions(){
    const oldSel = new Set(Array.from(hubFilter.selectedOptions).map(o=>o.value));
    const r = Number(radius.value)||DEFAULT_RADIUS;
    const hubs = visibleHubs();

    const opts = [`<option value="All"${oldSel.has('All')?' selected':''}>All</option>`];
    hubs.forEach(h=>{
      opts.push(`<option value="${escapeHtml(h.id)}"${ oldSel.has(h.id)?' selected':''}>${escapeHtml(h.fullName||h.name)}</option>`);
    });
    hubFilter.innerHTML = opts.join('');
  }

  function cascadeAM(){
    // when RM is chosen, reduce AM options to those present in filtered dataset
    const rms = Array.from(rmFilter.selectedOptions).map(o=>o.value);
    const inRM = s => rms.includes('All') || rms.includes(s.regionalManager||'');
    const ams = uniq(allStores.filter(inRM).map(s=>s.areaManager || '').filter(Boolean)).sort();
    const sel = new Set(Array.from(amFilter.selectedOptions).map(o=>o.value));
    amFilter.innerHTML = `<option value="All"${sel.has('All')?' selected':''}>All</option>` + ams.map(a=>`<option${sel.has(a)?' selected':''}>${escapeHtml(a)}</option>`).join('');
  }
  function cascadeRM(){
    const ams = Array.from(amFilter.selectedOptions).map(o=>o.value);
    const inAM = s => ams.includes('All') || ams.includes(s.areaManager||'');
    const rms = uniq(allStores.filter(inAM).map(s=>s.regionalManager || '').filter(Boolean)).sort();
    const sel = new Set(Array.from(rmFilter.selectedOptions).map(o=>o.value));
    rmFilter.innerHTML = `<option value="All"${sel.has('All')?' selected':''}>All</option>` + rms.map(rm=>`<option${sel.has(rm)?' selected':''}>${escapeHtml(rm)}</option>`).join('');
  }

  // ===== SIDE PANEL =====
  function openSidepanel(h){
    spHub = h;
    sidepanel.classList.add('show');
    spTitle.textContent = h.fullName || h.name || 'Hub';
    spMeta.innerHTML = `<div>${escapeHtml(h.city||'')}${h.state?`, ${escapeHtml(h.state)}`:''} • <b>${escapeHtml(h.statusLabel||h.status||'')}</b></div>`;
    const r = Number(radius.value)||DEFAULT_RADIUS;

    spRows = allStores
      .filter(s => distMiles(s.lat,s.lng,h.coords[0],h.coords[1])<=r)
      .map(s => ({
        key: `${s.storeNumberStr}`,
        title: `Store ${s.storeNumberStr} — ${s.storeName||''}`,
        addr: `${s.address||''}, ${s.city||''}, ${s.state||''}`,
        store: s
      }))
      .sort((a,b)=> Number(a.store.storeNumberStr) - Number(b.store.storeNumberStr));

    renderSidepanelCounts(h, spRows.length);
    renderSidepanelList();
    map.setView(h.coords, Math.max(map.getZoom(), 8));
    // deep link
    spLink.onclick = ()=> copyLinkToHub(h);
  }

  function renderSidepanelCounts(h, n){
    const r = Number(radius.value)||DEFAULT_RADIUS;
    const covered = {
      'Premium + Acosta':0, 'Premium Only':0, 'Acosta Only':0, 'Uncovered':0
    };
    spRows.forEach(rw => { covered[rw.store.coverageType||'Uncovered']++; });
    spCounts.innerHTML = `
      <div class="sp-chip"><span class="dot" style="background:${COLORS['Premium + Acosta']}"></span>P+A: <b>${covered['Premium + Acosta']}</b></div>
      <div class="sp-chip"><span class="dot" style="background:${COLORS['Premium Only']}"></span>Premium: <b>${covered['Premium Only']}</b></div>
      <div class="sp-chip"><span class="dot" style="background:${COLORS['Acosta Only']}"></span>Acosta: <b>${covered['Acosta Only']}</b></div>
      <div class="sp-chip"><span class="dot" style="background:${COLORS['Uncovered']}"></span>Uncov: <b>${covered['Uncovered']}</b></div>
      <div class="sp-chip">Total: <b>${n}</b> @ ${r} mi</div>`;
  }

  function renderSidepanelList(){
    const wrap = spRowsEl;
    const q = (spFilter||'').toLowerCase();
    const rows = spRows.filter(r=>{
      if (!q) return true;
      return (r.title.toLowerCase().includes(q) || r.addr.toLowerCase().includes(q));
    });
    wrap.innerHTML = rows.map((r,i)=>`
      <div class="row" data-i="${i}">
        <div class="num">${escapeHtml(r.store.storeNumberStr)}</div>
        <div style="flex:1">
          <div class="title">${escapeHtml(r.title)}</div>
          <div class="addr">${escapeHtml(r.addr)}</div>
        </div>
      </div>`).join('');
    Array.from(wrap.querySelectorAll('.row')).forEach(el=>{
      el.addEventListener('click', ()=>{
        const i = Number(el.dataset.i); const d = rows[i];
        if (!d) return;
        openStorePopup(d.store);
        map.panInside([d.store.lat,d.store.lng], { paddingTopLeft:[20,20], paddingBottomRight:[20,20] });
        Array.from(wrap.querySelectorAll('.row')).forEach(x=>x.classList.remove('active'));
        el.classList.add('active');
      });
    });
  }

  function hideSidepanel(){ sidepanel.classList.remove('show'); spHub=null; }

  function togglePinFromPanel(){ if (spHub){ togglePinned(spHub); } }

  // ===== HEATMAP =====
  function updateHeat(){
    const pts = filteredStores.map(s=>[s.lat, s.lng, 0.6]);
    if (heatLayerHolder.layer){ map.removeLayer(heatLayerHolder.layer); heatLayerHolder.layer=null; }
    if (!pts.length) return;
    heatLayerHolder.layer = L.heatLayer(pts, { radius: 25, blur: 15, maxZoom: 11 });
    if (tgHeat.checked) heatLayerHolder.layer.addTo(map);
  }
  function clearHeat(){
    if (heatLayerHolder.layer){ map.removeLayer(heatLayerHolder.layer); heatLayerHolder.layer=null; }
  }

  // ===== SUMMARY / CHIPS =====
  function renderChips(){
    // already wired via updateSummaryCounts
  }
  function updateSummaryCounts(){
    const cts = filteredStores.reduce((m,s)=>{ m[s.coverageType] = (m[s.coverageType]||0)+1; return m; }, {});
    k.pa.textContent = (cts['Premium + Acosta']||0).toLocaleString();
    k.p.textContent  = (cts['Premium Only']||0).toLocaleString();
    k.a.textContent  = (cts['Acosta Only']||0).toLocaleString();
    k.u.textContent  = (cts['Uncovered']||0).toLocaleString();
    k.total.textContent = filteredStores.length.toLocaleString();

    const conf = premiumConfirmed.length;
    const offer = premiumPending.filter(h=>h.statusSub==='pending_offer').length;
    const proposed = premiumPending.filter(h=>h.statusSub!=='pending_offer').length;
    k.confirmed.textContent = conf;
    k.offer.textContent = offer;
    k.proposed.textContent = proposed;

    const showAco = showAcosta.checked;
    acostaChip.hidden = !showAco;
    if (showAco) k.acostaHubs.textContent = acostaHubs.length;
  }
  function updateInViewCount(){
    const b = map.getBounds();
    const n = filteredStores.filter(s=>b.contains([s.lat,s.lng])).length;
    k.inView.textContent = `In view: ${n.toLocaleString()}`;
  }

  // ===== GAP FINDER (simple clustering by city center of uncovered) =====
  id('gapBtn').onclick = ()=> id('gapModal').classList.add('show');
  id('gapClose').onclick = ()=> id('gapModal').classList.remove('show');
  id('gapRun').onclick = ()=> runGapFinder();
  id('gapExport').onclick = ()=> exportGapCsv();

  function runGapFinder(){
    const min = Number(id('gapMin').value)||10;
    const miles = Number(id('gapMiles').value)||50;
    const uncovered = allStores.filter(s=> s.coverageType==='Uncovered');
    const centers = clusterByCity(uncovered);
    const results = centers.map(c=>{
      const count = uncovered.filter(s=> distMiles(c.lat,c.lng,s.lat,s.lng) <= miles).length;
      return {...c, count};
    }).filter(x=>x.count>=min).sort((a,b)=> b.count-a.count).slice(0,200);

    id('gapResults').innerHTML = results.map(r=>`
      <div class="row" style="cursor:default">
        <div class="num">${r.count}</div>
        <div style="flex:1">
          <div class="title">${escapeHtml(r.city)}, ${escapeHtml(r.state)}</div>
          <div class="addr">Center: ${r.lat.toFixed(3)}, ${r.lng.toFixed(3)} — ${miles} mi radius</div>
        </div>
        <button class="btn" data-lat="${r.lat}" data-lng="${r.lng}">Zoom</button>
      </div>`).join('');
    Array.from(id('gapResults').querySelectorAll('button')).forEach(b=>{
      b.onclick = ()=>{
        const lat = Number(b.dataset.lat), lng = Number(b.dataset.lng);
        map.setView([lat,lng], 8);
      };
    });
  }
  function exportGapCsv(){
    const html = id('gapResults').innerHTML;
    if (!html) return;
    // quick parse from current results
    const rows = Array.from(id('gapResults').querySelectorAll('.row')).map(r=>{
      const title = r.querySelector('.title')?.textContent||'';
      const num = r.querySelector('.num')?.textContent||'0';
      const addr = r.querySelector('.addr')?.textContent||'';
      return { title, num, info: addr };
    });
    const lines = ['City,Count,Info'].concat(rows.map(r=>csvRow([r.title, r.num, r.info])));
    downloadText(lines.join('\n'), `gap_results_${Date.now()}.csv`, 'text/csv');
  }

  // ===== ROLLUPS =====
  id('rollupBtn').onclick = ()=> { buildRollups(); id('rollupModal').classList.add('show'); };
  id('rollupClose').onclick = ()=> id('rollupModal').classList.remove('show');
  id('rollExport').onclick  = ()=> exportRollupsCsv();

  function buildRollups(){
    const byRM = id('rollByRM').checked;
    const key = s => byRM ? (s.regionalManager||'Unassigned') : (s.areaManager||'Unassigned');
    const groups = new Map();
    filteredStores.forEach(s=>{
      const k = key(s);
      const g = groups.get(k) || { key:k, total:0, pa:0, p:0, a:0, u:0 };
      g.total++;
      if (s.coverageType==='Premium + Acosta') g.pa++;
      else if (s.coverageType==='Premium Only') g.p++;
      else if (s.coverageType==='Acosta Only') g.a++;
      else g.u++;
      groups.set(k,g);
    });
    const arr = Array.from(groups.values()).sort((a,b)=> b.total-a.total || a.key.localeCompare(b.key));
    const table = `
      <table style="border-collapse:collapse;width:100%;font-size:13px">
        <thead>
          <tr>
            <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px"> ${byRM?'Regional Manager':'Area Manager'} </th>
            <th style="text-align:right;border-bottom:1px solid var(--border);padding:6px">Total</th>
            <th style="text-align:right;border-bottom:1px solid var(--border);padding:6px">P+A</th>
            <th style="text-align:right;border-bottom:1px solid var(--border);padding:6px">Premium</th>
            <th style="text-align:right;border-bottom:1px solid var(--border);padding:6px">Acosta</th>
            <th style="text-align:right;border-bottom:1px solid var(--border);padding:6px">Uncov</th>
          </tr>
        </thead>
        <tbody>
          ${arr.map(r=>`
            <tr>
              <td style="padding:6px;border-bottom:1px solid var(--border)">${escapeHtml(r.key)}</td>
              <td style="padding:6px;text-align:right;border-bottom:1px solid var(--border)">${r.total}</td>
              <td style="padding:6px;text-align:right;border-bottom:1px solid var(--border)">${r.pa}</td>
              <td style="padding:6px;text-align:right;border-bottom:1px solid var(--border)">${r.p}</td>
              <td style="padding:6px;text-align:right;border-bottom:1px solid var(--border)">${r.a}</td>
              <td style="padding:6px;text-align:right;border-bottom:1px solid var(--border)">${r.u}</td>
            </tr>`).join('')}
        </tbody>
      </table>`;
    id('rollTable').innerHTML = table;
  }
  function exportRollupsCsv(){
    const byRM = id('rollByRM').checked;
    const key = s => byRM ? (s.regionalManager||'Unassigned') : (s.areaManager||'Unassigned');
    const groups = new Map();
    filteredStores.forEach(s=>{
      const k = key(s);
      const g = groups.get(k) || { key:k, total:0, pa:0, p:0, a:0, u:0 };
      g.total++;
      if (s.coverageType==='Premium + Acosta') g.pa++;
      else if (s.coverageType==='Premium Only') g.p++;
      else if (s.coverageType==='Acosta Only') g.a++;
      else g.u++;
      groups.set(k,g);
    });
    const arr = Array.from(groups.values()).sort((a,b)=> b.total-a.total || a.key.localeCompare(b.key));
    const lines = [
      (byRM?'Regional Manager':'Area Manager')+',Total,P+A,Premium,Acosta,Uncovered',
      ...arr.map(r=>csvRow([r.key, r.total, r.pa, r.p, r.a, r.u]))
    ];
    downloadText(lines.join('\n'), `rollups_${byRM?'rm':'am'}_${Date.now()}.csv`, 'text/csv');
  }

  function downloadText(text, filename, mime='text/plain'){
  const blob = new Blob([text], {type: mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}


  // ===== EXPORTS =====
  function exportStoresCsv(){
    const head = ['Store #','Name','Address','City','State','Coverage','Area Mgr','Regional Mgr','Lat','Lng'];
    const rows = filteredStores.map(s=>[
      s.storeNumberStr, s.storeName||'', s.address||'', s.city||'', s.state||'',
      s.coverageType||'', s.areaManager||'', s.regionalManager||'', s.lat, s.lng
    ]);
    const lines = [head.join(','), ...rows.map(csvRow)];
    downloadText(lines.join('\n'), `stores_${Date.now()}.csv`, 'text/csv');
  }
  function exportSidepanelCsv(){
    if (!spHub) return;
    const head = ['Store #','Name','Address','City','State','Coverage','Area Mgr','Regional Mgr','Lat','Lng','Hub'];
    const rows = spRows.map(r=>{
      const s = r.store;
      return [s.storeNumberStr, s.storeName||'', s.address||'', s.city||'', s.state||'',
        s.coverageType||'', s.areaManager||'', s.regionalManager||'', s.lat, s.lng, spHub.fullName||spHub.name||''];
    });
    const lines = [head.join(','), ...rows.map(csvRow)];
    downloadText(lines.join('\n'), `hub_${slug(spHub.fullName||spHub.name)}_${Date.now()}.csv`, 'text/csv');
  }
  function printSidepanelList(){
    const rows = spRows.map(r=>`${r.store.storeNumberStr} — ${r.store.storeName||''}\n${r.addr}`).join('\n\n');
    const w = window.open('','_blank','width=800,height=900');
    w.document.write(`<pre style="font:13px/1.45 ui-monospace,Consolas,monospace;white-space:pre-wrap">${escapeHtml(rows)}</pre>`);
    w.document.close();
    w.focus();
    w.print();
  }
  function exportCompareCsv(){
    if (pinnedHubs.length<1) return;
    const r = Number(radius.value)||DEFAULT_RADIUS;
    const groups = pinnedHubs.map(h => ({
      hub: h,
      stores: allStores.filter(s => distMiles(s.lat,s.lng,h.coords[0],h.coords[1])<=r)
    }));
    const head = ['Hub','Store #','Name','City','State','Coverage'];
    const lines = [head.join(',')];
    groups.forEach(g=>{
      g.stores.forEach(s=>{
        lines.push(csvRow([g.hub.fullName||g.hub.name, s.storeNumberStr, s.storeName||'', s.city||'', s.state||'', s.coverageType||'']));
      });
    });
    downloadText(lines.join('\n'), `compare_${Date.now()}.csv`, 'text/csv');
  }

  // ===== SAVED VIEWS / STATE =====
  function saveCurrentView(){
    const name = prompt('Name this view:');
    if (!name) return;
    const v = {
      name,
      map: { center: map.getCenter(), zoom: map.getZoom() },
      toggles: {
        confirmed: showConfirmed.checked,
        pending:   showPending.checked,
        acosta:    showAcosta.checked,
        heat: tgHeat.checked, rings: tgRings.checked, overlap: tgOverlap.checked,
        compare: tgCompare.checked, within: tgWithin.checked, cluster: tgCluster.checked
      },
      radius: Number(radius.value)||DEFAULT_RADIUS,
      filters: {
        cov: Array.from(covFilter.selectedOptions).map(o=>o.value),
        rm:  Array.from(rmFilter.selectedOptions).map(o=>o.value),
        am:  Array.from(amFilter.selectedOptions).map(o=>o.value),
        hub: Array.from(hubFilter.selectedOptions).map(o=>o.value)
      }
    };
    const list = JSON.parse(localStorage.getItem(LS_VIEWS)||'[]');
    list.push(v);
    localStorage.setItem(LS_VIEWS, JSON.stringify(list));
    toastMsg('Saved view.');
    rebuildViewsMenu();
  }
  function rebuildViewsMenu(){
    const list = JSON.parse(localStorage.getItem(LS_VIEWS)||'[]');
    const el = id('viewList');
    if (!list.length){ el.innerHTML = `<div class="muted" style="padding:8px">No saved views</div>`; return; }
    el.innerHTML = list.map((v,i)=>`
      <div class="view-row">
        <div class="view-thumb"></div>
        <div style="flex:1">${escapeHtml(v.name)}</div>
        <div class="view-actions">
          <button class="btn" data-i="${i}" data-act="load">Load</button>
          <button class="btn" data-i="${i}" data-act="del">Delete</button>
        </div>
      </div>`).join('');
    el.querySelectorAll('button').forEach(b=>{
      b.onclick = ()=>{
        const i = Number(b.dataset.i); const act = b.dataset.act;
        const list = JSON.parse(localStorage.getItem(LS_VIEWS)||'[]');
        const v = list[i];
        if (!v) return;
        if (act==='del'){ list.splice(i,1); localStorage.setItem(LS_VIEWS, JSON.stringify(list)); rebuildViewsMenu(); return; }
        if (act==='load'){
          showConfirmed.checked = !!v.toggles.confirmed;
          showPending.checked   = !!v.toggles.pending;
          showAcosta.checked    = !!v.toggles.acosta;
          tgHeat.checked = !!v.toggles.heat; tgRings.checked = !!v.toggles.rings; tgOverlap.checked = !!v.toggles.overlap;
          tgCompare.checked = !!v.toggles.compare; compareMode = tgCompare.checked;
          tgWithin.checked = !!v.toggles.within; tgCluster.checked = !!v.toggles.cluster;
          radius.value = v.radius||DEFAULT_RADIUS; radiusLbl.textContent = radius.value;

          selectOptions(covFilter, v.filters.cov||['All']);
          selectOptions(rmFilter,  v.filters.rm ||['All']);
          selectOptions(amFilter,  v.filters.am ||['All']);
          buildHubFilterOptions(); // rebuild list before applying
          selectOptions(hubFilter, v.filters.hub||['All']);

          recomputeCoverage(); renderHubs(); updateRings(); runFilter();
          if (v.map?.center && Number.isFinite(v.map.center.lat)){
            map.setView([v.map.center.lat, v.map.center.lng], v.map.zoom||HOME_VIEW.zoom);
          }
          saveState();
          toastMsg(`Loaded view: ${escapeHtml(v.name)}`);
        }
      };
    });
  }

  function saveState(){
    const st = {
      confirmed: showConfirmed.checked, pending: showPending.checked, acosta: showAcosta.checked,
      heat: tgHeat.checked, rings: tgRings.checked, overlap: tgOverlap.checked,
      compare: tgCompare.checked, within: tgWithin.checked, cluster: tgCluster.checked,
      radius: Number(radius.value)||DEFAULT_RADIUS,
      cov: Array.from(covFilter.selectedOptions).map(o=>o.value),
      rm:  Array.from(rmFilter.selectedOptions).map(o=>o.value),
      am:  Array.from(amFilter.selectedOptions).map(o=>o.value),
      hub: Array.from(hubFilter.selectedOptions).map(o=>o.value),
      map: { c: map.getCenter(), z: map.getZoom() },
      lastQuery: localStorage.getItem(LS_LAST_QUERY)||''
    };
    localStorage.setItem(LS_STATE, JSON.stringify(st));
  }
  function tryLoadLocal(){
    const raw = localStorage.getItem(LS_STATE);
    if (!raw) return false;
    try{
      const st = JSON.parse(raw);
      showConfirmed.checked = !!st.confirmed; showPending.checked = !!st.pending; showAcosta.checked = !!st.acosta;
      tgHeat.checked = !!st.heat; tgRings.checked = !!st.rings; tgOverlap.checked = !!st.overlap;
      tgCompare.checked = !!st.compare; compareMode = tgCompare.checked;
      tgWithin.checked = !!st.within; tgCluster.checked = !!st.cluster;
      radius.value = st.radius||DEFAULT_RADIUS; radiusLbl.textContent = radius.value;

      selectOptions(covFilter, st.cov||['All']);
      selectOptions(rmFilter,  st.rm ||['All']);
      selectOptions(amFilter,  st.am ||['All']);
      buildHubFilterOptions();
      selectOptions(hubFilter, st.hub||['All']);

      if (st.map?.c && Number.isFinite(st.map.c.lat)){
        map.setView([st.map.c.lat, st.map.c.lng], st.map.z||HOME_VIEW.zoom);
      }
      const q = st.lastQuery||''; if (q) { id('searchBox').value = q; handleSearchInput(); }
      return true;
    }catch(e){ console.warn('State restore failed', e); return false; }
  }

  // Deep-link: ?open=<hubId>&pin=a|b|...  and ?source=
  function tryLoadSnapshot(){
    const u = new URL(location.href);
    const openId = u.searchParams.get('open');
    const pinIds = (u.searchParams.get('pin')||'').split(',').filter(Boolean);
    const src = u.searchParams.get('source');
    if (src){
      try{
        const parsed = JSON.parse(decodeURIComponent(src));
        saveSource(parsed); // persist
      }catch{}
    }
    if (openId) PENDING_OPEN_HUB_ID = openId;
    if (pinIds.length) PENDING_PIN_IDS = pinIds;
    return !!(openId || pinIds.length);
  }
  function copyLinkToHub(h){
    const u = new URL(location.href);
    u.searchParams.set('open', h.id);
    if (pinnedHubs.length) u.searchParams.set('pin', pinnedHubs.map(x=>x.id).join(','));
    navigator.clipboard.writeText(u.toString());
    toastMsg('Link copied.');
  }

  // ===== DATA SOURCE BADGE =====
  function badgeSource(mode, urls){
    const el = id('datasetBadge');
    const nice = mode==='url' ? `External source` : `Local files`;
    const lines = [
      `<span class="chip">Source: <b>${nice}</b></span>`,
      urls?.stores ? `<span class="chip">Stores: <code>${escapeHtml(shortUrl(urls.stores))}</code></span>`:'',
      urls?.premium? `<span class="chip">Premium hubs: <code>${escapeHtml(shortUrl(urls.premium))}</code></span>`:'',
      urls?.acosta ? `<span class="chip">Acosta hubs: <code>${escapeHtml(shortUrl(urls.acosta))}</code></span>`:''
    ].filter(Boolean).join(' ');
    el.innerHTML = lines || '';
  }

  // ===== SANDBOX =====
  sandboxBtn.onclick = ()=>{
    const r = Number(radius.value)||DEFAULT_RADIUS;
    if (!sandboxMarker){
      sandboxMarker = L.marker(map.getCenter(), { draggable:true }).addTo(map);
      sandboxCircle = L.circle(sandboxMarker.getLatLng(), { radius:r*1609.34, color:'#111', weight:1, opacity:.35, fill:false }).addTo(map);
      sandboxMarker.on('drag', refreshSandbox);
    }
    sbPanel.classList.add('show');
    refreshSandbox();
  };
  sbClose.onclick = ()=>{ sbPanel.classList.remove('show'); if (sandboxMarker){ map.removeLayer(sandboxMarker); map.removeLayer(sandboxCircle); sandboxMarker=null; sandboxCircle=null; } };
  sbSaveCsv.onclick = ()=>{
    if (!sandboxMarker) return;
    const ll = sandboxMarker.getLatLng();
    const r = Number(radius.value)||DEFAULT_RADIUS;
    const near = allStores.filter(s=> distMiles(ll.lat,ll.lng,s.lat,s.lng)<=r);
    const head = ['Lat','Lng','RadiusMI','StoresInRadius'];
    const line = csvRow([ll.lat, ll.lng, r, near.length]);
    downloadText([head.join(','), line].join('\n'), `sandbox_${Date.now()}.csv`, 'text/csv');
  };
  sbSaveJson.onclick = ()=>{
    if (!sandboxMarker) return;
    const ll = sandboxMarker.getLatLng();
    const r = Number(radius.value)||DEFAULT_RADIUS;
    const near = allStores.filter(s=> distMiles(ll.lat,ll.lng,s.lat,s.lng)<=r).map(s=>({store:s.storeNumberStr, city:s.city, state:s.state}));
    const obj = { lat: ll.lat, lng: ll.lng, radius_mi: r, nearby_stores: near };
    downloadText(JSON.stringify(obj,null,2), `sandbox_${Date.now()}.json`, 'application/json');
  };
  function refreshSandbox(){
    if (!sandboxMarker || !sandboxCircle) return;
    const ll = sandboxMarker.getLatLng();
    const r = Number(radius.value)||DEFAULT_RADIUS;
    sandboxCircle.setLatLng(ll).setRadius(r*1609.34);
    const near = allStores.filter(s=> distMiles(ll.lat,ll.lng,s.lat,s.lng)<=r).slice(0,10);
    sbNear.innerHTML = near.length
      ? `<div><b>${near.length}</b> stores within ${r} mi</div><ul style="margin:6px 0 0 16px;padding:0">${near.map(s=>`<li>Store ${escapeHtml(s.storeNumberStr)} — ${escapeHtml(s.city)}, ${escapeHtml(s.state)}</li>`).join('')}</ul>`
      : `<div class="muted">No stores within ${r} mi.</div>`;
  }

  // ===== UTIL =====
  function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || '#888'; }
  function id(x){ return document.getElementById(x); }
  function on(ev, el, fn, capture=false){ el.addEventListener(ev, fn, capture); }
  function selectOptions(sel, values){
    const want = new Set(values||[]);
    Array.from(sel.options).forEach(o=> o.selected = want.size? want.has(o.value): o.value==='All');
  }
  function uniq(arr){ return Array.from(new Set(arr)); }
function shortUrl(u){
  try {
    const x = new URL(u);
    return x.host + x.pathname.slice(0,40) + (x.pathname.length>40?'…':'');
  } catch (e) {
    return u;
  }
}

  function coverageCounts(markersArr){
    const out = {'Premium + Acosta':0, 'Premium Only':0, 'Acosta Only':0, 'Uncovered':0};
    (markersArr||[]).forEach(m=>{
      const ll = m.getLatLng();
      // reverse map: slow; skip — clusters summary uses only added stores we already colored;
      // keep structure for consistency
    });
    return out;
  }
  function clusterIconByDominantCoverage(cluster){
    // Determine dominant coverage by sampling child markers' fillColor
    const counts = { pa:0, p:0, a:0, u:0 };
    cluster.getAllChildMarkers().forEach(m=>{
      const c = m.options.fillColor;
      if (c === COLORS['Premium + Acosta']) counts.pa++;
      else if (c === COLORS['Premium Only']) counts.p++;
      else if (c === COLORS['Acosta Only']) counts.a++;
      else counts.u++;
    });
    const dom = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]?.[0]||'u';
    const klass = dom==='pa'?'marker-pa': dom==='p'?'marker-p': dom==='a'?'marker-a':'';
    const n = cluster.getChildCount();
    return L.divIcon({
      html: `<div><span>${n}</span></div>`,
      className: `marker-cluster ${klass}`,
      iconSize: L.point(40,40)
    });
  }

  function distMiles(lat1,lon1,lat2,lon2){
    const R = 3958.7613; // mile
    const dLat = deg2rad(lat2-lat1);
    const dLon = deg2rad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
  function deg2rad(d){ return d*Math.PI/180; }

  function destPoint(lat, lon, distMi, bearingDeg){
    const R = 3958.7613; // miles
    const br = bearingDeg * Math.PI/180;
    const dr = distMi / R;
    const la1 = lat*Math.PI/180, lo1 = lon*Math.PI/180;
    const la2 = Math.asin( Math.sin(la1)*Math.cos(dr) + Math.cos(la1)*Math.sin(dr)*Math.cos(br) );
    const lo2 = lo1 + Math.atan2(Math.sin(br)*Math.sin(dr)*Math.cos(la1), Math.cos(dr)-Math.sin(la1)*Math.sin(la2));
    return { lat: la2*180/Math.PI, lng: ((lo2*180/Math.PI)+540)%360-180 };
  }

  function escapeHtml(s){ return String(s??'').replace(/[&<>"]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c] )); }
  function csvRow(arr){ return arr.map(v=>{
    const s = String(v??'');
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(','); }

  function toggleDropdown(menu){ menu.style.display = (menu.style.display==='block') ? 'none' : 'block'; }

  function toastMsg(msg, actions=[]){
    toast.innerHTML = escapeHtml(msg) + (actions.length? ' ' + actions.map(a=>`<button class="btn">${escapeHtml(a.label)}</button>`).join('') : '');
    toast.classList.add('show');
    const btns = toast.querySelectorAll('button');
    btns.forEach((b,i)=> b.onclick = ()=>{ actions[i]?.action?.(); toast.classList.remove('show'); });
    setTimeout(()=> toast.classList.remove('show'), 2500);
  }
  function warnToast(msg, actions=[]){ toastMsg(msg, actions); }

  function showBusy(on){ busy.hidden = !on; }

  // ===== LOAD HELPERS (CSV/JSON + caching) =====
  async function loadAny(url, {expect=['application/json','text/csv'], cacheKey}={}){
    const useCache = (loadSource()?.mode==='url');
    if (useCache){
      const cache = JSON.parse(localStorage.getItem(LS_CACHE)||'{}');
      const hit = cache[url];
      if (hit && Date.now() - (hit.ts||0) < 5*60*1000){ // 5 min
        return parseBody(hit.body, hit.ct);
      }
    }
    const res = await fetch(url, {cache:'no-store'});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const ct = res.headers.get('content-type')||'';
    const body = await res.text();
    if (useCache){
      const cache = JSON.parse(localStorage.getItem(LS_CACHE)||'{}');
      cache[url] = { ct, body, ts: Date.now() };
      localStorage.setItem(LS_CACHE, JSON.stringify(cache));
    }
    return parseBody(body, ct);
  }
async function parseBody(body, ct){
  if (/json/i.test(ct)) {
    try { return JSON.parse(body); }
    catch (e) { throw new Error('Invalid JSON'); }
  }
  if (/csv|plain/i.test(ct)) {
    return parseCsv(body);
  }
  try { return JSON.parse(body); } catch {}
  return body;
}


  function parseCsv(text){
    const lines = text.replace(/\r/g,'').split('\n').filter(Boolean);
    const head = lines.shift().split(',').map(h=>h.trim());
    return lines.map(line=>{
      const cells = parseCsvLine(line);
      const row = {}; head.forEach((h,i)=> row[h] = cells[i]);
      return row;
    });
  }
  function parseCsvLine(line){
    const out=[]; let cur=''; let inq=false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (inq){
        if (ch === '"'){
          if (line[i+1] === '"'){ cur+='"'; i++; }
          else { inq=false; }
        } else cur+=ch;
      } else {
        if (ch === ','){ out.push(cur); cur=''; }
        else if (ch === '"'){ inq=true; }
        else cur+=ch;
      }
    }
    out.push(cur);
    return out;
  }

  function loadSource(){
    try{ return JSON.parse(localStorage.getItem(LS_SOURCE)||''); } catch { return null; }
  }
  function saveSource(obj){
    localStorage.setItem(LS_SOURCE, JSON.stringify(obj||{mode:'local'}));
  }

  // ===== NORMALIZATION =====
  async function normalizeInputTable(mixed){
    // mixed may already be array-of-objects (from JSON) or parsed rows (from CSV)
    return mixed;
  }
  function normalizeStores(rows){
    return rows.map(r=>{
      const lat = Number(r.Latitude ?? r.latitude ?? r.lat ?? r.Lat ?? r.lat_dd);
      const lng = Number(r.Longitude ?? r.longitude ?? r.lng ?? r.Lon ?? r.lng_dd);
      const city = String(r.City ?? r.city ?? '').trim();
      const state= String(r.State ?? r.state ?? '').trim() || String(r.ST||'').trim();
      const num = String(r.Store ?? r['Store #'] ?? r.StoreNumber ?? r.storeNumber ?? r['Store Number'] ?? r.Store_ID ?? r['Store ID'] ?? r.store_id ?? r.storeNumberStr ?? r['storeNumberStr'] || '').trim();
      return {
        storeNumberStr: num || String(r.SiteID || r.Site_Id || r.Site_Id__c || r.site || r.StoreCode || r.store || '0'),
        storeName: r.StoreName ?? r.storeName ?? r['Store Name'] ?? r.Job_Description ?? r.Job || '',
        address: r.Address ?? r.address ?? r.Address1 ?? r.addr ?? '',
        city, state,
        areaManager: r['Area Mgr'] ?? r.AreaMgr ?? r.AreaManager ?? r.areaManager ?? '',
        regionalManager: r['Regional Mgr'] ?? r.RegionalMgr ?? r.RegionalManager ?? r.regionalManager ?? '',
        coverageType: String(r.Coverage_Type ?? r.Coverage ?? r.coverageType ?? '').trim() || 'Uncovered',
        trainerCity: r.TrainerCity ?? r['Trainer City'] ?? '',
        lat, lng
      };
    }).filter(s => Number.isFinite(s.lat) && Number.isFinite(s.lng));
  }

  function populateRM(stores){
    const list = ['All', ...uniq(stores.map(s=>s.regionalManager||'').filter(Boolean)).sort()];
    rmFilter.innerHTML = list.map(v=>`<option${v==='All'?' selected':''}>${escapeHtml(v)}</option>`).join('');
  }
  function populateAM(stores){
    const list = ['All', ...uniq(stores.map(s=>s.areaManager||'').filter(Boolean)).sort()];
    amFilter.innerHTML = list.map(v=>`<option${v==='All'?' selected':''}>${escapeHtml(v)}</option>`).join('');
  }

  // ===== CHANGELOG =====
  function pushChangelog(entry){
    const list = JSON.parse(localStorage.getItem(LS_CHANGELOG)||'[]');
    list.unshift(entry);
    localStorage.setItem(LS_CHANGELOG, JSON.stringify(list.slice(0,400)));
  }
  function renderChangelog(){
    const list = JSON.parse(localStorage.getItem(LS_CHANGELOG)||'[]');
    id('changelog').textContent = list.map(e => {
      const what = Object.entries(e.what||{}).map(([k,v])=>`${k}=${v}`).join(', ');
      return `${e.when} — ${e.who||'user'} — ${what} — source:${e.source||'local'}`;
    }).join('\n');
  }
// --- helpers you were calling but hadn't defined yet ---

// simple slug for ids/filenames
function slug(s){
  return String(s||'')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g,'-')
    .replace(/^-+|-+$/g,'');
}

// filter the options of a <select multiple> based on a search box
function filterSelect(selectEl, needle){
  const q = (needle||'').toLowerCase().trim();
  Array.from(selectEl.options).forEach(opt=>{
    if (opt.value === 'All') { opt.hidden = false; return; }
    const txt = (opt.textContent||opt.value||'').toLowerCase();
    opt.hidden = q ? !txt.includes(q) : false;
  });
}

// group uncovered stores by city/state and return an averaged center
function clusterByCity(stores){
  const map = new Map(); // key = "city|state"
  stores.forEach(s=>{
    const key = `${(s.city||'').toLowerCase()}|${(s.state||'').toUpperCase()}`;
    const g = map.get(key) || { city:s.city||'', state:s.state||'', lat:0, lng:0, n:0 };
    g.lat += s.lat; g.lng += s.lng; g.n += 1;
    map.set(key, g);
  });
  return Array.from(map.values()).map(g=>({ city:g.city, state:g.state, lat:g.lat/g.n, lng:g.lng/g.n, n:g.n }));
}

// you call updateDatasetBadge(...) once; wire it to the badge already shown by badgeSource()
function updateDatasetBadge(storesFp, premiumFp, acostaFp, mode){
  const el = document.getElementById('datasetBadge');
  const extra = `<span class="chip">Counts: <b>${storesFp}</b> • <b>${premiumFp}</b> • <b>${acostaFp}</b></span>`;
  el.innerHTML = (el.innerHTML||'') + ' ' + extra;
}

// make `escape` mean HTML-escape (you used both names)
const escape = escapeHtml;

  // ===== MISC UI =====
  id('clearLastFilter').onclick = ()=>{
    const last = lastFilterChanged;
    if (!last) { resetAll(); runFilter(); return; }
    if (last==='rmFilter') selectOptions(rmFilter, ['All']);
    if (last==='amFilter') selectOptions(amFilter, ['All']);
    if (last==='covFilter') selectOptions(covFilter, ['All']);
    if (last==='hubFilter') selectOptions(hubFilter, ['All']);
    runFilter(); renderChips(); saveState();
  };
  id('emptyReset').onclick = ()=>{ resetAll(); runFilter(); renderChips(); saveState(); };

  function resetAll(){
  showConfirmed.checked = true;
  showPending.checked   = true;
  showAcosta.checked    = false; // default off
  tgHeat.checked = false; tgRings.checked=false; tgOverlap.checked=false; tgCompare.checked=false; compareMode=false; tgWithin.checked=false; tgCluster.checked=true;
  radius.value = DEFAULT_RADIUS; radiusLbl.textContent = DEFAULT_RADIUS;
  selectOptions(covFilter, ['All']); selectOptions(rmFilter, ['All']); selectOptions(amFilter, ['All']); buildHubFilterOptions(); selectOptions(hubFilter, ['All']);
  id('searchBox').value=''; hideResults(); clearTarget(); localStorage.removeItem(LS_LAST_QUERY);
  renderHubs(); updateRings();
}

} // end main()

main().catch(err => {
  const STATUS = document.getElementById('dataStatus');
  const msg = (err && err.message) || String(err);
  const esc = s => String(s ?? '').replace(/[&<>"]/g, c => (
    c === '&' ? '&amp;' :
    c === '<' ? '&lt;'  :
    c === '>' ? '&gt;'  :
    c === '"' ? '&quot;': c
  ));
  if (STATUS) {
    STATUS.innerHTML =
      `<span style="color:#b42318;font-weight:600">Init error:</span> ${esc(msg)}`;
  }
  console.error(err);
});

</script>
</body>
</html>
