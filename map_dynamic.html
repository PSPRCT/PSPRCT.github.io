<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Premium Retail Trainer Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  :root{
    --blue:#2f71ff; --violet:#6a1b9a; --gray:#9ea3a8; --ring:#d0d7de;
    --pa:#6c5ce7; --p:#2ecc71; --a:#f39c12; --u:#e74c3c;
    --bg:#fff; --fg:#111; --muted:#6b7280; --border:#e5e7eb; --panel:#fff;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  body{display:flex;flex-direction:column;min-width:320px}

  .topbar{position:sticky; top:0; background:var(--panel); display:flex;flex-wrap:wrap;gap:10px;align-items:center; padding:8px 10px;border-bottom:1px solid #eef0f3;z-index:10; box-shadow:0 4px 14px rgba(0,0,0,.04)}
  .search-wrap{display:flex;gap:8px;align-items:center;min-width:280px;flex:1}
  .searchbox{position:relative;flex:1}
  .searchbox input{width:100%;border:1px solid #d0d7de;border-radius:10px;padding:10px 12px 10px 64px;font-size:14px;background:var(--bg);color:var(--fg)}
  .badge-left{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:12px;font-weight:800;letter-spacing:.3px;background:#eef6ff;color:#0b5bd3;border:1px solid #cfe6ff;border-radius:999px;padding:3px 8px;display:none}
  .badge-left.show{display:inline-block}
  .results{position:absolute;left:0;right:0;top:calc(100% + 6px);background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.18);display:none;z-index:20;max-height:360px;overflow:auto}
  .results.show{display:block}
  .res{display:flex;gap:10px;padding:10px;cursor:pointer;align-items:flex-start}
  .res:hover{background:#f6f8fa}
  #searchResults .res.active{ background:#e7f0ff }
  .res .kind{flex:0 0 auto;font-size:11px;font-weight:800;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:#374151;background:var(--panel)}
  .res .text .sub{color:var(--muted);font-size:12px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .btn{border:1px solid #d0d7de;background:var(--panel);border-radius:10px;padding:8px 10px;font-weight:600;cursor:pointer;color:var(--fg); box-shadow:0 2px 8px rgba(0,0,0,.04)}
  .btn.link{border-color:transparent;text-decoration:underline}
  .toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:var(--panel);white-space:nowrap}
  .toggle input{width:16px;height:16px;accent-color:var(--blue)}
  .range{display:flex;align-items:center;gap:8px;white-space:nowrap}
  .range small{color:var(--muted)}

  .pillbar{display:flex;gap:6px;flex-wrap:wrap;padding:6px 10px}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #d0d7de;border-radius:999px;padding:6px 10px;background:var(--panel);color:var(--fg);cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.04)}
  .pill .dot{width:10px;height:10px;border-radius:50%}

  .filters{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:10px;padding:8px 10px;border-top:1px solid #eef0f3;border-bottom:1px solid #eef0f3;background:var(--panel); border-radius:12px; margin:6px 10px; box-shadow:0 6px 20px rgba(0,0,0,.06)}
  .picker{display:flex;flex-direction:column;gap:6px}
  .picker input{padding:6px 8px;font-size:13px;border:1px solid #d0d7de;border-radius:8px;background:var(--bg);color:var(--fg)}
  select[multiple]{height:110px;border:1px solid #d0d7de;border-radius:8px;padding:6px 8px;background:var(--bg);color:var(--fg)}

  .summary{display:flex;gap:10px;align-items:center;padding:6px 10px;border-bottom:1px solid #eef0f3;background:var(--panel)}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:var(--panel)}
  .dot{width:10px;height:10px;border-radius:50%}
  .muted{color:var(--muted);margin-left:auto}

  .mapwrap{position:relative;flex:1;min-height:460px;display:flex;overflow:hidden}
  #map{flex:1} /* height is inherited via flex */

  .sidepanel{width:380px;max-width:90vw;flex:0 0 380px;background:var(--panel);border-left:1px solid var(--border);box-shadow:-4px 0 18px rgba(0,0,0,.12);display:none;flex-direction:column;z-index:6}
  .sidepanel.show{display:flex}
  .sp-head{padding:10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
  .sp-head h3{margin:0;font-size:16px;line-height:1.2;flex:1}
  .sp-body{padding:10px;display:flex;flex-direction:column;gap:10px;height:calc(100vh - 220px);overflow:hidden}
  .sp-actions{display:flex;gap:8px;flex-wrap:wrap}
  .sp-counts{display:flex;gap:8px;flex-wrap:wrap}
  .sp-chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:3px 8px}
  .sp-toggles{display:flex;gap:8px;flex-wrap:wrap}
  .sp-quick{display:flex;gap:6px;flex-wrap:wrap}
  .sp-list{flex:1;min-height:160px;border:1px solid var(--border);border-radius:8px;padding:0;display:flex;flex-direction:column;overflow:auto; box-shadow: inset 0 0 0 2px rgba(0,0,0,.02)}
  .sp-list input{margin:8px;border:1px solid var(--border);border-radius:8px;padding:6px 8px}
  .sp-rows{position:static;height:auto}
  .row{position:relative;display:flex;gap:8px;align-items:flex-start;padding:10px;border-bottom:1px solid var(--border);background:var(--panel);cursor:pointer;min-height:56px}
  .row .title{font-weight:800;line-height:1.25}
  .row .addr{color:var(--muted);font-size:12px;line-height:1.25}
  .row .num{min-width:62px;font-variant-numeric:tabular-nums;color:var(--muted)}
  .row.active{background:#e7f0ff}

  .floating{position:absolute;left:10px;top:10px;z-index:402;display:flex;gap:8px;flex-wrap:wrap}
  .floating .btn,.floating .toggle{padding:6px 8px;font-size:12px}

  .legend{position:absolute;top:10px;right:10px;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:8px 10px;box-shadow:0 6px 18px rgba(0,0,0,.12);z-index:401}

  .sandbox{position:absolute;left:10px;bottom:10px;z-index:402;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:none}

  .dropdown-menu{position:absolute;right:0;top:calc(100% + 4px);background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:6px;z-index:5;max-height:70vh;overflow:auto;box-sizing:border-box;display:none;min-width:240px}

  .busy{position:fixed;inset:0;background:rgba(255,255,255,.5);display:flex;align-items:center;justify-content:center;z-index:9999}
  .busy[hidden]{display:none}
  .spin{width:36px;height:36px;border-radius:50%;border:4px solid rgba(0,0,0,.15);border-top-color:var(--blue);animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  .marker-cluster.marker-pa div{background:var(--pa);border:2px solid #fff}
  .marker-cluster.marker-p  div{background:var(--p); border:2px solid #fff}
  .marker-cluster.marker-a  div{background:var(--a); border:2px solid #fff}
  .marker-cluster.marker-u  div{background:var(--u); border:2px solid #fff}
  .hub{width:20px;height:20px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.25)}
  .hub.staffed{background:var(--violet)}
  .hub.open{background:#9ea3a8}
  .hl{width:22px;height:22px;border-radius:50%;border:2px solid #111;background:rgba(0,0,0,.05);box-shadow:0 0 0 1px rgba(0,0,0,.25)}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:5000}
  .modal.show{display:flex}
  .card{background:#fff;border-radius:12px;max-width:780px;width:92vw;box-shadow:0 20px 50px rgba(0,0,0,.25);border:1px solid var(--border)}
  .card header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
  .card header h3{margin:0;font-size:18px;flex:1}
  .card .body{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .kbd{display:inline-block;border:1px solid #cfd3d7;border-bottom-width:3px;border-radius:6px;padding:2px 6px;font-weight:700;background:#fff}
  @media (max-width:720px){ .card .body{grid-template-columns:1fr;} }
  @media (max-width: 1100px){ .filters{grid-template-columns:repeat(2,minmax(220px,1fr));} }
  @media (max-width: 640px){ .filters{grid-template-columns:1fr;} }
</style>
</head>
<body>

<div class="topbar">
  <div class="search-wrap" title="Type a store #, city/state, or hub name. Tip: type ‚Äònear‚Äô for nearby stores.">
    <div class="searchbox">
      <span id="searchBadge" class="badge-left">STORE</span>
      <input id="searchBox" type="text" placeholder="Type a store #, city/state, hub name‚Ä¶ (tip: 'near')" autocomplete="off" aria-label="Search store or city" />
      <div id="searchResults" class="results" role="listbox"></div>
    </div>
    <button id="searchClear" class="btn" type="button" title="Clear search">Clear</button>
  </div>

  <label class="toggle" title="Show staffed hubs"><input id="showStaffed" type="checkbox" checked />Staffed hubs</label>
  <label class="toggle" title="Show open hubs"><input id="showOpen" type="checkbox" checked />Open hubs</label>

  <div class="range" title="Hub radius used for lists, rings, overlap">
    <span>Radius</span>
    <input id="radius" type="range" min="25" max="150" step="5" value="75" />
    <b id="radiusLbl">75</b><small>mi</small>
  </div>

  <button id="fitBtn" class="btn" type="button" title="Fit map to filtered stores">Fit to Results</button>
  <button id="homeBtn" class="btn" type="button" title="Reset to starting view (keeps filters)">Home</button>
  <button id="resetBtn" class="btn" type="button" title="Reset all filters and view">Reset</button>

  <!-- Export -->
  <div class="dropdown" id="exportDrop" style="position:relative">
    <button class="btn" type="button" title="Download CSV of filtered stores or panel list">Export ‚ñæ</button>
    <div class="dropdown-menu">
      <button id="exportStores" class="btn" type="button" style="display:block;width:100%;margin:4px 0" title="Export all filtered stores on the map">
        Export filtered stores (CSV)
      </button>
      <label class="toggle" style="margin:6px 4px;display:flex"><input id="autoReset" type="checkbox" />Auto-reset after export/print</label>
    </div>
  </div>

  <!-- Saved Views -->
  <div class="dropdown" id="viewsDrop" style="position:relative">
    <button class="btn" type="button" title="Save or recall views">Views ‚ñæ</button>
    <div class="dropdown-menu" id="viewsMenu">
      <button id="viewSave" class="btn" type="button" style="display:block;width:100%">Save current view‚Ä¶</button>
      <div style="border-top:1px solid var(--border);margin:6px 0"></div>
      <div id="viewList" style="min-width:220px"></div>
    </div>
  </div>

  <button id="helpBtn" class="btn" type="button" title="Quick tips and shortcuts">Help</button>
</div>

<div class="pillbar" id="presetBar">
  <div id="presetUncov" class="pill" title="Uncovered + Rings + Heatmap">
    <span class="dot" style="background:var(--u)"></span> Preset: Uncovered focus
  </div>
  <div id="presetHubs" class="pill" title="Show only stores within any visible hub radius">
    üü¶ Preset: Hubs coverage
  </div>
  <div id="snapBtn" class="pill" title="Copy a shareable URL">üîó Save snapshot link</div>
</div>

<div class="pillbar" id="activeChips"></div>

<!-- Filters -->
<div class="filters" title="Use these to narrow stores; search also matches store # and city/state.">
  <div class="picker">
    <input id="covSearch" type="text" placeholder="Search coverage‚Ä¶" />
    <select id="covFilter" multiple>
      <option value="All" selected>All</option>
      <option>Premium + Acosta</option>
      <option>Premium Only</option>
      <option>Acosta Only</option>
      <option>Uncovered</option>
    </select>
  </div>
  <div class="picker">
    <input id="rmSearch" type="text" placeholder="Filter regional managers‚Ä¶" />
    <select id="rmFilter" multiple><option value="All" selected>All</option></select>
  </div>
  <div class="picker">
    <input id="amSearch" type="text" placeholder="Filter area managers‚Ä¶" />
    <select id="amFilter" multiple><option value="All" selected>All</option></select>
  </div>
  <div class="picker">
    <input id="hubSearch" type="text" placeholder="Filter hubs‚Ä¶" />
    <select id="hubFilter" multiple></select>
  </div>
</div>

<div id="dataStatus" style="padding:6px 10px;color:var(--fg);font-size:12px"></div>

<div class="summary" id="summary">
  <span class="chip"><span class="dot" style="background:var(--pa)"></span>P+A: <b id="k_pa">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--p)"></span>Premium: <b id="k_p">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--a)"></span>Acosta: <b id="k_a">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--u)"></span>Uncov: <b id="k_u">0</b></span>
  <span class="chip">Total: <b id="k_total">0</b></span>
  <span class="chip">Hubs ‚Äî <b id="k_staffed">0</b> staffed / <b id="k_open">0</b> open</span>
  <span class="muted" id="inView">In view: 0</span>
</div>

<div class="mapwrap">
  <div id="map" role="region" aria-label="Coverage Map"></div>

  <div class="floating">
    <label class="toggle" title="Density of stores"><input id="tgHeat" type="checkbox" />Heatmap</label>
    <label class="toggle" title="Show hub radius circles"><input id="tgRings" type="checkbox" />Hub radii</label>
    <label class="toggle" title="Highlight stores covered by 2+ hubs"><input id="tgOverlap" type="checkbox" />Overlap</label>
    <label class="toggle" title="Pin hubs to compare coverage"><input id="tgCompare" type="checkbox" />Compare</label>
    <label class="toggle" title="Filter: only stores inside any visible hub radius"><input id="tgWithin" type="checkbox" />Within hubs</label>
    <label class="toggle" title="Turn clustering on/off (useful when zoomed in)"><input id="tgCluster" type="checkbox" checked />Cluster</label>
    <button id="sandboxBtn" class="btn" type="button" title="Test a new hub location">New-hub sandbox</button>
  </div>

  <div class="legend" id="legend" style="display:none">
    <h4>Legend</h4>
    <div class="row"><span class="dot" style="background:var(--pa)"></span> Premium + Acosta</div>
    <div class="row"><span class="dot" style="background:var(--p)"></span> Premium Only</div>
    <div class="row"><span class="dot" style="background:var(--a)"></span> Acosta Only</div>
    <div class="row"><span class="hl"></span> overlap / compare highlight</div>
    <button id="legendClose" class="btn" type="button" style="margin-top:6px;padding:4px 8px;font-size:12px">Hide</button>
  </div>

  <!-- Sandbox -->
  <div class="sandbox" id="sandboxPanel">
    <h4>New-hub Sandbox</h4>
    <div>Click the map to position the blue ring, <b>or</b> enter an address/‚Äúlat,lng‚Äù below. Adjust radius as needed.</div>

    <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
      <input id="sandboxAddr" type="text" placeholder="e.g. 9339 Brookhaven Rd, Kimberly, AL 35091  (or 33.123,-86.456)"
             style="flex:1;min-width:260px;border:1px solid var(--border);border-radius:8px;padding:6px 8px"/>
      <button id="sandboxGeocode" class="btn" type="button" title="Use this address for the sandbox ring">Use address</button>
    </div>
    <div id="sandboxGeoMsg" style="margin-top:4px;font-size:12px;color:var(--muted)"></div>

    <div style="margin-top:10px">
      <b>Radius:</b> <input id="sandboxR" type="range" min="25" max="150" step="5" value="75">
      <b id="sandboxRlbl">75</b> mi
    </div>

    <div id="sandboxStats" style="margin-top:8px;font-size:13px"></div>
    <button id="sandboxListBtn" class="btn" type="button" style="margin-top:8px">View stores in radius</button>
    <div style="margin-top:8px"><small>Click ‚ÄúNew-hub sandbox‚Äù again to close.</small></div>
  </div>

  <div class="sidepanel" id="sidepanel">
    <div class="sp-head">
      <h3 id="spTitle">Hub</h3>
      <button id="spCollapse" class="btn" type="button" title="Collapse panel">‚ü®</button>
      <button id="spPinBtn" class="btn" type="button" title="Pin for compare">Pin</button>
      <button id="spClose" class="btn" type="button" title="Close panel">Close</button>
    </div>
    <div class="sp-body">
      <div id="spMeta" class="sp-meta" style="font-size:13px"></div>
      <div class="sp-actions">
        <button id="spExport" class="btn" type="button" title="Download CSV of this list">Export list (CSV)</button>
        <button id="spPrint" class="btn" type="button" title="Print this list">Print store list</button>
      </div>
      <div class="sp-toggles">
        <label class="toggle" title="Show only uncovered stores in this panel"><input id="spOnlyUncov" type="checkbox" />Uncovered only</label>
      </div>
      <div class="sp-quick" title="Change hub radius quickly">
        Radius: 
        <button class="btn" type="button" data-r="50">50</button>
        <button class="btn" type="button" data-r="75">75</button>
        <button class="btn" type="button" data-r="100">100</button><small> mi</small>
      </div>
      <div id="spCounts" class="sp-counts"></div>
      <div class="sp-list" id="spListWrap">
        <input id="spSearch" type="text" placeholder="Search stores in list‚Ä¶" />
        <div id="spRows" class="sp-rows"></div>
      </div>
    </div>
  </div>
</div>

<!-- Help modal -->
<div class="modal" id="helpModal" aria-modal="true" role="dialog">
  <div class="card">
    <header>
      <h3>Help & Shortcuts</h3>
      <button id="helpClose" class="btn" type="button">Close</button>
    </header>
    <div class="body">
      <div>
        <h4>Keyboard</h4>
        <p><span class="kbd">Ctrl</span> / <span class="kbd">‚åò</span> + <span class="kbd">K</span> ‚Äî Focus search</p>
        <p><span class="kbd">‚Üë</span> <span class="kbd">‚Üì</span> + <span class="kbd">Enter</span> ‚Äî Pick search result</p>
        <p><span class="kbd">H</span> ‚Äî Home (map only)</p>
        <p><span class="kbd">F</span> ‚Äî Focus side-panel search (when open)</p>
      </div>
      <div>
        <h4>Tips</h4>
        <ul>
          <li>Type <b>near</b> to suggest nearby stores.</li>
          <li>Use <b>Within hubs</b> to see only stores covered by visible hubs.</li>
          <li>Pin hubs to compare coverage; <b>Overlap</b> highlights shared stores.</li>
          <li>Side panel shows counts & metrics; click a store to zoom to it.</li>
          <li>Use <b>Views</b> to save/restore your favorite setups.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div id="busy" class="busy" hidden><div class="spin"></div></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/kdbush@3.0.0/kdbush.min.js"></script>
<script src="https://unpkg.com/geokdbush@3.0.0/geokdbush.umd.js"></script>
<script>
(async function(){
  // ---------- CONFIG ----------
  const DATA_URL = './store_data.json?v=' + Date.now();  // put your file next to this HTML
  // tiny test dataset (shown only if fetch fails)
  const FALLBACK_STORES = [
    { storeNumberStr:"1234", storeName:"Walmart", address:"701 W 51st St", city:"Austin", state:"TX", coverageType:"Uncovered", areaManager:"", regionalManager:"", trainerCity:"", lat:30.309, lng:-97.742 },
    { storeNumberStr:"5678", storeName:"Walmart", address:"10 S Riverside", city:"Chicago", state:"IL", coverageType:"Premium + Acosta", areaManager:"", regionalManager:"", trainerCity:"", lat:41.882, lng:-87.639 },
    { storeNumberStr:"9012", storeName:"Walmart", address:"100 Market St", city:"San Francisco", state:"CA", coverageType:"Acosta Only", areaManager:"", regionalManager:"", trainerCity:"", lat:37.793, lng:-122.396 }
  ];

  const COLORS = {
    "Premium + Acosta": getCSS('--pa'),
    "Premium Only":     getCSS('--p'),
    "Acosta Only":      getCSS('--a'),
    "Uncovered":        getCSS('--u')
  };
  const DEFAULT_RADIUS = 75;
  const LS_STATE = 'prt_state_v7';
  const LS_VIEWS = 'prt_views_v1';
  const LS_LAST_QUERY = 'prt_last_query';
  const HOME_VIEW = { center:[39.5,-98.35], zoom:5 };
  const AUTO_RESET = ()=> id('autoReset')?.checked;

  const hubs = [
    { id:"belle_vernon_pa", name:"Belle Vernon, PA (Open)", coords:[40.12507,-79.8664], status:"open", person:null },
    { id:"centennial_co",   name:"Centennial, CO (Open)",   coords:[39.62732,-104.779], status:"open", person:null },
    { id:"houston_tx",      name:"Houston, TX (Open)",      coords:[29.8535,-95.5095],  status:"open", person:null },
    { id:"kansas_city_mo",  name:"Kansas City, MO (Open)",  coords:[39.04512,-94.4429], status:"open", person:null },
    { id:"wilmington_oh",   name:"Wilmington, OH (Open)",   coords:[39.44499,-83.8244], status:"open", person:null },
    { id:"granite_falls_nc_walker", name:"Granite Falls, NC ‚Äî Lisa Walker", coords:[35.800494,-81.405803], status:"accepted", person:"Lisa Walker" },
    { id:"clarksville_tn_salvato",  name:"Clarksville, TN ‚Äî Nicholas Salvato", coords:[36.588879,-87.340167], status:"accepted", person:"Nicholas Salvato" },
    { id:"orange_park_fl_hall",     name:"Orange Park, FL ‚Äî Sabrina Hall", coords:[30.186756,-81.718887], status:"accepted", person:"Sabrina Hall" },
    { id:"olive_branch_ms_brown",   name:"Olive Branch, MS ‚Äî Annette Brown", coords:[34.926688,-89.894859], status:"accepted", person:"Annette Brown" },
    { id:"riverview_fl_santos",     name:"Riverview, FL ‚Äî Richard Santos", coords:[27.8661,-82.3265], status:"accepted", person:"Richard Santos" }
  ];

 let allStores = [];
let filteredStores = [];
const markerByStore = new Map();

const targetLayer    = L.layerGroup();
const ringLayer      = L.layerGroup();
const highlightLayer = L.layerGroup();
const hubLayer       = L.layerGroup();   // define once
const heatLayerHolder = { layer: null };

let compareMode = false;
let pinnedHubs = [];
let targetPin = null;
let searchIdx = [];
let resIndex = -1;

let spHub = null; let spRows = []; let spFilter = ''; let spOnlyUncov = false;

const debouncedRun = (() => { let t; return () => { clearTimeout(t); t = setTimeout(runFilter, 90); }; })();

const map = L.map('map', { zoomControl: true, inertia: true }).setView(HOME_VIEW.center, HOME_VIEW.zoom);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, attribution: '¬© OpenStreetMap' }).addTo(map);

const markers = L.markerClusterGroup({
  disableClusteringAtZoom: 12,
  spiderfyOnMaxZoom: false,
  maxClusterRadius: z => z >= 9 ? 50 : 70,
  iconCreateFunction: clusterIconByDominantCoverage,
  chunkedLoading: true,
  chunkInterval: 50,
  chunkDelay: 25
});
const plainMarkers = L.layerGroup();

// add layers to map exactly once
map.addLayer(markers);
targetLayer.addTo(map);
ringLayer.addTo(map);
highlightLayer.addTo(map);
hubLayer.addTo(map);



  // keep map sized correctly even after fonts/layout ready
  setTimeout(()=> map.invalidateSize(), 120);

  markers.on('clustermouseover', (e)=>{
    const cts = coverageCounts(e.layer.getAllChildMarkers());
    const total = Object.values(cts).reduce((a,b)=>a+b,0)||1;
    const pct = k => Math.round((cts[k]||0)*100/total);
    const html = `
      <div style="font-size:12px">
        <div><b>${total}</b> stores</div>
        <div><span class="dot" style="background:${COLORS["Premium + Acosta"]}"></span> P+A: <b>${cts["Premium + Acosta"]||0}</b> (${pct("Premium + Acosta")}%)</div>
        <div><span class="dot" style="background:${COLORS["Premium Only"]}"></span> Premium: <b>${cts["Premium Only"]||0}</b> (${pct("Premium Only")}%)</div>
        <div><span class="dot" style="background:${COLORS["Acosta Only"]}"></span> Acosta: <b>${cts["Acosta Only"]||0}</b> (${pct("Acosta Only")}%)</div>
        <div><span class="dot" style="background:${COLORS["Uncovered"]}"></span> Uncovered: <b>${cts["Uncovered"]||0}</b> (${pct("Uncovered")}%)</div>
      </div>`;
    e.layer.bindTooltip(html, {direction:'top', offset:[0,-12], opacity:0.95, sticky:true}).openTooltip();
  });
  markers.on('clustermouseout', (e)=>{ e.layer.closeTooltip(); });
  markers.on('clusterclick', (e)=>{ map.fitBounds(e.layer.getBounds()); });

  map.on('moveend zoomend', ()=>{
    updateInViewCount();
    if (id('tgHeat').checked) requestIdleCallback?.(updateHeat) ?? updateHeat();
    saveState();
  });

  map.on('popupopen', (e)=>{
    const s = e?.popup?._source?.store;
    if (!s || !spHub) return;
    Array.from(spRowsEl.querySelectorAll('.row')).forEach(el => el.classList.remove('active'));
    const rel = spRowsEl.querySelector(`.row[data-id="${s.storeNumberStr}"]`);
    if (rel){ rel.classList.add('active'); rel.scrollIntoView({block:'nearest'}); }
  });

  const STATUS = id('dataStatus'); const busy = id('busy');
  const legend = id('legend'); id('legendClose').onclick = ()=> legend.style.display='none';

  const searchBox = id('searchBox'), searchBadge = id('searchBadge'), searchResults = id('searchResults');
  id('searchClear').onclick = ()=>{ searchBox.value=''; localStorage.removeItem(LS_LAST_QUERY); searchBadge.classList.remove('show'); hideResults(); clearTarget(); runFilter(); };

  const showStaffed = id('showStaffed');
  const showOpen    = id('showOpen');
  const radius      = id('radius');  const radiusLbl   = id('radiusLbl');
  const tgHeat = id('tgHeat'), tgRings=id('tgRings'), tgOverlap=id('tgOverlap'), tgCompare=id('tgCompare'), tgWithin=id('tgWithin'), tgCluster=id('tgCluster');

  const covFilter = id('covFilter'); const covSearch = id('covSearch');
  const rmFilter  = id('rmFilter');  const rmSearch  = id('rmSearch');
  const amFilter  = id('amFilter');  const amSearch  = id('amSearch');
  const hubFilter = id('hubFilter'); const hubSearch = id('hubSearch');

  const presetUncov = id('presetUncov'); const presetHubs = id('presetHubs');
  const activeChips = id('activeChips');

  on('input', radius,   ()=>{ radiusLbl.textContent = radius.value; debouncedRun(); updateRings(); if (tgOverlap.checked) drawOverlap(); if (sandboxMarker) refreshSandbox(); saveState(); if (spHub) openSidepanel(spHub); });

  on('input', covSearch, ()=> filterSelect(covFilter, covSearch.value));
  on('input', rmSearch,  ()=> filterSelect(rmFilter,  rmSearch.value));
  on('input', amSearch,  ()=> filterSelect(amFilter,  amSearch.value));
  on('input', hubSearch, ()=> filterSelect(hubFilter, hubSearch.value));

  on('change', covFilter, ()=>{ runFilter(); saveState(); renderChips(); });
  on('change', rmFilter,  ()=>{ cascadeAM(); runFilter(); fitToResults(); saveState(); renderChips(); });
  on('change', amFilter,  ()=>{ cascadeHubs(); runFilter(); fitToResults(); saveState(); renderChips(); });
  on('change', hubFilter, ()=>{ runFilter(); fitToResults(); saveState(); renderChips(); });

  presetUncov.addEventListener('click', ()=>{
    setMulti(covFilter, ['Uncovered']);
    id('tgRings').checked = true;
    id('tgHeat').checked  = true;
    runFilter(); updateRings(); updateHeat(); fitToResults(); saveState(); renderChips();
  });
  presetHubs.addEventListener('click', ()=>{
    tgWithin.checked = true;
    runFilter(); fitToResults(); updateRings(); saveState(); renderChips();
  });

  id('fitBtn').onclick = ()=>{ fitToResults(); saveState(); };
  id('homeBtn').onclick = ()=>{ map.setView(HOME_VIEW.center, HOME_VIEW.zoom); };
  id('resetBtn').onclick = ()=>{ resetAll(); runFilter(); saveState(); renderChips(); };

  // Export menu
  const exportDrop = id('exportDrop'); const menu = exportDrop.querySelector('.dropdown-menu');
  exportDrop.querySelector('button').onclick = ()=>{ toggleDropdown(menu); };
  on('click', document.body, (e)=>{ if (!exportDrop.contains(e.target)) menu.style.display='none'; }, true);
  id('exportStores').onclick  = ()=>{ exportStoresCsv(); if(AUTO_RESET()) { resetAll(); runFilter(); renderChips(); } };

  // Views menu
  const viewsDrop = id('viewsDrop'); const viewsMenu = id('viewsMenu'); const viewList = id('viewList');
  viewsDrop.querySelector('button').onclick = ()=> toggleDropdown(viewsMenu);
  on('click', document.body, (e)=>{ if (!viewsDrop.contains(e.target)) viewsMenu.style.display='none'; }, true);
  id('viewSave').onclick = saveCurrentView;
  rebuildViewsMenu();

  const k = { pa:id('k_pa'), p:id('k_p'), a:id('k_a'), u:id('k_u'), total:id('k_total'), staffed:id('k_staffed'), open:id('k_open'), inView:id('inView') };

  tgHeat.onchange = ()=>{ if (tgHeat.checked) updateHeat(); else clearHeat(); saveState(); };
  tgRings.onchange= ()=>{ updateRings(); saveState(); };
  tgOverlap.onchange= ()=>{ if (tgOverlap.checked) drawOverlap(); else highlightLayer.clearLayers(); saveState(); };
  tgCompare.onchange= ()=>{ compareMode = tgCompare.checked; pinnedHubs=[]; highlightLayer.clearLayers(); alert(compareMode ? 'Compare mode on: click hub markers to pin them.' : 'Compare mode off.'); saveState(); };
  tgWithin.onchange = ()=>{ runFilter(); fitToResults(); saveState(); };
  tgCluster.onchange= ()=>{ refreshLayerMode(); };

  id('snapBtn').onclick = saveSnapshot;
  id('helpBtn').onclick = ()=> id('helpModal').classList.add('show');
  id('helpClose').onclick = ()=> id('helpModal').classList.remove('show');
  id('helpModal').addEventListener('click', (e)=>{ if(e.target.id==='helpModal') e.currentTarget.classList.remove('show'); });

  // Keyboard
  window.addEventListener('keydown',(e)=>{
    if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); searchBox.focus(); searchBox.select(); }
    if (e.key.toLowerCase() === 'h'){ map.setView(HOME_VIEW.center, HOME_VIEW.zoom); }
    if (e.key.toLowerCase() === 'f' && sidepanel.classList.contains('show')){ spSearch.focus(); spSearch.select(); }
  });

  // Side panel refs
  const sidepanel = id('sidepanel');
  const spTitle = id('spTitle'); const spMeta = id('spMeta'); const spCounts = id('spCounts');
  const spRowsEl = id('spRows'); const spSearch = id('spSearch');
  const spClose = id('spClose'); const spExport = id('spExport'); const spPinBtn = id('spPinBtn'); const spPrint = id('spPrint'); const spOnlyUncovEl = id('spOnlyUncov'); const spCollapse = id('spCollapse');
  spClose.onclick = ()=> hideSidepanel();
  spCollapse.onclick = ()=> hideSidepanel();
  spSearch.addEventListener('input', ()=>{ spFilter = spSearch.value.trim().toLowerCase(); renderSidepanelList(); });
  spExport.onclick = ()=>{ exportSidepanelCsv(); if(AUTO_RESET()){ resetAll(); runFilter(); renderChips(); } };
  spPrint.onclick  = ()=>{ printSidepanelList(); if(AUTO_RESET()){ resetAll(); runFilter(); renderChips(); } };
  spPinBtn.onclick = ()=> togglePinFromPanel();
  spOnlyUncovEl.onchange = ()=>{ spOnlyUncov = spOnlyUncovEl.checked; renderSidepanelList(); };

  // radius preset chips
  document.querySelectorAll('.sp-quick .btn[data-r]').forEach(b=>{
    b.addEventListener('click', ()=>{
      radius.value = b.dataset.r; radiusLbl.textContent=b.dataset.r;
      runFilter(); updateRings(); if (spHub) openSidepanel(spHub); saveState();
    });
  });

  // ---------- Load data ----------
  showBusy(true); let spinnerFailSafe = setTimeout(()=>showBusy(false), 7000);
  try {
    STATUS.textContent = `Loading ${DATA_URL} ‚Ä¶`;
    let raw = null;
    try{
      const resp = await fetch(DATA_URL, { cache:'no-store' });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const text = await resp.text();
      raw = JSON.parse(text.replace(/^\uFEFF/,''));
      if (!Array.isArray(raw)) throw new Error('store_data.json must be a JSON array');
    }catch(fetchErr){
      console.warn('Data fetch failed, using fallback stores:', fetchErr);
      STATUS.innerHTML = `<span style="color:#a15b00;font-weight:600">Loaded fallback test data</span> ‚Äî place <code>store_data.json</code> next to this file to load real data.`;
      raw = FALLBACK_STORES;
    }

    allStores = normalizeStores(raw);
    STATUS.textContent += `  |  ${allStores.length.toLocaleString()} stores ready`;

    populateRM(allStores); populateAM(allStores); cascadeAM(); cascadeHubs();
    id('hubFilter').innerHTML = hubs.map(h=>`<option>${escape(h.name)}</option>`).join('');

    buildSearchIndex();

    if (!tryLoadSnapshot()){ tryLoadLocal(); }

    const lastQ = localStorage.getItem(LS_LAST_QUERY) || '';
    if (lastQ) { searchBox.value = lastQ; handleSearchInput(); }

    runFilter(); renderChips(); renderHubs(); updateRings();
  } catch(err){
    STATUS.innerHTML = `<span style="color:#b42318;font-weight:600">Init error:</span> ${escape(err?.message || String(err))}`;
    console.error(err);
  } finally { clearTimeout(spinnerFailSafe); showBusy(false); }

  // ---------- Search ----------
  function buildSearchIndex(){
    searchIdx = allStores.map(s => ({
      kind:'STORE', store:s, lat:s.lat, lng:s.lng,
      text: (`store ${s.storeNumberStr} ${s.storeName||''} ${s.address||''} ${s.city} ${s.state} ${s.coverageType||''} ${s.areaManager||''} ${s.regionalManager||''}`).toLowerCase()
    }));
  }
  function clearTarget(){ if (targetPin){ targetLayer.removeLayer(targetPin); targetPin=null; } }
  const targetIcon = L.divIcon({className:'', html:'<div style="background:#2f71ff;border:2px solid #fff;border-radius:50%;width:18px;height:18px;box-shadow:0 0 0 1px rgba(0,0,0,.25)"></div>', iconSize:[18,18], iconAnchor:[9,9]});
  const hoverIcon  = L.divIcon({className:'', html:'<div class="hl"></div>', iconSize:[22,22], iconAnchor:[11,11]});
  let hoverMarker=null;
  function showHover(lat,lng){ if(hoverMarker) highlightLayer.removeLayer(hoverMarker); hoverMarker=L.marker([lat,lng],{icon:hoverIcon}).addTo(highlightLayer); }
  function hideHover(){ if(hoverMarker){ highlightLayer.removeLayer(hoverMarker); hoverMarker=null; } }

  function storePopupHTML(s){
    const r = Number(radius.value)||DEFAULT_RADIUS;
    const visH = hubs.filter(h => (h.status==='accepted'?showStaffed.checked:showOpen.checked));
    let nearest = null, best = 1e9;
    visH.forEach(h=>{ const d = distMiles(s.lat,s.lng,h.coords[0],h.coords[1]); if(d<best){best=d;nearest=h;} });
    const badge = `<span style="padding:2px 6px;border-radius:999px;border:1px solid var(--border);background:${COLORS[s.coverageType]||'#eee'}22">${escape(s.coverageType||'')}</span>`;
    return `
      <div style="font-size:13px;line-height:1.35;min-width:220px">
        <div style="font-weight:800;margin-bottom:4px">Store ${escape(s.storeNumberStr)} ‚Äî ${escape(s.storeName||'')}</div>
        <div>${escape(s.address||'')}</div>
        <div>${escape(s.city||'')}, ${escape(s.state||'')}</div>
        <div style="margin:6px 0">${badge}</div>
        <div><b>Trainer City:</b> ${escape(s.trainerCity||'')}</div>
        <div><b>Area Manager:</b> ${escape(s.areaManager||'')}</div>
        <div><b>Regional Manager:</b> ${escape(s.regionalManager||'')}</div>
        ${nearest?`<div style="margin-top:6px"><b>Nearest hub:</b> ${escape(nearest.name)} ‚Ä¢ ${best.toFixed(1)} mi</div>`:''}
        <div style="color:var(--muted);margin-top:6px">Lat: ${Number(s.lat).toFixed(4)}, Lng: ${Number(s.lng).toFixed(4)}</div>
      </div>`;
  }

  function hideResults(){ searchResults.classList.remove('show'); searchResults.innerHTML=''; searchResults._data=[]; resIndex=-1; }
  function showResults(list){
    if (!list.length){ hideResults(); return; }
    searchResults.innerHTML = list.map((r,i)=>`
      <div class="res" data-i="${i}" role="option" title="Open this result">
        <div class="kind">${r.kind}</div>
        <div class="text">
          <div>${escape(r.label)}</div>
          ${r.kind==='STORE'
            ? `<div class="sub">${escape(r.store.address||'')} ¬∑ ${escape(r.store.city||'')}, ${escape(r.store.state||'')} ¬∑ ${escape(r.store.coverageType||'')}</div>`
            : (r.kind==='NEAR' ? `<div class="sub">${escape(r.store.address||'')} ¬∑ ${escape(r.store.city||'')}, ${escape(r.store.state||'')}</div>` : '')
          }
        </div>
      </div>`).join('');
    searchResults.classList.add('show');
    Array.from(searchResults.querySelectorAll('.res')).forEach(el=>{
      el.addEventListener('mouseenter', ()=>{ const d = searchResults._data[Number(el.dataset.i)]; if(d && d.lat) showHover(d.lat,d.lng); });
      el.addEventListener('mouseleave', hideHover);
      el.addEventListener('click', ()=>{ const d = searchResults._data[Number(el.dataset.i)]; selectResult(d); });
    });
    searchResults._data = list; resIndex=-1;
  }
  function toResFromStore(s,score,kind='STORE'){ return { kind, store:s, label:`Store ${s.storeNumberStr} ‚Äî ${s.storeName||''}, ${s.city}, ${s.state}`, lat:s.lat, lng:s.lng, score }; }
  function toCityRes(city,state,lat,lng,score){ return { kind:'CITY', label:`${city}, ${state}`, lat, lng, score }; }
  function smartNearest(center,limit=5){
    return allStores.map(s => [distMiles(center.lat,center.lng,s.lat,s.lng), s]).sort((a,b)=>a[0]-b[0]).slice(0,limit).map((x,i)=>toResFromStore(x[1], 80-i,'NEAR'));
  }
  function handleSearchInput(){
    if (!allStores.length){ hideResults(); return; }
    const qraw = (searchBox.value||'').trim();
    const q = qraw.toLowerCase();
    localStorage.setItem(LS_LAST_QUERY, qraw);
    if (!q){ showResults(smartNearest(map.getCenter(), 8)); searchBadge.classList.remove('show'); return; }
    if (q==='near' || q==='near me'){ showResults(smartNearest(map.getCenter(),8)); return; }
    const items = [];
    const numInside = q.match(/\b(\d{3,6})\b/);
    if (numInside){
      const s = allStores.find(x => x.storeNumberStr === numInside[1]);
      if (s) items.push(toResFromStore(s, 120));
    }
    if (searchIdx && searchIdx.length){
      searchIdx.forEach(it => { if (it.text.includes(q)) items.push(toResFromStore(it.store, 70)); });
    }
    const sExact = allStores.find(x => (`${x.city}, ${x.state}`).toLowerCase() === q);
    if (sExact) items.unshift(toCityRes(sExact.city, sExact.state, sExact.lat, sExact.lng, 90));
    hubs.forEach(h=>{ if (h.name.toLowerCase().includes(q)) items.push({ kind:'HUB', label:h.name, lat:h.coords[0], lng:h.coords[1], score:60 }); });
    const seen=new Set(), out=[];
    items.sort((a,b)=>b.score-a.score).forEach(it=>{
      const k=it.kind+'|'+it.label+'|'+it.lat+'|'+it.lng;
      if(!seen.has(k)){ seen.add(k); out.push(it); }
    });
    showResults(out.slice(0,60));
  }
  searchBox.addEventListener('input', handleSearchInput);
  searchBox.addEventListener('keydown', (e)=>{
    const items = searchResults._data || [];
    if (e.key === 'ArrowDown'){ e.preventDefault(); resIndex = Math.min(items.length-1,resIndex+1); highlightResult(); }
    if (e.key === 'ArrowUp'){ e.preventDefault(); resIndex = Math.max(0,resIndex-1); highlightResult(); }
    if (e.key === 'Enter'){
      e.preventDefault();
      if (resIndex>=0 && items[resIndex]) { selectResult(items[resIndex]); }
    }
    if (e.key === 'Escape'){ hideResults(); }
  });
  function highlightResult(){
    Array.from(searchResults.querySelectorAll('.res')).forEach((el,i)=>{
      el.classList.toggle('active', i===resIndex);
      if(i===resIndex){
        el.scrollIntoView({block:'nearest'});
        const d=searchResults._data[i]; if(d && d.lat) showHover(d.lat,d.lng);
      }
    });
  }
  function selectResult(d){
    hideResults(); hideHover();
    if(!d) return;
    if(d.kind==='STORE' || d.kind==='NEAR'){ openStorePopup(d.store); return; }
    if(d.kind==='CITY' || d.kind==='HUB'){
      const latlng = [d.lat,d.lng];
      showPinPopup(latlng, `
        <div style="font-size:13px;line-height:1.35;min-width:220px">
          <div style="font-weight:800;margin-bottom:4px">${escape(d.label)}</div>
          <div style="color:var(--muted)">Lat: ${Number(d.lat).toFixed(4)}, Lng: ${Number(d.lng).toFixed(4)}</div>
        </div>
      `);
      map.panInside(latlng, { paddingTopLeft:[20,20], paddingBottomRight:[20,20] });
      return;
    }
  }

  function openStorePopup(store){
    const m = ensureMarkerForStore(store);
    const padRight = sidepanel.classList.contains('show') ? 420 : 20;
    const pan = () => map.panInside(m.getLatLng(), { paddingTopLeft:[20,20], paddingBottomRight:[padRight,20] });
    const open = () => {
      if (!m.getPopup()) m.bindPopup(storePopupHTML(store));
      m.openPopup();
    };
    if (tgCluster.checked) {
      markers.zoomToShowLayer(m, () => {
        pan();
        requestAnimationFrame(() => requestAnimationFrame(open));
      });
    } else {
      pan();
      requestAnimationFrame(open);
    }
  }

  function showPinPopup(latlng, html){
    if(!targetPin){ targetPin = L.marker(latlng,{icon:targetIcon}).addTo(targetLayer); }
    else { targetPin.setLatLng(latlng); }
    const p = L.popup({autoClose:true, closeOnClick:true, maxWidth:320}).setLatLng(latlng).setContent(html);
    p.openOn(map);
  }

  // ---------- Filtering ----------
  function storeFilter(s){
    const covSel = Array.from(covFilter.selectedOptions).map(o=>o.value);
    const covOK = covSel.includes('All') || covSel.includes(s.coverageType || '');

    const rmSel = Array.from(rmFilter.selectedOptions).map(o=>o.value);
    const amSel = Array.from(amFilter.selectedOptions).map(o=>o.value);
    const rmOK = rmSel.includes('All') || rmSel.includes(s.regionalManager || '');
    const amOK = amSel.includes('All') || amSel.includes(s.areaManager || '');

    const hubSel = Array.from(hubFilter.selectedOptions).map(o=>o.value);
    const hubOK = hubSel.length === 0 || hubSel.includes(s.trainerCity || '');

    let withinOK = true;
    if (tgWithin.checked){
      const r = Number(radius.value) || DEFAULT_RADIUS;
      withinOK = visibleHubs().some(h => distMiles(s.lat, s.lng, h.coords[0], h.coords[1]) <= r);
    }
    return covOK && rmOK && amOK && hubOK && withinOK;
  }

  function runFilter(){
    markerByStore.clear();
    if(tgCluster.checked){ markers.clearLayers(); } else { plainMarkers.clearLayers(); }

    filteredStores = allStores.filter(storeFilter);

    const ms = filteredStores.map(s=>{
      const m = L.circleMarker([s.lat,s.lng], {
        radius:5, weight:1, fillOpacity:.9, color:'#fff',
        fillColor: COLORS[s.coverageType] || '#999'
      });
      m.store = s;
      m.bindPopup(storePopupHTML(s));
      markerByStore.set(s.storeNumberStr, m);
      return m;
    });

    if (tgCluster.checked){ markers.addLayers(ms); }
    else { plainMarkers.addLayer(L.layerGroup(ms)); }

    updateCounts();
    updateInViewCount();
    if (id('tgHeat').checked) updateHeat();
    if (id('tgRings').checked) updateRings();
  }

  function updateCounts(){
    const cts=coverageCounts((tgCluster.checked? markers.getLayers() : plainMarkers.getLayers()[0]?.getLayers?.() || []).map(m=>m));
    k.pa.textContent=cts["Premium + Acosta"]||0;
    k.p.textContent =cts["Premium Only"]||0;
    k.a.textContent =cts["Acosta Only"]||0;
    k.u.textContent =cts["Uncovered"]||0;
    k.total.textContent=filteredStores.length;
    k.staffed.textContent=hubs.filter(h=>h.status==='accepted').length;
    k.open.textContent   =hubs.filter(h=>h.status==='open').length;
  }
  function updateInViewCount(){
    const b=map.getBounds();
    const inV=filteredStores.filter(s=>b.contains([s.lat,s.lng])).length;
    k.inView.textContent=`In view: ${inV}`;
  }

  // ---------- Heatmap ----------
  function updateHeat(){
    clearHeat();
    const pts=filteredStores.map(s=>[s.lat,s.lng,0.6]);
    heatLayerHolder.layer=L.heatLayer(pts,{radius:18,blur:22,maxZoom:10});
    map.addLayer(heatLayerHolder.layer);
  }
  function clearHeat(){ if(heatLayerHolder.layer){ map.removeLayer(heatLayerHolder.layer); heatLayerHolder.layer=null; } }

  // ---------- Utility helpers ----------
  function id(x){ return document.getElementById(x); }
  function on(ev,el,fn,capture){ el.addEventListener(ev,fn,capture||false); }
  function getCSS(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
  function escape(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function distMiles(lat1,lng1,lat2,lng2){ const R=3958.8; const toRad=d=>d*Math.PI/180; const dLat=toRad(lat2-lat1); const dLon=toRad(lng2-lng1); const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
  function coverageCounts(markersArr){ const out={}; markersArr.forEach(m=>{ const s=m?.store; if(!s) return; out[s.coverageType]=(out[s.coverageType]||0)+1; }); return out; }
  function toggleDropdown(menu){ menu.style.display=menu.style.display==='block'?'none':'block'; }
  function setMulti(sel,arr){ Array.from(sel.options).forEach(o=>{o.selected=arr.includes(o.value);}); }
  function filterSelect(selectEl, q){
    const query = (q||'').toLowerCase();
    Array.from(selectEl.options).forEach(opt=>{
      if (opt.value === 'All') { opt.hidden = false; return; }
      const txt = (opt.textContent||'').toLowerCase();
      opt.hidden = query && !txt.includes(query);
    });
  }
  function clusterIconByDominantCoverage(cluster){
    const children = cluster.getAllChildMarkers();
    const counts = { 'Premium + Acosta':0,'Premium Only':0,'Acosta Only':0,'Uncovered':0 };
    children.forEach(m=>{ const s = m.store; if(!s) return; counts[s.coverageType] = (counts[s.coverageType] || 0) + 1; });
    const domKey = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'Uncovered';
    const cls =
      domKey === 'Premium + Acosta' ? 'marker-pa' :
      domKey === 'Premium Only'     ? 'marker-p'  :
      domKey === 'Acosta Only'      ? 'marker-a'  : 'marker-u';
    const total = children.length;
    const html = `<div><span>${total}</span></div>`;
    return L.divIcon({ html, className: `marker-cluster ${cls}`, iconSize: L.point(40, 40) });
  }

  function visibleHubs(){
    return hubs.filter(h =>
      (h.status === 'accepted' && showStaffed.checked) ||
      (h.status === 'open'     && showOpen.checked)
    );
  }

  function ensureMarkerForStore(store){
    let m = markerByStore.get(store.storeNumberStr);
    if (!m){
      m = L.circleMarker([store.lat, store.lng], {
        radius: 5, weight: 1, fillOpacity: .9, color: '#fff',
        fillColor: COLORS[store.coverageType] || '#999'
      });
      m.store = store;
      m.bindPopup(storePopupHTML(store));
      markerByStore.set(store.storeNumberStr, m);
      if (tgCluster.checked) markers.addLayer(m);
      else {
        let g = plainMarkers.getLayers()[0];
        if (!g){ g = L.layerGroup().addTo(plainMarkers); }
        g.addLayer(m);
      }
    }
    return m;
  }

  // ---------- Hubs (render icons & interactions) ----------
  const hubLayer = L.layerGroup().addTo(map);

// ---------- Hubs (render icons & interactions) ----------
function renderHubs(){
  hubLayer.clearLayers();
  visibleHubs().forEach(h=>{
    const el = document.createElement('div');
    el.className = `hub ${h.status==='accepted' ? 'staffed' : 'open'}`;
    const icon = L.divIcon({ className:'', html: el, iconSize:[20,20], iconAnchor:[10,10] });
    const m = L.marker(h.coords, { icon, title:h.name }).addTo(hubLayer);
    m.hub = h;
    m.on('click', ()=> compareMode ? togglePin(h) : openSidepanel(h));
    m.on('mouseover', ()=> m.bindTooltip(h.name, {direction:'top', offset:[0,-8]}).openTooltip());
    m.on('mouseout',  ()=> m.closeTooltip());
  });
}

  function updateRings(){
    ringLayer.clearLayers();
    if(!tgRings.checked) return;
    const r = Number(radius.value) || DEFAULT_RADIUS;
    visibleHubs().forEach(h=>{
      ringLayer.addLayer(L.circle(h.coords,{radius:r*1609,color:'#333',weight:1,fill:false,opacity:.4}));
    });
  }

  function drawOverlap(){
    highlightLayer.clearLayers();
    if(!tgOverlap.checked) return;
    const r = Number(radius.value)||DEFAULT_RADIUS;
    const vis = visibleHubs();
    filteredStores.forEach(s=>{
      let cnt = 0;
      vis.forEach(h => { if (distMiles(s.lat,s.lng,h.coords[0],h.coords[1]) <= r) cnt++; });
      if (cnt >= 2){
        highlightLayer.addLayer(L.circleMarker([s.lat,s.lng],{radius:7,color:'#111',weight:2,fillOpacity:0.2}));
      }
    });
  }

  function togglePin(h){
    const i = pinnedHubs.findIndex(x=>x.id===h.id);
    if (i>=0){ pinnedHubs.splice(i,1); } else { pinnedHubs.push(h); }
    drawOverlap();
  }
  function togglePinFromPanel(){
  if (!spHub) return;
  togglePin(spHub);
  const isPinned = pinnedHubs.some(x => x.id === spHub.id);
  spPinBtn.textContent = isPinned ? 'Unpin' : 'Pin';
  alert(isPinned ? 'Pinned for compare' : 'Unpinned');
}


  // ---------- Sidepanel ----------
  function openSidepanel(h){
    spHub = h;
    sidepanel.classList.add('show');
    spTitle.textContent = h.name;
    renderSidepanelMeta();
    renderSidepanelList(true);
    // pan to the hub with space for the panel
    const padRight = 420;
    map.panInside(h.coords, { paddingTopLeft:[20,20], paddingBottomRight:[padRight,20] });
    // set button label based on pin state
    spPinBtn.textContent = pinnedHubs.some(x=>x.id===h.id) ? 'Unpin' : 'Pin';
  }

  function hideSidepanel(){
    sidepanel.classList.remove('show');
    spHub = null;
    spRows = [];
    spRowsEl.innerHTML = '';
  }

  function renderSidepanelMeta(){
    if(!spHub) return;
    const r = Number(radius.value)||DEFAULT_RADIUS;
    const stores = storesWithin(spHub.coords, r);
    const totals = {
      'Premium + Acosta': 0, 'Premium Only': 0, 'Acosta Only': 0, 'Uncovered': 0
    };
    stores.forEach(s=>{ totals[s.coverageType] = (totals[s.coverageType]||0) + 1; });
    spMeta.innerHTML = `
      <div><b>Radius:</b> ${r} mi</div>
      <div style="margin-top:4px;display:flex;gap:8px;flex-wrap:wrap">
        <span class="sp-chip"><span class="dot" style="background:${COLORS['Premium + Acosta']}"></span> P+A: <b>${totals['Premium + Acosta']||0}</b></span>
        <span class="sp-chip"><span class="dot" style="background:${COLORS['Premium Only']}"></span> Premium: <b>${totals['Premium Only']||0}</b></span>
        <span class="sp-chip"><span class="dot" style="background:${COLORS['Acosta Only']}"></span> Acosta: <b>${totals['Acosta Only']||0}</b></span>
        <span class="sp-chip"><span class="dot" style="background:${COLORS['Uncovered']}"></span> Uncovered: <b>${totals['Uncovered']||0}</b></span>
        <span class="sp-chip">Total: <b>${stores.length}</b></span>
      </div>
    `;
  }

  function renderSidepanelList(rebuild=false){
    if(!spHub) return;
    const r = Number(radius.value)||DEFAULT_RADIUS;
    let list = storesWithin(spHub.coords, r);
    if (spOnlyUncov) list = list.filter(s=> (s.coverageType||'')==='Uncovered');

    // remember base list for print/export
    spRows = list.slice();

    // search filter inside panel
    const q = (spFilter||'').toLowerCase();
    if (q){
      list = list.filter(s =>
        (s.storeNumberStr||'').toLowerCase().includes(q) ||
        (s.address||'').toLowerCase().includes(q) ||
        (s.city||'').toLowerCase().includes(q) ||
        (s.state||'').toLowerCase().includes(q) ||
        (s.coverageType||'').toLowerCase().includes(q)
      );
    }

    // sort by store #
    list.sort((a,b)=> (a.storeNumberStr||'').localeCompare(b.storeNumberStr||''));

    // counts
    spCounts.innerHTML = `
      <span class="sp-chip">In list: <b>${list.length}</b></span>
      ${spOnlyUncov?'<span class="sp-chip">Uncovered only</span>':''}
    `;

    // rows
    spRowsEl.innerHTML = list.map(s => `
      <div class="row" data-id="${escape(s.storeNumberStr)}" title="Zoom to store">
        <div class="num">#${escape(s.storeNumberStr)}</div>
        <div class="text">
          <div class="title">${escape(s.storeName||'')}</div>
          <div class="addr">${escape(s.address||'')} ¬∑ ${escape(s.city||'')}, ${escape(s.state||'')}</div>
        </div>
        <div class="kind">${escape(s.coverageType||'')}</div>
      </div>
    `).join('');

    // attach handlers
    Array.from(spRowsEl.querySelectorAll('.row')).forEach(el=>{
      el.addEventListener('click', ()=>{
        const idd = el.getAttribute('data-id');
        const s = spRows.find(x => x.storeNumberStr === idd);
        if (s) openStorePopup(s);
        Array.from(spRowsEl.querySelectorAll('.row')).forEach(e=>e.classList.remove('active'));
        el.classList.add('active');
      });
    });

    if (rebuild) renderSidepanelMeta();
  }

  function storesWithin(center, rmi){
    const [clat, clng] = center;
    return filteredStores.filter(s => distMiles(clat,clng,s.lat,s.lng) <= rmi);
  }

  // ---------- Fit / Layer mode ----------
  function fitToResults(){
    const layers = [];
    if (tgCluster.checked) {
      markers.eachLayer(m=>layers.push(m));
    } else {
      const g = plainMarkers.getLayers()[0];
      if (g) g.eachLayer(m=>layers.push(m));
    }
    // optionally include visible hubs when filtering to hubs
    visibleHubs().forEach(h => {
      layers.push(L.marker(h.coords));
    });

    if (!layers.length){ map.setView(HOME_VIEW.center, HOME_VIEW.zoom); return; }
    const group = L.featureGroup(layers);
    const padRight = sidepanel.classList.contains('show') ? 420 : 20;
    map.fitBounds(group.getBounds(), { paddingTopLeft:[20,20], paddingBottomRight:[padRight,20], maxZoom: 11 });
  }

  function refreshLayerMode(){
    // switch between cluster and plain markers without regenerating store markers
    if (tgCluster.checked){
      map.removeLayer(plainMarkers);
      map.addLayer(markers);
    } else {
      map.removeLayer(markers);
      map.addLayer(plainMarkers);
    }
    runFilter();
  }

  // ---------- Cascading filters ----------
  function unique(list){ return Array.from(new Set(list.filter(Boolean))).sort(); }

  function populateRM(stores){
    const rms = unique(stores.map(s=>s.regionalManager));
    rmFilter.innerHTML = ['<option value="All" selected>All</option>', ...rms.map(r=>`<option>${escape(r)}</option>`)].join('');
  }
  function populateAM(stores){
    const ams = unique(stores.map(s=>s.areaManager));
    amFilter.innerHTML = ['<option value="All" selected>All</option>', ...ams.map(a=>`<option>${escape(a)}</option>`)].join('');
  }

  function cascadeAM(){
    const rmSel = Array.from(rmFilter.selectedOptions).map(o=>o.value);
    let pool = allStores.slice();
    if (!rmSel.includes('All')){
      pool = pool.filter(s => rmSel.includes(s.regionalManager||''));
    }
    const ams = unique(pool.map(s=>s.areaManager));
    const prev = Array.from(amFilter.selectedOptions).map(o=>o.value);
    amFilter.innerHTML = ['<option value="All">All</option>', ...ams.map(a=>`<option>${escape(a)}</option>`)].join('');
    // keep previous if possible
    setMulti(amFilter, prev.filter(v=>v==='All' || ams.includes(v)));
  }

  function cascadeHubs(){
    const rmSel = Array.from(rmFilter.selectedOptions).map(o=>o.value);
    const amSel = Array.from(amFilter.selectedOptions).map(o=>o.value);
    let pool = allStores.slice();
    if (!rmSel.includes('All')) pool = pool.filter(s => rmSel.includes(s.regionalManager||''));
    if (!amSel.includes('All')) pool = pool.filter(s => amSel.includes(s.areaManager||''));
    const hubsFromData = unique(pool.map(s=>s.trainerCity).filter(Boolean));
    hubFilter.innerHTML = hubsFromData.map(h=>`<option>${escape(h)}</option>`).join('');
  }

  // ---------- Export / Print ----------
  function exportStoresCsv(){
    const rows = [
      ['Store #','Name','Address','City','State','Coverage','Area Manager','Regional Manager','Trainer City','Lat','Lng'],
      ...filteredStores.map(s=>[
        s.storeNumberStr, s.storeName||'', s.address||'', s.city||'', s.state||'',
        s.coverageType||'', s.areaManager||'', s.regionalManager||'', s.trainerCity||'',
        s.lat, s.lng
      ])
    ];
    downloadCsv(rows, `filtered_stores_${Date.now()}.csv`);
  }

  function exportSidepanelCsv(){
    if(!spHub){ alert('Open a hub panel first.'); return; }
    const r = Number(radius.value)||DEFAULT_RADIUS;
    const rows = [
      ['Hub','Radius(mi)','Store #','Name','Address','City','State','Coverage','Area Manager','Regional Manager','Lat','Lng'],
      ...spRows.map(s=>[
        spHub.name, r, s.storeNumberStr, s.storeName||'', s.address||'', s.city||'', s.state||'',
        s.coverageType||'', s.areaManager||'', s.regionalManager||'', s.lat, s.lng
      ])
    ];
    downloadCsv(rows, `${slug(spHub.name)}_${r}mi_${Date.now()}.csv`);
  }

function printSidepanelList(){
  if(!spHub){ alert('Open a hub panel first.'); return; }
  const r = Number(radius.value)||DEFAULT_RADIUS;
  const win = window.open('', '_blank');
  const rows = spRows.map(s=>`
    <tr>
      <td>#${escape(s.storeNumberStr)}</td>
      <td>${escape(s.storeName||'')}</td>
      <td>${escape(s.address||'')}, ${escape(s.city||'')}, ${escape(s.state||'')}</td>
      <td>${escape(s.coverageType||'')}</td>
      <td>${escape(s.areaManager||'')}</td>
      <td>${escape(s.regionalManager||'')}</td>
    </tr>
  `).join('');
  win.document.write(`
    <html><head><title>${escape(spHub.name)} ‚Äî ${r}mi</title>
    <style>
      body{font-family:system-ui,Segoe UI,Arial,sans-serif;padding:20px}
      table{border-collapse:collapse;width:100%} th,td{border:1px solid #ddd;padding:6px 8px;font-size:12px}
      th{background:#f3f4f6;text-align:left}
      h2{margin:0 0 8px}
      .meta{color:#555;margin-bottom:10px}
    </style></head><body>
      <h2>${escape(spHub.name)}</h2>
      <div class="meta">Radius: <b>${r} mi</b> ‚Ä¢ Stores: <b>${spRows.length}</b></div>
      <table>
        <thead><tr><th>Store</th><th>Name</th><th>Address</th><th>Coverage</th><th>AM</th><th>RM</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <script>window.print()<\\/script>
    </body></html>
  `);
  win.document.close();
}


  function downloadCsv(rows, fname){
    const csv = rows.map(r=>r.map(v=>csvCell(v)).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fname;
    a.click();
    URL.revokeObjectURL(a.href);
  }
  function csvCell(v){
    if (v==null) return '';
    const s = String(v).replace(/"/g,'""');
    if (/[,"\n]/.test(s)) return `"${s}"`;
    return s;
  }
  function slug(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }

  // ---------- Views / Snapshots / State ----------
  function saveState(){
    const state = {
      map: { center: map.getCenter(), zoom: map.getZoom() },
      toggles: {
        heat: tgHeat.checked, rings: tgRings.checked, overlap: tgOverlap.checked,
        compare: tgCompare.checked, within: tgWithin.checked, cluster: tgCluster.checked
      },
      filters: {
        cov: Array.from(covFilter.selectedOptions).map(o=>o.value),
        rm: Array.from(rmFilter.selectedOptions).map(o=>o.value),
        am: Array.from(amFilter.selectedOptions).map(o=>o.value),
        hub: Array.from(hubFilter.selectedOptions).map(o=>o.value)
      },
      radius: Number(radius.value)||DEFAULT_RADIUS,
      showStaffed: showStaffed.checked,
      showOpen: showOpen.checked
    };
    localStorage.setItem(LS_STATE, JSON.stringify(state));
  }

  function tryLoadLocal(){
    const raw = localStorage.getItem(LS_STATE);
    if(!raw) return false;
    try{
      const st = JSON.parse(raw);
      if (st.map) map.setView([st.map.center.lat, st.map.center.lng], st.map.zoom);
      if (st.toggles){
        tgHeat.checked = !!st.toggles.heat;
        tgRings.checked= !!st.toggles.rings;
        tgOverlap.checked=!!st.toggles.overlap;
        tgCompare.checked=!!st.toggles.compare; compareMode = tgCompare.checked;
        tgWithin.checked =!!st.toggles.within;
        tgCluster.checked= !!st.toggles.cluster;
      }
      if (st.filters){
        setMulti(covFilter, st.filters.cov||['All']);
        setMulti(rmFilter,  st.filters.rm||['All']);
        cascadeAM();
        setMulti(amFilter,  st.filters.am||['All']);
        cascadeHubs();
        setMulti(hubFilter, st.filters.hub||[]);
      }
      if (st.radius){ radius.value = st.radius; radiusLbl.textContent = st.radius; }
      if ('showStaffed' in st) showStaffed.checked = !!st.showStaffed;
      if ('showOpen'    in st) showOpen.checked    = !!st.showOpen;
      return true;
    }catch(e){ console.warn('Bad saved state', e); return false; }
  }

  function saveCurrentView(){
    const name = prompt('Name this view:');
    if(!name) return;
    const views = JSON.parse(localStorage.getItem(LS_VIEWS) || '[]');
    const state = JSON.parse(localStorage.getItem(LS_STATE) || '{}');
    views.push({ id: Date.now(), name, state });
    localStorage.setItem(LS_VIEWS, JSON.stringify(views));
    rebuildViewsMenu();
  }

  function rebuildViewsMenu(){
    const views = JSON.parse(localStorage.getItem(LS_VIEWS) || '[]');
    viewList.innerHTML = views.map(v=>`
      <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;padding:4px 0">
        <button class="btn" data-id="${v.id}" style="flex:1;text-align:left">${escape(v.name)}</button>
        <button class="btn link del" data-id="${v.id}" title="Delete">Delete</button>
      </div>
    `).join('') || '<div style="color:var(--muted);padding:6px">No saved views yet.</div>';
    Array.from(viewList.querySelectorAll('button.btn[data-id]')).forEach(b=>{
      b.addEventListener('click', (e)=>{
        if (b.classList.contains('del')) return;
        const idv = Number(b.getAttribute('data-id'));
        const views = JSON.parse(localStorage.getItem(LS_VIEWS) || '[]');
        const v = views.find(x=>x.id===idv);
        if (!v) return;
        localStorage.setItem(LS_STATE, JSON.stringify(v.state));
        tryLoadLocal();
        runFilter(); renderChips(); renderHubs(); updateRings(); fitToResults();
      });
    });
    Array.from(viewList.querySelectorAll('button.del')).forEach(b=>{
      b.addEventListener('click', ()=>{
        const idv = Number(b.getAttribute('data-id'));
        const views = JSON.parse(localStorage.getItem(LS_VIEWS) || '[]').filter(x=>x.id!==idv);
        localStorage.setItem(LS_VIEWS, JSON.stringify(views));
        rebuildViewsMenu();
      });
    });
  }

  function saveSnapshot(){
    const st = JSON.parse(localStorage.getItem(LS_STATE) || '{}');
    const hash = btoa(unescape(encodeURIComponent(JSON.stringify(st))));
    const url = `${location.origin}${location.pathname}#${hash}`;
    navigator.clipboard?.writeText(url);
    alert('Snapshot link copied to clipboard.');
  }

  function tryLoadSnapshot(){
    if (!location.hash) return false;
    try{
      const json = decodeURIComponent(escape(atob(location.hash.slice(1))));
      const st = JSON.parse(json);
      localStorage.setItem(LS_STATE, JSON.stringify(st));
      location.hash = '';
      tryLoadLocal();
      return true;
    }catch(e){ console.warn('Invalid snapshot in URL', e); return false; }
  }

  function renderChips(){
    const chips = [];
    const cov = Array.from(covFilter.selectedOptions).map(o=>o.value).filter(v=>v!=='All');
    const rm  = Array.from(rmFilter.selectedOptions).map(o=>o.value).filter(v=>v!=='All');
    const am  = Array.from(amFilter.selectedOptions).map(o=>o.value).filter(v=>v!=='All');
    const hb  = Array.from(hubFilter.selectedOptions).map(o=>o.value);
    if (cov.length) chips.push(`<span class="chip">Coverage: ${cov.map(escape).join(', ')}</span>`);
    if (rm.length)  chips.push(`<span class="chip">RM: ${rm.map(escape).join(', ')}</span>`);
    if (am.length)  chips.push(`<span class="chip">AM: ${am.map(escape).join(', ')}</span>`);
    if (hb.length)  chips.push(`<span class="chip">Hubs: ${hb.map(escape).join(', ')}</span>`);
    if (tgWithin.checked) chips.push(`<span class="chip">Within hubs</span>`);
    activeChips.innerHTML = chips.join('') || '<span class="muted" style="margin-left:10px">No active chips</span>';
  }

  function resetAll(){
    tgHeat.checked = false; clearHeat();
    tgRings.checked = false; updateRings();
    tgOverlap.checked = false; highlightLayer.clearLayers();
    tgCompare.checked = false; compareMode=false; pinnedHubs=[];
    tgWithin.checked = false;
    tgCluster.checked = true;
    showStaffed.checked = true; showOpen.checked = true;
    radius.value = DEFAULT_RADIUS; radiusLbl.textContent = DEFAULT_RADIUS;
    setMulti(covFilter, ['All']);
    setMulti(rmFilter, ['All']); cascadeAM();
    setMulti(amFilter, ['All']); cascadeHubs();
    setMulti(hubFilter, []);
    searchBox.value=''; localStorage.removeItem(LS_LAST_QUERY); hideResults(); clearTarget();
    map.setView(HOME_VIEW.center, HOME_VIEW.zoom);
  }

  // ---------- Sandbox (what-if ring) ----------
  let sandboxOpen = false;
  let sandboxCircle = null;
  let sandboxMarker = null;

  id('sandboxBtn').addEventListener('click', ()=>{
    sandboxOpen = !sandboxOpen;
    id('sandboxPanel').style.display = sandboxOpen ? 'block' : 'none';
    if (!sandboxOpen){
      if (sandboxCircle) ringLayer.removeLayer(sandboxCircle), sandboxCircle=null;
      if (sandboxMarker) highlightLayer.removeLayer(sandboxMarker), sandboxMarker=null;
      id('sandboxStats').innerHTML = '';
      id('sandboxAddr').value = '';
      id('sandboxGeoMsg').textContent = '';
      return;
    }
    // initialize at map center
    const c = map.getCenter();
    placeSandbox([c.lat, c.lng], Number(id('sandboxR').value)||DEFAULT_RADIUS);
  });

  id('sandboxR').addEventListener('input', ()=>{
    id('sandboxRlbl').textContent = id('sandboxR').value;
    refreshSandbox();
  });

  map.on('click', (e)=>{
    if (!sandboxOpen) return;
    placeSandbox([e.latlng.lat, e.latlng.lng], Number(id('sandboxR').value)||DEFAULT_RADIUS);
  });

  id('sandboxGeocode').addEventListener('click', ()=>{
    const s = id('sandboxAddr').value.trim();
    const out = id('sandboxGeoMsg');
    if (!s){ out.textContent='Enter an address or "lat,lng".'; return; }
    const ll = tryParseLatLng(s);
    if (ll){
      out.textContent = 'Using coordinates you entered.';
      placeSandbox(ll, Number(id('sandboxR').value)||DEFAULT_RADIUS);
    } else {
      out.innerHTML = 'No geocoder configured for offline use. Enter "lat,lng" (e.g., 33.52,-86.80).';
    }
  });

  id('sandboxListBtn').addEventListener('click', ()=>{
    if (!sandboxMarker) { alert('Place the sandbox ring first (click the map or enter lat,lng).'); return; }
    // mimic sidepanel for sandbox
    const fakeHub = { name: 'Sandbox Hub', coords: sandboxMarker.getLatLng() };
    openSidepanel(fakeHub);
  });

  function placeSandbox([lat,lng], r){
    if (sandboxMarker) highlightLayer.removeLayer(sandboxMarker);
    sandboxMarker = L.marker([lat,lng], { icon:hoverIcon }).addTo(highlightLayer);
    if (sandboxCircle) ringLayer.removeLayer(sandboxCircle);
    sandboxCircle = L.circle([lat,lng], { radius:r*1609, color:'#0b5bd3', weight:1.5, fill:false, opacity:.7 }).addTo(ringLayer);
    refreshSandbox();
    map.panInside([lat,lng], { paddingTopLeft:[20,20], paddingBottomRight:[20,20] });
  }
  function refreshSandbox(){
    if (!sandboxCircle) return;
    const r = Number(id('sandboxR').value)||DEFAULT_RADIUS;
    sandboxCircle.setRadius(r*1609);
    const c = sandboxCircle.getLatLng();
    const list = storesWithin([c.lat, c.lng], r);
    const totals = { 'Premium + Acosta':0,'Premium Only':0,'Acosta Only':0,'Uncovered':0 };
    list.forEach(s=>{ totals[s.coverageType] = (totals[s.coverageType]||0) + 1; });
    id('sandboxRlbl').textContent = r;
    id('sandboxStats').innerHTML = `
      <div><b>${list.length}</b> stores in ${r} mi</div>
      <div style="margin-top:4px;display:flex;gap:8px;flex-wrap:wrap">
        <span class="sp-chip"><span class="dot" style="background:${COLORS['Premium + Acosta']}"></span> P+A: <b>${totals['Premium + Acosta']||0}</b></span>
        <span class="sp-chip"><span class="dot" style="background:${COLORS['Premium Only']}"></span> Premium: <b>${totals['Premium Only']||0}</b></span>
        <span class="sp-chip"><span class="dot" style="background:${COLORS['Acosta Only']}"></span> Acosta: <b>${totals['Acosta Only']||0}</b></span>
        <span class="sp-chip"><span class="dot" style="background:${COLORS['Uncovered']}"></span> Uncovered: <b>${totals['Uncovered']||0}</b></span>
      </div>
    `;
  }

  function tryParseLatLng(s){
    const m = s.match(/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/);
    if (!m) return null;
    const lat = parseFloat(m[1]), lng = parseFloat(m[2]);
    if (isNaN(lat)||isNaN(lng)) return null;
    if (lat<-90||lat>90||lng<-180||lng>180) return null;
    return [lat,lng];
  }

  // ---------- Store normalization ----------
  function normalizeStores(arr){
    return arr.map(o=>{
      const s = { ...o };
      s.storeNumberStr = String(o.storeNumberStr ?? o.Store ?? o.storeNumber ?? o['Store #'] ?? '').trim();
      s.storeName  = o.storeName ?? o.Name ?? o['Store Name'] ?? 'Walmart';
      s.address    = o.address ?? o.Address ?? '';
      s.city       = o.city ?? o.City ?? '';
      s.state      = o.state ?? o.State ?? '';
      s.coverageType = o.coverageType ?? o.Coverage_Type ?? o.Covered_By ?? 'Uncovered';
      s.areaManager   = o.areaManager ?? o.AreaMgr ?? o['Area Mgr'] ?? o['Area Manager'] ?? '';
      s.regionalManager = o.regionalManager ?? o.RegMgr ?? o['Regional Manager'] ?? '';
      s.trainerCity  = o.trainerCity ?? o.Assigned_Premium ?? o['Trainer City'] ?? '';
      s.lat = Number(o.lat ?? o.Lat ?? o.latitude ?? o.Latitude);
      s.lng = Number(o.lng ?? o.Lon ?? o.Lng ?? o.longitude ?? o.Longitude);
      return s;
    }).filter(s => Number.isFinite(s.lat) && Number.isFinite(s.lng));
  }

  // ---------- Search badge logic ----------
  searchBox.addEventListener('focus', ()=> searchBadge.classList.add('show'));
  searchBox.addEventListener('blur',  ()=> searchBadge.classList.remove('show'));

  // ensure first search opens popup (worked around clustering timing)
  function openStorePopupFirstSafe(store){
    const m = ensureMarkerForStore(store);
    if (tgCluster.checked) {
      markers.zoomToShowLayer(m, () => {
        setTimeout(()=>{ openStorePopup(store); }, 0);
      });
    } else {
      openStorePopup(store);
    }
  }

  // ---------- Busy ----------
  function showBusy(v){ busy.hidden = !v; }

  // ---------- Final kickers ----------
  renderHubs();
  updateRings();

})(); // end IIFE
</script>
</body>
</html>
