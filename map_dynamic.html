<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Premium Retail Trainer Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  :root{
    --blue:#2f71ff; --violet:#6a1b9a; --gray:#9ea3a8; --ring:#d0d7de;
    --pa:#6c5ce7; --p:#2ecc71; --a:#f39c12; --u:#e74c3c;
    --bg:#fff; --fg:#111; --muted:#6b7280; --border:#e5e7eb; --panel:#fff;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  body{display:flex;flex-direction:column;min-width:320px}

  .topbar{position:sticky; top:0; background:var(--panel); display:flex;flex-wrap:wrap;gap:10px;align-items:center; padding:8px 10px;border-bottom:1px solid #eef0f3;z-index:10; box-shadow:0 4px 14px rgba(0,0,0,.04)}
  .search-wrap{display:flex;gap:8px;align-items:center;min-width:280px;flex:1}
  .searchbox{position:relative;flex:1}
  .searchbox input{width:100%;border:1px solid #d0d7de;border-radius:10px;padding:10px 12px 10px 48px;font-size:14px;background:var(--bg);color:var(--fg)}
  .badge-left{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:12px;font-weight:800;letter-spacing:.3px;background:#eef6ff;color:#0b5bd3;border:1px solid #cfe6ff;border-radius:999px;padding:3px 8px;display:none}
  .badge-left.show{display:inline-block}
  .results{position:absolute;left:0;right:0;top:calc(100% + 6px);background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.18);display:none;z-index:20;max-height:360px;overflow:auto}
  .results.show{display:block}
  .res{display:flex;gap:10px;padding:10px;cursor:pointer;align-items:flex-start}
  .res:hover{background:#f6f8fa}
  #searchResults .res.active{ background:#e7f0ff }
  .res .kind{flex:0 0 auto;font-size:11px;font-weight:800;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:#374151;background:var(--panel)}
  .res .text .sub{color:var(--muted);font-size:12px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .btn{border:1px solid #d0d7de;background:var(--panel);border-radius:10px;padding:8px 10px;font-weight:600;cursor:pointer;color:var(--fg); box-shadow:0 2px 8px rgba(0,0,0,.04)}
  .btn.link{border-color:transparent;text-decoration:underline}
  .toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:var(--panel);white-space:nowrap}
  .toggle input{width:16px;height:16px;accent-color:var(--blue)}
  .range{display:flex;align-items:center;gap:8px;white-space:nowrap}
  .range small{color:var(--muted)}

  .pillbar{display:flex;gap:6px;flex-wrap:wrap;padding:6px 10px}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #d0d7de;border-radius:999px;padding:6px 10px;background:var(--panel);color:var(--fg);cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.04)}
  .pill .dot{width:10px;height:10px;border-radius:50%}

  .filters{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:10px;padding:8px 10px;border-top:1px solid #eef0f3;border-bottom:1px solid #eef0f3;background:var(--panel); border-radius:12px; margin:6px 10px; box-shadow:0 6px 20px rgba(0,0,0,.06)}
  .picker{display:flex;flex-direction:column;gap:6px}
  .picker input{padding:6px 8px;font-size:13px;border:1px solid #d0d7de;border-radius:8px;background:var(--bg);color:var(--fg)}
  select[multiple]{height:110px;border:1px solid #d0d7de;border-radius:8px;padding:6px 8px;background:var(--bg);color:var(--fg)}
</style><style>
/* --- Toolbar (row 1) -------------------------------------------------- */
.topbar,
.toolbar,
.headerbar {                 /* cover common class names used earlier */
  position: sticky;
  top: 0;
  z-index: 1000;
  background: #fff;
  border-bottom: 1px solid var(--border, #e5e7eb);
  padding: 6px 10px;
}

.topbar .controls,
.toolbar .controls,
.headerbar .controls {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
}

/* keep controls from stretching */
.topbar .controls > *,
.toolbar .controls > *,
.headerbar .controls > * {
  flex: 0 0 auto;
}

/* normalize heights */
input[type="text"],
input[type="search"],
select,
button,
.btn {
  height: 30px;
  line-height: 28px;
  padding: 0 10px;
  border-radius: 8px;
}

/* Search box + icon: no overlap */
.searchbox { position: relative; width: 340px; max-width: 42vw; }
.searchbox input {
  padding-left: 28px;         /* room for the icon */
  padding-right: 14px;        /* room for clear button etc */
}
.searchbox .icon {
  position: absolute;
  left: 8px; top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  opacity: .7;
  font-size: 14px;
}

/* Make any search dropdown sit above controls but below modals */
.search-dropdown,
.typeahead,
.autocomplete-list {
  position: absolute;
  z-index: 1200;
  max-height: 240px;
  overflow: auto;
}

/* --- Filter strip (row 2) --------------------------------------------- */
.filters,
.filter-row,
#filterRow {
  display: grid;
  grid-template-columns: repeat(4, minmax(220px, 1fr));
  gap: 12px;
  padding: 10px;
  border-bottom: 1px solid var(--border, #e5e7eb);
  background: #fff;
}

/* listboxes (coverage / RM / AM / hubs) */
.filters select[size],
.filter-row select[size],
#filterRow select[size],
.filters .listbox,
.filter-row .listbox,
#filterRow .listbox {
  height: 120px;              /* keeps the rows even like before */
  min-height: 120px;
  width: 100%;
}

/* labels inside listbox blocks */
.filters .label,
.filter-row .label,
#filterRow .label {
  font-size: 12px;
  color: #6b7280;
  margin-bottom: 4px;
}

/* counts/status strip under filters */
.counts,
.status-strip {
  padding: 6px 12px;
  font-size: 13px;
  color: #374151;
}

/* --- Map + sidepanel spacing ----------------------------------------- */
.mapwrap { position: relative; }
.sidepanel {
  position: absolute;
  right: 10px; top: 70px;     /* below sticky topbar */
  width: 380px; max-width: 40vw;
  z-index: 900;               /* below dropdowns but above map */
}

/* --- Buttons cluster under the map ----------------------------------- */
.toolchips,
.toggles-row {
  position: sticky;
  bottom: 0;
  background: rgba(255,255,255,.9);
  border-top: 1px solid var(--border, #e5e7eb);
  padding: 6px 8px;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  z-index: 800;
}

/* --- Responsive adjustments ------------------------------------------ */
@media (max-width: 1280px){
  .filters, .filter-row, #filterRow {
    grid-template-columns: repeat(2, minmax(220px, 1fr));
  }
  .sidepanel{ width: 340px; }
}
@media (max-width: 900px){
  .filters, .filter-row, #filterRow {
    grid-template-columns: 1fr;
  }
  .searchbox{ width: 100%; max-width: 100%; }
  .sidepanel{ position: fixed; right: 8px; left: 8px; width: auto; }
}

/* --- Safety: make any stray dropdown/select menus not overflow topbar */
select { max-width: 220px; }
</style>

</head>
<body>
<!-- Top bar -->
<div class="topbar">
  <div class="search-wrap" title="Type a store #, city/state, or hub name. Tip: type ‚Äònear‚Äô for nearby stores.">
    <div class="searchbox">
      <span id="searchBadge" class="badge-left">SEARCH</span>
      <input id="searchBox" type="text" placeholder="Type a store #, city/state, hub name‚Ä¶ (tip: 'near Dallas')" autocomplete="off" aria-label="Search store or city" />
      <div id="searchResults" class="results" role="listbox"></div>
    </div>
    <button id="searchClear" class="btn" type="button" title="Clear search">Clear</button>
  </div>

  <label class="toggle" title="Show Premium confirmed hubs"><input id="showConfirmed" type="checkbox" checked />Premium (confirmed)</label>
  <label class="toggle" title="Show Premium pending offers"><input id="showPending" type="checkbox" checked />Premium (pending)</label>
  <label class="toggle" title="Show Acosta trainers"><input id="showAcosta" type="checkbox" checked />Acosta</label>

  <div class="range" title="Hub radius used for coverage, lists, rings, overlap">
    <span>Radius</span>
    <input id="radius" type="range" min="25" max="150" step="5" value="75" />
    <b id="radiusLbl">75</b><small>mi</small>
  </div>

  <button id="fitBtn" class="btn" type="button" title="Fit map to filtered stores">Fit to Results</button>
  <button id="homeBtn" class="btn" type="button" title="Reset to starting view (keeps filters)">Home</button>
  <button id="resetBtn" class="btn" type="button" title="Reset all filters and view">Reset</button>

  <!-- Export -->
  <div class="dropdown" id="exportDrop" style="position:relative">
    <button class="btn" type="button" title="Download CSV of filtered stores or panel list">Export ‚ñæ</button>
    <div class="dropdown-menu">
      <button id="exportStores" class="btn" type="button" style="display:block;width:100%;margin:4px 0" title="Export all filtered stores on the map">
        Export filtered stores (CSV)
      </button>
      <label class="toggle" style="margin:6px 4px;display:flex"><input id="autoReset" type="checkbox" />Auto-reset after export/print</label>
    </div>
  </div>

  <!-- Saved Views -->
  <div class="dropdown" id="viewsDrop" style="position:relative">
    <button class="btn" type="button" title="Save or recall views">Views ‚ñæ</button>
    <div class="dropdown-menu" id="viewsMenu">
      <button id="viewSave" class="btn" type="button" style="display:block;width:100%">Save current view‚Ä¶</button>
      <div style="border-top:1px solid var(--border);margin:6px 0"></div>
      <div id="viewList" style="min-width:220px"></div>
    </div>
  </div>

  <!-- Analysis buttons -->
  <button id="gapBtn" class="btn" type="button" title="Find cities with uncovered clusters">Gap finder</button>
  <button id="rollupBtn" class="btn" type="button" title="Totals by RM/AM">Rollups</button>

  <button id="helpBtn" class="btn" type="button" title="Quick tips and shortcuts">Help</button>
</div>

<div class="pillbar" id="presetBar">
  <div id="snapBtn" class="pill" title="Copy a shareable URL">üîó Save snapshot link</div>
</div>

<div class="pillbar" id="activeChips"></div>

<!-- Filters -->
<div class="filters" title="Use these to narrow stores; search also matches store # and city/state.">
  <div class="picker">
    <input id="covSearch" type="text" placeholder="Search coverage‚Ä¶" />
    <select id="covFilter" multiple>
      <option value="All" selected>All</option>
      <option>Premium + Acosta</option>
      <option>Premium Only</option>
      <option>Acosta Only</option>
      <option>Uncovered</option>
    </select>
  </div>
  <div class="picker">
    <input id="rmSearch" type="text" placeholder="Filter regional managers‚Ä¶" />
    <select id="rmFilter" multiple><option value="All" selected>All</option></select>
  </div>
  <div class="picker">
    <input id="amSearch" type="text" placeholder="Filter area managers‚Ä¶" />
    <select id="amFilter" multiple><option value="All" selected>All</option></select>
  </div>
  <div class="picker">
    <input id="hubSearch" type="text" placeholder="Filter hubs‚Ä¶" />
    <select id="hubFilter" multiple></select>
  </div>
</div>

<div id="dataStatus" style="padding:6px 10px;color:var(--fg);font-size:12px"></div>

<div class="summary" id="summary">
  <span class="chip"><span class="dot" style="background:var(--pa)"></span>P+A: <b id="k_pa">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--p)"></span>Premium: <b id="k_p">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--a)"></span>Acosta: <b id="k_a">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--u)"></span>Uncov: <b id="k_u">0</b></span>
  <span class="chip">Total: <b id="k_total">0</b></span>
  <span class="chip">Hubs ‚Äî <b id="k_h_conf">0</b> confirmed ‚Ä¢ <b id="k_h_offer">0</b> pending offer ‚Ä¢ <b id="k_h_prop">0</b> proposed</span>
  <span class="muted" id="inView">In view: 0</span>
</div>
<div class="summary" id="datasetBadge"></div>

<div class="mapwrap">
  <div id="map" role="region" aria-label="Coverage Map" style="min-height:460px"></div>

  <div class="floating">
    <label class="toggle" title="Density of stores"><input id="tgHeat" type="checkbox" />Heatmap</label>
    <label class="toggle" title="Show hub radius circles"><input id="tgRings" type="checkbox" />Hub radii</label>
    <label class="toggle" title="Highlight stores covered by 2+ hubs"><input id="tgOverlap" type="checkbox" />Overlap</label>
    <label class="toggle" title="Pin hubs to compare coverage"><input id="tgCompare" type="checkbox" />Compare</label>
    <label class="toggle" title="Filter: only stores inside any visible hub radius"><input id="tgWithin" type="checkbox" />Within hubs</label>
    <label class="toggle" title="Turn clustering on/off (useful when zoomed in)"><input id="tgCluster" type="checkbox" checked />Cluster</label>
    <button id="sandboxBtn" class="btn" type="button" title="Test a new hub location">New-hub sandbox</button>
  </div>

  <!-- Compare/Venn panel -->
  <div id="comparePanel" class="compare-panel">
    <div style="font-weight:800;margin-bottom:6px">Compare (2 pins)</div>
    <div id="compareBody" style="font-size:13px"></div>
    <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
      <button id="cmpExport" class="btn" type="button">Export CSV</button>
      <button id="cmpClear" class="btn" type="button">Clear pins</button>
    </div>
  </div>

  <div class="sidepanel" id="sidepanel">
    <div class="sp-head">
      <h3 id="spTitle">Hub</h3>
      <button id="spCollapse" class="btn" type="button" title="Collapse panel">‚ü®</button>
      <button id="spPinBtn" class="btn" type="button" title="Pin for compare">Pin</button>
      <button id="spLink" class="btn" type="button" title="Copy link to this hub">Link</button>
      <button id="spClose" class="btn" type="button" title="Close panel">Close</button>
    </div>
    <div class="sp-body">
      <div id="spMeta" class="sp-meta" style="font-size:13px"></div>
      <div class="sp-actions">
        <button id="spExport" class="btn" type="button" title="Download CSV of this list">Export list (CSV)</button>
        <button id="spPrint" class="btn" type="button" title="Print this list">Print store list</button>
      </div>
      <div class="sp-quick" title="Change hub radius quickly">
        Radius:
        <button class="btn" type="button" data-r="50">50</button>
        <button class="btn" type="button" data-r="75">75</button>
        <button class="btn" type="button" data-r="100">100</button><small> mi</small>
      </div>
      <div id="spCounts" class="sp-counts"></div>
      <div class="sp-list" id="spListWrap">
        <input id="spSearch" type="text" placeholder="Search stores in list‚Ä¶" />
        <div id="spRows" class="sp-rows"></div>
      </div>
    </div>
  </div>

  <!-- Empty state overlay -->
  <div id="emptyState" class="empty-state" hidden>
    <div class="empty-card">
      <h4>No stores match your filters</h4>
      <div class="muted">Try widening your radius, turning off ‚ÄúWithin hubs‚Äù, or clearing a filter.</div>
      <div class="empty-actions">
        <button id="clearLastFilter" class="btn" type="button">Clear last filter</button>
        <button id="emptyReset" class="btn" type="button">Reset all</button>
      </div>
    </div>
  </div>
</div>

<!-- Help modal -->
<div class="modal" id="helpModal" aria-modal="true" role="dialog">
  <div class="card">
    <header>
      <h3>Help & Shortcuts</h3>
      <button id="helpClose" class="btn" type="button">Close</button>
    </header>
    <div class="body">
      <div>
        <h4>Keyboard</h4>
        <p><span class="kbd">Ctrl</span> / <span class="kbd">‚åò</span> + <span class="kbd">K</span> ‚Äî Focus search</p>
        <p><span class="kbd">‚Üë</span> <span class="kbd">‚Üì</span> + <span class="kbd">Enter</span> ‚Äî Pick search result</p>
        <p><span class="kbd">H</span> ‚Äî Home (map only)</p>
        <p><span class="kbd">F</span> ‚Äî Focus side-panel search (when open)</p>
      </div>
      <div>
        <h4>Tips</h4>
        <ul>
          <li>Type <b>near</b> or <b>near Dallas</b> to jump the map and suggest nearby stores.</li>
          <li>Use <b>Within hubs</b> to see only stores covered by visible hubs.</li>
          <li>Pin hubs to compare coverage; <b>Overlap</b> highlights shared stores.</li>
          <li>Side panel shows counts & metrics; click a store to zoom to it.</li>
          <li>Use <b>Views</b> to save/restore your favorite setups.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Gap Finder modal -->
<div class="modal" id="gapModal" aria-modal="true" role="dialog">
  <div class="card">
    <header>
      <h3>Gap finder</h3>
      <button id="gapClose" class="btn" type="button">Close</button>
    </header>
    <div class="body" style="grid-template-columns:1fr;">
      <div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;align-items:center">
          <label class="toggle" title="Only show clusters at least this big">Min uncovered
            <input id="gapMin" type="number" value="10" style="width:80px;margin-left:8px">
          </label>
          <label class="toggle" title="Radius (mi) around each city center">Radius (mi)
            <input id="gapMiles" type="number" value="50" style="width:80px;margin-left:8px">
          </label>
          <button id="gapRun" class="btn" type="button">Run</button>
          <button id="gapExport" class="btn" type="button">Export CSV</button>
        </div>
        <div id="gapResults" style="max-height:65vh;overflow:auto"></div>
      </div>
    </div>
  </div>
</div>

<!-- Rollups modal -->
<div class="modal" id="rollupModal" aria-modal="true" role="dialog">
  <div class="card">
    <header>
      <h3>Manager rollups</h3>
      <button id="rollupClose" class="btn" type="button">Close</button>
    </header>
    <div class="body" style="grid-template-columns:1fr;">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
        <label class="toggle"><input type="radio" name="rollBy" id="rollByRM" checked> By Regional Manager</label>
        <label class="toggle"><input type="radio" name="rollBy" id="rollByAM"> By Area Manager</label>
        <button id="rollExport" class="btn" type="button">Export CSV</button>
      </div>
      <div id="rollTable" style="max-height:65vh;overflow:auto"></div>
    </div>
  </div>
</div>

<!-- Propose Hub modal -->
<div class="modal" id="submitModal" aria-modal="true" role="dialog">
  <div class="card">
    <header>
      <h3>Propose hub</h3>
      <button id="phClose" class="btn" type="button">Close</button>
    </header>
    <div class="body" style="grid-template-columns:1fr 1fr">
      <div>
        <label>City<br><input id="phCity" type="text" placeholder="e.g. Lakeland"></label>
      </div>
      <div>
        <label>State<br><input id="phState" type="text" placeholder="FL"></label>
      </div>
      <div>
        <label>Trainer / Candidate (optional)<br><input id="phName" type="text" placeholder="Name"></label>
      </div>
      <div>
        <label>Status<br>
          <select id="phStatus">
            <option>Proposed</option>
            <option>Pending Offer</option>
          </select>
        </label>
      </div>
      <div style="grid-column:1 / -1">
        <label>Notes (optional)<br><input id="phNotes" type="text" placeholder="context for this hub"></label>
      </div>
      <div style="grid-column:1 / -1;font-size:12px;color:var(--muted)">
        Lat/Lng and radius are pulled from the Sandbox ring.
      </div>
    </div>
    <div style="padding:12px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end">
      <button id="phSubmit" class="btn" type="button">Save proposal</button>
    </div>
  </div>
</div>

<!-- Busy overlay -->
<div id="busy" class="busy" hidden role="status" aria-live="polite" aria-label="Loading">
  <div class="spin"></div>
</div>
  <style>
    html, body { height:100%; margin:0; font-family:Arial, sans-serif; }
    #map { height:100%; width:100%; }
    #sidepanel {
      position:absolute; top:0; right:0; width:320px; height:100%;
      background:#fff; border-left:1px solid #ccc; overflow-y:auto;
      display:none; flex-direction:column; z-index:1000; padding:10px;
    }
    #sidepanel.show { display:flex; }
    #filters {
      position:absolute; top:10px; left:10px; background:#fff; border:1px solid #ccc;
      padding:10px; border-radius:6px; z-index:1000;
    }
    #filters input, #filters select { margin:4px 0; }
    .toolbar {
      position:absolute; top:10px; right:340px; background:#fff; border:1px solid #ccc;
      border-radius:6px; padding:8px; z-index:1000;
      display:flex; gap:6px;
    }
    .toolbar button {
      padding:6px 10px; border:1px solid #999; background:#f8f8f8;
      border-radius:4px; cursor:pointer;
    }
    .toolbar button:hover { background:#eee; }
    .searchbox {
      display:flex; align-items:center; border:1px solid #ccc; border-radius:4px;
      padding:2px 6px; background:#fff;
    }
    .searchbox input {
      border:none; outline:none; flex:1; font-size:14px; padding:4px;
    }
    .searchbox .icon {
      margin-left:4px; color:#888; font-size:14px;
      flex-shrink:0;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidepanel" role="dialog" aria-label="Details panel">
    <button id="closePanel">Close</button>
    <div id="panelContent"></div>
  </div>
  <div id="filters">
    <div class="searchbox">
      <input id="searchBox" type="text" placeholder="Search store # or city" />
      <span class="icon">üîç</span>
    </div>
    <div>
      <label><input type="checkbox" id="tgAcosta"> Show Acosta</label>
    </div>
    <div>
      <label>Regional: <select id="fRegional"><option value="">All</option></select></label>
    </div>
    <div>
      <label>Area Mgr: <select id="fArea"><option value="">All</option></select></label>
    </div>
    <div>
      <label>Hub: <select id="fHub"><option value="">All</option></select></label>
    </div>
  </div>
  <div class="toolbar">
    <button id="btnGapFinder">Gap Finder</button>
    <button id="btnRollups">Rollups</button>
    <button id="btnHelp">Help</button>
  </div>
<script>
  // --- Map setup ---
  const map = L.map('map').setView([39.5, -98.35], 5);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // Cluster group
  const markers = L.markerClusterGroup();
  map.addLayer(markers);

  // Utilities
  function id(x){ return document.getElementById(x); }
  function show(el){ el.classList.add('show'); }
  function hide(el){ el.classList.remove('show'); }

  // Filter elements
  const tgAcosta = id('tgAcosta');
  const fRegional = id('fRegional');
  const fArea = id('fArea');
  const fHub = id('fHub');
  const searchBox = id('searchBox');

  // Panel
  const sidepanel = id('sidepanel');
  const panelContent = id('panelContent');
  id('closePanel').onclick = () => hide(sidepanel);

  // --- Dummy Data (replace with your JSON import) ---
  const stores = [
    {id:1, name:"Walmart 1234", city:"Springfield", state:"IL", lat:39.8, lng:-89.65, regional:"North", area:"A1", hub:"Hub1", type:"Premium"},
    {id:2, name:"Walmart 5678", city:"Columbus", state:"OH", lat:39.96, lng:-82.99, regional:"East", area:"B1", hub:"Hub2", type:"Acosta"},
    {id:3, name:"Walmart 9012", city:"Denver", state:"CO", lat:39.74, lng:-104.99, regional:"West", area:"C1", hub:"Hub3", type:"Premium"},
  ];

  // --- Populate dropdowns ---
  const regionals = [...new Set(stores.map(s=>s.regional))];
  const areas = [...new Set(stores.map(s=>s.area))];
  const hubs = [...new Set(stores.map(s=>s.hub))];

  regionals.forEach(r=> fRegional.add(new Option(r,r)));
  areas.forEach(a=> fArea.add(new Option(a,a)));
  hubs.forEach(h=> fHub.add(new Option(h,h)));

  // --- Marker handling ---
  const markerById = {};

  function addMarkers(){
    markers.clearLayers();
    stores.forEach(s=>{
      if(!tgAcosta.checked && s.type==="Acosta") return;
      if(fRegional.value && s.regional!==fRegional.value) return;
      if(fArea.value && s.area!==fArea.value) return;
      if(fHub.value && s.hub!==fHub.value) return;

      const m = L.marker([s.lat, s.lng]).bindPopup(
        `<b>${s.name}</b><br>${s.city}, ${s.state}<br>${s.type} / ${s.regional} / ${s.area}`
      );
      m.on('click', ()=> {
        panelContent.innerHTML = `
          <h3>${s.name}</h3>
          <p>${s.city}, ${s.state}</p>
          <p><b>Regional:</b> ${s.regional}</p>
          <p><b>Area:</b> ${s.area}</p>
          <p><b>Hub:</b> ${s.hub}</p>
          <p><b>Type:</b> ${s.type}</p>
        `;
        show(sidepanel);
      });
      markers.addLayer(m);
      markerById[s.id] = m;
    });
  }
  addMarkers();

  [tgAcosta, fRegional, fArea, fHub].forEach(el => el.onchange = addMarkers);
<script>
/* ------------------------------
   Chunk 4: Data loading + tools
--------------------------------*/

// 1) Tiny CSS fix so the üîç icon never overlaps typed numbers
(() => {
  const style = document.createElement('style');
  style.textContent = `.searchbox input{ padding-right:28px !important; }`;
  document.head.appendChild(style);
})();

// 2) State for search
let searchQuery = "";

// 3) Helper: CSV download
function downloadCsv(rows, filename){
  const csv = rows.map(r => r.map(v => `"${String(v ?? '').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

// 4) Normalize a store row to the fields our UI expects
function normStore(o){
  const s = { ...o };
  const n = {};

  n.id = String(s.id ?? s.storeNumberStr ?? s.Store ?? s.storeNumber ?? s['Store #'] ?? '').trim() || crypto.randomUUID();
  n.name = s.storeName ?? s.Name ?? s['Store Name'] ?? (s.storeNumberStr ? `Walmart ${s.storeNumberStr}` : 'Walmart');
  n.city = s.city ?? s.City ?? '';
  n.state = s.state ?? s.State ?? '';
  n.lat = Number(s.lat ?? s.latitude ?? s.Latitude ?? s.Lat);
  n.lng = Number(s.lng ?? s.longitude ?? s.Longitude ?? s.Lon);

  n.regional = s.regionalManager ?? s.RegMgr ?? s['Regional Manager'] ?? s.Regional ?? '';
  n.area     = s.areaManager ?? s.AreaMgr ?? s['Area Manager'] ?? s.Area ?? '';
  n.hub      = s.trainerCity ?? s.Assigned_Premium ?? s['Trainer City'] ?? s.Hub ?? '';
  n.type     = s.coverageType ?? s.Coverage_Type ?? s.Covered_By ?? s.type ?? 'Uncovered';

  return (Number.isFinite(n.lat) && Number.isFinite(n.lng)) ? n : null;
}

// 5) Load your real data and replace the dummy array (created in Chunk 3)
async function loadRealData(){
  try{
    const [storesResp, acostaResp, premResp] = await Promise.allSettled([
      fetch('./store_data.json?v='+Date.now(), { cache:'no-store' }),
      fetch('./acosta_geocoded.json?v='+Date.now(), { cache:'no-store' }),
      fetch('./premium_trainers_master.json?v='+Date.now(), { cache:'no-store' })
    ]);

    // STORES
    if (storesResp.status === 'fulfilled' && storesResp.value.ok){
      const raw = await storesResp.value.json();
      const list = (Array.isArray(raw) ? raw : []).map(normStore).filter(Boolean);
      // Replace the dummy const array contents in-place:
      // (Chunk 3 declared `const stores = [...]`; mutating its contents is allowed.)
      stores.splice(0, stores.length, ...list);
    } else {
      console.warn('store_data.json failed, keeping sample data.');
    }

    // OPTIONAL: you can read acosta/premium here if you want to compute new coverage later.
    // For now we only ensure the files fetch without breaking the UI.
    if (acostaResp.status === 'fulfilled' && acostaResp.value.ok){
      await acostaResp.value.json(); // not used directly in this simplified build
    }
    if (premResp.status === 'fulfilled' && premResp.value.ok){
      await premResp.value.json(); // not used directly in this simplified build
    }

    // Rebuild dropdowns using live data
    rebuildFiltersFromStores();
    // Re-draw markers using current filters/search
    addMarkers();
  }catch(e){
    console.error('loadRealData error:', e);
  }
}

// Build the filter dropdowns from current stores
function rebuildFiltersFromStores(){
  const regs = [...new Set(stores.map(s=>s.regional).filter(Boolean))].sort();
  const areas = [...new Set(stores.map(s=>s.area).filter(Boolean))].sort();
  const hubs  = [...new Set(stores.map(s=>s.hub).filter(Boolean))].sort();

  // Clear (preserve "All"/blank first option)
  ;[...fRegional.options].slice(1).forEach(()=>fRegional.remove(1));
  ;[...fArea.options].slice(1).forEach(()=>fArea.remove(1));
  ;[...fHub.options].slice(1).forEach(()=>fHub.remove(1));

  regs.forEach(r=> fRegional.add(new Option(r,r)));
  areas.forEach(a=> fArea.add(new Option(a,a)));
  hubs.forEach(h=> fHub.add(new Option(h,h)));
}

// 6) Enhance marker rendering to include search filtering
const _origAddMarkers = addMarkers;
function addMarkers(){
  markers.clearLayers();

  // Prepare text query
  const q = (searchQuery||'').trim().toLowerCase();

  stores.forEach(s=>{
    // Filters
    if(!tgAcosta.checked && String(s.type).toLowerCase()==="acosta") return;
    if(fRegional.value && s.regional!==fRegional.value) return;
    if(fArea.value && s.area!==fArea.value) return;
    if(fHub.value && s.hub!==fHub.value) return;

    // Search (matches: id/number, city, state, name)
    if (q){
      const hay = `${s.id} ${s.name||''} ${s.city||''} ${s.state||''}`.toLowerCase();
      if (!hay.includes(q)) return;
    }

    const m = L.marker([s.lat, s.lng]).bindPopup(
      `<b>${s.name}</b><br>${s.city}, ${s.state}<br>${s.type || ''} / ${s.regional || ''} / ${s.area || ''}`
    );
    m.on('click', ()=> {
      panelContent.innerHTML = `
        <h3>${s.name}</h3>
        <p>${s.city}, ${s.state}</p>
        <p><b>Regional:</b> ${s.regional || '‚Äî'}</p>
        <p><b>Area:</b> ${s.area || '‚Äî'}</p>
        <p><b>Hub:</b> ${s.hub || '‚Äî'}</p>
        <p><b>Type:</b> ${s.type || '‚Äî'}</p>
      `;
      show(sidepanel);
    });
    markers.addLayer(m);
  });
}
// Re-bind filter changes to the enhanced addMarkers
[tgAcosta, fRegional, fArea, fHub].forEach(el => el.onchange = addMarkers);

// 7) Search box wiring
searchBox.addEventListener('input', ()=>{
  searchQuery = searchBox.value || '';
  addMarkers();
});

// 8) Toolbar buttons ‚Äî Gap Finder, Rollups, Help
id('btnGapFinder').onclick = ()=>{
  if (!stores.length){ alert('No stores loaded yet.'); return; }

  // Simple gap finder:
  //  - find cities where stores are "Uncovered"
  //  - group by city/state center
  //  - count uncovered within 50 miles
  const R = 50; // miles
  const uncovered = stores.filter(s => String(s.type).toLowerCase()==='uncovered');
  if (!uncovered.length){
    panelContent.innerHTML = `<h3>Gap Finder</h3><p>No Uncovered stores found.</p>`;
    show(sidepanel);
    return;
  }

  // City centers (avg lat/lng per city/state)
  const groups = new Map();
  for (const s of uncovered){
    if (!s.city || !s.state) continue;
    const key = `${s.city.toLowerCase()}|${s.state.toUpperCase()}`;
    const g = groups.get(key) || { city:s.city, state:s.state, lat:0, lng:0, n:0, pts:[] };
    g.lat += s.lat; g.lng += s.lng; g.n++; g.pts.push(s); groups.set(key, g);
  }
  const centers = [...groups.values()].map(g => ({ city:g.city, state:g.state, lat:g.lat/g.n, lng:g.lng/g.n }));

  function distMi(a,b){
    const toRad = d=>d*Math.PI/180, Rm=3958.8;
    const dLat = toRad(b.lat-a.lat), dLon = toRad(b.lng-a.lng);
    const aa = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2;
    return 2*Rm*Math.atan2(Math.sqrt(aa), Math.sqrt(1-aa));
  }

  const ranked = centers.map(c=>{
    const n = uncovered.reduce((acc,s)=> acc + (distMi({lat:s.lat,lng:s.lng}, c) <= R ? 1 : 0), 0);
    return { ...c, n };
  }).filter(r=>r.n>0).sort((a,b)=> b.n - a.n).slice(0,200);

  const html = `
    <h3>Gap Finder (Top ${ranked.length})</h3>
    <p>Uncovered stores within ${R} mi of each city center.</p>
    <div style="max-height:60vh; overflow:auto;">
      ${ranked.map(r=>`
        <div style="display:flex;gap:8px;align-items:center;border-bottom:1px solid #eee;padding:6px 0;cursor:pointer"
             onclick="(function(){ map.setView([${r.lat},${r.lng}], 9); })()">
          <div style="min-width:48px;text-align:right;font-variant-numeric:tabular-nums"><b>${r.n}</b></div>
          <div>${r.city}, ${r.state}</div>
        </div>
      `).join('')}
    </div>
  `;
  panelContent.innerHTML = html;
  show(sidepanel);
};

id('btnRollups').onclick = ()=>{
  if (!stores.length){ alert('No stores loaded yet.'); return; }

  // Build rollups by Regional and Area
  const by = (key) => {
    const m = new Map();
    stores.forEach(s=>{
      const k = s[key] || '‚Äî';
      const g = m.get(k) || { label:k, total:0, premium:0, acosta:0, uncovered:0 };
      g.total++;
      const t = String(s.type || '').toLowerCase();
      if (t.includes('premium')) g.premium++;
      else if (t.includes('acosta')) g.acosta++;
      else g.uncovered++;
      m.set(k,g);
    });
    return [...m.values()].sort((a,b)=> b.total - a.total);
  };

  const rm = by('regional');
  const am = by('area');

  const table = rows => `
    <table style="border-collapse:collapse;width:100%;font-size:13px">
      <thead>
        <tr>
          <th style="text-align:left;border-bottom:1px solid #ddd;padding:4px 6px">Group</th>
          <th style="text-align:right;border-bottom:1px solid #ddd;padding:4px 6px">Premium</th>
          <th style="text-align:right;border-bottom:1px solid #ddd;padding:4px 6px">Acosta</th>
          <th style="text-align:right;border-bottom:1px solid #ddd;padding:4px 6px">Uncovered</th>
          <th style="text-align:right;border-bottom:1px solid #ddd;padding:4px 6px">Total</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td style="padding:4px 6px">${r.label}</td>
            <td style="padding:4px 6px;text-align:right">${r.premium}</td>
            <td style="padding:4px 6px;text-align:right">${r.acosta}</td>
            <td style="padding:4px 6px;text-align:right">${r.uncovered}</td>
            <td style="padding:4px 6px;text-align:right"><b>${r.total}</b></td>
          </tr>`).join('')}
      </tbody>
    </table>
  `;

  panelContent.innerHTML = `
    <h3>Rollups</h3>
    <h4 style="margin:10px 0 6px">By Regional Manager</h4>
    ${table(rm)}
    <h4 style="margin:14px 0 6px">By Area Manager</h4>
    ${table(am)}
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="exportRM" style="padding:6px 10px">Export RM CSV</button>
      <button id="exportAM" style="padding:6px 10px">Export AM CSV</button>
    </div>
  `;
  id('exportRM').onclick = ()=>{
    const rows = [['Regional','Premium','Acosta','Uncovered','Total'], ...rm.map(r=>[r.label,r.premium,r.acosta,r.uncovered,r.total])];
    downloadCsv(rows, 'rollups_by_regional.csv');
  };
  id('exportAM').onclick = ()=>{
    const rows = [['Area','Premium','Acosta','Uncovered','Total'], ...am.map(r=>[r.label,r.premium,r.acosta,r.uncovered,r.total])];
    downloadCsv(rows, 'rollups_by_area.csv');
  };
  show(sidepanel);
};

id('btnHelp').onclick = ()=>{
  panelContent.innerHTML = `
    <h3>Help</h3>
    <ul>
      <li>Use the search box to filter by store number, name, city, or state.</li>
      <li>Use the dropdowns to filter by Regional, Area, or Hub.</li>
      <li>Toggle ‚ÄúShow Acosta‚Äù to include/exclude Acosta stores.</li>
      <li>Gap Finder lists cities with many Uncovered stores within 50 miles.</li>
      <li>Rollups summarizes counts by Regional/Area and lets you export CSVs.</li>
      <li>Click a marker to open details in the right panel.</li>
    </ul>
  `;
  show(sidepanel);
};

// 9) Kick off loading your real JSON (replaces sample data in-place)
loadRealData();

</script>
</body>
</html>
