<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Premium Retail Trainer Map with Dynamic Filters & Toggles</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
  }

  #filters {
    background: #fafafa;
    border-bottom: 1px solid #ddd;
    padding: 12px 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    align-items: center;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.08);
  }
  #filters > div {
    display: flex;
    align-items: center;
    position: relative;
  }
  label {
    font-weight: 600;
    margin-right: 8px;
    white-space: nowrap;
    color: #333;
  }
  select, input[type="text"], button {
    padding: 6px 10px;
    font-size: 14px;
    border-radius: 6px;
    border: 1px solid #ccc;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }
  select[multiple] {
    width: 170px;
    height: 120px;
  }
  select:focus, input[type="text"]:focus {
    outline: none;
    border-color: #3399ff;
    box-shadow: 0 0 6px rgba(51,153,255,0.6);
  }
  button {
    cursor: pointer;
    background: #3399ff;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 7px 15px;
    font-weight: 600;
    user-select: none;
    transition: background-color 0.2s ease;
  }
  button:hover {
    background: #2673cc;
  }
  #map {
    flex: 1;
    margin: 15px 15px 25px 15px;
    border-radius: 10px;
    box-shadow: 0 3px 12px rgb(0 0 0 / 0.1);
  }

  /* Modern toggle switches */
  #toggles {
    display: flex;
    gap: 25px;
    align-items: center;
    margin-left: 10px;
  }
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 46px;
    height: 24px;
  }
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc;
    transition: .3s;
    border-radius: 34px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
  }
  .toggle-switch input:checked + .slider {
    background-color: #3399ff;
  }
  .toggle-switch input:checked + .slider:before {
    transform: translateX(22px);
  }
  /* Toggle label text */
  .toggle-label-text {
    margin-left: 8px;
    font-weight: 500;
    user-select: none;
    color: #444;
  }

  /* Clear search button */
  #searchClearBtn {
    position: absolute;
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 18px;
    color: #888;
    padding: 0;
    user-select: none;
    transition: color 0.2s ease;
  }
  #searchClearBtn:hover {
    color: #3399ff;
  }
  /* Position relative wrapper for search input */
  #searchWrapper {
    flex-grow: 1;
    max-width: 320px;
    position: relative;
  }

  /* Autocomplete dropdown styles */
  #searchSuggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 160px;
    overflow-y: auto;
    border: 1px solid #ccc;
    background: white;
    z-index: 1500;
    font-size: 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    display: none;
  }
/* Legend styling */
  .legend {
    position: absolute;
    bottom: 15px;
    right: 15px;
    background: white;
    padding: 10px 14px;
    border-radius: 6px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    font-size: 14px;
    line-height: 1.4;
    color: #222;
    z-index: 10000;
    max-width: 220px;
  }
  .legend h4 {
    margin: 0 0 8px 0;
  }
  .legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
  }
  .legend-color {
    width: 18px;
    height: 18px;
    margin-right: 10px;
    border-radius: 50%;
    flex-shrink: 0;
}
  #searchSuggestions div {
    padding: 5px 8px;
    cursor: pointer;
  }
  #searchSuggestions div.highlighted {
    background-color: #3399FF;
    color: white;
  }

  /* Responsive tweaks */
  @media (max-width: 600px) {
    #filters {
      gap: 12px;
    }
    select[multiple] {
      width: 140px;
      height: 100px;
    }
    #searchWrapper {
      max-width: 100%;
    }
    #toggles {
      gap: 15px;
    }
  }
 /* Hub status styles (accepted vs open) */
.hub-icon {
  width: 22px; height: 22px;
  border-radius: 50%;
  border: 2px solid #fff;
  box-shadow: 0 0 0 1px rgba(0,0,0,0.25), 0 2px 6px rgba(0,0,0,0.15);
}
.hub-accepted { background: #6a1b9a; } /* purple */
.hub-open { background: #9e9e9e; }     /* gray */
.hub-badge {
  display:inline-block; padding:2px 6px; border-radius:10px; font-size:12px; font-weight:600; color:#fff;
}
.hub-badge.accepted { background:#6a1b9a; }  /* was green */
.hub-badge.open { background:#9e9e9e; }
#hubCount { font-weight: 600; font-size: 14px; color: #333; }
.hubCount-accepted { color: #6a1b9a; } /* match Accepted Hub purple */
.hubCount-open { color: #9e9e9e; }     /* match Open Hub gray */
.busy-mask {
  position: fixed; inset: 0; background: rgba(255,255,255,0.4);
  display: flex; align-items: center; justify-content: center;
  z-index: 20000;
}
.spinner {
  width: 36px; height: 36px; border-radius: 50%;
  border: 4px solid rgba(0,0,0,0.15);
  border-top-color: #3399ff;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }


</style>
</head>
<body>

<div id="filters">
  <div id="searchWrapper">
    <label for="searchBox">Search store # or city:</label>
    <input type="text" id="searchBox" autocomplete="off" placeholder="Search store # or city" style="width: 100%;" />
    <button id="searchClearBtn" title="Clear search">&times;</button>
    <div id="searchSuggestions"></div>
  </div>

  <div>
    <label for="coverageFilter">Coverage Type:</label>
    <select id="coverageFilter" multiple title="Select coverage types">
      <option value="All">All</option>
      <option value="Premium + Acosta" selected>Premium + Acosta</option>
      <option value="Premium Only" selected>Premium Only</option>
      <option value="Acosta Only">Acosta Only</option>
      <option value="Uncovered">Uncovered</option>
    </select>
  </div>

  <div>
    <label for="regionalFilter">Regional Manager:</label>
    <select id="regionalFilter" multiple title="Select regional managers">
      <option value="All" selected>All</option>
    </select>
  </div>

  <div>
    <label for="areaFilter">Area Manager:</label>
    <select id="areaFilter" multiple title="Select area managers">
      <option value="All" selected>All</option>
    </select>
  </div>

  <div>
    <label for="trainerHubFilter">Trainer Hub Filter:</label>
    <select id="trainerHubFilter" multiple title="Select trainer hubs"></select>
  </div>

  <div>
    <label for="zoomHub">Zoom to Hub:</label>
    <select id="zoomHub" title="Select a trainer hub to zoom">
      <option value="">-- Select Hub --</option>
    </select>
  </div>

  <div id="toggles">
    <label class="toggle-switch">
      <input type="checkbox" id="toggleHubs" checked />
      <span class="slider"></span>
    </label>
    <span class="toggle-label-text">Show Accepted Hubs</span>


    <label class="toggle-switch">
      <input type="checkbox" id="toggleRadius" checked />
      <span class="slider"></span>
    </label>
    <span class="toggle-label-text">Show Coverage Radius</span>
    <span style="margin-left:10px">
  <label>Radius:</label>
  <input type="range" id="radiusMiles" min="25" max="150" step="5" value="75" style="width:120px" />
  <span id="radiusLabel">75 mi</span>
</span>
<label class="toggle-switch" title="Allow changing the 75 mi radius">
  <input type="checkbox" id="allowCustomRadius" />
  <span class="slider"></span>
</label>
<span class="toggle-label-text">Custom radius</span>

        <label class="toggle-switch" title="Show hubs that are still open placeholders">
      <input type="checkbox" id="showOpenHubs" checked />
      <span class="slider"></span>
    </label>
    <span class="toggle-label-text">Show Open Hubs</span>

  </div>

  <div>
    <button id="resetFilters">Reset Filters</button>
    <button id="fitToResults">Fit to Results</button>

  </div>
  <div>
    <button id="exportVisibleCSV">Export Visible Stores CSV</button>
  </div>
  <div>
    <button id="exportFilteredCSV">Export Filtered Stores CSV</button>
  </div>
  <div>
    <button id="printMap">Print Store List</button>
  </div>

  <div id="filterCount" style="font-weight:bold; margin-left:15px; min-width:180px;">
    Showing 0 of 0 stores
  </div>
</div>
<div id="hubCount"></div>

<div id="map"></div>
<div id="busyMask" class="busy-mask" hidden>
  <div class="spinner"></div>
</div>

  <div class="legend" id="legend">
  <h4>Legend</h4>
  <div class="legend-item"><div class="legend-color" style="background:blue"></div>Premium + Acosta</div>
  <div class="legend-item"><div class="legend-color" style="background:green"></div>Premium Only</div>
  <div class="legend-item"><div class="legend-color" style="background:orange"></div>Acosta Only</div>
  <div class="legend-item"><div class="legend-color" style="background:red"></div>Uncovered</div>
<div class="legend-item"><span class="legend-color" style="background:#6a1b9a"></span>Accepted Hub</div>
<div class="legend-item"><span class="legend-color" style="background:#9e9e9e"></span>Open Hub</div>

</div>


<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(async function(){
  const coverageColors = {
    "Premium + Acosta": 'blue',
    "Premium Only": 'green',
    "Acosta Only": 'orange',
    "Uncovered": 'red'
  };

    const trainerHubs = [
  // ---- Placeholders (OPEN) you want to keep showing until hired ----
  { id: "belle_vernon_pa", name: "Belle Vernon, PA (Open)", coords: [40.12507, -79.8664], status: "open", person: null },
  { id: "blair_ne", name: "Blair, NE (Open)", coords: [41.5461, -96.1202], status: "open", person: null },
  { id: "casa_grande_az", name: "Casa Grande, AZ (Open)", coords: [32.89055, -111.754], status: "open", person: null },
  { id: "centennial_co", name: "Centennial, CO (Open)", coords: [39.62732, -104.779], status: "open", person: null },
  { id: "centerville_ut", name: "Centerville, UT (Open)", coords: [40.92955, -111.89], status: "open", person: null },
  { id: "colton_ca", name: "Colton, CA (Open)", coords: [34.0739, -117.314], status: "open", person: null },
  { id: "coral_springs_fl", name: "Coral Springs, FL (Open)", coords: [26.2882, -80.2522], status: "open", person: null },
  { id: "dallas_tx_open", name: "Dallas, TX (Open)", coords: [32.96356, -96.7706], status: "open", person: null }, // Dallas stays open
  { id: "elk_grove_village_il", name: "Elk Grove Village, IL (Open)", coords: [42.00865, -87.9974], status: "open", person: null },
  { id: "fairlawn_oh", name: "Fairlawn, OH (Open)", coords: [41.13315, -81.6352], status: "open", person: null },
  { id: "fort_wayne_in", name: "Fort Wayne, IN (Open)", coords: [41.0654, -85.1584], status: "open", person: null },
  { id: "houston_tx", name: "Houston, TX (Open)", coords: [29.8535, -95.5095], status: "open", person: null },
  { id: "jefferson_wi", name: "Jefferson, WI (Open)", coords: [42.98769, -88.8079], status: "open", person: null },
  { id: "kansas_city_mo", name: "Kansas City, MO (Open)", coords: [39.04512, -94.4429], status: "open", person: null },
  { id: "lakeland_fl", name: "Lakeland, FL (Open)", coords: [28.03591, -81.8997], status: "open", person: null },
  { id: "lincoln_il", name: "Lincoln, IL (Open)", coords: [40.16278, -89.3984], status: "open", person: null },
  { id: "mobile_al", name: "Mobile, AL (Open)", coords: [30.70114, -88.1032], status: "open", person: null },
  { id: "muskogee_ok", name: "Muskogee, OK (Open)", coords: [35.70582, -95.5003], status: "open", person: null },
  { id: "north_little_rock_ar", name: "North Little Rock, AR (Open)", coords: [34.83217, -92.3949], status: "open", person: null },
  { id: "newcastle_ok", name: "Newcastle, OK (Open)", coords: [35.2936, -97.6065], status: "open", person: null },
  { id: "oneonta_al", name: "Oneonta, AL (Open)", coords: [33.94815, -86.4728], status: "open", person: null },
  { id: "parkesburg_pa", name: "Parkesburg, PA (Open)", coords: [39.95872, -75.9194], status: "open", person: null },
  { id: "plainfield_in", name: "Plainfield, IN (Open)", coords: [39.70421, -86.3994], status: "open", person: null },
  { id: "poulsbo_wa", name: "Poulsbo, WA (Open)", coords: [47.75105, -122.614], status: "open", person: null },
  { id: "prairieville_la", name: "Prairieville, LA (Open)", coords: [30.30297, -90.9721], status: "open", person: null },
  { id: "roseville_mn", name: "Roseville, MN (Open)", coords: [45.00608, -93.1566], status: "open", person: null },
  { id: "salem_or", name: "Salem, OR (Open)", coords: [44.9429, -123.035], status: "open", person: null },
  { id: "secaucus_nj", name: "Secaucus, NJ (Open)", coords: [40.78885, -74.056], status: "open", person: null },
  { id: "waterloo_ny", name: "Waterloo, NY (Open)", coords: [42.89256, -76.8823], status: "open", person: null },
  { id: "white_lake_mi", name: "White Lake, MI (Open)", coords: [42.66065, -83.4676], status: "open", person: null },
  { id: "williamsburg_va", name: "Williamsburg, VA (Open)", coords: [37.31045, -76.7468], status: "open", person: null },
  { id: "wilmington_oh", name: "Wilmington, OH (Open)", coords: [39.44499, -83.8244], status: "open", person: null },

  // ---- Confirmed/Named hubs with accepted hires ----
  { id: "granite_falls_nc_walker", name: "Granite Falls, NC - Lisa Walker", coords: [35.80049406642459, -81.40580339729192], status: "accepted", person: "Lisa Walker" },
  { id: "clarksville_tn_salvato", name: "Clarksville, TN - Nicholas Salvato", coords: [36.58887925062968, -87.34016705996005], status: "accepted", person: "Nicholas Salvato" },
  { id: "orange_park_fl_hall", name: "Orange Park, FL - Sabrina Hall", coords: [30.186755922868347, -81.71888670245784], status: "accepted", person: "Sabrina Hall" },
  { id: "excelsior_springs_mo_estep", name: "Excelsior Springs, MO - Teresa Estep", coords: [39.354429998804825, -94.1669969175497], status: "accepted", person: "Teresa Estep" },
  { id: "louisville_ky_lilla", name: "Louisville, KY - Heather Lilla", coords: [38.209, -85.5198], status: "accepted", person: "Heather Lilla" },
  { id: "seguin_tx_winston", name: "Seguin, TX - Christina Winston", coords: [29.56000348742034, -97.96778298897998], status: "accepted", person: "Christina Winston" },
  { id: "minden_la_slater", name: "Minden, LA - Sami Jo Slater", coords: [32.686373819218176, -93.25250065821655], status: "accepted", person: "Sami Jo Slater" },
  { id: "kenly_nc_gross", name: "Kenly, NC - Brooke Gross", coords: [35.691639527137895, -78.17947437532841], status: "accepted", person: "Brooke Gross" },
  { id: "ofallon_mo_mcallister", name: "O'Fallon, MO - Mike McAllister", coords: [38.787159492769945, -90.71070211756692], status: "accepted", person: "Mike McAllister" },
  { id: "king_george_va_faulk", name: "King George, VA - Amy Faulk", coords: [38.25603416823435, -77.06032785806136], status: "accepted", person: "Amy Faulk" },
  { id: "sparta_mo_rogers", name: "Sparta, MO - Michelle Rogers", coords: [37.0314699051066, -93.1450542446044], status: "accepted", person: "Michelle Rogers" },
  { id: "darlington_sc_jones", name: "Darlington, SC - Kristen Jones", coords: [34.305681297736434, -79.85061846002368], status: "accepted", person: "Kristen Jones" },
  { id: "orangeburg_sc_shepherd", name: "Orangeburg, SC - Kendra Shepherd", coords: [33.47688895186578, -80.85696511771735], status: "accepted", person: "Kendra Shepherd" },
  { id: "dandridge_tn_matthews", name: "Dandridge, TN - Jennifer Matthews", coords: [35.98401850406635, -83.55508935997715], status: "accepted", person: "Jennifer Matthews" },
  { id: "navassa_nc_hook", name: "Navassa, NC - Jennifer Hook", coords: [34.25673752598021, -78.02249231584642], status: "accepted", person: "Jennifer Hook" },
  { id: "ingleside_il_gonzalez", name: "Ingleside, IL – Miguel Gonzalez", coords: [42.3940241, -88.142826], status: "accepted", person: "Miguel Gonzalez" },
  { id: "cambridge_oh_kerr", name: "Cambridge, OH - Rolland Kerr", coords: [40.017145, -81.604126], status: "accepted", person: "Rolland Kerr" },
  { id: "acworth_ga_orr", name: "Acworth, GA - John Orr", coords: [34.0626832, -84.6417505], status: "accepted", person: "John Orr" },
  { id: "norman_ok_ard", name: "Norman, OK - Teryl Ard", coords: [35.2131655, -97.4837249], status: "accepted", person: "Teryl Ard" },
  { id: "monroeville_pa_weaver", name: "Monroeville, PA - Heather Weaver", coords: [40.4349947, -79.7687263], status: "accepted", person: "Heather Weaver" },
  { id: "orlando_fl_lawrence", name: "Orlando, FL - Davonte Lawrence", coords: [28.5256823, -81.1815574], status: "accepted", person: "Davonte Lawrence" },
  { id: "fort_myers_fl_whitfield", name: "Fort Myers, FL - Muriel Curry Whitfield", coords: [26.6279876, -81.8700003], status: "accepted", person: "Muriel Curry Whitfield" },
  { id: "farmingville_ny_reich", name: "Farmingville, NY - Barbara Reich", coords: [40.8408592, -73.0307648], status: "accepted", person: "Barbara Reich" },
  { id: "folsom_ca_white", name: "Folsom, CA - Gerard White", coords: [38.6824363, -121.1481451], status: "accepted", person: "Gerard White" },
  { id: "willimantic_ct_bokoff", name: "Willimantic, CT - Melissa Bokoff", coords: [41.7101216, -72.2129277], status: "accepted", person: "Melissa Bokoff" },
  { id: "mabelvale_ar_eslick", name: "Mabelvale, AR - Angela Eslick", coords: [34.6217306, -92.4317642], status: "accepted", person: "Angela Eslick" },
  { id: "rayne_la_thibodeaux", name: "Rayne, LA - Marcie Thibodeaux", coords: [30.220651, -92.295472], status: "accepted", person: "Marcie Thibodeaux" },
  { id: "belvidere_il_vargas", name: "Belvidere, IL - Justin Vargas Salgado", coords: [42.257867, -88.846723], status: "accepted", person: "Justin Vargas Salgado" },
  { id: "kimberly_al_savage", name: "Kimberly, AL - Jessica Savage", coords: [33.6997, -86.7712], status: "accepted", person: "Jessica Savage" },
  { id: "olive_branch_ms_brown", name: "Olive Branch, MS - Annette Brown", coords: [34.92668799775572, -89.89485850418528], status: "accepted", person: "Annette Brown" }
  // NOTE: Removed Allen, TX - Jennifer Burton (declined)
];


  let allStores = [];
  let filteredStores = [];
  const storeMarkersMap = new Map();
  let currentOpenPopup = null;
  let hubsMarkers = [];
  let coverageCircles = [];

  function getDistanceMiles(lat1, lon1, lat2, lon2) {
    const R = 3958.8;
    const toRad = angle => angle * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  try {
    const response = await fetch('store_data.json');
    if (!response.ok) throw new Error('Failed to load store_data.json');
    let rawStores = await response.json();
console.log('Loaded stores:', Array.isArray(rawStores) ? rawStores.length : '(not an array)');

    allStores = rawStores.map(s => ({
      ...s,
      city: s.city ? s.city.trim().toLowerCase() : '',
      cityDisplay: s.city ? s.city.trim() : '',
      state: s.state ? s.state.trim() : '',
      trainerCity: s.trainerCity ? s.trainerCity.trim() : '',
      storeNumber: s.storeNumber.toString()
    }));
  } catch (err) {
    alert(err.message);
    return;
  }

  const map = L.map('map').setView([39.5, -98.35], 5);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  const markers = L.markerClusterGroup();
  map.addLayer(markers);

function iconForHub(hub) {
  const cls = hub.status === "accepted" ? "hub-accepted" : "hub-open";
  return L.divIcon({
    className: "",
    html: `<div class="hub-icon ${cls}" title="${hub.name}"></div>`,
    iconSize: [22,22],
    iconAnchor: [11,11],
    popupAnchor: [0,-10]
  });
}


function addTrainerHubsAndCircles(hubsToShow) {
  hubsMarkers.forEach(m => map.removeLayer(m));
  coverageCircles.forEach(c => map.removeLayer(c));
  hubsMarkers = [];
  coverageCircles = [];

  hubsToShow.forEach(hub => {
    const coveredCount = filteredStores.filter(
  s => getDistanceMiles(hub.coords[0], hub.coords[1], s.latitude, s.longitude) <= getRadiusMiles()
).length;


    const statusKey = hub.status === "accepted" ? "accepted" : "open";
    const badge = `<span class="hub-badge ${statusKey}">${statusKey.toUpperCase()}</span>`;
    const person = hub.person ? ` &nbsp;•&nbsp; <strong>${hub.person}</strong>` : "";

    const hubMarker = L.marker(hub.coords, { icon: iconForHub(hub) })
      .bindPopup(`
        <b>${hub.name}</b><br>
        ${badge}${person}<br>
       Stores covered within ${getRadiusMiles()} miles (filtered): ${coveredCount}

      `)
      .addTo(map);

    hubsMarkers.push(hubMarker);

const circle = L.circle(hub.coords, {
  radius: getRadiusMiles() * 1609.34,

      color: 'purple',
      weight: 1,
      fillOpacity: 0.1,
      dashArray: '5,10'
    }).addTo(map);
    coverageCircles.push(circle);
    function highlight(on) {
  circle.setStyle({ weight: on ? 3 : 1, fillOpacity: on ? 0.18 : 0.1 });
  if (on && circle.bringToFront) circle.bringToFront();
}
hubMarker.on('mouseover', () => highlight(true));
hubMarker.on('mouseout',  () => highlight(false));
circle.on('mouseover', () => highlight(true));
circle.on('mouseout',  () => highlight(false));

  });
}


  const regionalSet = new Set(allStores.map(s => s.regionalManager));
  const areaSet = new Set(allStores.map(s => s.areaManager));

  const regionalFilter = document.getElementById('regionalFilter');
  const areaFilter = document.getElementById('areaFilter');
  const zoomHubSelect = document.getElementById('zoomHub');
  const trainerHubFilter = document.getElementById('trainerHubFilter');
  const coverageFilter = document.getElementById('coverageFilter');
  const toggleHubsCheckbox = document.getElementById('toggleHubs');
  const toggleRadiusCheckbox = document.getElementById('toggleRadius');
  const showOpenHubsCheckbox = document.getElementById('showOpenHubs');
const radiusInput  = document.getElementById('radiusMiles');
const radiusLabel  = document.getElementById('radiusLabel');
const allowCustom  = document.getElementById('allowCustomRadius');

// default: locked to 75

   if (allowCustom) allowCustom.checked = false;
  if (radiusInput) { radiusInput.disabled = true; radiusInput.value = 75; }
  if (radiusLabel) radiusLabel.textContent = '75 mi';

const getRadiusMiles = () => allowCustom && allowCustom.checked
  ? (parseInt(radiusInput.value, 10) || 75)
  : 75;

if (radiusInput) radiusInput.addEventListener('input', () => {
  radiusLabel.textContent = `${getRadiusMiles()} mi`;
  onFilterChange();
  saveState && saveState();
});
if (allowCustom) allowCustom.addEventListener('change', () => {
  radiusInput.disabled = !allowCustom.checked;
  radiusLabel.textContent = `${getRadiusMiles()} mi`;
  onFilterChange();
  saveState && saveState();
});


  function populateHubControls() {
  // Zoom select
  zoomHubSelect.innerHTML = '<option value="">-- Select Hub --</option>';
  trainerHubs.forEach(hub => {
    const opt = document.createElement('option');
    opt.value = JSON.stringify(hub.coords);
    opt.textContent = hub.name;
    zoomHubSelect.appendChild(opt);
  });

  // Filter multi-select
  trainerHubFilter.innerHTML = '';
  trainerHubs.forEach(hub => {
    const opt = document.createElement('option');
    opt.value = hub.name;
    opt.textContent = hub.name;
    trainerHubFilter.appendChild(opt);
  });
}

// Build both controls from the current hubs list
populateHubControls();


  function populateSelect(selectElem, optionsSet) {
    [...selectElem.options].forEach(o => { if (o.value !== 'All') selectElem.removeChild(o); });
    optionsSet.forEach(opt => {
      const option = document.createElement('option');
      option.value = opt;
      option.textContent = opt;
      selectElem.appendChild(option);
    });
  }

  populateSelect(regionalFilter, regionalSet);
  populateSelect(areaFilter, areaSet);


  function updateTrainerHubFilter() {
    const hubsWithStores = new Set();
    trainerHubs.forEach(hub => {
      const coversAny = filteredStores.some(store =>
  getDistanceMiles(hub.coords[0], hub.coords[1], store.latitude, store.longitude) <= getRadiusMiles()
);

      if (coversAny) hubsWithStores.add(hub.name);
    });

    [...trainerHubFilter.options].forEach(option => {
      if (option.value === '') return;
      if (hubsWithStores.has(option.value)) {
        option.disabled = false;
        option.style.display = '';
      } else {
        option.disabled = true;
        option.style.display = 'none';
        option.selected = false;
      }
    });

    [...zoomHubSelect.options].forEach(option => {
      if (option.value === '') return;
      const hub = trainerHubs.find(h => h.name === option.textContent);
      if (!hub) return;
      if (hubsWithStores.has(hub.name)) {
        option.disabled = false;
        option.style.display = '';
      } else {
        option.disabled = true;
        option.style.display = 'none';
        if (zoomHubSelect.value === option.value) {
          zoomHubSelect.value = '';
        }
      }
    });
  }



  zoomHubSelect.addEventListener('change', () => {
    if (zoomHubSelect.value) {
      const coords = JSON.parse(zoomHubSelect.value);
      map.setView(coords, 11);
    }
  });

  regionalFilter.addEventListener('change', () => {
    const selectedRegionals = Array.from(regionalFilter.selectedOptions).map(o => o.value);
    if (selectedRegionals.includes('All')) {
      populateSelect(areaFilter, areaSet);
    } else {
      const filteredAreas = new Set(allStores.filter(s => selectedRegionals.includes(s.regionalManager)).map(s => s.areaManager));
      populateSelect(areaFilter, filteredAreas);
    }
    areaFilter.querySelector('option[value="All"]').selected = true;
    onFilterChange();
  });

  areaFilter.addEventListener('change', onFilterChange);
  trainerHubFilter.addEventListener('change', onFilterChange);
  coverageFilter.addEventListener('change', onFilterChange);
  showOpenHubsCheckbox.addEventListener('change', onFilterChange);
  



toggleHubsCheckbox.addEventListener('change', onFilterChange);

  toggleRadiusCheckbox.addEventListener('change', () => {
    if (toggleRadiusCheckbox.checked) {
      coverageCircles.forEach(c => c.addTo(map));
    } else {
      coverageCircles.forEach(c => map.removeLayer(c));
    }
  });
function saveState() {
  const state = {
    coverage: Array.from(coverageFilter.selectedOptions).map(o => o.value),
    regional: Array.from(regionalFilter.selectedOptions).map(o => o.value),
    area:     Array.from(areaFilter.selectedOptions).map(o => o.value),
    hubs:     Array.from(trainerHubFilter.selectedOptions).map(o => o.value),
    zoomHub:  zoomHubSelect.value,
    toggles: {
      showHubs: toggleHubsCheckbox.checked,
      showRadius: toggleRadiusCheckbox.checked,
      showOpen: showOpenHubsCheckbox.checked
    },
    search: searchBox.value,
    radius: {
      allowCustom: allowCustom.checked,
      value: radiusInput.value
    }
  };
  localStorage.setItem('trainerMapState', JSON.stringify(state));
}

function loadState() {
  const raw = localStorage.getItem('trainerMapState');
  if (!raw) return;
  const s = JSON.parse(raw);

  function restoreMulti(select, values) {
    if (!select || !values) return;
    Array.from(select.options).forEach(o => o.selected = values.includes(o.value));
  }

  restoreMulti(coverageFilter, s.coverage);
  restoreMulti(regionalFilter, s.regional);
  restoreMulti(areaFilter, s.area);
  restoreMulti(trainerHubFilter, s.hubs);
  if (s.zoomHub) zoomHubSelect.value = s.zoomHub;

  if (s.toggles) {
    if ('showHubs' in s.toggles) toggleHubsCheckbox.checked = s.toggles.showHubs;
    if ('showRadius' in s.toggles) toggleRadiusCheckbox.checked = s.toggles.showRadius;
    if ('showOpen' in s.toggles) showOpenHubsCheckbox.checked = s.toggles.showOpen;
  }

  if (typeof s.search === 'string') searchBox.value = s.search;

  if (s.radius) {
    allowCustom.checked = !!s.radius.allowCustom;
    radiusInput.disabled = !allowCustom.checked;
    if (s.radius.value) radiusInput.value = s.radius.value;
    radiusLabel.textContent = `${getRadiusMiles()} mi`;
  }
}

  function filterStores() {
    const selectedCoverage = Array.from(coverageFilter.selectedOptions).map(o => o.value);
    const selectedRegional = Array.from(regionalFilter.selectedOptions).map(o => o.value);
    const selectedArea = Array.from(areaFilter.selectedOptions).map(o => o.value);
    const selectedTrainerHubs = Array.from(trainerHubFilter.selectedOptions).map(o => o.value);

    filteredStores = allStores.filter(store => {
      const covMatch = selectedCoverage.includes('All') || selectedCoverage.includes(store.coverageType);
      const regMatch = selectedRegional.includes('All') || selectedRegional.includes(store.regionalManager);
      const areaMatch = selectedArea.includes('All') || selectedArea.includes(store.areaManager);

      if (selectedTrainerHubs.length === 0) {
        return covMatch && regMatch && areaMatch;
      }

      return selectedTrainerHubs.some(hubName => {
        const hub = trainerHubs.find(h => h.name === hubName);
        if (!hub) return false;
        return getDistanceMiles(hub.coords[0], hub.coords[1], store.latitude, store.longitude) <= getRadiusMiles();

      }) && covMatch && regMatch && areaMatch;
    });
  }

  function addLazyLoadedMarkers(stores) {
    markers.clearLayers();
    storeMarkersMap.clear();

    const bounds = map.getBounds();
    const bufferLat = 50 / 69;

    const extendedBounds = L.latLngBounds(
      [bounds.getSouth() - bufferLat, bounds.getWest() - bufferLat],
      [bounds.getNorth() + bufferLat, bounds.getEast() + bufferLat]
    );

    stores.filter(store => extendedBounds.contains([store.latitude, store.longitude]))
      .forEach(store => {
        const marker = L.circleMarker([store.latitude, store.longitude], {
          radius: 6,
          color: coverageColors[store.coverageType] || 'gray',
          fillColor: coverageColors[store.coverageType] || 'gray',
          fillOpacity: 0.8,
          weight: 1
        }).bindPopup(`
          <strong>Store #${store.storeNumber}</strong><br>
          ${store.storeName}<br>
          ${store.address}<br>
          ${store.cityDisplay}, ${store.state}<br>
          Coverage: ${store.coverageType}<br>
          Trainer City: ${store.trainerCity}<br>
          Area Manager: ${store.areaManager}<br>
          Regional Manager: ${store.regionalManager}
        `);
        markers.addLayer(marker);
        storeMarkersMap.set(store.storeNumber.replace(/^0+/, ''), marker);
      });
  }

  function updateFilterCount() {
    document.getElementById('filterCount').textContent =
      `Showing ${filteredStores.length} of ${allStores.length} stores`;
  }

async function onFilterChange() {
  const mask = document.getElementById('busyMask');
  if (mask) mask.hidden = false;
  try {
    // 1) filter + draw stores
    filterStores();
    addLazyLoadedMarkers(filteredStores);
    updateFilterCount();

    // 2) enable/disable hub options based on filtered stores
    updateTrainerHubFilter();

    // 3) choose which hubs to show (accepted vs open as independent toggles)
    const includeAccepted = toggleHubsCheckbox.checked;
    const includeOpen     = showOpenHubsCheckbox.checked;

    const hubsToShow = trainerHubs.filter(hub => {
      const typeAllowed =
        (hub.status === 'accepted' && includeAccepted) ||
        (hub.status === 'open'     && includeOpen);
      if (!typeAllowed) return false;

      return filteredStores.some(store =>
        getDistanceMiles(hub.coords[0], hub.coords[1], store.latitude, store.longitude) <= getRadiusMiles()
      );
    });

    // 4) update hub counter (colored) and render hubs
    const acceptedCount = hubsToShow.filter(h => h.status === 'accepted').length;
    const openCount     = hubsToShow.filter(h => h.status === 'open').length;
    const hubCountEl = document.getElementById('hubCount');
    if (hubCountEl) {
      hubCountEl.innerHTML =
        `Hubs shown: <span class="hubCount-accepted">${acceptedCount} accepted</span> / ` +
        `<span class="hubCount-open">${openCount} open</span>`;
    }

    addTrainerHubsAndCircles(hubsToShow);

    // 5) respect radius toggle for drawing
    if (!toggleRadiusCheckbox.checked) coverageCircles.forEach(c => map.removeLayer(c));
  } finally {
    requestAnimationFrame(() => { if (mask) mask.hidden = true; });
  }
}



    } finally {
    requestAnimationFrame(() => { if (mask) mask.hidden = true; });
  }
}
document.getElementById('resetFilters').addEventListener('click', () => {
  // coverage defaults
  for (let option of coverageFilter.options) {
    option.selected = (option.value === "Premium + Acosta" || option.value === "Premium Only");
  }

  // managers back to All
  ['regionalFilter', 'areaFilter'].forEach(id => {
    const sel = document.getElementById(id);
    Array.from(sel.options).forEach(o => o.selected = (o.value === "All"));
  });

  // hub filters cleared
  trainerHubFilter.selectedIndex = -1;
  zoomHubSelect.value = "";

  // radius back to locked 75
  allowCustom.checked = false;
  radiusInput.disabled = true;
  radiusInput.value = 75;
  radiusLabel.textContent = '75 mi';

  // toggles default
  toggleHubsCheckbox.checked   = true;  // accepted hubs ON
  toggleRadiusCheckbox.checked = true;  // circles ON
  showOpenHubsCheckbox.checked = true;  // open hubs ON

  // map + refresh + persist
  map.setView([39.5, -98.35], 5);
  onFilterChange();
  saveState();
});


  function fitToResults() {
  if (!filteredStores.length) return;
  const latLngs = filteredStores.map(s => [s.latitude, s.longitude]);
  map.fitBounds(L.latLngBounds(latLngs), { padding: [20,20] });
}
document.getElementById('fitToResults').addEventListener('click', fitToResults);


  // Export CSV and Print functionality

  document.getElementById('exportFilteredCSV').addEventListener('click', () => {
    if (filteredStores.length === 0) {
      alert('No filtered stores to export.');
      return;
    }
    const headers = ['Store Number', 'Store Name', 'Address', 'City', 'State', 'Coverage Type', 'Trainer City', 'Area Manager', 'Regional Manager'];
    const csvRows = [headers.join(',')];
    filteredStores.forEach(s => {
      const row = [
        `"${s.storeNumber}"`,
        `"${s.storeName.replace(/"/g, '""')}"`,
        `"${s.address.replace(/"/g, '""')}"`,
        `"${s.cityDisplay.replace(/"/g, '""')}"`,
        `"${s.state}"`,
        `"${s.coverageType}"`,
        `"${s.trainerCity}"`,
        `"${s.areaManager}"`,
        `"${s.regionalManager}"`
      ];
      csvRows.push(row.join(','));
    });
    const csvContent = csvRows.join('\n');
    const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'filtered_stores.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('exportVisibleCSV').addEventListener('click', () => {
    const visibleStores = filteredStores.filter(store => map.getBounds().contains([store.latitude, store.longitude]));
    if (visibleStores.length === 0) {
      alert('No visible stores to export.');
      return;
    }
    const headers = ['Store Number', 'Store Name', 'Address', 'City', 'State', 'Coverage Type', 'Trainer City', 'Area Manager', 'Regional Manager'];
    const csvRows = [headers.join(',')];
    visibleStores.forEach(s => {
      const row = [
        `"${s.storeNumber}"`,
        `"${s.storeName.replace(/"/g, '""')}"`,
        `"${s.address.replace(/"/g, '""')}"`,
        `"${s.cityDisplay.replace(/"/g, '""')}"`,
        `"${s.state}"`,
        `"${s.coverageType}"`,
        `"${s.trainerCity}"`,
        `"${s.areaManager}"`,
        `"${s.regionalManager}"`
      ];
      csvRows.push(row.join(','));
    });
    const csvContent = csvRows.join('\n');
    const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'visible_stores.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('printMap').addEventListener('click', () => {
    const tbody = document.getElementById('printableBody');
    tbody.innerHTML = '';
    filteredStores.forEach(store => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${store.storeNumber}</td>
        <td>${store.storeName}</td>
        <td>${store.address}</td>
        <td>${store.cityDisplay}</td>
        <td>${store.state}</td>
        <td>${store.coverageType}</td>
        <td>${store.trainerCity}</td>
        <td>${store.areaManager}</td>
        <td>${store.regionalManager}</td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById('printable').style.display = 'block';
    window.print();
    document.getElementById('printable').style.display = 'none';
  });

  // Search with autosuggest and popup opening

  const searchBox = document.getElementById('searchBox');
  const searchClearBtn = document.getElementById('searchClearBtn');
  const suggestionsBox = document.getElementById('searchSuggestions');
  ['coverageFilter','regionalFilter','areaFilter','trainerHubFilter'].forEach(id =>
  document.getElementById(id).addEventListener('change', saveState)
);
zoomHubSelect.addEventListener('change', saveState);
showOpenHubsCheckbox.addEventListener('change', saveState);
toggleHubsCheckbox.addEventListener('change', saveState);
toggleRadiusCheckbox.addEventListener('change', saveState);
searchBox.addEventListener('input', saveState);
  let selectedSuggestionIndex = -1;
  let suggestionResults = [];

  function closeSuggestions() {
    suggestionsBox.style.display = 'none';
    selectedSuggestionIndex = -1;
    suggestionResults = [];
  }

  function openPopupForMarker(marker) {
    if (currentOpenPopup) currentOpenPopup.closePopup();
    marker.openPopup();
    currentOpenPopup = marker;
  }

  function zoomToMarker(marker, zoomLevel=14) {
    map.setView(marker.getLatLng(), zoomLevel);
  }

  function populateSuggestions(term) {
    const t = term.toLowerCase();
    if (!t) {
      closeSuggestions();
      onFilterChange();
      return;
    }
    suggestionResults = allStores.filter(store => {
      const storeNumNoLeadingZeros = store.storeNumber.replace(/^0+/, '');
      return storeNumNoLeadingZeros === t
          || store.storeNumber.toLowerCase().includes(t)
          || store.city.toLowerCase().includes(t)
          || store.cityDisplay.toLowerCase().includes(t);
    }).slice(0, 20);

    if (suggestionResults.length === 0) {
      closeSuggestions();
      return;
    }

    suggestionsBox.innerHTML = '';
    suggestionResults.forEach((store, idx) => {
      const div = document.createElement('div');
      div.textContent = `#${store.storeNumber} - ${store.storeName} (${store.cityDisplay}, ${store.state})`;
      div.dataset.index = idx;
      div.addEventListener('click', () => {
        selectSuggestion(idx);
      });
      suggestionsBox.appendChild(div);
    });
    suggestionsBox.style.display = 'block';
    selectedSuggestionIndex = -1;
  }

  function selectSuggestion(index) {
    if (index < 0 || index >= suggestionResults.length) return;
    const store = suggestionResults[index];
    searchBox.value = `#${store.storeNumber} - ${store.storeName} (${store.cityDisplay})`;
    closeSuggestions();

    // Update filters to show only the selected store
    filteredStores = [store];
    addLazyLoadedMarkers(filteredStores);
    updateFilterCount();

    const markerKey = store.storeNumber.replace(/^0+/, '');
    const marker = storeMarkersMap.get(markerKey);
    if (marker) {
      zoomToMarker(marker);
      openPopupForMarker(marker);
    }
  }

  searchBox.addEventListener('input', () => {
    populateSuggestions(searchBox.value.trim());
  });

  searchBox.addEventListener('keydown', e => {
    if (suggestionsBox.style.display === 'none') return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      if (selectedSuggestionIndex < suggestionResults.length - 1) {
        selectedSuggestionIndex++;
        highlightSuggestion(selectedSuggestionIndex);
      }
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (selectedSuggestionIndex > 0) {
        selectedSuggestionIndex--;
        highlightSuggestion(selectedSuggestionIndex);
      }
   } else if (e.key === 'Enter') {
  e.preventDefault();
  if (selectedSuggestionIndex >= 0) {
    selectSuggestion(selectedSuggestionIndex);
  } else if (suggestionResults.length > 0) {
    selectSuggestion(0);
  }

    } else if (e.key === 'Escape') {
      closeSuggestions();
    }
  });

  function highlightSuggestion(index) {
    [...suggestionsBox.children].forEach(child => child.classList.remove('highlighted'));
    if (index >= 0 && index < suggestionsBox.children.length) {
      suggestionsBox.children[index].classList.add('highlighted');
    }
  }

  searchClearBtn.addEventListener('click', () => {
    searchBox.value = '';
    closeSuggestions();
    zoomHubSelect.value = '';
    map.setView([39.5, -98.35], 5);
    onFilterChange();
    searchBox.focus();
  });

  document.addEventListener('click', e => {
    if (!searchBox.contains(e.target) && !suggestionsBox.contains(e.target)) {
      closeSuggestions();
    }
  });

  document.addEventListener('keydown', (e) => {
  const tag = document.activeElement?.tagName;
  if (tag === 'INPUT' || tag === 'SELECT' || tag === 'TEXTAREA') return;

  if (e.key === 'r') { document.getElementById('resetFilters').click(); }
  if (e.key === 'f') { fitToResults(); }
  if (e.key === 'h') { toggleHubsCheckbox.checked = !toggleHubsCheckbox.checked; onFilterChange(); saveState(); }
  if (e.key === 'o') { showOpenHubsCheckbox.checked = !showOpenHubsCheckbox.checked; onFilterChange(); saveState(); }
  if (e.key === 'c') { toggleRadiusCheckbox.checked = !toggleRadiusCheckbox.checked; onFilterChange(); saveState(); }
  if (e.key === '/') { e.preventDefault(); searchBox.focus(); }
  if (e.key === 'z') { e.preventDefault(); zoomHubSelect.focus(); }
});


  // Initial load
  // Restore and initial draw
loadState();
onFilterChange();


})();
</script>


</body>
</html>
