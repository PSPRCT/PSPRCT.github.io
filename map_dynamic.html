<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Premium Retail Trainer Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  html, body { height:100%; margin:0; font-family:Arial, sans-serif; display:flex; flex-direction:column; }
  #filters {
    background:#fafafa; border-bottom:1px solid #ddd; padding:12px 15px;
    display:flex; flex-wrap:wrap; gap:20px; align-items:center; box-shadow:0 2px 6px rgb(0 0 0 / 0.08);
  }
  #filters > div { display:flex; align-items:center; position:relative; }
  label { font-weight:600; margin-right:8px; white-space:nowrap; color:#333; }
  select, input[type="text"], button {
    padding:6px 10px; font-size:14px; border-radius:6px; border:1px solid #ccc;
    transition:border-color .2s ease, box-shadow .2s ease;
  }
  select[multiple]{ width:170px; height:120px; }
  select:focus, input[type="text"]:focus{ outline:none; border-color:#3399ff; box-shadow:0 0 6px rgba(51,153,255,.6); }
  button{ cursor:pointer; background:#3399ff; color:#fff; border:none; border-radius:6px; padding:7px 15px; font-weight:600; }
  button:hover{ background:#2673cc; }
  #map { flex:1; margin:15px; border-radius:10px; box-shadow:0 3px 12px rgb(0 0 0 / 0.1); }

  /* Toggle pills */
  .toggles-row{display:flex;flex-wrap:wrap;gap:18px;align-items:center;margin-left:10px}
  .toggle-inline{display:inline-flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04);cursor:pointer}
  .toggle-inline .text{font-weight:600;color:#333}
  .toggle-inline input{opacity:0;width:0;height:0;position:absolute}
  .toggle-inline .tgl-slider{position:relative;display:inline-block;width:46px;height:24px;background:#ccc;border-radius:34px;transition:.3s;flex-shrink:0}
  .toggle-inline .tgl-slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s}
  .toggle-inline input:checked + .tgl-slider{background:#3399ff}
  .toggle-inline input:checked + .tgl-slider:before{transform:translateX(22px)}

  /* Radius group */
  .radius-group{display:inline-flex;align-items:center;gap:10px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
  .radius-group .radius-title{font-weight:600;color:#333}
  .radius-group input[type="range"]{width:120px}

  @media (max-width:700px){ .toggles-row{gap:10px} .toggle-inline{padding:6px 8px} .radius-group{flex-wrap:wrap} }

  /* Search clear */
  #searchWrapper{flex-grow:1;max-width:320px;position:relative}
  #searchClearBtn{position:absolute;right:6px;top:50%;transform:translateY(-50%);background:transparent;border:none;cursor:pointer;font-size:18px;color:#888}
  #searchClearBtn:hover{color:#3399ff}
  #searchSuggestions{position:absolute;top:100%;left:0;right:0;max-height:160px;overflow-y:auto;border:1px solid #ccc;background:#fff;z-index:1500;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,.15);display:none}
  #searchSuggestions div{padding:5px 8px;cursor:pointer}
  #searchSuggestions div.highlighted{background:#3399ff;color:#fff}

  /* Legend */
  .legend{position:absolute;bottom:15px;right:15px;background:#fff;padding:10px 14px;border-radius:6px;box-shadow:0 3px 10px rgba(0,0,0,.2);font-size:14px;line-height:1.4;color:#222;z-index:10000;max-width:240px}
  .legend h4{margin:0 0 8px}
  .legend-item{display:flex;align-items:center;margin-bottom:6px}
  .legend-color{width:18px;height:18px;margin-right:10px;border-radius:50%;flex-shrink:0}

  /* KPI strip & chips */
  .kpi-strip{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:10px}
  .kpi-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #e0e0e0;background:#fff}
  .kpi-dot{width:10px;height:10px;border-radius:50%}
  .kpi-chip .value{font-weight:700}
  .kpi-pct{margin-left:8px;font-size:12px;color:#444}
  .quick-actions{display:flex;gap:10px;align-items:center}
  .chip{border:1px solid #3399ff;background:#3399ff;color:#fff;border-radius:999px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer}
  .chip:hover{background:#2673cc;border-color:#2673cc}
  .chip-active{background:#ffe5e5;border-color:#ff9999;color:#b42318}

  /* Busy mask */
  .busy-mask{position:fixed;inset:0;background:rgba(255,255,255,.4);display:flex;align-items:center;justify-content:center;z-index:20000}
  .busy-mask[hidden]{display:none !important}
  .spinner{width:36px;height:36px;border-radius:50%;border:4px solid rgba(0,0,0,.15);border-top-color:#3399ff;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Hub markers */
  .hub-icon{width:22px;height:22px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.15)}
  .hub-staffed{background:#6a1b9a}
  .hub-open{background:#9e9e9e}
  .hub-badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:12px;font-weight:700;color:#fff}
  .hub-badge.staffed{background:#6a1b9a}
  .hub-badge.open{background:#9e9e9e}
  .hub-badge.next{background:#ff8c00}

  /* Hub panel + overlay */
  #hubPanel{position:absolute;top:130px;right:20px;width:360px;max-height:70vh;overflow:auto;background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.12);z-index:12000;display:none}
  #hubPanel header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eee;font-weight:700}
  #hubPanel .body{padding:10px 12px;font-size:13px}
  #hubPanel .list{max-height:52vh;overflow:auto;margin-top:8px}
  #hubPanel .row{padding:4px 0;border-bottom:1px dashed #eee}
  #hubPanel .close{background:#3399ff;color:#fff;border:0;padding:6px 12px;border-radius:999px;font-size:13px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
  #hubPanel .close::before{content:"×";font-size:16px;line-height:1}
  #hubPanel .close:hover{background:#2673cc}
  #hubPanel .footer{position:sticky;bottom:0;background:#fff;padding:10px 12px;border-top:1px solid #eee}
  #hubPanel .footer .close{width:100%}
  #hubOverlay{position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:11000}
  #hubOverlay[hidden]{display:none !important}

  /* Print panel */
  #printable{display:none;padding:24px;background:#fff}
  #printTitle{margin:0 0 12px;font-size:18px}
  #printTable{width:100%;border-collapse:collapse;font-size:12px}
  #printTable th,#printTable td{border:1px solid #ccc;padding:6px;text-align:left}
  @media print{
    body *{visibility:hidden !important}
    #printable,#printable *{visibility:visible !important}
    #printable{display:block !important;position:absolute;inset:0}
  }
</style>
</head>
<body>

<div id="filters">
  <div id="searchWrapper">
    <label for="searchBox">Search store # or city:</label>
    <input type="text" id="searchBox" autocomplete="off" placeholder="Search store # or city" style="width:100%" />
    <button id="searchClearBtn" title="Clear search">&times;</button>
    <div id="searchSuggestions"></div>
  </div>

  <div>
    <label for="coverageFilter">Coverage Type:</label>
    <select id="coverageFilter" multiple title="Select coverage types">
      <option value="All">All</option>
      <option value="Premium + Acosta">Premium + Acosta</option>
      <option value="Premium Only">Premium Only</option>
      <option value="Acosta Only">Acosta Only</option>
      <option value="Uncovered">Uncovered</option>
    </select>
  </div>

  <div>
    <label for="regionalFilter">Regional Manager:</label>
    <select id="regionalFilter" multiple title="Select regional managers">
      <option value="All" selected>All</option>
    </select>
  </div>

  <div>
    <label for="areaFilter">Area Manager:</label>
    <select id="areaFilter" multiple title="Select area managers">
      <option value="All" selected>All</option>
    </select>
  </div>

  <div>
    <label for="trainerHubFilter">Trainer Hub Filter:</label>
    <select id="trainerHubFilter" multiple title="Select trainer hubs"></select>
  </div>

  <div id="toggles" class="toggles-row">
    <label class="toggle-inline" title="Show staffed trainer hubs">
      <span class="text">Staffed hubs</span>
      <input type="checkbox" id="toggleHubs" checked role="switch" aria-label="Show staffed hubs" />
      <span class="tgl-slider" aria-hidden="true"></span>
    </label>

    <label class="toggle-inline" title="Show coverage radius circles">
      <span class="text">Coverage radius</span>
      <input type="checkbox" id="toggleRadius" checked role="switch" aria-label="Show coverage radius" />
      <span class="tgl-slider" aria-hidden="true"></span>
    </label>

    <div class="radius-group">
      <span class="radius-title">Radius:</span>
      <input type="range" id="radiusMiles" min="25" max="150" step="5" value="75" />
      <span id="radiusLabel">75 mi</span>
    </div>

    <label class="toggle-inline" title="Allow changing the default 75mi radius">
      <span class="text">Custom radius</span>
      <input type="checkbox" id="allowCustomRadius" role="switch" aria-label="Allow custom radius" />
      <span class="tgl-slider" aria-hidden="true"></span>
    </label>

    <label class="toggle-inline" title="Show placeholder open hubs">
      <span class="text">Open hubs</span>
      <input type="checkbox" id="showOpenHubs" checked role="switch" aria-label="Show open hubs" />
      <span class="tgl-slider" aria-hidden="true"></span>
    </label>
  </div>

  <div class="quick-actions">
    <button id="uncoveredChip" class="chip" title="Toggle uncovered-only">Uncovered only</button>
    <button id="outsideChip" class="chip" title="Only stores outside all visible hubs">Outside all hubs</button>
    <button id="inViewChip" class="chip" title="Only stores currently in map view">In view only</button>
    <button id="copyLinkBtn" title="Copy a URL with current filters">Copy link</button>
    <button id="exportHubsCSV" title="Export visible hubs with counts">Export Hubs CSV</button>
    <button id="exportKpiCsv" title="Export KPI counts and uncovered %">Export KPIs CSV</button>
  </div>

  <div>
    <button id="resetFilters">Reset Filters</button>
    <button id="fitToResults">Fit to Results</button>
  </div>

  <div>
    <button id="exportFilteredCSV">Export Filtered Stores CSV</button>
    <button id="printMap">Print Store List</button>
  </div>

  <div id="filterCount" style="font-weight:bold; margin-left:15px; min-width:180px;">Showing 0 of 0 stores</div>
  <span id="inViewCount" style="margin-left:8px;color:#555"></span>

  <div id="kpiStrip" class="kpi-strip" aria-live="polite"></div>
</div>

<div id="hubCount" style="padding:0 15px 6px; color:#333; font-size:14px;"></div>

<div id="map"></div>

<!-- Overlay + Hub panel -->
<div id="hubOverlay" aria-hidden="true" hidden></div>

<div id="hubPanel" role="dialog" aria-modal="true" aria-live="polite">
  <header>
    <span class="title">Hub</span>
    <button id="hubPanelClose" class="close" title="Close panel" aria-label="Close panel">Close</button>
  </header>
  <div class="body">
    <div class="summary"></div>
    <button id="exportHubPanelCsv">Export stores CSV</button>
    <div class="list"></div>
    <div class="footer">
      <button id="hubPanelCloseFooter" class="close" title="Close panel" aria-label="Close panel">Close</button>
    </div>
  </div>
</div>

<!-- Busy -->
<div id="busyMask" class="busy-mask" hidden><div class="spinner"></div></div>

<!-- Print panel -->
<div id="printable">
  <h2 id="printTitle">Store List</h2>
  <table id="printTable">
    <thead>
      <tr>
        <th>Store #</th><th>Store Name</th><th>Address</th><th>City</th><th>State</th>
        <th>Coverage</th><th>Trainer City</th><th>Area Manager</th><th>Regional Manager</th>
      </tr>
    </thead>
    <tbody id="printableBody"></tbody>
  </table>
</div>

<!-- Legend -->
<div class="legend" id="legend">
  <h4>Legend</h4>
  <div class="legend-item"><div class="legend-color" style="background:blue"></div>Premium + Acosta</div>
  <div class="legend-item"><div class="legend-color" style="background:green"></div>Premium Only</div>
  <div class="legend-item"><div class="legend-color" style="background:orange"></div>Acosta Only</div>
  <div class="legend-item"><div class="legend-color" style="background:red"></div>Uncovered</div>
  <div class="legend-item"><span class="legend-color" style="background:#6a1b9a"></span>Staffed Hub</div>
  <div class="legend-item"><span class="legend-color" style="background:#9e9e9e"></span>Open Hub</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(async function(){
  /* ---------- Config ---------- */
  const coverageColors = {
    "Premium + Acosta": "blue",
    "Premium Only": "green",
    "Acosta Only": "orange",
    "Uncovered": "red"
  };
  const NEXT_WIN_UNCOV_THRESHOLD = 35;

  /* ---------- Hubs (open + staffed) ---------- */
  const trainerHubs = [
    /* OPEN (examples) */
    { id:"belle_vernon_pa", name:"Belle Vernon, PA (Open)", coords:[40.12507,-79.8664], status:"open", person:null },
    { id:"blair_ne", name:"Blair, NE (Open)", coords:[41.5461,-96.1202], status:"open", person:null },
    { id:"centennial_co", name:"Centennial, CO (Open)", coords:[39.62732,-104.779], status:"open", person:null },

    /* STAFFED (formerly 'accepted') */
    { id: "granite_falls_nc_walker", name: "Granite Falls, NC - Lisa Walker", coords: [35.80049406642459, -81.40580339729192], status: "accepted", person: "Lisa Walker" },
    { id: "clarksville_tn_salvato", name: "Clarksville, TN - Nicholas Salvato", coords: [36.58887925062968, -87.34016705996005], status: "accepted", person: "Nicholas Salvato" },
    { id: "orange_park_fl_hall", name: "Orange Park, FL - Sabrina Hall", coords: [30.186755922868347, -81.71888670245784], status: "accepted", person: "Sabrina Hall" },
    { id: "excelsior_springs_mo_estep", name: "Excelsior Springs, MO - Teresa Estep", coords: [39.354429998804825, -94.1669969175497], status: "accepted", person: "Teresa Estep" },
    { id: "louisville_ky_lilla", name: "Louisville, KY - Heather Lilla", coords: [38.209, -85.5198], status: "accepted", person: "Heather Lilla" },
    { id: "seguin_tx_winston", name: "Seguin, TX - Christina Winston", coords: [29.56000348742034, -97.96778298897998], status: "accepted", person: "Christina Winston" },
    { id: "minden_la_slater", name: "Minden, LA - Sami Jo Slater", coords: [32.686373819218176, -93.25250065821655], status: "accepted", person: "Sami Jo Slater" },
    { id: "kenly_nc_gross", name: "Kenly, NC - Brooke Gross", coords: [35.691639527137895, -78.17947437532841], status: "accepted", person: "Brooke Gross" },
    { id: "ofallon_mo_mcallister", name: "O'Fallon, MO - Mike McAllister", coords: [38.787159492769945, -90.71070211756692], status: "accepted", person: "Mike McAllister" },
    { id: "king_george_va_faulk", name: "King George, VA - Amy Faulk", coords: [38.25603416823435, -77.06032785806136], status: "accepted", person: "Amy Faulk" },
    { id: "sparta_mo_rogers", name: "Sparta, MO - Michelle Rogers", coords: [37.0314699051066, -93.1450542446044], status: "accepted", person: "Michelle Rogers" },
    { id: "darlington_sc_jones", name: "Darlington, SC - Kristen Jones", coords: [34.305681297736434, -79.85061846002368], status: "accepted", person: "Kristen Jones" },
    { id: "orangeburg_sc_shepherd", name: "Orangeburg, SC - Kendra Shepherd", coords: [33.47688895186578, -80.85696511771735], status: "accepted", person: "Kendra Shepherd" },
    { id: "dandridge_tn_matthews", name: "Dandridge, TN - Jennifer Matthews", coords: [35.98401850406635, -83.55508935997715], status: "accepted", person: "Jennifer Matthews" },
    { id: "navassa_nc_hook", name: "Navassa, NC - Jennifer Hook", coords: [34.25673752598021, -78.02249231584642], status: "accepted", person: "Jennifer Hook" },
    { id: "ingleside_il_gonzalez", name: "Ingleside, IL – Miguel Gonzalez", coords: [42.3940241, -88.142826], status: "accepted", person: "Miguel Gonzalez" },
    { id: "cambridge_oh_kerr", name: "Cambridge, OH - Rolland Kerr", coords: [40.017145, -81.604126], status: "accepted", person: "Rolland Kerr" },
    { id: "acworth_ga_orr", name: "Acworth, GA - John Orr", coords: [34.0626832, -84.6417505], status: "accepted", person: "John Orr" },
    { id: "norman_ok_ard", name: "Norman, OK - Teryl Ard", coords: [35.2131655, -97.4837249], status: "accepted", person: "Teryl Ard" },
    { id: "fort_myers_fl_whitfield", name: "Fort Myers, FL - Muriel Curry Whitfield", coords: [26.6279876, -81.8700003], status: "accepted", person: "Muriel Curry Whitfield" },
    { id: "farmingville_ny_reich", name: "Farmingville, NY - Barbara Reich", coords: [40.8408592, -73.0307648], status: "accepted", person: "Barbara Reich" },
    { id: "folsom_ca_white", name: "Folsom, CA - Gerard White", coords: [38.6824363, -121.1481451], status: "accepted", person: "Gerard White" },
    { id: "willimantic_ct_bokoff", name: "Willimantic, CT - Melissa Bokoff", coords: [41.7101216, -72.2129277], status: "accepted", person: "Melissa Bokoff" },
    { id: "mabelvale_ar_eslick", name: "Mabelvale, AR - Angela Eslick", coords: [34.6217306, -92.4317642], status: "accepted", person: "Angela Eslick" },
    { id: "rayne_la_thibodeaux", name: "Rayne, LA - Marcie Thibodeaux", coords: [30.220651, -92.295472], status: "accepted", person: "Marcie Thibodeaux" },
    { id: "belvidere_il_vargas", name: "Belvidere, IL - Justin Vargas Salgado", coords: [42.257867, -88.846723], status: "accepted", person: "Justin Vargas Salgado" },
    { id: "kimberly_al_savage", name: "Kimberly, AL - Jessica Savage", coords: [33.77344, -86.81388], status: "accepted", person: "Jessica Savage" },
    { id: "olive_branch_ms_brown", name: "Olive Branch, MS - Annette Brown", coords: [34.92668799775572, -89.89485850418528], status: "accepted", person: "Annette Brown" },
    { id: "riverview_fl_santos",  name: "Riverview, FL - Richard Santos",  coords: [27.8661, -82.3265],  status: "accepted", person: "Richard Santos" }
  ];
  trainerHubs.forEach(h => { h.latRad = h.coords[0]*Math.PI/180; h.lngRad = h.coords[1]*Math.PI/180; });

  /* ---------- State ---------- */
  let allStores = [];
  let filteredStores = [];
  let hubsMarkers = [];
  let coverageCircles = [];
  const storeMarkersMap = new Map();
  let currentOpenPopup = null;
  let lastHubsToShow = [];
  let prevCoverageSelection = null;
  let outsideOnly = false;
  let inViewOnly = false;
  let kpiSnapshot = { counts:{}, total:0, pctUncov:0 };

  /* ---------- Utils ---------- */
  function debounce(fn, delay=150){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay); }; }
  const debouncedOnFilterChange = debounce(onFilterChange,150);

  function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
  function toRad(a){ return a*Math.PI/180; }
  function getDistanceMiles(lat1, lon1, lat2, lon2, lat1Rad, lon1Rad, lat2Rad, lon2Rad){
    const R = 3958.8;
    const φ1 = lat1Rad ?? toRad(lat1), λ1 = lon1Rad ?? toRad(lon1);
    const φ2 = lat2Rad ?? toRad(lat2), λ2 = lon2Rad ?? toRad(lon2);
    const dφ = φ2-φ1, dλ = λ2-λ1;
    const a = Math.sin(dφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
    return R*(2*Math.atan2(Math.sqrt(Math.sqrt(a)),Math.sqrt(1-a))); // oops? Wait: that's wrong.

  }
</script>
</body>
</html>
