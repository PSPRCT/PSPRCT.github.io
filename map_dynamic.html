<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Premium Retail Trainer Map (stable rollback)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  :root{
    --blue:#2f71ff; --violet:#6a1b9a; --gray:#9ea3a8; --ring:#d0d7de;
    --pa:#6c5ce7; --p:#2ecc71; --a:#f39c12; --u:#e74c3c;
    --bg:#fff; --fg:#111; --muted:#6b7280; --border:#e5e7eb; --panel:#fff;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  body{display:flex;flex-direction:column;min-width:320px}

  .topbar{position:sticky; top:0; background:var(--panel); display:flex;flex-wrap:wrap;gap:10px;align-items:center; padding:8px 10px;border-bottom:1px solid #eef0f3;z-index:10; box-shadow:0 4px 14px rgba(0,0,0,.04)}
  .search-wrap{display:flex;gap:8px;align-items:center;min-width:280px;flex:1}
  .searchbox{position:relative;flex:1}
  .searchbox input{width:100%;border:1px solid #d0d7de;border-radius:10px;padding:10px 12px 10px 64px;font-size:14px;background:var(--bg);color:var(--fg)}
  .badge-left{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:12px;font-weight:800;letter-spacing:.3px;background:#eef6ff;color:#0b5bd3;border:1px solid #cfe6ff;border-radius:999px;padding:3px 8px;display:none}
  .badge-left.show{display:inline-block}
  .results{position:absolute;left:0;right:0;top:calc(100% + 6px);background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.18);display:none;z-index:20;max-height:360px;overflow:auto}
  .results.show{display:block}
  .res{display:flex;gap:10px;padding:10px;cursor:pointer;align-items:flex-start}
  .res:hover{background:#f6f8fa}
  #searchResults .res.active{ background:#e7f0ff }
  .res .kind{flex:0 0 auto;font-size:11px;font-weight:800;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:#374151;background:var(--panel)}
  .res .text .sub{color:var(--muted);font-size:12px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .btn{border:1px solid #d0d7de;background:var(--panel);border-radius:10px;padding:8px 10px;font-weight:600;cursor:pointer;color:var(--fg); box-shadow:0 2px 8px rgba(0,0,0,.04)}
  .toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:var(--panel);white-space:nowrap}
  .toggle input{width:16px;height:16px;accent-color:var(--blue)}
  .range{display:flex;align-items:center;gap:8px;white-space:nowrap}
  .range small{color:var(--muted)}

  .filters{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:10px;padding:8px 10px;border-top:1px solid #eef0f3;border-bottom:1px solid #eef0f3;background:var(--panel); border-radius:12px; margin:6px 10px; box-shadow:0 6px 20px rgba(0,0,0,.06)}
  .picker{display:flex;flex-direction:column;gap:6px}
  .picker input{padding:6px 8px;font-size:13px;border:1px solid #d0d7de;border-radius:8px;background:var(--bg);color:var(--fg)}
  select[multiple]{height:110px;border:1px solid #d0d7de;border-radius:8px;padding:6px 8px;background:var(--bg);color:var(--fg)}

  .summary{display:flex;gap:10px;align-items:center;padding:6px 10px;border-bottom:1px solid #eef0f3;background:var(--panel)}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:var(--panel);}
  .dot{width:10px;height:10px;border-radius:50%}

  .mapwrap{position:relative;flex:1;min-height:460px;display:flex;overflow:hidden}
  #map{flex:1; min-height: 480px;}

  .sidepanel{width:380px;max-width:90vw;flex:0 0 380px;background:var(--panel);border-left:1px solid var(--border);box-shadow:-4px 0 18px rgba(0,0,0,.12);display:none;flex-direction:column;z-index:6}
  .sidepanel.show{display:flex}
  .sp-head{padding:10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
  .sp-head h3{margin:0;font-size:16px;line-height:1.2;flex:1}
  .sp-body{padding:10px;display:flex;flex-direction:column;gap:10px;height:calc(100vh - 220px);overflow:hidden}
  .sp-actions{display:flex;gap:8px;flex-wrap:wrap}
  .sp-counts{display:flex;gap:8px;flex-wrap:wrap}
  .sp-chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:3px 8px}
  .sp-list{flex:1;min-height:160px;border:1px solid var(--border);border-radius:8px;padding:0;display:flex;flex-direction:column;overflow:auto; box-shadow: inset 0 0 0 2px rgba(0,0,0,.02)}
  .sp-list input{margin:8px;border:1px solid var(--border);border-radius:8px;padding:6px 8px;position:sticky;top:0;background:var(--panel);z-index:1}
  .row{position:relative;display:flex;gap:8px;align-items:flex-start;padding:10px;border-bottom:1px solid var(--border);background:var(--panel);cursor:pointer;min-height:56px}
  .row .title{font-weight:800;line-height:1.25}
  .row .addr{color:var(--muted);font-size:12px;line-height:1.25}
  .row .num{min-width:62px;font-variant-numeric:tabular-nums;color:var(--muted)}
  .row.active{background:#e7f0ff}

  .floating{position:absolute;left:10px;top:10px;z-index:402;display:flex;gap:8px;flex-wrap:wrap}
  .floating .btn,.floating .toggle{padding:6px 8px;font-size:12px}

  .legend{position:absolute;top:10px;right:10px;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:8px 10px;box-shadow:0 6px 18px rgba(0,0,0,.12);z-index:401}

  .sandbox{position:absolute;left:10px;bottom:10px;z-index:402;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:none;min-width:260px;box-shadow:0 10px 24px rgba(0,0,0,.12)}
  .sandbox.show{display:block}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:5000}
  .modal.show{display:flex}
  .card{background:#fff;border-radius:12px;max-width:980px;width:92vw;box-shadow:0 20px 50px rgba(0,0,0,.25);border:1px solid var(--border)}
  .card header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
  .card header h3{margin:0;font-size:18px;flex:1}
  .card .body{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .kbd{display:inline-block;border:1px solid #cfd3d7;border-bottom-width:3px;border-radius:6px;padding:2px 6px;font-weight:700;background:#fff}
  .body .section{border:1px dashed #e5e7eb;border-radius:8px;padding:10px}
  @media (max-width:720px){ .card .body{grid-template-columns:1fr;} }
  @media (max-width: 1100px){ .filters{grid-template-columns:repeat(2,minmax(220px,1fr));} }
  @media (max-width: 640px){ .filters{grid-template-columns:1fr;} }

  /* simple dropdown */
  .dropdown { position:relative }
  .dropdown .dropdown-menu{ display:none; position:absolute; top:calc(100% + 6px); left:0; background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:6px; box-shadow:0 10px 24px rgba(0,0,0,.14); z-index:25 }
</style>
</head>
<body>

<div class="topbar">
  <div class="search-wrap" title="Type a store #, city/state, or hub name. Tip: type ‘near’ for nearby stores.">
    <div class="searchbox">
      <span id="searchBadge" class="badge-left">SEARCH</span>
      <input id="searchBox" type="text" placeholder="Type a store #, city/state, hub name… (tip: 'near Dallas')" autocomplete="off" aria-label="Search store or city" />
      <div id="searchResults" class="results" role="listbox"></div>
    </div>
    <button id="searchClear" class="btn" type="button" title="Clear search">Clear</button>
  </div>

  <label class="toggle"><input id="showConfirmed" type="checkbox" checked />Premium (confirmed)</label>
  <label class="toggle"><input id="showPending"   type="checkbox" checked />Premium (pending)</label>
  <label class="toggle"><input id="showAcosta"    type="checkbox" />Acosta</label>

  <div class="range" title="Hub radius used for coverage, lists, rings, overlap">
    <span>Radius</span>
    <input id="radius" type="range" min="25" max="150" step="5" value="75" />
    <b id="radiusLbl">75</b><small>mi</small>
  </div>

  <button id="fitBtn" class="btn" type="button">Fit to Results</button>
  <button id="homeBtn" class="btn" type="button">Home</button>
  <button id="resetBtn" class="btn" type="button">Reset</button>

  <div class="dropdown" id="exportDrop" style="position:relative">
    <button class="btn" type="button">Export ▾</button>
    <div class="dropdown-menu">
      <button id="exportStores" class="btn" type="button" style="display:block;width:100%;margin:4px 0">
        Export filtered stores (CSV)
      </button>
      <label class="toggle" style="margin:6px 4px;display:flex"><input id="autoReset" type="checkbox" />Auto-reset after export/print</label>
    </div>
  </div>

  <div class="dropdown" id="viewsDrop" style="position:relative">
    <button class="btn" type="button">Views ▾</button>
    <div class="dropdown-menu" id="viewsMenu">
      <button id="viewSave" class="btn" type="button" style="display:block;width:100%">Save current view…</button>
      <div style="border-top:1px solid var(--border);margin:6px 0"></div>
      <div id="viewList" style="min-width:220px"></div>
    </div>
  </div>

  <div class="dropdown" id="sourceDrop" style="position:relative">
    <button class="btn" type="button">Source ▾</button>
    <div class="dropdown-menu" id="sourceMenu">
      <div style="padding:6px 8px;font-weight:700">Data source</div>
      <button class="btn" id="srcLocal"  type="button" style="display:block;width:100%">Local JSON (default)</button>
      <button class="btn" id="srcURL"    type="button" style="display:block;width:100%">External Sheet / CSV / JSON…</button>
      <div style="border-top:1px solid var(--border);margin:6px 0"></div>
      <button class="btn link" id="srcClear" type="button" style="display:block;width:100%">Use default & clear saved source</button>
    </div>
  </div>

  <button id="gapBtn" class="btn" type="button">Gap finder</button>
  <button id="rollupBtn" class="btn" type="button">Rollups</button>
  <button id="helpBtn" class="btn" type="button">Help</button>
</div>

<div class="filters">
  <div class="picker">
    <input id="covSearch" type="text" placeholder="Search coverage…" />
    <select id="covFilter" multiple>
      <option value="All" selected>All</option>
      <option>Premium + Acosta</option>
      <option>Premium Only</option>
      <option>Acosta Only</option>
      <option>Uncovered</option>
    </select>
  </div>
  <div class="picker">
    <input id="rmSearch" type="text" placeholder="Filter regional managers…" />
    <select id="rmFilter" multiple><option value="All" selected>All</option></select>
  </div>
  <div class="picker">
    <input id="amSearch" type="text" placeholder="Filter area managers…" />
    <select id="amFilter" multiple><option value="All" selected>All</option></select>
  </div>
  <div class="picker">
    <input id="hubSearch" type="text" placeholder="Filter hubs…" />
    <select id="hubFilter" multiple><option value="All" selected>All</option></select>
  </div>
</div>

<div id="dataStatus" style="padding:6px 10px;color:var(--fg);font-size:12px"></div>

<div class="summary" id="summary">
  <span class="chip"><span class="dot" style="background:var(--pa)"></span>P+A: <b id="k_pa">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--p)"></span>Premium: <b id="k_p">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--a)"></span>Acosta: <b id="k_a">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--u)"></span>Uncov: <b id="k_u">0</b></span>
  <span class="chip">Total: <b id="k_total">0</b></span>
  <span class="chip">Hubs — <b id="k_confirmed">0</b> confirmed / <b id="k_offer">0</b> offer / <b id="k_proposed">0</b> proposed</span>
  <span class="chip" id="acostaChip" hidden>Acosta hubs: <b id="k_acosta_hubs">0</b></span>
  <span class="chip" id="datasetBadge"></span>
  <span class="chip" id="inView">In view: 0</span>
</div>

<div class="mapwrap">
  <div id="map" role="region" aria-label="Coverage Map"></div>

  <div class="floating">
    <label class="toggle"><input id="tgHeat" type="checkbox" />Heatmap</label>
    <label class="toggle"><input id="tgRings" type="checkbox" />Hub radii</label>
    <label class="toggle"><input id="tgOverlap" type="checkbox" />Overlap</label>
    <label class="toggle"><input id="tgCompare" type="checkbox" />Compare</label>
    <label class="toggle"><input id="tgWithin" type="checkbox" />Within hubs</label>
    <label class="toggle"><input id="tgCluster" type="checkbox" checked />Cluster</label>
    <button id="sandboxBtn" class="btn" type="button">New-hub sandbox</button>
  </div>

  <div class="sidepanel" id="sidepanel">
    <div class="sp-head">
      <h3 id="spTitle">Hub</h3>
      <button id="spCollapse" class="btn" type="button">⟨</button>
      <button id="spPinBtn" class="btn" type="button">Pin</button>
      <button id="spLink" class="btn" type="button">Link</button>
      <button id="spClose" class="btn" type="button">Close</button>
    </div>
    <div class="sp-body">
      <div id="spMeta" class="sp-meta" style="font-size:13px"></div>
      <div class="sp-actions">
        <button id="spExport" class="btn" type="button">Export list (CSV)</button>
        <button id="spPrint" class="btn" type="button">Print store list</button>
      </div>
      <div class="sp-quick">Radius:
        <button class="btn" type="button" data-r="50">50</button>
        <button class="btn" type="button" data-r="75">75</button>
        <button class="btn" type="button" data-r="100">100</button><small> mi</small>
      </div>
      <div id="spCounts" class="sp-counts"></div>
      <div class="sp-list" id="spListWrap">
        <input id="spSearch" type="text" placeholder="Search stores in list…" />
        <div id="spRows" class="sp-rows"></div>
      </div>
    </div>
  </div>
</div>

<!-- Help -->
<div class="modal" id="helpModal" aria-modal="true" role="dialog">
  <div class="card">
    <header>
      <h3>Help, Tips & Changelog</h3>
      <button id="helpClose" class="btn" type="button">Close</button>
    </header>
    <div class="body">
      <div class="section">
        <h4>Keyboard</h4>
        <p><span class="kbd">Ctrl</span>/<span class="kbd">⌘</span> + <span class="kbd">K</span> — Focus search</p>
        <p><span class="kbd">H</span> — Home</p>
        <p><span class="kbd">F</span> — Focus panel search</p>
      </div>
      <div class="section">
        <h4>Tips</h4>
        <ul>
          <li>Type <b>near</b> or <b>near Dallas</b> to jump the map and suggest nearby stores.</li>
          <li>Use <b>Within hubs</b> to see only stores covered by visible hubs.</li>
          <li>Pin hubs to compare coverage; <b>Overlap</b> highlights shared stores.</li>
          <li>Side panel shows counts & metrics; click a store to zoom to it.</li>
          <li>Use <b>Views</b> to save/restore your favorite setups.</li>
        </ul>
      </div>
      <div class="section">
        <h4>Changelog (local)</h4>
        <div id="changelog" style="max-height:45vh;overflow:auto;font-family:ui-monospace,Consolas,monospace;font-size:12px;background:#fafbfc;padding:8px;border-radius:8px;border:1px solid var(--border)"></div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <button class="btn" id="chgClear">Clear history</button>
          <button class="btn" id="chgExport">Export</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="busy" class="busy" hidden style="position:fixed;inset:0;background:rgba(255,255,255,.5);display:flex;align-items:center;justify-content:center;z-index:9999">
  <div style="width:36px;height:36px;border-radius:50%;border:4px solid rgba(0,0,0,.15);border-top-color:var(--blue);animation:spin .8s linear infinite"></div>
</div>
<div id="toast" class="toast" style="position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 12px;border-radius:10px;display:none;z-index:5001"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
// ===== Tiny error banner (helps surface syntax/runtime issues) =====
(function(){
  var banner = document.createElement('div');
  banner.style.cssText='position:fixed;left:10px;bottom:10px;z-index:99999;background:#111;color:#fff;padding:8px 10px;border-radius:8px;max-width:90vw;display:none';
  document.addEventListener('DOMContentLoaded', function(){ document.body.appendChild(banner); });
  function show(msg){ banner.textContent='Error: '+msg; banner.style.display='block'; }
  window.addEventListener('error', function(e){ show(e.message || String(e)); });
  window.addEventListener('unhandledrejection', function(e){ show((e.reason && e.reason.message) || String(e.reason)); });
})();
</script>

<script>
// ========================== ROLLBACK MAIN (no async/await) ==========================
(function(){

// ----- CONFIG -----
var DATA_URL_DEFAULT    = './store_data.json';
var ACOSTA_URL_DEFAULT  = './acosta_geocoded.json';
var PREMIUM_URL_DEFAULT = './premium_trainers_master.json';

var LS_STATE  = 'prt_state_v10';
var LS_VIEWS  = 'prt_views_v2';
var LS_LAST_QUERY = 'prt_last_query';
var LS_SOURCE = 'prt_source_v1';
var LS_CACHE  = 'prt_cache_v1';
var LS_CHANGELOG = 'prt_changelog_v1';

var COLORS = {
  "Premium + Acosta": css('--pa'),
  "Premium Only":     css('--p'),
  "Acosta Only":      css('--a'),
  "Uncovered":        css('--u')
};
var DEFAULT_RADIUS = 75;
var HOME_VIEW = { center:[39.5,-98.35], zoom:5 };

var FALLBACK_STORES = [
  { storeNumberStr:"1234", storeName:"Walmart", address:"701 W 51st St", city:"Austin", state:"TX", coverageType:"Uncovered", areaManager:"", regionalManager:"", trainerCity:"", lat:30.309, lng:-97.742 },
  { storeNumberStr:"5678", storeName:"Walmart", address:"10 S Riverside", city:"Chicago", state:"IL", coverageType:"Uncovered", areaManager:"", regionalManager:"", trainerCity:"", lat:41.882, lng:-87.639 }
];

// ----- STATE -----
var premiumConfirmed = [];
var premiumPending   = [];
var acostaHubs       = [];

var allStores = [];
var filteredStores = [];
var markerByStore = new Map();

var PENDING_OPEN_HUB_ID = null;
var PENDING_PIN_IDS = [];
var compareMode = false;
var pinnedHubs = [];
var lastFilterChanged = null;

// ----- MAP -----
var map = L.map('map', { zoomControl:true, inertia:true }).setView(HOME_VIEW.center, HOME_VIEW.zoom);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18, attribution:'© OpenStreetMap'}).addTo(map);
var hubPane = map.createPane('hubPane'); hubPane.style.zIndex=650; hubPane.style.pointerEvents='auto';

var markers = L.markerClusterGroup({
  disableClusteringAtZoom: 12,
  spiderfyOnMaxZoom: false,
  maxClusterRadius: function(z){ return z>=9 ? 50 : 70; },
  iconCreateFunction: clusterIconByDominantCoverage,
  chunkedLoading: true, chunkInterval:50, chunkDelay:25
});
var plainMarkers = L.layerGroup();
var targetLayer    = L.layerGroup().addTo(map);
var ringLayer      = L.layerGroup().addTo(map);
var highlightLayer = L.layerGroup().addTo(map);
var hubLayer       = L.layerGroup().addTo(map);
var heatLayerHolder = { layer:null };
map.addLayer(markers);
setTimeout(function(){ map.invalidateSize(); }, 120);

// ----- UI refs -----
var STATUS = id('dataStatus'), busy=id('busy'), toast=id('toast');
var showConfirmed = id('showConfirmed');
var showPending   = id('showPending');
var showAcosta    = id('showAcosta'); showAcosta.checked=false;
var acostaChip = id('acostaChip');
var radius      = id('radius'), radiusLbl=id('radiusLbl');
var tgHeat=id('tgHeat'), tgRings=id('tgRings'), tgOverlap=id('tgOverlap'), tgCompare=id('tgCompare'), tgWithin=id('tgWithin'), tgCluster=id('tgCluster');
var covFilter=id('covFilter'), covSearch=id('covSearch');
var rmFilter=id('rmFilter'), rmSearch=id('rmSearch');
var amFilter=id('amFilter'), amSearch=id('amSearch');
var hubFilter=id('hubFilter'), hubSearch=id('hubSearch');
var k = {
  pa:id('k_pa'), p:id('k_p'), a:id('k_a'), u:id('k_u'),
  total:id('k_total'), confirmed:id('k_confirmed'),
  offer:id('k_offer'), proposed:id('k_proposed'),
  inView:id('inView'), acostaHubs:id('k_acosta_hubs')
};

// Side panel
var sidepanel=id('sidepanel'), spTitle=id('spTitle'), spMeta=id('spMeta'), spCounts=id('spCounts');
var spRowsEl=id('spRows'), spSearch=id('spSearch'), spLink=id('spLink');
var spClose=id('spClose'), spExport=id('spExport'), spPinBtn=id('spPinBtn'), spPrint=id('spPrint'), spCollapse=id('spCollapse');
var spHub=null, spRows=[], spFilter='';

// Sandbox (placeholder in rollback)
var sandboxBtn=id('sandboxBtn');

// Helpers
function AUTO_RESET(){ var el=id('autoReset'); return !!(el && el.checked); }

// ----- Wire UI -----
showConfirmed.onchange = handleHubVisibilityChange;
showPending.onchange   = handleHubVisibilityChange;
showAcosta.onchange    = handleHubVisibilityChange;

on('input', radius, function(){
  radiusLbl.textContent = radius.value;
  recomputeCoverage(); debouncedRun(); updateRings();
  if (tgOverlap.checked) drawOverlap();
  if (spHub) openSidepanel(spHub);
  saveState();
});

on('input', covSearch, function(){ filterSelect(covFilter, covSearch.value); });
on('input', rmSearch,  function(){ filterSelect(rmFilter,  rmSearch.value); });
on('input', amSearch,  function(){ filterSelect(amFilter,  amSearch.value); });
on('input', hubSearch, function(){ filterSelect(hubFilter, hubSearch.value); });

on('change', rmFilter,  function(){ lastFilterChanged='rmFilter'; cascadeAM(); runFilter(); fitToResults(); saveState(); buildHubFilterOptions(); });
on('change', amFilter,  function(){ lastFilterChanged='amFilter'; cascadeRM(); runFilter(); fitToResults(); saveState(); buildHubFilterOptions(); });
on('change', covFilter, function(){ lastFilterChanged='covFilter'; runFilter(); saveState(); });
on('change', hubFilter, function(){ lastFilterChanged='hubFilter'; runFilter(); fitToResults(); saveState(); });

id('fitBtn').onclick  = function(){ fitToResults(); saveState(); };
id('homeBtn').onclick = function(){ map.setView(HOME_VIEW.center, HOME_VIEW.zoom); };
id('resetBtn').onclick= function(){ resetAll(); runFilter(); saveState(); };

var exportDrop = id('exportDrop'), menu = exportDrop.querySelector('.dropdown-menu');
exportDrop.querySelector('button').onclick = function(){ toggleDropdown(menu); };
on('click', document.body, function(e){ if(!exportDrop.contains(e.target)) menu.style.display='none'; }, true);
id('exportStores').onclick = function(){ exportStoresCsv(); if(AUTO_RESET()) { resetAll(); runFilter(); } };

var viewsDrop=id('viewsDrop'), viewsMenu=id('viewsMenu'), viewList=id('viewList');
viewsDrop.querySelector('button').onclick = function(){ toggleDropdown(viewsMenu); renderSavedViews(); };
on('click', document.body, function(e){ if(!viewsDrop.contains(e.target)) viewsMenu.style.display='none'; }, true);
id('viewSave').onclick = saveCurrentView;

tgHeat.onchange   = function(){ if (tgHeat.checked) updateHeat(); else clearHeat(); saveState(); };
tgRings.onchange  = function(){ updateRings(); saveState(); };
tgOverlap.onchange= function(){ if (tgOverlap.checked) drawOverlap(); else highlightLayer.clearLayers(); saveState(); };
tgCompare.onchange= function(){ compareMode = tgCompare.checked; pinnedHubs=[]; highlightLayer.clearLayers(); alert(compareMode?'Compare mode on: click hub markers to pin them.':'Compare mode off.'); saveState(); };
tgWithin.onchange = function(){ lastFilterChanged='tgWithin'; runFilter(); fitToResults(); saveState(); };
tgCluster.onchange= function(){ refreshLayerMode(); };

var searchBox=id('searchBox'), searchBadge=id('searchBadge'), searchResults=id('searchResults'), searchWrap=document.querySelector('.searchbox');
id('searchClear').onclick=function(){ searchBox.value=''; localStorage.removeItem(LS_LAST_QUERY); searchBadge.classList.remove('show'); hideResults(); clearTarget(); runFilter(); };
window.addEventListener('keydown', function(e){
  if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); searchBox.focus(); searchBox.select(); }
  if (e.key.toLowerCase()==='h'){ map.setView(HOME_VIEW.center, HOME_VIEW.zoom); }
  if (e.key.toLowerCase()==='f' && sidepanel.classList.contains('show')){ spSearch.focus(); spSearch.select(); }
});

// sidepanel actions
spClose.onclick=function(){ hideSidepanel(); };
spCollapse.onclick=function(){ hideSidepanel(); };
spSearch.addEventListener('input', function(){ spFilter = (spSearch.value||'').toLowerCase().trim(); renderSidepanelList(); });
spExport.onclick=function(){ exportSidepanelCsv(); if(AUTO_RESET()){ resetAll(); runFilter(); } };
spPrint.onclick=function(){ printSidepanelList(); if(AUTO_RESET()){ resetAll(); runFilter(); } };
spPinBtn.onclick=function(){ if (spHub) togglePinned(spHub); };
Array.prototype.forEach.call(document.querySelectorAll('.sp-quick .btn[data-r]'), function(b){
  b.addEventListener('click', function(){
    radius.value = b.getAttribute('data-r'); radiusLbl.textContent=radius.value;
    recomputeCoverage(); runFilter(); updateRings(); if(spHub) openSidepanel(spHub); saveState();
  });
});

// helpers & modals
id('helpBtn').onclick=function(){ id('helpModal').classList.add('show'); renderChangelog(); };
id('helpClose').onclick=function(){ id('helpModal').classList.remove('show'); };
id('chgClear').onclick=function(){ localStorage.removeItem(LS_CHANGELOG); renderChangelog(); toastMsg('Changelog cleared'); };
id('chgExport').onclick=function(){ var blob=new Blob([localStorage.getItem(LS_CHANGELOG)||'[]'],{type:'application/json'}); downloadBlob(blob,'changelog.json'); };

id('gapBtn').onclick=function(){ showGapFinder(); };
id('rollupBtn').onclick=function(){ showRollups(); };

// map events
markers.on('clusterclick', function(e){ map.fitBounds(e.layer.getBounds()); });
map.on('moveend zoomend', function(){
  updateInViewCount();
  if (id('tgHeat').checked){ setTimeout(updateHeat,0); }
  saveState();
});

// ----- LOAD DATA (promise chain, cached fallback) -----
showBusy(true);
var spinnerFailSafe = setTimeout(function(){ showBusy(false); }, 7000);

var src = loadSource(), srcMode = (src && src.mode) || 'local';
var URLS = {
  stores:  (srcMode==='url' && src && src.stores ) ? src.stores  : DATA_URL_DEFAULT,
  acosta:  (srcMode==='url' && src && src.acosta ) ? src.acosta  : ACOSTA_URL_DEFAULT,
  premium: (srcMode==='url' && src && src.premium) ? src.premium : PREMIUM_URL_DEFAULT
};
badgeSource(srcMode, URLS);

Promise.resolve()
  .then(function(){
    STATUS.textContent = 'Loading stores…';
    return loadAny(URLS.stores, { expect:['application/json','text/csv'] })
      .then(normalizeInputTable)
      .then(function(storeRaw){
        if (!Array.isArray(storeRaw)) throw new Error('Stores must be an array');
        allStores = normalizeStores(storeRaw);
        STATUS.textContent += '  |  '+allStores.length.toLocaleString()+' stores ready';
        populateRM(allStores); populateAM(allStores);
      })
      .catch(function(fetchErr){
        warn('Stores failed: '+ (fetchErr && fetchErr.message ? fetchErr.message : String(fetchErr)));
        STATUS.innerHTML = '<span style="color:#a15b00;font-weight:600">Loaded fallback test data</span> — provide <code>store_data.json</code> or choose Source ▾';
        allStores = normalizeStores(FALLBACK_STORES);
        populateRM(allStores); populateAM(allStores);
      });
  })
  .then(function(){
    return loadAny(URLS.acosta, { expect:['application/json','text/csv'] })
      .then(normalizeInputTable)
      .then(function(aRows){
        acostaHubs = (aRows||[])
          .map(function(r){
            var lat = num(r.Latitude || r.latitude || r.lat);
            var lng = num(r.Longitude || r.longitude || r.lng);
            var name = str(r.RepName || r.name || 'Acosta Rep');
            var city = str(r.City || ''), state=str(r.State || '');
            return (isFinite(lat)&&isFinite(lng)) ? {
              id:'ac_'+slug(name+'-'+city+'-'+state),
              name:name, fullName: name+' — '+city+', '+state,
              coords:[lat,lng], status:'acosta'
            } : null;
          }).filter(Boolean);
        STATUS.textContent += '  |  Acosta hubs: '+acostaHubs.length;
      })
      .catch(function(e){
        STATUS.innerHTML += '  |  <span style="color:#b42318">Acosta failed</span>';
        acostaHubs=[];
      });
  })
  .then(function(){
    return loadAny(URLS.premium, { expect:['application/json','text/csv'] })
      .then(normalizeInputTable)
      .then(function(rows){
        rows = Array.isArray(rows) ? rows : [];
        function statusText(r){
          var fields=[r.Status,r.status,r.HubStatus,r.Hub_Status,r.TrainerStatus,r.Trainer_Status,r.CandidateStatus,r.AssignmentStatus];
          for (var i=0;i<fields.length;i++){ var t=str(fields[i]).toLowerCase(); if(t) return t; }
          return '';
        }
        function getCity(r){
          return str(r.City||r.city||r.Hub_City||r['Hub City']||r.ProposedCity||r['Proposed City']||r.TargetCity||r['Target City']||r.CandidateCity||r['Candidate City']||r.HubCity||'');
        }
        function getState(r){
          return str(r.State||r.state||r.Hub_State||r['Hub State']||r.ProposedState||r['Proposed State']||r.TargetState||r['Target State']||r.CandidateState||r['Candidate State']||r.HubState||'');
        }
        function getCoords(r){
          var lat=num(r.Latitude||r.latitude||r.lat||r.Lat||r.lat_dd||r.Latitude__c);
          var lng=num(r.Longitude||r.longitude||r.lng||r.Lon||r.lng_dd||r.Longitude__c);
          return (isFinite(lat)&&isFinite(lng)) ? [lat,lng] : null;
        }
        function getName(r){
          return str(r.CandidateName||r.Candidate||r.RepName||r.repName||r.TrainerName||r['Trainer Name']||r.Premium_Trainer||r.PremiumTrainer||r.name||r.Name||'');
        }
        function classify(r){
          var s=statusText(r), hasName=!!getName(r);
          if (hasName && !/(offer|propos|recruit|pend)/i.test(s)) return {status:'confirmed',statusSub:'confirmed'};
          if (/(offer)/i.test(s)) return {status:'pending',statusSub:'pending_offer'};
          if (/(propos|plan|target)/i.test(s)) return {status:'pending',statusSub:'proposed'};
          if (/(recruit|source|pipeline|open)/i.test(s)) return {status:'pending',statusSub:'open'};
          return {status:'pending',statusSub: hasName?'pending_candidate':'proposed'};
        }
        function pretty(sub){
          return {
            confirmed:'Confirmed', pending_offer:'Pending Offer',
            pending_candidate:'Pending', proposed:'Proposed', open:'Open'
          }[sub] || 'Pending';
        }
        function coordsFromCityState(city,state){
          if (!city||!state) return null;
          var rows = allStores.filter(function(s){
            return (str(s.city).toLowerCase()===str(city).toLowerCase()) &&
                   (str(s.state).toUpperCase()===str(state).toUpperCase());
          });
          if (!rows.length) return null;
          var lat=0,lng=0; rows.forEach(function(s){ lat+=s.lat; lng+=s.lng; });
          return [lat/rows.length, lng/rows.length];
        }
        function toHub(r){
          var coords=getCoords(r), city=getCity(r), state=getState(r), nm=getName(r);
          if (!coords && city && state) coords=coordsFromCityState(city,state);
          if (!coords) return null;
          var c=classify(r), status=c.status, statusSub=c.statusSub, statusLabel=pretty(statusSub);
          var label=(city&&state? (city+', '+state): (city||state||'')) + ' ('+statusLabel+(nm?(' — '+nm):'')+')';
          return {
            id: (status[0]+'_')+slug((city||'')+'-'+(state||'')+'-'+coords[0].toFixed(3)+'-'+coords[1].toFixed(3)+'-'+(nm||'')),
            name: nm || 'Proposed',
            fullName: label, label: label,
            coords: coords, status: status, statusSub: statusSub, statusLabel: statusLabel,
            city: city, state: state
          };
        }
        var hubs = rows.map(toHub).filter(Boolean);
        premiumConfirmed = hubs.filter(function(h){ return h.status==='confirmed'; });
        premiumPending   = hubs.filter(function(h){ return h.status==='pending'; });
      })
      .catch(function(){ premiumConfirmed=[]; premiumPending=[]; });
  })
  .then(function(){
    buildSearchIndex();
    buildHubFilterOptions();
    if (!tryLoadSnapshot()){ tryLoadLocal(); }
    recomputeCoverage();
    runFilter(); renderHubs(); updateRings();
    updateDatasetBadge('stores:'+allStores.length, 'premium:'+(premiumConfirmed.length+premiumPending.length), 'acosta:'+acostaHubs.length, srcMode);
    pushChangelog({
      when:new Date().toISOString(), who:'local user',
      what:{stores:allStores.length, premium_confirmed:premiumConfirmed.length, premium_pending:premiumPending.length, acosta:acostaHubs.length},
      source:srcMode
    });
  })
  .catch(function(err){
    STATUS.innerHTML = '<span style="color:#b42318;font-weight:600">Init error:</span> '+escapeHtml((err && err.message)||String(err));
    console.error(err);
  })
  .finally ? .finally(done) : done(); // for older browsers

function done(){
  clearTimeout(spinnerFailSafe); showBusy(false);
  if (PENDING_PIN_IDS.length){
    pinnedHubs = visibleHubs().filter(function(h){ return PENDING_PIN_IDS.indexOf(h.id)>=0; });
    if (tgOverlap.checked) drawOverlap();
  }
  if (PENDING_OPEN_HUB_ID){
    var h = visibleHubs().find(function(x){ return x.id===PENDING_OPEN_HUB_ID; });
    if (h) openSidepanel(h);
    PENDING_OPEN_HUB_ID=null;
  }
  updateInViewCount();
  renderSavedViews();
}

// ================= SEARCH =================
var searchIdx=[], resIndex=-1, targetPin=null;
var targetIcon = L.divIcon({className:'', html:'<div style="background:#2f71ff;border:2px solid #fff;border-radius:50%;width:18px;height:18px;box-shadow:0 0 0 1px rgba(0,0,0,.25)"></div>', iconSize:[18,18], iconAnchor:[9,9]});
var hoverIcon  = L.divIcon({className:'', html:'<div style="width:22px;height:22px;border-radius:50%;border:2px solid #111;background:rgba(0,0,0,.05);box-shadow:0 0 0 1px rgba(0,0,0,.25)"></div>', iconSize:[22,22], iconAnchor:[11,11]});
var hoverMarker=null;

function buildSearchIndex(){
  searchIdx = allStores.map(function(s){
    return { kind:'STORE', store:s, lat:s.lat, lng:s.lng,
      text: ('store '+s.storeNumberStr+' '+(s.storeName||'')+' '+(s.address||'')+' '+s.city+' '+s.state+' '+(s.coverageType||'')+' '+(s.areaManager||'')+' '+(s.regionalManager||'')).toLowerCase()
    };
  });
}
function showHover(lat,lng){ if(hoverMarker) highlightLayer.removeLayer(hoverMarker); hoverMarker=L.marker([lat,lng],{icon:hoverIcon}).addTo(highlightLayer); }
function hideHover(){ if(hoverMarker){ highlightLayer.removeLayer(hoverMarker); highlightLayer.clearLayers(); hoverMarker=null; } }
function clearTarget(){ if (targetPin){ targetLayer.removeLayer(targetPin); targetPin=null; } }
function hideResults(){ searchResults.classList.remove('show'); searchResults.innerHTML=''; searchResults._data=[]; resIndex=-1; }
function showResults(list){
  if (!list.length){ hideResults(); return; }
  searchResults.innerHTML = list.map(function(r,i){
    return '<div class="res" data-i="'+i+'" role="option">'+
      '<div class="kind">'+r.kind+'</div>'+
      '<div class="text">'+
      '<div>'+escapeHtml(r.label)+'</div>'+
      (r.kind==='STORE'
        ? '<div class="sub">'+escapeHtml(r.store.address||'')+' · '+escapeHtml(r.store.city||'')+', '+escapeHtml(r.store.state||'')+' · '+escapeHtml(r.store.coverageType||'')+'</div>'
        : (r.kind==='NEAR' ? '<div class="sub">'+escapeHtml(r.store.address||'')+' · '+escapeHtml(r.store.city||'')+', '+escapeHtml(r.store.state||'')+'</div>' : '')
      )+
      '</div></div>';
  }).join('');
  searchResults.classList.add('show');
  Array.prototype.forEach.call(searchResults.querySelectorAll('.res'), function(el){
    el.addEventListener('mouseenter', function(){
      var d=searchResults._data[Number(el.getAttribute('data-i'))]; if(d && d.lat) showHover(d.lat,d.lng);
    });
    el.addEventListener('mouseleave', hideHover);
    el.addEventListener('click', function(){
      var d=searchResults._data[Number(el.getAttribute('data-i'))]; selectResult(d);
    });
  });
  searchResults._data=list; resIndex=-1;
}
function toResFromStore(s,score,kind){ return { kind:kind||'STORE', store:s, label:'Store '+s.storeNumberStr+' — '+(s.storeName||'')+', '+s.city+', '+s.state, lat:s.lat, lng:s.lng, score:score }; }
function toCityRes(city,state,lat,lng,score){ return { kind:'CITY', label:city+', '+state, lat:lat, lng:lng, score:score }; }
function smartNearest(center,limit){
  limit = limit||8;
  return allStores.map(function(s){ return [distMi(center.lat,center.lng,s.lat,s.lng), s]; })
    .sort(function(a,b){ return a[0]-b[0]; }).slice(0,limit).map(function(x,i){ return toResFromStore(x[1],80-i,'NEAR'); });
}
function fuzzyScore(hay, needle){
  hay=(hay||'').toLowerCase(); needle=(needle||'').toLowerCase().trim();
  if (!needle) return 0;
  if (hay.indexOf(needle)>=0) return 100;
  var toks=needle.split(/\s+/).filter(Boolean), hits=0; toks.forEach(function(t){ if(hay.indexOf(t)>=0) hits++; });
  return hits ? 60 + hits*10 : 0;
}
function findCityCenter(query){
  var m=(query||'').match(/^\s*(.+?)(?:,\s*([A-Za-z]{2}))?\s*$/); if(!m) return null;
  var qCity=(m[1]||'').toLowerCase(), qState=(m[2]||'').toUpperCase();
  var groups=new Map();
  allStores.forEach(function(s){
    var city=(s.city||'').toLowerCase(), st=(s.state||'').toUpperCase();
    var cityHit = (city===qCity) || (city.indexOf(qCity)>=0);
    var stateHit = !qState || st===qState;
    if (cityHit && stateHit){
      var key=city+'|'+st, g=groups.get(key) || {city:s.city,state:s.state,lat:0,lng:0,n:0};
      g.lat+=s.lat; g.lng+=s.lng; g.n++; groups.set(key,g);
    }
  });
  if (!groups.size) return null;
  var best = Array.from(groups.values()).sort(function(a,b){ return b.n-a.n; })[0];
  return { city:best.city, state:best.state, lat:best.lat/best.n, lng:best.lng/best.n, n:best.n };
}
function highlightResult(){
  Array.prototype.forEach.call(searchResults.querySelectorAll('.res'), function(el,i){
    el.classList.toggle('active', i===resIndex);
    if(i===resIndex){ var d=searchResults._data[i]; if(d && d.lat) showHover(d.lat,d.lng); }
  });
}
function selectResult(d){
  hideResults(); hideHover(); if(!d) return;
  if(d.kind==='STORE' || d.kind==='NEAR'){ openStorePopup(d.store); return; }
  if(d.kind==='CITY' || d.kind==='HUB'){
    var latlng=[d.lat,d.lng];
    showPinPopup(latlng, '<div style="font-size:13px;line-height:1.35;min-width:220px"><div style="font-weight:800;margin-bottom:4px">'+escapeHtml(d.label)+'</div><div style="color:var(--muted)">Lat: '+Number(d.lat).toFixed(4)+', Lng: '+Number(d.lng).toFixed(4)+'</div></div>');
    map.panInside(latlng, { paddingTopLeft:[20,20], paddingBottomRight:[20,20] });
  }
}
function showPinPopup(latlng, html){
  if(!targetPin){ targetPin=L.marker(latlng,{icon:targetIcon}).addTo(targetLayer); } else { targetPin.setLatLng(latlng); }
  L.popup({autoClose:true, closeOnClick:true, maxWidth:320}).setLatLng(latlng).setContent(html).openOn(map);
}

searchBox.addEventListener('input', handleSearchInput);
searchBox.addEventListener('keydown', function(e){
  var items = searchResults._data || [];
  if (e.key==='ArrowDown'){ e.preventDefault(); resIndex=Math.min(items.length-1,resIndex+1); highlightResult(); }
  if (e.key==='ArrowUp'){ e.preventDefault(); resIndex=Math.max(0,resIndex-1); highlightResult(); }
  if (e.key==='Enter'){ e.preventDefault(); if (resIndex>=0 && items[resIndex]) selectResult(items[resIndex]); }
  if (e.key==='Escape'){ hideResults(); }
});
document.addEventListener('click', function(e){ if(!searchWrap.contains(e.target)) hideResults(); });

function handleSearchInput(){
  if (!allStores.length){ hideResults(); return; }
  var qraw=(searchBox.value||'').trim(), q=qraw.toLowerCase();
  localStorage.setItem(LS_LAST_QUERY, qraw);
  var nearCity=q.match(/^near\s+(.+)$/i);
  if (!q || q==='near' || q==='near me'){
    searchBadge.textContent='NEAR'; searchBadge.classList.add('show');
    showResults(smartNearest(map.getCenter(),8)); return;
  }
  if (nearCity){
    var center=findCityCenter(nearCity[1]);
    if (center){
      map.setView([center.lat,center.lng], Math.max(map.getZoom(),8));
      showResults(smartNearest({lat:center.lat,lng:center.lng},8));
      searchBadge.textContent='NEAR'; searchBadge.classList.add('show');
      showPinPopup([center.lat,center.lng],
        '<div style="font-size:13px;line-height:1.35;min-width:220px"><div style="font-weight:800;margin-bottom:4px">Near '+escapeHtml(center.city)+', '+escapeHtml(center.state)+'</div><div style="color:var(--muted)">'+center.n+' reference stores • '+center.lat.toFixed(4)+', '+center.lng.toFixed(4)+'</div></div>');
      return;
    }
  }
  var items=[], numInside=q.match(/\b(\d{3,6})\b/);
  if (numInside){
    var s=allStores.find(function(x){ return x.storeNumberStr===numInside[1]; });
    if (s) items.push(toResFromStore(s,120));
  }
  var cityHits=new Map();
  allStores.forEach(function(s){
    var score=fuzzyScore(s.city+', '+s.state, q);
    if (score>=70){
      var key=s.city+'|'+s.state, v=cityHits.get(key)||{city:s.city,state:s.state,lat:0,lng:0,n:0,score:score};
      v.lat+=s.lat; v.lng+=s.lng; v.n++; v.score=Math.max(v.score,score); cityHits.set(key,v);
    }
  });
  Array.from(cityHits.values()).sort(function(a,b){ return b.score-a.score || b.n-a.n; }).slice(0,8)
    .forEach(function(c){ items.push(toCityRes(c.city,c.state,c.lat/c.n,c.lng/c.n,85)); });
  searchIdx.forEach(function(it){ var sc=fuzzyScore(it.text,q); if(sc>=70) items.push(toResFromStore(it.store,sc)); });
  visibleHubs().forEach(function(h){ var sc=fuzzyScore((h.fullName||h.name||''),q); if(sc>=70) items.push({kind:'HUB', label:(h.fullName||h.name), lat:h.coords[0], lng:h.coords[1], score:sc}); });
  var seen=new Set(), out=[];
  items.sort(function(a,b){ return b.score-a.score; }).forEach(function(it){
    var k=it.kind+'|'+it.label+'|'+it.lat+'|'+it.lng; if(!seen.has(k)){ seen.add(k); out.push(it); }
  });
  if (out.length){ searchBadge.textContent='SEARCH'; searchBadge.classList.add('show'); } else { searchBadge.classList.remove('show'); }
  showResults(out.slice(0,60));
}

// ========== FILTERING & MARKERS ==========
function storeFilter(s){
  var covSel = Array.prototype.map.call(covFilter.selectedOptions, function(o){ return o.value; });
  var covOK  = covSel.indexOf('All')>=0 || covSel.indexOf(s.coverageType||'')>=0;
  var rmSel = Array.prototype.map.call(rmFilter.selectedOptions, function(o){ return o.value; });
  var amSel = Array.prototype.map.call(amFilter.selectedOptions, function(o){ return o.value; });
  var rmOK  = rmSel.indexOf('All')>=0 || rmSel.indexOf(s.regionalManager||'')>=0;
  var amOK  = amSel.indexOf('All')>=0 || amSel.indexOf(s.areaManager||'')>=0;

  var hubSel = Array.prototype.map.call(hubFilter.selectedOptions, function(o){ return o.value; });
  var hubOK = true;
  if (hubSel.length && hubSel.indexOf('All')<0){
    var r=num(radius.value)||DEFAULT_RADIUS, hubsNow=visibleHubs(),
        sel=hubsNow.filter(function(h){ return hubSel.indexOf(h.id)>=0; });
    hubOK = sel.some(function(h){ return distMi(s.lat,s.lng,h.coords[0],h.coords[1])<=r; });
  }
  var withinOK=true;
  if (tgWithin.checked){
    var r2=num(radius.value)||DEFAULT_RADIUS;
    withinOK = visibleHubs().some(function(h){ return distMi(s.lat,s.lng,h.coords[0],h.coords[1])<=r2; });
  }
  return covOK && rmOK && amOK && hubOK && withinOK;
}
var debouncedRun=(function(){ var t; return function(){ clearTimeout(t); t=setTimeout(runFilter,90); }; })();

function runFilter(){
  markerByStore.clear();
  if (tgCluster.checked){ markers.clearLayers(); } else { plainMarkers.clearLayers(); }

  filteredStores = allStores.filter(storeFilter);
  var addTo = tgCluster.checked ? markers : plainMarkers;
  if (!tgCluster.checked) { map.addLayer(plainMarkers); }

  filteredStores.forEach(function(s){
    var m=L.circleMarker([s.lat,s.lng],{radius:5,weight:1,color:'#fff',fillOpacity:.95,fillColor:COLORS[s.coverageType]||'#888'})
      .bindTooltip('Store '+escapeHtml(s.storeNumberStr)+' — '+escapeHtml(s.city)+', '+escapeHtml(s.state), {direction:'top', offset:[0,-10]})
      .on('click', function(){ openStorePopup(s); });
    addTo.addLayer(m); markerByStore.set(s,m);
  });

  updateSummaryCounts(); updateInViewCount();
  if (tgHeat.checked) updateHeat();
  updateRings();
  renderHubs(); // ensure hub toggles/cascades reflect
}
function refreshLayerMode(){
  if (tgCluster.checked){
    map.removeLayer(plainMarkers);
    if(!map.hasLayer(markers)) map.addLayer(markers);
    runFilter();
  } else {
    map.removeLayer(markers);
    if(!map.hasLayer(plainMarkers)) map.addLayer(plainMarkers);
    runFilter();
  }
}
function fitToResults(){
  var arr=filteredStores; if(!arr.length) return;
  var b=L.latLngBounds(arr.map(function(s){ return [s.lat,s.lng]; })); map.fitBounds(b.pad(0.15));
}
function openStorePopup(s){
  var latlng=[s.lat,s.lng];
  var html = '<div style="font-size:13px;min-width:240px;line-height:1.35">'+
    '<div style="font-weight:800;margin-bottom:4px">Store '+escapeHtml(s.storeNumberStr)+' — '+escapeHtml(s.storeName||'')+'</div>'+
    '<div>'+escapeHtml(s.address||'')+'</div>'+
    '<div>'+escapeHtml(s.city||'')+', '+escapeHtml(s.state||'')+'</div>'+
    '<div style="margin-top:6px"><span class="dot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:'+(COLORS[s.coverageType]||'#888')+'"></span> '+escapeHtml(s.coverageType||'')+'</div>'+
    ((s.areaManager||s.regionalManager) ? '<div style="color:var(--muted);margin-top:6px">AM: '+escapeHtml(s.areaManager||'—')+' • RM: '+escapeHtml(s.regionalManager||'—')+'</div>' : '')+
  '</div>';
  L.popup({autoClose:true, closeOnClick:true, maxWidth:320}).setLatLng(latlng).setContent(html).openOn(map);
  var m=markerByStore.get(s); if(m && markers.hasLayer(m)) markers.zoomToShowLayer(m, function(){ m.openPopup && m.openPopup(); });
}

// ===== COVERAGE & HUBS =====
function visibleHubs(){
  var list=[]; if (showConfirmed.checked) list=list.concat(premiumConfirmed);
  if (showPending.checked) list=list.concat(premiumPending);
  if (showAcosta.checked) list=list.concat(acostaHubs);
  return list;
}
function recomputeCoverage(){
  var r=num(radius.value)||DEFAULT_RADIUS;
  allStores.forEach(function(s){
    var inPrem = inAny(hcat(premiumConfirmed,premiumPending), s.lat,s.lng,r);
    var inAco  = inAny(acostaHubs, s.lat,s.lng,r);
    var type='Uncovered';
    if (inPrem && inAco) type='Premium + Acosta';
    else if (inPrem) type='Premium Only';
    else if (inAco) type='Acosta Only';
    s.coverageType=type;
  });
}
function inAny(hubs, lat,lng, r){
  if (!hubs || !hubs.length) return false;
  for (var i=0;i<hubs.length;i++){
    var h=hubs[i]; if (distMi(lat,lng,h.coords[0],h.coords[1])<=r) return true;
  }
  return false;
}
function renderHubs(){
  hubLayer.clearLayers();
  visibleHubs().forEach(function(h){
    var el=document.createElement('div'); el.className='hub '+(h.status==='acosta'?'acosta':(h.status==='confirmed'?'confirmed':'pending'));
    el.style.cssText='width:20px;height:20px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.25);'+
      (h.status==='acosta'?'background:'+css('--a'): (h.status==='confirmed'?'background:'+css('--violet'):'background:#9ea3a8'));
    var icon=L.divIcon({className:'', html:el, iconSize:[20,20], iconAnchor:[10,10]});
    L.marker(h.coords, {icon:icon, pane:'hubPane'})
      .on('click', function(){ compareMode ? togglePinned(h) : openSidepanel(h); })
      .bindTooltip(escapeHtml(h.fullName||h.name), {direction:'top', offset:[0,-12], opacity:.95, sticky:true})
      .addTo(hubLayer);
  });
}
function updateRings(){
  ringLayer.clearLayers(); if(!tgRings.checked) return;
  var r=num(radius.value)||DEFAULT_RADIUS;
  visibleHubs().forEach(function(h){
    L.circle(h.coords, { radius:r*1609.34, color:'#000', weight:1, opacity:.25, fill:false }).addTo(ringLayer);
  });
}
function drawOverlap(){
  highlightLayer.clearLayers(); if(!tgOverlap.checked) return;
  var r=num(radius.value)||DEFAULT_RADIUS;
  filteredStores.forEach(function(s){
    var count=visibleHubs().reduce(function(n,h){ return n + (distMi(s.lat,s.lng,h.coords[0],h.coords[1])<=r ? 1 : 0); }, 0);
    if (count>=2){ L.circleMarker([s.lat,s.lng], {radius:7,color:'#000',weight:2,fill:false}).addTo(highlightLayer); }
  });
}

function togglePinned(h){
  var ix=pinnedHubs.findIndex(function(x){ return x.id===h.id; });
  if (ix>=0) pinnedHubs.splice(ix,1);
  else { if (pinnedHubs.length>=2) pinnedHubs.shift(); pinnedHubs.push(h); }
  if (tgOverlap.checked) drawOverlap();
}

// HUB filter options
function buildHubFilterOptions(){
  var oldSel=new Set(Array.prototype.map.call(hubFilter.selectedOptions, function(o){ return o.value; }));
  var hubs=visibleHubs(), opts=['<option value="All"'+(oldSel.has('All')?' selected':'')+'>All</option>'];
  hubs.forEach(function(h){ opts.push('<option value="'+escapeHtml(h.id)+'"'+(oldSel.has(h.id)?' selected':'')+'>'+escapeHtml(h.fullName||h.name)+'</option>'); });
  hubFilter.innerHTML = opts.join('');
}
function cascadeAM(){
  var rms=Array.prototype.map.call(rmFilter.selectedOptions, function(o){ return o.value; });
  var inRM=function(s){ return rms.indexOf('All')>=0 || rms.indexOf(s.regionalManager||'')>=0; };
  var ams=uniq(allStores.filter(inRM).map(function(s){ return s.areaManager||''; }).filter(Boolean)).sort();
  var sel=new Set(Array.prototype.map.call(amFilter.selectedOptions, function(o){ return o.value; }));
  amFilter.innerHTML = '<option value="All"'+(sel.has('All')?' selected':'')+'>All</option>'+ams.map(function(a){ return '<option'+(sel.has(a)?' selected':'')+'>'+escapeHtml(a)+'</option>'; }).join('');
}
function cascadeRM(){
  var ams=Array.prototype.map.call(amFilter.selectedOptions, function(o){ return o.value; });
  var inAM=function(s){ return ams.indexOf('All')>=0 || ams.indexOf(s.areaManager||'')>=0; };
  var rms=uniq(allStores.filter(inAM).map(function(s){ return s.regionalManager||''; }).filter(Boolean)).sort();
  var sel=new Set(Array.prototype.map.call(rmFilter.selectedOptions, function(o){ return o.value; }));
  rmFilter.innerHTML = '<option value="All"'+(sel.has('All')?' selected':'')+'>All</option>'+rms.map(function(rm){ return '<option'+(sel.has(rm)?' selected':'')+'>'+escapeHtml(rm)+'</option>'; }).join('');
}

// ===== SIDE PANEL =====
function openSidepanel(h){
  spHub=h; sidepanel.classList.add('show');
  spTitle.textContent = h.fullName || h.name || 'Hub';
  spMeta.innerHTML = '<div>'+escapeHtml(h.city||'')+(h.state?(', '+escapeHtml(h.state)):'')+' • <b>'+escapeHtml(h.statusLabel||h.status||'')+'</b></div>';
  var r=num(radius.value)||DEFAULT_RADIUS;
  spRows = allStores.filter(function(s){ return distMi(s.lat,s.lng,h.coords[0],h.coords[1])<=r; })
    .map(function(s){ return { key:String(s.storeNumberStr), title:'Store '+s.storeNumberStr+' — '+(s.storeName||''), addr:(s.address||'')+', '+(s.city||'')+', '+(s.state||''), store:s }; })
    .sort(function(a,b){ return Number(a.store.storeNumberStr)-Number(b.store.storeNumberStr); });
  renderSidepanelCounts(h, spRows.length);
  renderSidepanelList();
  map.setView(h.coords, Math.max(map.getZoom(), 8));
  spLink.onclick=function(){ copyLinkToHub(h); };
}
function renderSidepanelCounts(h,n){
  var covered={'Premium + Acosta':0, 'Premium Only':0, 'Acosta Only':0, 'Uncovered':0};
  spRows.forEach(function(rw){ covered[rw.store.coverageType||'Uncovered']++; });
  spCounts.innerHTML =
    '<div class="sp-chip"><span class="dot" style="background:'+COLORS['Premium + Acosta']+'"></span>P+A: <b>'+covered['Premium + Acosta']+'</b></div>'+
    '<div class="sp-chip"><span class="dot" style="background:'+COLORS['Premium Only']+'"></span>Premium: <b>'+covered['Premium Only']+'</b></div>'+
    '<div class="sp-chip"><span class="dot" style="background:'+COLORS['Acosta Only']+'"></span>Acosta: <b>'+covered['Acosta Only']+'</b></div>'+
    '<div class="sp-chip"><span class="dot" style="background:'+COLORS['Uncovered']+'"></span>Uncovered: <b>'+covered['Uncovered']+'</b></div>'+
    '<div class="sp-chip">Total: <b>'+n+'</b></div>';
}
function renderSidepanelList(){
  var rows = spRows.filter(function(r){
    if(!spFilter) return true;
    var hay=(r.title+' '+r.addr).toLowerCase();
    return hay.indexOf(spFilter)>=0;
  });
  spRowsEl.innerHTML = rows.map(function(r){
    return '<div class="row" data-id="'+escapeHtml(r.key)+'">'+
      '<div class="num">'+escapeHtml(r.key)+'</div>'+
      '<div class="text"><div class="title">'+escapeHtml(r.title)+'</div><div class="addr">'+escapeHtml(r.addr)+'</div></div>'+
      '<div class="pill" style="margin-left:auto"><span class="dot" style="background:'+(COLORS[r.store.coverageType]||'#888')+'"></span></div>'+
    '</div>';
  }).join('');
  Array.prototype.forEach.call(spRowsEl.querySelectorAll('.row'), function(el){
    el.addEventListener('click', function(){
      var id = el.getAttribute('data-id');
      var row = spRows.find(function(x){ return x.key===id; });
      if (row){ openStorePopup(row.store); map.panTo([row.store.lat,row.store.lng]); }
      Array.prototype.forEach.call(spRowsEl.querySelectorAll('.row'), function(o){ o.classList.remove('active'); });
      el.classList.add('active');
    });
  });
}

// ===== SUMMARY, COUNTS, HEAT =====
function updateSummaryCounts(){
  var counts={'Premium + Acosta':0, 'Premium Only':0, 'Acosta Only':0, 'Uncovered':0};
  filteredStores.forEach(function(s){ counts[s.coverageType||'Uncovered']++; });
  k.pa.textContent = counts['Premium + Acosta'];
  k.p.textContent  = counts['Premium Only'];
  k.a.textContent  = counts['Acosta Only'];
  k.u.textContent  = counts['Uncovered'];
  k.total.textContent = filteredStores.length;

  // hub tallies
  var offer = premiumPending.filter(function(h){ return h.statusSub==='pending_offer'; }).length;
  var proposed = premiumPending.length - offer;
  k.confirmed.textContent = premiumConfirmed.length;
  k.offer.textContent = offer;
  k.proposed.textContent = proposed;

  acostaChip.hidden = !showAcosta.checked;
  k.acostaHubs.textContent = acostaHubs.length;
}
function updateInViewCount(){
  var b = map.getBounds(), n=0;
  filteredStores.forEach(function(s){ if(b.contains([s.lat,s.lng])) n++; });
  k.inView.textContent = 'In view: '+n.toLocaleString();
}
function updateHeat(){
  var pts = filteredStores.map(function(s){ return [s.lat,s.lng, 0.5]; });
  if (!heatLayerHolder.layer){
    heatLayerHolder.layer = L.heatLayer(pts, { radius:22, blur:15, maxZoom:10 });
    heatLayerHolder.layer.addTo(map);
  } else {
    heatLayerHolder.layer.setLatLngs(pts);
  }
}
function clearHeat(){
  if (heatLayerHolder.layer){ map.removeLayer(heatLayerHolder.layer); heatLayerHolder.layer=null; }
}

// ===== EXPORTS & PRINT =====
function exportStoresCsv(){
  var cols=['Store #','Store Name','Address','City','State','Coverage Type','Area Manager','Regional Manager','Lat','Lng'];
  var rows=filteredStores.map(function(s){
    return [s.storeNumberStr,s.storeName||'',s.address||'',s.city||'',s.state||'',s.coverageType||'',s.areaManager||'',s.regionalManager||'',s.lat,s.lng];
  });
  var csv = toCSV([cols].concat(rows));
  downloadText(csv,'filtered_stores.csv','text/csv');
  toastMsg('Exported '+rows.length+' stores');
}
function exportSidepanelCsv(){
  if(!spHub) return;
  var cols=['Store #','Store Name','Address','City','State','Coverage Type','AM','RM','Lat','Lng','Hub','Hub Status','Radius (mi)'];
  var r=num(radius.value)||DEFAULT_RADIUS;
  var rows=spRows.map(function(rw){
    var s=rw.store;
    return [s.storeNumberStr,s.storeName||'',s.address||'',s.city||'',s.state||'',s.coverageType||'',s.areaManager||'',s.regionalManager||'',s.lat,s.lng,(spHub.fullName||spHub.name||''),(spHub.statusLabel||spHub.status||''),r];
  });
  var csv = toCSV([cols].concat(rows));
  downloadText(csv, 'hub_store_list.csv','text/csv');
  toastMsg('Exported list for '+(spHub.fullName||spHub.name));
}
function printSidepanelList(){
  var html='<!doctype html><meta charset="utf-8"><title>Store List</title>'+
    '<style>body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px} table{border-collapse:collapse;width:100%} th,td{border:1px solid #ddd;padding:6px 8px;font-size:12px} th{background:#f6f8fa;text-align:left}</style>'+
    '<h2>'+(spHub?escapeHtml(spHub.fullName||spHub.name):'Hub')+' — '+(num(radius.value)||DEFAULT_RADIUS)+' mi</h2>'+
    '<table><thead><tr><th>#</th><th>Store</th><th>Address</th><th>City</th><th>State</th><th>Coverage</th></tr></thead><tbody>'+
    spRows.map(function(rw){
      var s=rw.store;
      return '<tr><td>'+escapeHtml(String(s.storeNumberStr))+'</td><td>'+escapeHtml(s.storeName||'')+'</td><td>'+escapeHtml(s.address||'')+'</td><td>'+escapeHtml(s.city||'')+'</td><td>'+escapeHtml(s.state||'')+'</td><td>'+escapeHtml(s.coverageType||'')+'</td></tr>';
    }).join('')+
    '</tbody></table><script>window.onload=function(){setTimeout(function(){window.print()},200)}</script>';
  var w=window.open('','_blank'); if(w){ w.document.write(html); w.document.close(); }
}

// ===== VIEWS & SOURCE =====
function saveCurrentView(){
  var views = JSON.parse(localStorage.getItem(LS_VIEWS)||'[]');
  var name = prompt('Name this view:','View '+(views.length+1)); if(!name) return;
  var v = snapshotState(); v.name=name;
  views.push(v);
  localStorage.setItem(LS_VIEWS, JSON.stringify(views));
  renderSavedViews();
  toastMsg('Saved view “'+name+'”');
}
function renderSavedViews(){
  var views = JSON.parse(localStorage.getItem(LS_VIEWS) || '[]');

  var html = views.length
    ? views.map(function(v,i){
        return `<button data-i="${i}">${escapeHtml(v.name || ("View " + (i+1)))}</button>`;
      }).join('')
    : '<div style="padding:6px 8px;color:var(--muted)">No saved views yet.</div>';

  id('viewList').innerHTML = html;

  Array.prototype.forEach.call(
    id('viewList').querySelectorAll('button[data-i]'),
    function(b){
      b.onclick = function(){
        var arr = JSON.parse(localStorage.getItem(LS_VIEWS) || '[]');
        var ix = Number(b.getAttribute('data-i'));
        if (arr[ix]) applySnapshot(arr[ix]);
      };
    }
  );
}


function badgeSource(mode, urls){
  var text = (mode==='url') ? ('External ('+[urls.stores,urls.premium,urls.acosta].filter(Boolean).length+' files)') : 'Local JSON';
  id('datasetBadge').textContent = text;
}
function loadSource(){
  try{ return JSON.parse(localStorage.getItem(LS_SOURCE)||''); }catch(e){ return null; }
}
id('srcLocal').onclick=function(){
  localStorage.removeItem(LS_SOURCE);
  location.reload();
};
id('srcURL').onclick=function(){
  var stores = prompt('URL for Stores (CSV or JSON):', '');
  if(!stores) return;
  var premium = prompt('URL for Premium hubs (CSV or JSON):', '');
  var acosta  = prompt('URL for Acosta hubs (CSV or JSON):', '');
  var cfg={mode:'url', stores:stores, premium:premium||null, acosta:acosta||null};
  localStorage.setItem(LS_SOURCE, JSON.stringify(cfg));
  location.reload();
};
id('srcClear').onclick=function(){ localStorage.removeItem(LS_SOURCE); location.reload(); };

// ===== SNAPSHOT (STATE SAVE/LOAD) =====
function snapshotState(){
  var selToArr = function(sel){ return Array.prototype.map.call(sel.selectedOptions, function(o){return o.value;}); };
  var b = map.getBounds();
  return {
    radius:num(radius.value),
    toggles:{ confirmed:showConfirmed.checked, pending:showPending.checked, acosta:showAcosta.checked,
      heat:tgHeat.checked, rings:tgRings.checked, overlap:tgOverlap.checked, compare:tgCompare.checked, within:tgWithin.checked, cluster:tgCluster.checked },
    filters:{ cov:selToArr(covFilter), rm:selToArr(rmFilter), am:selToArr(amFilter), hub:selToArr(hubFilter) },
    view:{ center:map.getCenter(), zoom:map.getZoom(), bounds:[[b.getSouth(),b.getWest()],[b.getNorth(),b.getEast()]] },
    search: searchBox.value || '',
    pins: pinnedHubs.map(function(h){return h.id;}),
    openHub: spHub ? spHub.id : null
  };
}
function applySnapshot(snap){
  if(!snap) return;
  radius.value = snap.radius || DEFAULT_RADIUS; radiusLbl.textContent=radius.value;

  showConfirmed.checked = !!(snap.toggles && snap.toggles.confirmed);
  showPending.checked   = !!(snap.toggles && snap.toggles.pending);
  showAcosta.checked    = !!(snap.toggles && snap.toggles.acosta);
  tgHeat.checked        = !!(snap.toggles && snap.toggles.heat);
  tgRings.checked       = !!(snap.toggles && snap.toggles.rings);
  tgOverlap.checked     = !!(snap.toggles && snap.toggles.overlap);
  tgCompare.checked     = !!(snap.toggles && snap.toggles.compare); compareMode=tgCompare.checked;
  tgWithin.checked      = !!(snap.toggles && snap.toggles.within);
  tgCluster.checked     = !!(snap.toggles && snap.toggles.cluster);

  setMultiSelect(covFilter, snap.filters && snap.filters.cov);
  setMultiSelect(rmFilter,  snap.filters && snap.filters.rm);
  setMultiSelect(amFilter,  snap.filters && snap.filters.am);
  buildHubFilterOptions(); // depends on toggles
  setMultiSelect(hubFilter, snap.filters && snap.filters.hub);

  if (snap.view && snap.view.center){ map.setView([snap.view.center.lat, snap.view.center.lng], snap.view.zoom||HOME_VIEW.zoom); }
  if (typeof snap.search==='string'){ searchBox.value=snap.search; }

  PENDING_OPEN_HUB_ID = snap.openHub || null;
  PENDING_PIN_IDS = Array.isArray(snap.pins)? snap.pins : [];

  recomputeCoverage(); runFilter(); updateRings(); if (tgOverlap.checked) drawOverlap();
  buildHubFilterOptions();
}
function tryLoadSnapshot(){
  try{
    var raw=localStorage.getItem(LS_STATE); if(!raw) return false;
    var snap=JSON.parse(raw); applySnapshot(snap); return true;
  }catch(e){ return false; }
}
function saveState(){ try{ localStorage.setItem(LS_STATE, JSON.stringify(snapshotState())); }catch(e){} }
function tryLoadLocal(){
  var q = localStorage.getItem(LS_LAST_QUERY)||''; if(q){ searchBox.value=q; }
}

// ===== GAP FINDER / ROLLUPS (lightweight) =====
function showGapFinder(){
  // Simple “uncovered by distance” list from current center outwards
  var c = map.getCenter();
  var rows = allStores
    .map(function(s){ return { s:s, d: distMi(c.lat,c.lng, s.lat,s.lng) }; })
    .filter(function(x){ return (x.s.coverageType||'Uncovered')==='Uncovered'; })
    .sort(function(a,b){ return a.d-b.d; }).slice(0,50);
  var html='<h3 style="margin:0 0 6px">Nearest Uncovered (from map center)</h3>'+
    '<ol style="margin:0;padding-left:18px">'+rows.map(function(r){
      var s=r.s;
      return '<li>Store '+escapeHtml(String(s.storeNumberStr))+' — '+escapeHtml(s.city)+', '+escapeHtml(s.state)+' ('+r.d.toFixed(1)+' mi)</li>';
    }).join('')+'</ol>';
  toastBig(html);
}
function showRollups(){
  var totals={'Premium + Acosta':0,'Premium Only':0,'Acosta Only':0,'Uncovered':0};
  allStores.forEach(function(s){ totals[s.coverageType||'Uncovered']++; });
  var html='<h3 style="margin:0 0 6px">Rollups (all stores)</h3>'+
    '<div>P+A: '+totals['Premium + Acosta'].toLocaleString()+'</div>'+
    '<div>Premium: '+totals['Premium Only'].toLocaleString()+'</div>'+
    '<div>Acosta: '+totals['Acosta Only'].toLocaleString()+'</div>'+
    '<div>Uncovered: '+totals['Uncovered'].toLocaleString()+'</div>';
  toastBig(html);
}

// ===== CLUSTER ICON =====
function clusterIconByDominantCoverage(cluster){
  var children = cluster.getAllChildMarkers();
  var tally={'Premium + Acosta':0,'Premium Only':0,'Acosta Only':0,'Uncovered':0};
  children.forEach(function(m){
    try{
      var c = m.options.fillColor || '#999';
      // We don’t know coverage type directly—approximate by color match:
      if (c===COLORS['Premium + Acosta']) tally['Premium + Acosta']++;
      else if (c===COLORS['Premium Only']) tally['Premium Only']++;
      else if (c===COLORS['Acosta Only']) tally['Acosta Only']++;
      else tally['Uncovered']++;
    }catch(e){ tally['Uncovered']++; }
  });
  var best='Uncovered', max=-1; for (var k in tally){ if(tally[k]>max){ max=tally[k]; best=k; } }
  var color = (COLORS[best]||'#888');
  var count = children.length;
  var html = '<div style="background:'+color+';color:#fff;border:2px solid #fff;border-radius:999px;box-shadow:0 0 0 1px rgba(0,0,0,.25);width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-weight:800">'+count+'</div>';
  return L.divIcon({ html:html, className:'', iconSize:[34,34] });
}

// ===== UTILS =====
function id(x){ return document.getElementById(x); }
function on(ev, el, fn, capture){ el.addEventListener(ev, fn, !!capture); }
function css(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }
function num(x){ var n=Number(x); return isFinite(n)?n:NaN; }
function str(x){ return (x==null)?'':String(x).trim(); }
function uniq(arr){ var s=new Set(arr); return Array.from(s); }
function hcat(a,b){ return (a||[]).concat(b||[]); }
function escapeHtml(s){ return String(s==null?'':s).replace(/[&<>"']/g,function(c){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);}); }
function slug(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
function distMi(lat1,lon1,lat2,lon2){
  var R=3958.761; var dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function toRad(d){ return d*Math.PI/180; }

function setMultiSelect(sel, values){
  if(!values || !values.length) return;
  Array.prototype.forEach.call(sel.options, function(o){ o.selected = values.indexOf(o.value)>=0; });
}
function filterSelect(sel, q){
  q=(q||'').toLowerCase();
  Array.prototype.forEach.call(sel.options, function(o){
    if (o.value==='All'){ o.hidden=false; return; }
    var show = !q || (o.textContent||'').toLowerCase().indexOf(q)>=0;
    o.hidden = !show;
  });
}
function toggleDropdown(menu){ menu.style.display = (menu.style.display==='block' ? 'none' : 'block'); }

function toCSV(rows){
  return rows.map(function(r){
    return r.map(function(v){
      var s=(v==null?'':String(v)); if (/[",\n]/.test(s)) s='"'+s.replace(/"/g,'""')+'"'; return s;
    }).join(',');
  }).join('\n');
}
function downloadText(text, filename, mime){
  var blob=new Blob([text],{type: mime||'text/plain;charset=utf-8'}); downloadBlob(blob, filename);
}
function downloadBlob(blob, filename){
  var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
  setTimeout(function(){ URL.revokeObjectURL(a.href); }, 500);
}
function toastMsg(msg){ var t=toast; t.textContent=msg; t.style.display='block'; setTimeout(function(){ t.style.display='none'; }, 1800); }
function toastBig(html){
  var t=toast; t.innerHTML=html; t.style.display='block'; t.style.maxWidth='520px'; t.style.textAlign='left';
  setTimeout(function(){ t.style.display='none'; t.innerHTML=''; t.style.maxWidth='unset'; }, 5000);
}
function showBusy(flag){ busy.hidden = !flag; }

function updateDatasetBadge(){
  var args=[].slice.call(arguments);
  id('datasetBadge').textContent = args.join(' • ');
}
function warn(msg){ console.warn(msg); }

// ===== NORMALIZATION & LOADERS =====
function normalizeStores(rows){
  return rows.map(function(r, i){
    var lat = num(r.lat||r.Lat||r.latitude||r.Latitude);
    var lng = num(r.lng||r.Lon||r.lon||r.Longitude||r.longitude);
    var city = str(r.city||r.City);
    var state= str(r.state||r.State||r.ST||r.st);
    var numStr = str(r.storeNumberStr||r.StoreNumber||r['Store #']||r.Store||r['Store']||r.StoreNum||r.Store_Number||r.Site||r.SiteID||r.Site_Id||r.Store_ID||r.StoreId||r.Site_ID||r['Store #']);
    if(!numStr){ numStr = String(r.StoreNum || r.Store || r.SiteID || i+1); }
    return {
      storeNumberStr: numStr,
      storeName: str(r.storeName||r['Store Name']||r.Name||r.SiteName||r.Site_Name||'Walmart'),
      address: str(r.address||r.Address||r['Street Address']||''),
      city: city, state: state,
      areaManager: str(r.areaManager||r['Area Mgr']||r.AreaMgr||r.AreaManager||r.AM||''),
      regionalManager: str(r.regionalManager||r['Regional Mgr']||r.RegionalMgr||r.RegionalManager||r.RM||''),
      trainerCity: str(r.trainerCity||r['Trainer City']||''),
      lat: isFinite(lat)?lat:0, lng:isFinite(lng)?lng:0,
      coverageType: str(r.coverageType||r.Coverage_Type||r.Coverage||r['Coverage']||'Uncovered')
    };
  }).filter(function(s){ return isFinite(s.lat)&&isFinite(s.lng); });
}
function loadAny(url, opts){
  return fetch(url, {cache:'no-cache'}).then(function(res){
    if(!res.ok) throw new Error('Fetch '+res.status);
    var ct = (res.headers.get('content-type')||'').toLowerCase();
    return res.text().then(function(text){
      return { text:text, contentType:ct };
    });
  });
}
function normalizeInputTable(resp){
  var ct = resp.contentType||'';
  var text= resp.text||'';
  if (/json/.test(ct) || text.trim().charAt(0)==='[' || text.trim().charAt(0)==='{'){
    try{ var j=JSON.parse(text); return Array.isArray(j)? j : (j.rows||j.data||[]); }catch(e){ throw new Error('Bad JSON'); }
  }
  // naive CSV parser (handles simple CSV)
  var lines=text.replace(/\r/g,'').split('\n').filter(function(l){return l.trim().length;});
  if (!lines.length) return [];
  var headers = lines[0].split(',').map(function(h){ return h.trim(); });
  var out=[];
  for (var i=1;i<lines.length;i++){
    var row = csvSplit(lines[i]); var o={};
    headers.forEach(function(h,ix){ o[h]=row[ix]; });
    out.push(o);
  }
  return out;
}
function csvSplit(line){
  var out=[], cur='', inQ=false;
  for (var i=0;i<line.length;i++){
    var ch=line[i];
    if (inQ){
      if (ch==='"'){ if(line[i+1]==='"'){ cur+='"'; i++; } else { inQ=false; } }
      else cur+=ch;
    } else {
      if (ch===','){ out.push(cur); cur=''; }
      else if (ch==='"'){ inQ=true; }
      else cur+=ch;
    }
  }
  out.push(cur);
  return out;
}

// ===== CHANGELOG =====
function pushChangelog(entry){
  try{
    var arr=JSON.parse(localStorage.getItem(LS_CHANGELOG)||'[]');
    arr.unshift(entry);
    localStorage.setItem(LS_CHANGELOG, JSON.stringify(arr.slice(0,200)));
  }catch(e){}
}
function renderChangelog(){
  var arr=JSON.parse(localStorage.getItem(LS_CHANGELOG)||'[]');
  id('changelog').textContent = JSON.stringify(arr, null, 2);
}

// ===== LINKS =====
function copyLinkToHub(h){
  var r=num(radius.value)||DEFAULT_RADIUS;
  var snap=snapshotState(); snap.openHub=h.id; snap.pins=pinnedHubs.map(function(x){return x.id;});
  var payload = btoa(unescape(encodeURIComponent(JSON.stringify(snap))));
  var url = location.origin + location.pathname + '#snap='+payload;
  navigator.clipboard.writeText(url).then(function(){ toastMsg('Link copied to clipboard'); });
}

// ===== RESET =====
function resetAll(){
  // toggles
  showConfirmed.checked=true; showPending.checked=true; showAcosta.checked=false;
  tgHeat.checked=false; clearHeat();
  tgRings.checked=false; tgOverlap.checked=false; tgCompare.checked=false; compareMode=false; tgWithin.checked=false; tgCluster.checked=true;
  // radius
  radius.value=DEFAULT_RADIUS; radiusLbl.textContent=DEFAULT_RADIUS;
  // filters
  setMultiSelect(covFilter, ['All']); setMultiSelect(rmFilter, ['All']); setMultiSelect(amFilter, ['All']); buildHubFilterOptions(); setMultiSelect(hubFilter, ['All']);
  // search
  searchBox.value=''; hideResults(); clearTarget();
  // view
  map.setView(HOME_VIEW.center, HOME_VIEW.zoom);
  // sidepanel
  hideSidepanel();
  pinnedHubs=[]; highlightLayer.clearLayers(); ringLayer.clearLayers();
  recomputeCoverage();
}
function hideSidepanel(){ sidepanel.classList.remove('show'); spHub=null; spRows=[]; spRowsEl.innerHTML=''; }

// ===== APPLY SNAPSHOT FROM URL (optional) =====
(function(){
  if(location.hash.indexOf('#snap=')===0){
    try{
      var payload=location.hash.slice(6);
      var json=decodeURIComponent(escape(atob(payload)));
      var snap=JSON.parse(json);
      applySnapshot(snap);
      setTimeout(function(){ location.hash=''; }, 100);
    }catch(e){}
  }
})();

// ===== END IIFE =====
})(); 
</script>
</body>
</html>
