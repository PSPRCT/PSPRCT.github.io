<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Premium Retail Trainer Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  html, body { height:100%; margin:0; font-family:Arial, sans-serif; display:flex; flex-direction:column; }
  #filters { background:#fafafa; border-bottom:1px solid #ddd; padding:12px 15px; display:flex; flex-wrap:wrap; gap:18px; align-items:center; box-shadow:0 2px 6px rgb(0 0 0 / 0.08); }
  #filters > div { display:flex; align-items:center; position:relative; gap:8px; }
  label { font-weight:600; white-space:nowrap; color:#333; }
  select, input[type="text"], button { padding:6px 10px; font-size:14px; border-radius:6px; border:1px solid #ccc; }
  select[multiple]{ width:170px; height:120px; }
  button{ cursor:pointer; background:#3399ff; color:#fff; border:none; border-radius:6px; padding:7px 12px; font-weight:600; }
  button.secondary{ background:#fff; color:#333; border:1px solid #ccc; }
  button:hover{ filter:brightness(0.95); }
  #map { flex:1; margin:15px; border-radius:10px; box-shadow:0 3px 12px rgb(0 0 0 / 0.1); }
  .toggles-row{display:flex;flex-wrap:wrap;gap:14px;align-items:center}
  .toggle-inline{display:inline-flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff}
  .toggle-inline input{opacity:0;width:0;height:0;position:absolute}
  .toggle-inline .tgl-slider{position:relative;display:inline-block;width:46px;height:24px;background:#ccc;border-radius:34px;transition:.3s}
  .toggle-inline .tgl-slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s}
  .toggle-inline input:checked + .tgl-slider{background:#3399ff}
  .toggle-inline input:checked + .tgl-slider:before{transform:translateX(22px)}
  .radius-group,.minstores-group{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
  #legend{position:absolute;bottom:15px;right:15px;background:#fff;padding:10px 14px;border-radius:6px;box-shadow:0 3px 10px rgba(0,0,0,.2);font-size:14px;line-height:1.4;color:#222;z-index:10000;max-width:260px}
  #legend h4{margin:0 0 8px}
  #legend .legend-item{display:flex;align-items:center;margin-bottom:6px;cursor:pointer;user-select:none}
  #legend .legend-item.disabled{opacity:.35}
  .legend-color{width:18px;height:18px;margin-right:10px;border-radius:50%;box-shadow:inset 0 0 0 1px rgba(0,0,0,.15)}
  .kpi-strip{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .kpi-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #e0e0e0;background:#fff}
  .kpi-dot{width:10px;height:10px;border-radius:50%}
  .kpi-pct{margin-left:8px;font-size:12px;color:#444}
  .busy-mask{position:fixed;inset:0;background:rgba(255,255,255,.5);display:flex;align-items:center;justify-content:center;z-index:20000}
  .busy-mask[hidden]{display:none !important}
  .spinner{width:36px;height:36px;border-radius:50%;border:4px solid rgba(0,0,0,.15);border-top-color:#3399ff;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .hub-icon{width:22px;height:22px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.15)}
  .hub-staffed{background:#6a1b9a}
  .hub-open{background:#9e9e9e}
  .chip{border:1px solid #3399ff;background:#3399ff;color:#fff;border-radius:999px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer}
  .chip-active{background:#ffe5e5;border-color:#ff9999;color:#b42318}
  #hubCount{padding:0 15px 6px; color:#333; font-size:14px;}
  #printable{display:none;padding:24px;background:#fff}
  #printTable{width:100%;border-collapse:collapse;font-size:12px}
  #printTable th,#printTable td{border:1px solid #ccc;padding:6px;text-align:left}
  @media print{ body *{visibility:hidden !important} #printable,#printable *{visibility:visible !important} #printable{display:block !important;position:absolute;inset:0} }
</style>
</head>
<body>

<!-- Controls -->
<div id="filters">
  <div>
    <label for="searchBox">Search store # or city:</label>
    <input type="text" id="searchBox" placeholder="Search store # or city" />
    <button id="searchClear" class="secondary">Clear</button>
  </div>

  <div>
    <label for="coverageFilter">Coverage Type:</label>
    <select id="coverageFilter" multiple>
      <option value="All" selected>All</option>
      <option value="Premium + Acosta">Premium + Acosta</option>
      <option value="Premium Only">Premium Only</option>
      <option value="Acosta Only">Acosta Only</option>
      <option value="Uncovered">Uncovered</option>
    </select>
  </div>

  <div>
    <label for="regionalFilter">Regional Manager:</label>
    <select id="regionalFilter" multiple>
      <option value="All" selected>All</option>
    </select>
  </div>

  <div>
    <label for="areaFilter">Area Manager:</label>
    <select id="areaFilter" multiple>
      <option value="All" selected>All</option>
    </select>
  </div>

  <div>
    <label for="trainerHubFilter">Trainer Hub Filter:</label>
    <select id="trainerHubFilter" multiple></select>
  </div>

  <div class="toggles-row">
    <label class="toggle-inline">
      <span>Staffed hubs</span>
      <input type="checkbox" id="toggleHubs" checked />
      <span class="tgl-slider"></span>
    </label>
    <label class="toggle-inline">
      <span>Open hubs</span>
      <input type="checkbox" id="showOpenHubs" checked />
      <span class="tgl-slider"></span>
    </label>
    <label class="toggle-inline">
      <span>Coverage radius</span>
      <input type="checkbox" id="toggleRadius" checked />
      <span class="tgl-slider"></span>
    </label>

    <div class="radius-group">
      <span>Radius:</span>
      <input type="range" id="radiusMiles" min="25" max="150" step="5" value="75" />
      <span id="radiusLabel">75 mi</span>
      <label class="toggle-inline" style="border:none;padding:0">
        <span>Custom</span>
        <input type="checkbox" id="allowCustomRadius" />
        <span class="tgl-slider"></span>
      </label>
    </div>

    <div class="minstores-group" title="Only show hubs that reach at least this many filtered stores">
      <span>Min stores / hub:</span>
      <input type="range" id="minStores" min="0" max="150" step="5" value="0" />
      <span id="minStoresLabel">0</span>
    </div>
  </div>

  <div class="toggles-row">
    <button id="uncoveredChip" class="chip">Uncovered only</button>
    <button id="outsideChip" class="chip">Outside all hubs</button>
    <button id="inViewChip" class="chip">In view only</button>
    <button id="testHubChip" class="chip">Test hub</button>
  </div>

  <div class="toggles-row">
    <button id="fitToResults" class="secondary">Fit to Results</button>
    <button id="resetFilters" class="secondary">Reset Filters</button>
    <button id="exportFilteredCSV">Export Filtered Stores CSV</button>
    <button id="exportNearestCsv">Export Nearest CSV</button>
    <button id="exportHubsCSV">Export Hubs CSV</button>
    <button id="exportKpiCsv">Export KPIs CSV</button>
    <button id="printMap">Print Store List</button>
  </div>

  <div class="toggles-row">
    <button id="groupSummaryBtn" class="secondary">Group summary</button>
    <button id="copyLinkBtn" class="secondary">Copy link</button>
    <button id="helpBtn" class="secondary">Help</button>
  </div>

  <div class="toggles-row">
    <button id="saveViewBtn" class="secondary">Save view</button>
    <select id="loadViewSelect">
      <option value="">Load view…</option>
    </select>
    <button id="deleteViewBtn" class="secondary">Delete</button>
  </div>

  <div id="filterCount" style="font-weight:bold; min-width:180px;">Showing 0 of 0 stores</div>
  <span id="inViewCount" style="color:#555"></span>

  <div id="kpiStrip" class="kpi-strip" aria-live="polite"></div>
</div>

<div id="hubCount"></div>
<div id="map" aria-label="Coverage Map"></div>

<!-- Legend -->
<div id="legend" aria-live="polite">
  <h4>Legend</h4>
  <div class="legend-item" data-coverage="Premium + Acosta"><div class="legend-color" style="background:blue"></div>Premium + Acosta</div>
  <div class="legend-item" data-coverage="Premium Only"><div class="legend-color" style="background:green"></div>Premium Only</div>
  <div class="legend-item" data-coverage="Acosta Only"><div class="legend-color" style="background:orange"></div>Acosta Only</div>
  <div class="legend-item" data-coverage="Uncovered"><div class="legend-color" style="background:red"></div>Uncovered</div>
  <div class="legend-item"><span class="legend-color" style="background:#6a1b9a"></span>Staffed Hub</div>
  <div class="legend-item"><span class="legend-color" style="background:#9e9e9e"></span>Open Hub</div>
</div>

<!-- Busy -->
<div id="busyMask" class="busy-mask" hidden><div class="spinner"></div></div>

<!-- Printable -->
<div id="printable">
  <h2 id="printTitle">Store List</h2>
  <table id="printTable">
    <thead>
      <tr>
        <th>Store #</th><th>Store Name</th><th>Address</th><th>City</th><th>State</th>
        <th>Coverage</th><th>Trainer City</th><th>Area Manager</th><th>Regional Manager</th>
      </tr>
    </thead>
    <tbody id="printableBody"></tbody>
  </table>
</div>

<!-- Panels & overlays (kept simple) -->
<div id="hubOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,.25);display:none"></div>
<div id="hubPanel" style="position:absolute;top:140px;right:20px;width:360px;max-height:70vh;overflow:auto;background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.12);display:none">
  <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eee;font-weight:700">
    <span class="title">Hub</span>
    <button id="hubPanelClose" class="secondary">Close</button>
  </div>
  <div style="padding:10px 12px;font-size:13px">
    <div class="summary"></div>
    <button id="exportHubPanelCsv">Export stores CSV</button>
    <div class="list" style="max-height:52vh;overflow:auto;margin-top:8px"></div>
  </div>
</div>

<div id="summaryPanel" style="position:absolute;top:170px;right:20px;width:420px;max-height:70vh;overflow:auto;background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.12);display:none">
  <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eee;font-weight:700">
    <span>Group summary</span>
    <button id="summaryClose" class="secondary">Close</button>
  </div>
  <div style="padding:10px 12px;font-size:13px">
    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
      <label for="groupBySelect" style="margin:0;">Group by:</label>
      <select id="groupBySelect">
        <option value="regionalManager">Regional Manager</option>
        <option value="areaManager">Area Manager</option>
        <option value="state">State</option>
        <option value="coverageType">Coverage Type</option>
      </select>
      <button id="exportGroupCsv">Export</button>
    </div>
    <div id="groupSummaryTableWrap"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(async function(){
  /* ---------- Config ---------- */
  const coverageColors = {
    "Premium + Acosta": "blue",
    "Premium Only": "green",
    "Acosta Only": "orange",
    "Uncovered": "red"
  };
  const NEXT_WIN_UNCOV_THRESHOLD = 35;

  /* ---------- Hubs (open + staffed) ---------- */
  const trainerHubs = [
    /* OPEN hubs (sample subset from your list to keep file concise; add the rest as needed) */
    { id:"belle_vernon_pa",      name:"Belle Vernon, PA (Open)",      coords:[40.12507,-79.8664],  status:"open", person:null },
    { id:"centennial_co",        name:"Centennial, CO (Open)",        coords:[39.62732,-104.779],  status:"open", person:null },
    { id:"coral_springs_fl",     name:"Coral Springs, FL (Open)",     coords:[26.2882,-80.2522],   status:"open", person:null },
    { id:"elk_grove_village_il", name:"Elk Grove Village, IL (Open)", coords:[42.00865,-87.9974],  status:"open", person:null },
    { id:"houston_tx",           name:"Houston, TX (Open)",           coords:[29.8535,-95.5095],   status:"open", person:null },
    { id:"kansas_city_mo",       name:"Kansas City, MO (Open)",       coords:[39.04512,-94.4429],  status:"open", person:null },
    { id:"lakeland_fl",          name:"Lakeland, FL (Open)",          coords:[28.03591,-81.8997],  status:"open", person:null },
    { id:"wilmington_oh",        name:"Wilmington, OH (Open)",        coords:[39.44499,-83.8244],  status:"open", person:null },

    /* STAFFED hubs (from your latest) */
    { id:"granite_falls_nc_walker", name:"Granite Falls, NC - Lisa Walker", coords:[35.80049406642459,-81.40580339729192], status:"accepted", person:"Lisa Walker" },
    { id:"clarksville_tn_salvato",  name:"Clarksville, TN - Nicholas Salvato", coords:[36.58887925062968,-87.34016705996005], status:"accepted", person:"Nicholas Salvato" },
    { id:"orange_park_fl_hall",     name:"Orange Park, FL - Sabrina Hall", coords:[30.186755922868347,-81.71888670245784], status:"accepted", person:"Sabrina Hall" },
    { id:"excelsior_springs_mo_estep", name:"Excelsior Springs, MO - Teresa Estep", coords:[39.354429998804825,-94.1669969175497], status:"accepted", person:"Teresa Estep" },
    { id:"seguin_tx_winston",       name:"Seguin, TX - Christina Winston", coords:[29.56000348742034,-97.96778298897998], status:"accepted", person:"Christina Winston" },
    { id:"norman_ok_ard",           name:"Norman, OK - Teryl Ard", coords:[35.2131655,-97.4837249], status:"accepted", person:"Teryl Ard" },
    { id:"kimberly_al_savage",      name:"Kimberly, AL - Jessica Savage", coords:[33.77344,-86.81388], status:"accepted", person:"Jessica Savage" },
    { id:"olive_branch_ms_brown",   name:"Olive Branch, MS - Annette Brown", coords:[34.92668799775572,-89.89485850418528], status:"accepted", person:"Annette Brown" },
    { id:"riverview_fl_santos",     name:"Riverview, FL - Richard Santos", coords:[27.8661,-82.3265], status:"accepted", person:"Richard Santos" }
  ];
  trainerHubs.forEach(h => { h.latRad = toRad(h.coords[0]); h.lngRad = toRad(h.coords[1]); });

  /* ---------- State ---------- */
  let allStores = [];
  let filteredStores = [];
  let hubsMarkers = [];
  let coverageCircles = [];
  const storeMarkersMap = new Map();
  let lastHubsToShow = [];
  let outsideOnly = false;
  let inViewOnly = false;
  let prevCoverageSelection = null;
  let kpiSnapshot = { counts:{}, total:0, pctUncov:0 };
  let nearestLine = null;

  /* Test hub */
  let testMode = false, testHubMarker=null, testHubCircle=null;
  const TEST_HUB = { id:'test_hub', name:'Test Hub (temporary)', status:'open', person:null, coords:null, latRad:null, lngRad:null };

  /* Saved views */
  const VIEWS_KEY = 'trainerMapViews';

  /* ---------- Utils ---------- */
  function toRad(a){ return a*Math.PI/180; }
  function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
  function debounce(fn, delay=150){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay); }; }
  const debouncedOnFilterChange = debounce(onFilterChange,150);

  function getDistanceMiles(lat1, lon1, lat2, lon2, lat1Rad, lon1Rad, lat2Rad, lon2Rad){
    const R = 3958.8;
    const φ1 = lat1Rad ?? toRad(lat1), λ1 = lon1Rad ?? toRad(lon1);
    const φ2 = lat2Rad ?? toRad(lat2), λ2 = lon2Rad ?? toRad(lon2);
    const dφ = φ2-φ1, dλ = λ2-λ1;
    const a = Math.sin(dφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
  }

  /* ---------- Map ---------- */
  const markers = L.markerClusterGroup({});
  const map = L.map('map').setView([39.5,-98.35],5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'© OpenStreetMap contributors'}).addTo(map);
  map.addLayer(markers);
  map.on('moveend zoomend', updateInViewCount);

  function iconForHub(hub){
    const cls = hub.status === "accepted" ? "hub-staffed" : "hub-open";
    return L.divIcon({
      className:"",
      html:`<div class="hub-icon ${cls}" title="${escapeHtml(hub.name)}"></div>`,
      iconSize:[22,22], iconAnchor:[11,11], popupAnchor:[0,-10]
    });
  }

  /* ---------- DOM ---------- */
  const coverageFilter = document.getElementById('coverageFilter');
  const regionalFilter = document.getElementById('regionalFilter');
  const areaFilter     = document.getElementById('areaFilter');
  const trainerHubFilter = document.getElementById('trainerHubFilter');

  const toggleHubsCheckbox = document.getElementById('toggleHubs');
  const showOpenHubsCheckbox = document.getElementById('showOpenHubs');
  const toggleRadiusCheckbox = document.getElementById('toggleRadius');

  const radiusInput = document.getElementById('radiusMiles');
  const radiusLabel = document.getElementById('radiusLabel');
  const allowCustom = document.getElementById('allowCustomRadius');

  const minStoresInput = document.getElementById('minStores');
  const minStoresLabel = document.getElementById('minStoresLabel');

  const searchBox  = document.getElementById('searchBox');
  const searchClear= document.getElementById('searchClear');

  const uncoveredChip = document.getElementById('uncoveredChip');
  const outsideChip   = document.getElementById('outsideChip');
  const inViewChip    = document.getElementById('inViewChip');
  const testHubChip   = document.getElementById('testHubChip');

  const copyLinkBtn   = document.getElementById('copyLinkBtn');
  const exportHubsBtn = document.getElementById('exportHubsCSV');
  const exportNearestBtn = document.getElementById('exportNearestCsv');
  const groupSummaryBtn = document.getElementById('groupSummaryBtn');

  const saveViewBtn = document.getElementById('saveViewBtn');
  const loadViewSelect = document.getElementById('loadViewSelect');
  const deleteViewBtn = document.getElementById('deleteViewBtn');

  const helpBtn = document.getElementById('helpBtn');

  /* ---------- Data load ---------- */
  try{
    const resp = await fetch('store_data.json', { cache: 'no-cache' });
    if(!resp.ok) throw new Error(`Failed to load store_data.json (HTTP ${resp.status})`);
    const raw = await resp.json();

    allStores = raw.map(s => ({
      ...s,
      city: (s.city||"").trim().toLowerCase(),
      cityDisplay: (s.city||"").trim(),
      state: (s.state||"").trim(),
      trainerCity: (s.trainerCity||"").trim(),
      storeNumber: String(s.storeNumber),
      latRad: toRad(s.latitude ?? 0),
      lngRad: toRad(s.longitude ?? 0),
    }));
    console.log('Loaded stores:', allStores.length);
  }catch(err){
    console.error(err);
    document.getElementById('filterCount').textContent = 'Error: could not load store_data.json — serve over HTTP and check path.';
    return; // stop here if data can’t be loaded
  }

  /* ---------- Build filters ---------- */
  function populateSelect(selectElem, optionsSet){
    // keep "All", remove rest
    [...selectElem.options].forEach(o => { if (o.value!=="All") selectElem.removeChild(o); });
    optionsSet.forEach(opt => {
      const option = document.createElement('option');
      option.value = opt; option.textContent = opt;
      selectElem.appendChild(option);
    });
  }
  const regionalSet = new Set(allStores.map(s=>s.regionalManager).filter(Boolean));
  const areaSet     = new Set(allStores.map(s=>s.areaManager).filter(Boolean));
  populateSelect(regionalFilter, regionalSet);
  populateSelect(areaFilter, areaSet);

  function populateHubFilter(){
    trainerHubFilter.innerHTML = '';
    trainerHubs.forEach(h => {
      const opt = document.createElement('option');
      opt.value = h.name; opt.textContent = h.name;
      trainerHubFilter.appendChild(opt);
    });
  }
  populateHubFilter();

  /* ---------- Radius + min-stores behavior ---------- */
  allowCustom.checked = false;
  radiusInput.disabled = true; radiusInput.value = 75;
  radiusLabel.textContent = '75 mi';
  minStoresLabel.textContent = String(minStoresInput.value);
  const getRadiusMiles = () => (allowCustom && allowCustom.checked ? (parseInt(radiusInput.value,10)||75) : 75);

  radiusInput.addEventListener('input', () => { radiusLabel.textContent = `${getRadiusMiles()} mi`; debouncedOnFilterChange(); saveState(); });
  allowCustom.addEventListener('change', () => { radiusInput.disabled = !allowCustom.checked; radiusLabel.textContent = `${getRadiusMiles()} mi`; debouncedOnFilterChange(); saveState(); });
  minStoresInput.addEventListener('input', () => { minStoresLabel.textContent = String(minStoresInput.value); debouncedOnFilterChange(); saveState(); });

  /* ---------- Filtering ---------- */
  function typeAllowed(hub){
    return (hub.status==='accepted' && toggleHubsCheckbox.checked) ||
           (hub.status==='open'     && showOpenHubsCheckbox.checked);
  }
  function considerTestHub(){
    return (testHubMarker && testHubCircle && showOpenHubsCheckbox.checked);
  }
  function findNearestAllowedHub(store){
    let best=null, bestD=Infinity;
    for (const h of trainerHubs){
      if (!typeAllowed(h)) continue;
      const d = getDistanceMiles(h.coords[0],h.coords[1],store.latitude,store.longitude,h.latRad,h.lngRad,store.latRad,store.lngRad);
      if (d<bestD){bestD=d;best=h;}
    }
    if (considerTestHub()){
      const ll = testHubMarker.getLatLng();
      const d = getDistanceMiles(ll.lat,ll.lng,store.latitude,store.longitude,toRad(ll.lat),toRad(ll.lng),store.latRad,store.lngRad);
      if (d<bestD){ bestD=d; best=TEST_HUB; }
    }
    return { hub:best, miles:bestD };
  }

  function filterStores(){
    const selectedCoverage = Array.from(coverageFilter.selectedOptions).map(o=>o.value);
    const selectedRegional = Array.from(regionalFilter.selectedOptions).map(o=>o.value);
    const selectedArea     = Array.from(areaFilter.selectedOptions).map(o=>o.value);

    const chosenHubNames = Array.from(trainerHubFilter.selectedOptions).map(o=>o.value);
    const chosenHubs = trainerHubs.filter(h => chosenHubNames.includes(h.name));

    const bounds = map.getBounds();

    filteredStores = allStores.filter(store => {
      const covMatch  = selectedCoverage.includes('All') || selectedCoverage.includes(store.coverageType);
      const regMatch  = selectedRegional.includes('All') || selectedRegional.includes(store.regionalManager);
      const areaMatch = selectedArea.includes('All') || selectedArea.includes(store.areaManager);

      if (inViewOnly && !bounds.contains([store.latitude, store.longitude])) return false;

      const r = getRadiusMiles();
      const hubConstraintOK = !chosenHubs.length || chosenHubs.some(h =>
        getDistanceMiles(h.coords[0],h.coords[1],store.latitude,store.longitude,h.latRad,h.lngRad,store.latRad,store.lngRad) <= r
      );

      let outsideOK = true;
      if (outsideOnly){
        for (const h of trainerHubs){
          if (!typeAllowed(h)) continue;
          const d = getDistanceMiles(h.coords[0],h.coords[1],store.latitude,store.longitude,h.latRad,h.lngRad,store.latRad,store.lngRad);
          if (d <= r){ outsideOK = false; break; }
        }
        if (outsideOK && considerTestHub()){
          const ll = testHubMarker.getLatLng();
          const d = getDistanceMiles(ll.lat,ll.lng,store.latitude,store.longitude,toRad(ll.lat),toRad(ll.lng),store.latRad,store.lngRad);
          if (d <= r) outsideOK = false;
        }
      }

      return covMatch && regMatch && areaMatch && hubConstraintOK && outsideOK;
    });
  }

  /* ---------- Rendering ---------- */
  function addLazyLoadedMarkers(stores, opts = {}){
    const forceAll = !!opts.forceAll;
    markers.clearLayers();
    storeMarkersMap.clear();

    const bounds = map.getBounds();
    const bufferLat = 50/69; // ~50 miles
    const extended = L.latLngBounds(
      [bounds.getSouth()-bufferLat, bounds.getWest()-bufferLat],
      [bounds.getNorth()+bufferLat, bounds.getEast()+bufferLat]
    );

    stores
      .filter(s => forceAll ? true : extended.contains([s.latitude,s.longitude]))
      .forEach(store => {
        const nearest = findNearestAllowedHub(store);
        const marker = L.circleMarker([store.latitude,store.longitude],{
          radius:6,
          color:coverageColors[store.coverageType]||'gray',
          fillColor:coverageColors[store.coverageType]||'gray',
          fillOpacity:.85,
          weight:1
        });
        marker.isStoreMarker = true;
        marker.bindPopup(`
          <strong>Store #${escapeHtml(store.storeNumber)}</strong><br>
          ${escapeHtml(store.storeName)}<br>
          ${escapeHtml(store.address)}<br>
          ${escapeHtml(store.cityDisplay)}, ${escapeHtml(store.state)}<br>
          Coverage: <b>${escapeHtml(store.coverageType)}</b><br>
          Trainer City: ${escapeHtml(store.trainerCity)}<br>
          Area: ${escapeHtml(store.areaManager)}<br>
          Regional: ${escapeHtml(store.regionalManager)}<br>
          ${nearest.hub ? `Nearest hub: ${escapeHtml(nearest.hub.name)} (${nearest.miles.toFixed(1)} mi)` : 'No visible hub nearby'}
        `);
        markers.addLayer(marker);
        storeMarkersMap.set(store.storeNumber.replace(/^0+/, ''), marker);
      });
  }

  // cluster summary (Shift+click)
  markers.on('clusterclick', function (e) {
    if (!e.originalEvent || !e.originalEvent.shiftKey) return;
    e.originalEvent.preventDefault();
    e.originalEvent.stopPropagation();
    const children = e.layer.getAllChildMarkers ? e.layer.getAllChildMarkers() : [];
    const counts = { "Premium + Acosta":0,"Premium Only":0,"Acosta Only":0,"Uncovered":0, total:children.length };
    children.forEach(m => {
      const color = m.options.fillColor;
      for (const [k,v] of Object.entries(coverageColors)){
        if (v===color) counts[k]++;
      }
    });
    const html = `
      <b>Cluster summary</b><br>
      P+A: ${counts["Premium + Acosta"]} · P: ${counts["Premium Only"]} · A: ${counts["Acosta Only"]} · U: ${counts["Uncovered"]}<br>
      Total: ${counts.total}
    `;
    L.popup().setLatLng(e.layer.getLatLng()).setContent(html).openOn(map);
  });

  // nearest line on popup
  map.on('popupopen', (e) => {
    if (!e.popup || !e.popup._source || !e.popup._source.isStoreMarker) return;
    if (nearestLine){ map.removeLayer(nearestLine); nearestLine=null; }
    const latlng = e.popup._source.getLatLng();
    const dummyStore = { latitude:latlng.lat, longitude:latlng.lng, latRad:toRad(latlng.lat), lngRad:toRad(latlng.lng) };
    const res = findNearestAllowedHub(dummyStore);
    if (res.hub){
      const hubLatLng = res.hub===TEST_HUB ? testHubMarker.getLatLng() : L.latLng(res.hub.coords[0], res.hub.coords[1]);
      nearestLine = L.polyline([latlng, hubLatLng], { weight:2, opacity:0.7, dashArray:'4,6' }).addTo(map);
    }
  });
  map.on('popupclose', () => { if (nearestLine){ map.removeLayer(nearestLine); nearestLine=null; } });

  function updateKPI(){
    const c = { "Premium + Acosta":0,"Premium Only":0,"Acosta Only":0,"Uncovered":0 };
    filteredStores.forEach(s => { c[s.coverageType] = (c[s.coverageType]||0)+1; });
    const total = filteredStores.length || 1;
    const pctUn = Math.round((c["Uncovered"]/total)*1000)/10;

    const chip = (color,label,val)=>`
      <span class="kpi-chip"><span class="kpi-dot" style="background:${color}"></span>
      <span class="label">${label}</span><span class="value">${val}</span></span>`;
    const el = document.getElementById('kpiStrip');
    el.innerHTML = [
      chip('blue','Premium + Acosta', c['Premium + Acosta']||0),
      chip('green','Premium Only', c['Premium Only']||0),
      chip('orange','Acosta Only', c['Acosta Only']||0),
      chip('red','Uncovered', c['Uncovered']||0),
      `<span class="kpi-pct">Uncovered: <strong>${isFinite(pctUn)?pctUn:0}%</strong></span>`
    ].join('');
    kpiSnapshot = { counts:c, total:filteredStores.length, pctUncov:pctUn };
  }

  function getStoresCoveredByHub(hub){
    const r = getRadiusMiles();
    return filteredStores.filter(s => getDistanceMiles(hub.coords[0],hub.coords[1],s.latitude,s.longitude,hub.latRad,hub.lngRad,s.latRad,s.lngRad) <= r);
  }

  function openHubPanel(hub){
    const panel = document.getElementById('hubPanel');
    const overlay = document.getElementById('hubOverlay');
    const list = getStoresCoveredByHub(hub);
    const byCov = { "Premium + Acosta":0, "Premium Only":0, "Acosta Only":0, "Uncovered":0 };
    list.forEach(s => byCov[s.coverageType] = (byCov[s.coverageType]||0)+1);

    panel.querySelector('.title').textContent = hub.name || 'Hub';
    panel.querySelector('.summary').innerHTML =
      `${list.length} stores within ${getRadiusMiles()} mi` +
      `<div style="margin-top:6px;font-size:12px;color:#444">
        <b>Breakdown</b> — P+A: ${byCov["Premium + Acosta"]||0}, P-only: ${byCov["Premium Only"]||0},
        A-only: ${byCov["Acosta Only"]||0}, Uncov: ${byCov["Uncovered"]||0}
      </div>`;

    panel.querySelector('.list').innerHTML = list.slice(0,800).map(s =>
      `<div style="padding:4px 0;border-bottom:1px dashed #eee">#${escapeHtml(s.storeNumber)} — ${escapeHtml(s.cityDisplay)}, ${escapeHtml(s.state)} — ${escapeHtml(s.coverageType)}</div>`
    ).join('');

    panel.style.display = 'block';
    overlay.style.display = 'block';

    const btn = document.getElementById('exportHubPanelCsv');
    btn.onclick = () => {
      const headers = ['Store Number','Store Name','Address','City','State','Coverage Type','Trainer City','Area Manager','Regional Manager'];
      const q = v => `"${String(v ?? '').replace(/"/g,'""')}"`;
      const rows = [headers.join(',')].concat(list.map(s => [
        q(s.storeNumber), q(s.storeName), q(s.address), q(s.cityDisplay), q(s.state),
        q(s.coverageType), q(s.trainerCity), q(s.areaManager), q(s.regionalManager)
      ].join(',')));
      const blob = new Blob(["\uFEFF"+rows.join('\n')],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download=`stores_for_${(hub.id||'hub')}.csv`; a.click(); URL.revokeObjectURL(url);
    };
  }
  function closeHubPanel(){
    document.getElementById('hubPanel').style.display = 'none';
    document.getElementById('hubOverlay').style.display = 'none';
  }
  document.getElementById('hubPanelClose').addEventListener('click', closeHubPanel);
  document.getElementById('hubOverlay').addEventListener('click', closeHubPanel);

  function addTrainerHubsAndCircles(hubsToShow){
    hubsMarkers.forEach(m => map.removeLayer(m));
    coverageCircles.forEach(c => map.removeLayer(c));
    hubsMarkers = []; coverageCircles = [];

    const rMiles = getRadiusMiles();
    hubsToShow.forEach(hub => {
      const within = getStoresCoveredByHub(hub);
      const uncovered = within.filter(s=>s.coverageType==='Uncovered').length;
      const byCov = { "Premium + Acosta":0,"Premium Only":0,"Acosta Only":0,"Uncovered":0 };
      within.forEach(s => byCov[s.coverageType]=(byCov[s.coverageType]||0)+1);

      const statusKey = hub.status === 'accepted' ? 'staffed' : 'open';
      const nextWin = (hub.status==='open' && uncovered >= NEXT_WIN_UNCOV_THRESHOLD);
      const badge = `<span style="display:inline-block;padding:2px 6px;border-radius:10px;font-size:12px;font-weight:700;color:#fff;background:${statusKey==='staffed' ? '#6a1b9a' : '#9e9e9e'}">${statusKey.toUpperCase()}</span>${nextWin ? ' <span style="display:inline-block;padding:2px 6px;border-radius:10px;font-size:12px;font-weight:700;color:#fff;background:#ff8c00">NEXT WIN</span>' : ''}`;
      const person = hub.person ? ` &nbsp;•&nbsp; <strong>${escapeHtml(hub.person)}</strong>` : "";

      const popupHtml = `
        <b>${escapeHtml(hub.name)}</b>${person}<br>
        ${badge}<br>
        <div style="margin-top:6px">
          <b>${within.length}</b> in ${rMiles} mi &nbsp;|&nbsp;
          P+A: ${byCov["Premium + Acosta"]||0} · P: ${byCov["Premium Only"]||0} · A: ${byCov["Acosta Only"]||0} · U: ${byCov["Uncovered"]||0}
        </div>
        <div style="margin-top:6px"><a href="#" data-hub="${hub.id}" class="open-panel">Open list</a></div>
      `;

      const hubMarker = L.marker(hub.coords,{icon:iconForHub(hub)}).bindPopup(popupHtml).addTo(map);
      hubsMarkers.push(hubMarker);

      const circle = L.circle(hub.coords,{ radius:rMiles*1609.34, color:'purple', weight:1, fillOpacity:.1, dashArray:'5,10' }).addTo(map);
      coverageCircles.push(circle);

      function highlight(on){ circle.setStyle({weight:on?3:1, fillOpacity:on?.18:.1}); if(on && circle.bringToFront) circle.bringToFront(); }
      hubMarker.on('mouseover', () => highlight(true));
      hubMarker.on('mouseout',  () => highlight(false));
      circle.on('mouseover', () => highlight(true));
      circle.on('mouseout',  () => highlight(false));
      hubMarker.on('click', () => openHubPanel(hub));
      circle.on('click', () => openHubPanel(hub));
    });

    map.on('popupopen', (e) => {
      const link = e.popup._contentNode.querySelector('a.open-panel');
      if (link){
        link.addEventListener('click', (ev) => {
          ev.preventDefault();
          const id = link.getAttribute('data-hub');
          const hub = trainerHubs.find(h => h.id === id);
          if (hub) openHubPanel(hub);
        }, { once:true });
      }
    });
  }

  function updateTrainerHubFilter(){
    const hubsWithStores = new Set();
    trainerHubs.forEach(hub => {
      const coversAny = filteredStores.some(store =>
        getDistanceMiles(hub.coords[0], hub.coords[1], store.latitude, store.longitude, hub.latRad, hub.lngRad, store.latRad, store.lngRad) <= getRadiusMiles()
      );
      if (coversAny) hubsWithStores.add(hub.name);
    });
    [...trainerHubFilter.options].forEach(option => {
      const show = hubsWithStores.has(option.value);
      option.disabled = !show;
      option.style.display = show ? '' : 'none';
      if (!show) option.selected = false;
    });
  }

  function fitToResults(){
    if (!filteredStores.length) return;
    const latLngs = filteredStores.map(s => [s.latitude,s.longitude]);
    map.fitBounds(L.latLngBounds(latLngs),{padding:[20,20]});
  }

  /* ---------- Counts/UI ---------- */
  function updateFilterCount(){
    document.getElementById('filterCount').textContent = `Showing ${filteredStores.length} of ${allStores.length} stores`;
  }
  function updateInViewCount(){
    const el = document.getElementById('inViewCount'); if (!el) return;
    if (!filteredStores.length){ el.textContent=''; return; }
    const b = map.getBounds(); let n=0; for (const s of filteredStores) if (b.contains([s.latitude,s.longitude])) n++;
    el.textContent = ` | In view: ${n}`;
  }

  /* ---------- Group summary ---------- */
  function openSummaryPanel(){ document.getElementById('summaryPanel').style.display='block'; document.getElementById('hubOverlay').style.display='block'; }
  function closeSummaryPanel(){ document.getElementById('summaryPanel').style.display='none'; document.getElementById('hubOverlay').style.display='none'; }
  document.getElementById('summaryClose').addEventListener('click', closeSummaryPanel);

  function renderGroupSummary(){
    const key = document.getElementById('groupBySelect').value;
    const groups = new Map();
    for (const s of filteredStores){
      const k = s[key] || '(blank)';
      if (!groups.has(k)) groups.set(k, { "Premium + Acosta":0,"Premium Only":0,"Acosta Only":0,"Uncovered":0, total:0 });
      const g = groups.get(k);
      g[s.coverageType] = (g[s.coverageType]||0)+1; g.total++;
    }
    const rows = [];
    groups.forEach((g, name) => {
      const uncPct = g.total ? Math.round((g['Uncovered']/g.total)*1000)/10 : 0;
      rows.push(`
        <tr>
          <td>${escapeHtml(name)}</td>
          <td>${g['Premium + Acosta']||0}</td>
          <td>${g['Premium Only']||0}</td>
          <td>${g['Acosta Only']||0}</td>
          <td>${g['Uncovered']||0}</td>
          <td>${g.total}</td>
          <td>${uncPct}%</td>
        </tr>`);
    });
    const html = `
      <table style="width:100%;border-collapse:collapse;font-size:12px">
        <thead><tr><th>${escapeHtml(key)}</th><th>P+A</th><th>P-only</th><th>A-only</th><th>Uncov</th><th>Total</th><th>Uncov %</th></tr></thead>
        <tbody>${rows.join('')}</tbody>
      </table>`;
    document.getElementById('groupSummaryTableWrap').innerHTML = html;
  }
  document.getElementById('groupBySelect').addEventListener('change', renderGroupSummary);
  document.getElementById('exportGroupCsv').addEventListener('click', () => {
    const key = document.getElementById('groupBySelect').value;
    const groups = new Map();
    for (const s of filteredStores){
      const k = s[key] || '(blank)';
      if (!groups.has(k)) groups.set(k, { "Premium + Acosta":0,"Premium Only":0,"Acosta Only":0,"Uncovered":0, total:0 });
      const g = groups.get(k);
      g[s.coverageType] = (g[s.coverageType]||0)+1; g.total++;
    }
    const headers = [key,'Premium + Acosta','Premium Only','Acosta Only','Uncovered','Total','Uncovered %'];
    const q = v => `"${String(v ?? '').replace(/"/g,'""')}"`;
    const lines = [headers.join(',')];
    groups.forEach((g, name) => {
      const uncPct = g.total ? Math.round((g['Uncovered']/g.total)*1000)/10 : 0;
      lines.push([q(name), g['Premium + Acosta']||0, g['Premium Only']||0, g['Acosta Only']||0, g['Uncovered']||0, g.total, uncPct].join(','));
    });
    const blob = new Blob(["\uFEFF"+lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='group_summary.csv'; a.click(); URL.revokeObjectURL(url);
  });
  groupSummaryBtn.addEventListener('click', () => { openSummaryPanel(); renderGroupSummary(); });

  /* ---------- Saved views ---------- */
  function loadSavedViewsDropdown(){
    loadViewSelect.innerHTML = '<option value="">Load view…</option>';
    const raw = localStorage.getItem(VIEWS_KEY);
    if (!raw) return;
    try{
      const obj = JSON.parse(raw) || {};
      Object.keys(obj).forEach(k => {
        const opt = document.createElement('option'); opt.value = k; opt.textContent = k; loadViewSelect.appendChild(opt);
      });
    }catch{}
  }
  function getUIState(){
    return {
      v:4,
      coverage:Array.from(coverageFilter.selectedOptions).map(o=>o.value),
      regional:Array.from(regionalFilter.selectedOptions).map(o=>o.value),
      area:Array.from(areaFilter.selectedOptions).map(o=>o.value),
      hubs:Array.from(trainerHubFilter.selectedOptions).map(o=>o.value),
      toggles:{ showHubs:toggleHubsCheckbox.checked, showRadius:toggleRadiusCheckbox.checked, showOpen:showOpenHubsCheckbox.checked },
      search:searchBox.value,
      radius:{ allowCustom:allowCustom.checked, value:radiusInput.value },
      chips:{ outsideOnly, inViewOnly, uncovered:uncoveredChip.classList.contains('chip-active'), test:testMode },
      minStores: minStoresInput.value,
      mapView:{ center: map.getCenter(), zoom: map.getZoom() }
    };
  }
  function applyStateFromObject(s){
    function restoreMulti(select, values){ if(!select||!values) return; Array.from(select.options).forEach(o => o.selected = values.includes(o.value)); }
    restoreMulti(coverageFilter, s.coverage);
    restoreMulti(regionalFilter, s.regional);
    restoreMulti(areaFilter, s.area);
    restoreMulti(trainerHubFilter, s.hubs);
    if (s.toggles){
      if ('showHubs' in s.toggles) toggleHubsCheckbox.checked = s.toggles.showHubs;
      if ('showRadius' in s.toggles) toggleRadiusCheckbox.checked = s.toggles.showRadius;
      if ('showOpen' in s.toggles) showOpenHubsCheckbox.checked = s.toggles.showOpen;
    }
    if (typeof s.search === 'string') searchBox.value = s.search;
    if (s.radius){ allowCustom.checked = !!s.radius.allowCustom; radiusInput.disabled = !allowCustom.checked; if (s.radius.value) radiusInput.value = s.radius.value; radiusLabel.textContent = `${getRadiusMiles()} mi`; }
    if (s.chips){
      outsideOnly = !!s.chips.outsideOnly; inViewOnly = !!s.chips.inViewOnly; testMode = !!s.chips.test;
      uncoveredChip.classList.toggle('chip-active', !!s.chips.uncovered);
      outsideChip.classList.toggle('chip-active', !!s.chips.outsideOnly);
      inViewChip.classList.toggle('chip-active', !!s.chips.inViewOnly);
      testHubChip.classList.toggle('chip-active', !!s.chips.test);
      if (testMode) enableTestHub(); else disableTestHub();
    }
    if (s.minStores !== undefined){ minStoresInput.value = s.minStores; minStoresLabel.textContent = String(s.minStores); }
    syncLegendFromCoverage();
    if (s.mapView && s.mapView.center && typeof s.mapView.zoom === 'number'){
      try{ map.setView([s.mapView.center.lat, s.mapView.center.lng], s.mapView.zoom); }catch{}
    }
  }
  function loadStateFromHash(){
    if (!location.hash.startsWith('#s=')) return false;
    try{ const s = JSON.parse(decodeURIComponent(location.hash.slice(3))); applyStateFromObject(s); return true; }
    catch{ return false; }
  }
  function saveState(){ localStorage.setItem('trainerMapState', JSON.stringify(getUIState())); }
  function loadState(){
    const raw = localStorage.getItem('trainerMapState'); if (!raw) return;
    try{ const s = JSON.parse(raw); applyStateFromObject(s); }catch{}
  }
  saveViewBtn.addEventListener('click', () => {
    const name = prompt('Name this view (e.g., "East Region uncovered")');
    if (!name) return;
    const raw = localStorage.getItem(VIEWS_KEY);
    const views = raw ? (JSON.parse(raw) || {}) : {};
    views[name] = getUIState();
    localStorage.setItem(VIEWS_KEY, JSON.stringify(views));
    loadSavedViewsDropdown();
    alert('Saved.');
  });
  loadViewSelect.addEventListener('change', () => {
    const key = loadViewSelect.value; if (!key) return;
    const raw = localStorage.getItem(VIEWS_KEY);
    if (!raw) return;
    const obj = JSON.parse(raw) || {};
    if (obj[key]){ applyStateFromObject(obj[key]); onFilterChange(); }
  });
  deleteViewBtn.addEventListener('click', () => {
    const key = loadViewSelect.value; if (!key) return;
    const raw = localStorage.getItem(VIEWS_KEY); if (!raw) return;
    const obj = JSON.parse(raw) || {};
    delete obj[key];
    localStorage.setItem(VIEWS_KEY, JSON.stringify(obj));
    loadSavedViewsDropdown();
    alert('Deleted.');
  });

  /* ---------- Legend clicks ---------- */
  function syncLegendFromCoverage(){
    const selected = new Set(Array.from(coverageFilter.selectedOptions).map(o=>o.value));
    document.querySelectorAll('#legend .legend-item[data-coverage]').forEach(item => {
      const cov = item.getAttribute('data-coverage');
      const on = selected.has('All') || selected.has(cov);
      item.classList.toggle('disabled', !on);
    });
  }
  function toggleCoverageValue(value, turnOn){
    const opts = Array.from(coverageFilter.options);
    if (turnOn){
      const allOpt = opts.find(o=>o.value==='All');
      if (allOpt && allOpt.selected) allOpt.selected=false;
      const opt = opts.find(o=>o.value===value); if (opt) opt.selected = true;
    } else {
      const opt = opts.find(o=>o.value===value); if (opt) opt.selected = false;
      if (!opts.some(o=>o.value!=='All' && o.selected)) opts.find(o=>o.value==='All').selected = true;
    }
    syncLegendFromCoverage();
    onFilterChange(); saveState();
  }
  document.querySelectorAll('#legend .legend-item[data-coverage]').forEach(item => {
    item.addEventListener('click', () => {
      const cov = item.getAttribute('data-coverage');
      const disabled = item.classList.contains('disabled');
      toggleCoverageValue(cov, disabled);
    });
  });

  /* ---------- Test hub ---------- */
  function enableTestHub(){
    if (testHubMarker) return;
    map._testHubClick = (e) => {
      if (!testHubMarker){
        testHubMarker = L.marker(e.latlng, { draggable:true, icon:iconForHub({status:'open', name:'Test Hub'}) }).addTo(map);
        testHubCircle = L.circle(e.latlng, { radius:getRadiusMiles()*1609.34, color:'purple', weight:1, fillOpacity:.08, dashArray:'4,8' }).addTo(map);
        TEST_HUB.coords = [e.latlng.lat, e.latlng.lng];
        TEST_HUB.latRad = toRad(e.latlng.lat); TEST_HUB.lngRad = toRad(e.latlng.lng);
      } else {
        const ll = e.latlng;
        testHubMarker.setLatLng(ll); testHubCircle.setLatLng(ll);
        testHubCircle.setRadius(getRadiusMiles()*1609.34);
        TEST_HUB.coords = [ll.lat, ll.lng]; TEST_HUB.latRad = toRad(ll.lat); TEST_HUB.lngRad = toRad(ll.lng);
      }
      onFilterChange();
    };
    map.on('click', map._testHubClick);
  }
  function disableTestHub(){
    if (map._testHubClick){ map.off('click', map._testHubClick); map._testHubClick = null; }
    if (testHubMarker){ map.removeLayer(testHubMarker); testHubMarker=null; }
    if (testHubCircle){ map.removeLayer(testHubCircle); testHubCircle=null; }
  }

  /* ---------- Main refresh ---------- */
  async function onFilterChange(){
    const mask = document.getElementById('busyMask'); mask && (mask.hidden = false);
    try{
      filterStores();
      addLazyLoadedMarkers(filteredStores);
      updateInViewCount(); updateFilterCount(); updateKPI();
      updateTrainerHubFilter();

      const includeStaffed = toggleHubsCheckbox.checked;
      const includeOpen    = showOpenHubsCheckbox.checked;
      let hubsToShow = trainerHubs.filter(h => (h.status==='accepted' && includeStaffed) || (h.status==='open' && includeOpen));

      lastHubsToShow = hubsToShow.map(h => ({ ...h, coveredCount: getStoresCoveredByHub(h).length }));

      const selectedRegional = Array.from(regionalFilter.selectedOptions).map(o=>o.value);
      const selectedArea     = Array.from(areaFilter.selectedOptions).map(o=>o.value);
      const managerScoped = !selectedRegional.includes('All') || !selectedArea.includes('All');
      if (managerScoped){
        hubsToShow = lastHubsToShow.filter(h => h.coveredCount > 0);
      } else {
        hubsToShow = lastHubsToShow;
      }

      const minN = parseInt(minStoresInput.value,10) || 0;
      hubsToShow = hubsToShow.filter(h => h.coveredCount >= minN);

      const staffedCount = hubsToShow.filter(h => h.status==='accepted').length;
      const openCount    = hubsToShow.filter(h => h.status==='open').length;
      const hubCountEl = document.getElementById('hubCount');
      hubCountEl.innerHTML = `Hubs shown: <span style="color:#6a1b9a;font-weight:700">${staffedCount} staffed</span> / <span style="color:#9e9e9e;font-weight:700">${openCount} open</span>`;

      addTrainerHubsAndCircles(hubsToShow);

      if (testHubCircle && testHubMarker){
        testHubCircle.setRadius(getRadiusMiles()*1609.34);
      }

      if (!toggleRadiusCheckbox.checked) coverageCircles.forEach(c => map.removeLayer(c));
    } finally {
      const mask2 = document.getElementById('busyMask'); mask2 && requestAnimationFrame(()=>{ mask2.hidden = true; });
    }
  }

  /* ---------- Events ---------- */
  regionalFilter.addEventListener('change', () => {
    const selectedRegionals = Array.from(regionalFilter.selectedOptions).map(o=>o.value);
    if (selectedRegionals.includes('All')) {
      populateSelect(areaFilter, areaSet);
    } else {
      const filteredAreas = new Set(allStores.filter(s => selectedRegionals.includes(s.regionalManager)).map(s=>s.areaManager));
      populateSelect(areaFilter, filteredAreas);
    }
    areaFilter.querySelector('option[value="All"]').selected = true;
    onFilterChange();
  });
  areaFilter.addEventListener('change', debouncedOnFilterChange);
  trainerHubFilter.addEventListener('change', debouncedOnFilterChange);
  coverageFilter.addEventListener('change', () => { syncLegendFromCoverage(); debouncedOnFilterChange(); });

  showOpenHubsCheckbox.addEventListener('change', debouncedOnFilterChange);
  toggleHubsCheckbox.addEventListener('change', debouncedOnFilterChange);
  toggleRadiusCheckbox.addEventListener('change', () => {
    if (toggleRadiusCheckbox.checked) coverageCircles.forEach(c => c.addTo(map));
    else coverageCircles.forEach(c => map.removeLayer(c));
  });

  document.getElementById('resetFilters').addEventListener('click', () => {
    for (const o of coverageFilter.options) o.selected = (o.value==="All");
    ['regionalFilter','areaFilter'].forEach(id => {
      const sel=document.getElementById(id); Array.from(sel.options).forEach(o => o.selected=(o.value==="All"));
    });
    trainerHubFilter.selectedIndex = -1;
    allowCustom.checked = false; radiusInput.disabled = true; radiusInput.value = 75; radiusLabel.textContent = '75 mi';
    toggleHubsCheckbox.checked = true; toggleRadiusCheckbox.checked = true; showOpenHubsCheckbox.checked = true;
    uncoveredChip.classList.remove('chip-active'); outsideChip.classList.remove('chip-active'); inViewChip.classList.remove('chip-active');
    testHubChip.classList.remove('chip-active'); disableTestHub();
    outsideOnly = false; inViewOnly = false; prevCoverageSelection = null;
    minStoresInput.value = 0; minStoresLabel.textContent = '0';

    map.setView([39.5,-98.35],5);
    syncLegendFromCoverage();
    onFilterChange(); saveState();
  });

  document.getElementById('fitToResults').addEventListener('click', fitToResults);

  // Chips
  uncoveredChip.addEventListener('click', () => {
    const active = uncoveredChip.classList.toggle('chip-active');
    if (active){
      prevCoverageSelection = Array.from(coverageFilter.selectedOptions).map(o=>o.value);
      Array.from(coverageFilter.options).forEach(o => o.selected = (o.value==='Uncovered'));
    } else if (prevCoverageSelection && prevCoverageSelection.length){
      Array.from(coverageFilter.options).forEach(o => o.selected = prevCoverageSelection.includes(o.value));
      prevCoverageSelection = null;
    }
    syncLegendFromCoverage();
    debouncedOnFilterChange(); saveState();
  });
  outsideChip.addEventListener('click', () => { outsideOnly = outsideChip.classList.toggle('chip-active'); debouncedOnFilterChange(); saveState(); });
  inViewChip.addEventListener('click', () => { inViewOnly = inViewChip.classList.toggle('chip-active'); debouncedOnFilterChange(); saveState(); });

  // Test hub
  testHubChip.addEventListener('click', () => { testMode = testHubChip.classList.toggle('chip-active'); if (testMode){ enableTestHub(); } else { disableTestHub(); } });

  // Copy link
  copyLinkBtn.addEventListener('click', async () => {
    const hash = '#s=' + encodeURIComponent(JSON.stringify(getUIState()));
    const url = location.origin + location.pathname + hash;
    try{ await navigator.clipboard.writeText(url); alert('Link copied to clipboard.'); }
    catch{ prompt('Copy this link:', url); }
  });

  // Export hubs CSV
  exportHubsBtn.addEventListener('click', () => {
    if (!lastHubsToShow.length){ alert('No hubs to export.'); return; }
    const headers = ['Hub Name','Status','Person','Latitude','Longitude','Radius (mi)','Covered Stores (filtered)'];
    const rows = [headers.join(',')];
    lastHubsToShow.forEach(h => {
      const [lat,lng] = h.coords;
      rows.push([`"${h.name.replace(/"/g,'""')}"`, (h.status==='accepted'?'staffed':'open'), `"${(h.person||'').replace(/"/g,'""')}"`, lat, lng, getRadiusMiles(), h.coveredCount].join(','));
    });
    const csv = rows.join('\n'); const blob = new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='hubs.csv'; a.click(); URL.revokeObjectURL(url);
  });

  // Export KPIs
  document.getElementById('exportKpiCsv').addEventListener('click', () => {
    const c = kpiSnapshot.counts || {};
    const headers = ['Premium + Acosta','Premium Only','Acosta Only','Uncovered','Total','Uncovered %'];
    const row = [ c['Premium + Acosta']||0, c['Premium Only']||0, c['Acosta Only']||0, c['Uncovered']||0, kpiSnapshot.total||0, kpiSnapshot.pctUncov||0 ];
    const csv = headers.join(',') + '\n' + row.join(',');
    const blob = new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='kpis.csv'; a.click(); URL.revokeObjectURL(url);
  });

  // Export nearest hub CSV
  exportNearestBtn.addEventListener('click', () => {
    if (!filteredStores.length){ alert('No filtered stores to export.'); return; }
    const r = getRadiusMiles();
    const headers = ['Store Number','Store Name','City','State','Coverage','Nearest Hub','Hub Status','Distance (mi)','Within Radius?'];
    const q = v => `"${String(v ?? '').replace(/"/g,'""')}"`;
    const lines = [headers.join(',')];
    filteredStores.forEach(s => {
      const res = findNearestAllowedHub(s);
      const name = res.hub ? res.hub.name : '';
      const status = res.hub ? (res.hub.status==='accepted'?'staffed':'open') : '';
      const miles = isFinite(res.miles) ? res.miles.toFixed(1) : '';
      const within = res.hub ? (res.miles <= r ? 'Yes' : 'No') : 'No';
      lines.push([q(s.storeNumber), q(s.storeName), q(s.cityDisplay), q(s.state), q(s.coverageType), q(name), q(status), miles, within].join(','));
    });
    const blob = new Blob(["\uFEFF"+lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='nearest_hub_assignments.csv'; a.click(); URL.revokeObjectURL(url);
  });

  // Export filtered stores
  const exportFilteredBtn = document.getElementById('exportFilteredCSV');
  if (exportFilteredBtn) {
    exportFilteredBtn.addEventListener('click', () => {
      if (!filteredStores.length){ alert('No filtered stores to export.'); return; }
      const headers = ['Store Number','Store Name','Address','City','State','Coverage Type','Trainer City','Area Manager','Regional Manager'];
      const q = v => `"${String(v ?? '').replace(/"/g,'""')}"`;
      const rows = [headers.join(',')].concat(filteredStores.map(s => [
        q(s.storeNumber),q(s.storeName),q(s.address),q(s.cityDisplay),q(s.state),q(s.coverageType),q(s.trainerCity),q(s.areaManager),q(s.regionalManager)
      ].join(',')));
      const blob = new Blob(["\uFEFF"+rows.join('\n')],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`filtered_stores_${filteredStores.length}.csv`; a.click(); URL.revokeObjectURL(url);
    });
  }

  // Print list
  const printBtn = document.getElementById('printMap');
  if (printBtn) {
    printBtn.addEventListener('click', () => {
      if (!filteredStores.length){ alert('No stores to print.'); return; }
      const tbody = document.getElementById('printableBody');
      const title = document.getElementById('printTitle');
      tbody.innerHTML = filteredStores.map(s => `
        <tr>
          <td>${escapeHtml(s.storeNumber)}</td>
          <td>${escapeHtml(s.storeName)}</td>
          <td>${escapeHtml(s.address)}</td>
          <td>${escapeHtml(s.cityDisplay)}</td>
          <td>${escapeHtml(s.state)}</td>
          <td>${escapeHtml(s.coverageType)}</td>
          <td>${escapeHtml(s.trainerCity)}</td>
          <td>${escapeHtml(s.areaManager)}</td>
          <td>${escapeHtml(s.regionalManager)}</td>
        </tr>`).join('');
      title.textContent = `Store List — ${filteredStores.length} of ${allStores.length}`;
      const panel = document.getElementById('printable'); panel.style.display='block';
      setTimeout(()=>{ window.print(); panel.style.display='none'; }, 50);
    });
  }

  // Help
  helpBtn.addEventListener('click', () => {
    alert('Tips:\n• Click legend items to toggle coverage types.\n• Shift+click a cluster for a quick breakdown.\n• “Nearest CSV” lists each filtered store with its nearest visible hub.\n• Use Save/Load view to store presets.');
  });

  // Search
  searchBox.addEventListener('input', debouncedOnFilterChange);
  searchClear.addEventListener('click', () => { searchBox.value=''; debouncedOnFilterChange(); });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    const tag = document.activeElement?.tagName;
    if (tag==='INPUT' || tag==='SELECT' || tag==='TEXTAREA') return;
    if (e.key==='r') document.getElementById('resetFilters').click();
    if (e.key==='f') fitToResults();
    if (e.key==='h'){ toggleHubsCheckbox.checked=!toggleHubsCheckbox.checked; debouncedOnFilterChange(); saveState(); }
    if (e.key==='o'){ showOpenHubsCheckbox.checked=!showOpenHubsCheckbox.checked; debouncedOnFilterChange(); saveState(); }
    if (e.key==='c'){ toggleRadiusCheckbox.checked=!toggleRadiusCheckbox.checked; debouncedOnFilterChange(); saveState(); }
    if (e.key==='/'){ e.preventDefault(); searchBox.focus(); }
  });

  // Persist state on change
  ;['coverageFilter','regionalFilter','areaFilter','trainerHubFilter'].forEach(id => document.getElementById(id).addEventListener('change', saveState));
  showOpenHubsCheckbox.addEventListener('change', saveState);
  toggleHubsCheckbox.addEventListener('change', saveState);
  toggleRadiusCheckbox.addEventListener('change', saveState);
  if (searchBox) searchBox.addEventListener('input', saveState);

  // Saved views dropdown
  function loadSavedViewsDropdown(){ /* already defined above but re-bind for initial call */ }
  loadSavedViewsDropdown();

  // Initial load
  const usedHash = loadStateFromHash(); if (!usedHash) loadState();
  if (![...coverageFilter.options].some(o=>o.selected)){ coverageFilter.querySelector('option[value="All"]').selected = true; }
  syncLegendFromCoverage();
  onFilterChange();

})();
</script>
</body>
</html>
