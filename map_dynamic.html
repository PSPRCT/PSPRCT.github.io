<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Premium Retail Trainer Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  html, body { height:100%; margin:0; font-family:Arial, sans-serif; display:flex; flex-direction:column; }
  #filters {
    background:#fafafa; border-bottom:1px solid #ddd; padding:12px 15px;
    display:flex; flex-wrap:wrap; gap:20px; align-items:center; box-shadow:0 2px 6px rgb(0 0 0 / 0.08);
  }
  #filters > div { display:flex; align-items:center; position:relative; }
  label { font-weight:600; margin-right:8px; white-space:nowrap; color:#333; }
  select, input[type="text"], button {
    padding:6px 10px; font-size:14px; border-radius:6px; border:1px solid #ccc;
    transition:border-color .2s ease, box-shadow .2s ease;
  }
  select[multiple]{ width:170px; height:120px; }
  select:focus, input[type="text"]:focus{ outline:none; border-color:#3399ff; box-shadow:0 0 6px rgba(51,153,255,.6); }
  button{ cursor:pointer; background:#3399ff; color:#fff; border:none; border-radius:6px; padding:7px 15px; font-weight:600; }
  button:hover{ background:#2673cc; }
  #map { flex:1; margin:15px; border-radius:10px; box-shadow:0 3px 12px rgb(0 0 0 / 0.1); }

  /* Toggle pills */
  .toggles-row{display:flex;flex-wrap:wrap;gap:18px;align-items:center;margin-left:10px}
  .toggle-inline{display:inline-flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04);cursor:pointer}
  .toggle-inline .text{font-weight:600;color:#333}
  .toggle-inline input{opacity:0;width:0;height:0;position:absolute}
  .toggle-inline .tgl-slider{position:relative;display:inline-block;width:46px;height:24px;background:#ccc;border-radius:34px;transition:.3s;flex-shrink:0}
  .toggle-inline .tgl-slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s}
  .toggle-inline input:checked + .tgl-slider{background:#3399ff}
  .toggle-inline input:checked + .tgl-slider:before{transform:translateX(22px)}

  /* Radius group */
  .radius-group{display:inline-flex;align-items:center;gap:10px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
  .radius-group .radius-title{font-weight:600;color:#333}
  .radius-group input[type="range"]{width:120px}

  @media (max-width:700px){ .toggles-row{gap:10px} .toggle-inline{padding:6px 8px} .radius-group{flex-wrap:wrap} }

  /* Search clear */
  #searchWrapper{flex-grow:1;max-width:320px;position:relative}
  #searchClearBtn{position:absolute;right:6px;top:50%;transform:translateY(-50%);background:transparent;border:none;cursor:pointer;font-size:18px;color:#888}
  #searchClearBtn:hover{color:#3399ff}
  #searchSuggestions{position:absolute;top:100%;left:0;right:0;max-height:160px;overflow-y:auto;border:1px solid #ccc;background:#fff;z-index:1500;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,.15);display:none}
  #searchSuggestions div{padding:5px 8px;cursor:pointer}
  #searchSuggestions div.highlighted{background:#3399ff;color:#fff}

  /* Legend */
  .legend{position:absolute;bottom:15px;right:15px;background:#fff;padding:10px 14px;border-radius:6px;box-shadow:0 3px 10px rgba(0,0,0,.2);font-size:14px;line-height:1.4;color:#222;z-index:10000;max-width:240px}
  .legend h4{margin:0 0 8px}
  .legend-item{display:flex;align-items:center;margin-bottom:6px}
  .legend-color{width:18px;height:18px;margin-right:10px;border-radius:50%;flex-shrink:0}

  /* KPI strip & chips */
  .kpi-strip{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:10px}
  .kpi-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #e0e0e0;background:#fff}
  .kpi-dot{width:10px;height:10px;border-radius:50%}
  .kpi-chip .value{font-weight:700}
  .kpi-pct{margin-left:8px;font-size:12px;color:#444}
  .quick-actions{display:flex;gap:10px;align-items:center}
  .chip{border:1px solid #3399ff;background:#3399ff;color:#fff;border-radius:999px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer}
  .chip:hover{background:#2673cc;border-color:#2673cc}
  .chip-active{background:#ffe5e5;border-color:#ff9999;color:#b42318}

  /* Busy mask */
  .busy-mask{position:fixed;inset:0;background:rgba(255,255,255,.4);display:flex;align-items:center;justify-content:center;z-index:20000}
  .busy-mask[hidden]{display:none !important}
  .spinner{width:36px;height:36px;border-radius:50%;border:4px solid rgba(0,0,0,.15);border-top-color:#3399ff;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Hub markers */
  .hub-icon{width:22px;height:22px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.25),0 2px 6px rgba(0,0,0,.15)}
  .hub-staffed{background:#6a1b9a}
  .hub-open{background:#9e9e9e}
  .hub-badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:12px;font-weight:700;color:#fff}
  .hub-badge.staffed{background:#6a1b9a}
  .hub-badge.open{background:#9e9e9e}
  .hub-badge.next{background:#ff8c00}

  /* Hub panel + overlay */
  #hubPanel{position:absolute;top:130px;right:20px;width:360px;max-height:70vh;overflow:auto;background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.12);z-index:12000;display:none}
  #hubPanel header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eee;font-weight:700}
  #hubPanel .body{padding:10px 12px;font-size:13px}
  #hubPanel .list{max-height:52vh;overflow:auto;margin-top:8px}
  #hubPanel .row{padding:4px 0;border-bottom:1px dashed #eee}
  #hubPanel .close{background:#3399ff;color:#fff;border:0;padding:6px 12px;border-radius:999px;font-size:13px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
  #hubPanel .close::before{content:"×";font-size:16px;line-height:1}
  #hubPanel .close:hover{background:#2673cc}
  #hubPanel .footer{position:sticky;bottom:0;background:#fff;padding:10px 12px;border-top:1px solid #eee}
  #hubPanel .footer .close{width:100%}
  #hubOverlay{position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:11000}
  #hubOverlay[hidden]{display:none !important}

  /* Print panel */
  #printable{display:none;padding:24px;background:#fff}
  #printTitle{margin:0 0 12px;font-size:18px}
  #printTable{width:100%;border-collapse:collapse;font-size:12px}
  #printTable th,#printTable td{border:1px solid #ccc;padding:6px;text-align:left}
  @media print{
    body *{visibility:hidden !important}
    #printable,#printable *{visibility:visible !important}
    #printable{display:block !important;position:absolute;inset:0}
  }
</style>
</head>
<body>

<div id="filters">
  <div id="searchWrapper">
    <label for="searchBox">Search store # or city:</label>
    <input type="text" id="searchBox" autocomplete="off" placeholder="Search store # or city" style="width:100%" />
    <button id="searchClearBtn" title="Clear search">&times;</button>
    <div id="searchSuggestions"></div>
  </div>

  <div>
    <label for="coverageFilter">Coverage Type:</label>
    <select id="coverageFilter" multiple title="Select coverage types">
      <option value="All">All</option>
      <option value="Premium + Acosta">Premium + Acosta</option>
      <option value="Premium Only">Premium Only</option>
      <option value="Acosta Only">Acosta Only</option>
      <option value="Uncovered">Uncovered</option>
    </select>
  </div>

  <div>
    <label for="regionalFilter">Regional Manager:</label>
    <select id="regionalFilter" multiple title="Select regional managers">
      <option value="All" selected>All</option>
    </select>
  </div>

  <div>
    <label for="areaFilter">Area Manager:</label>
    <select id="areaFilter" multiple title="Select area managers">
      <option value="All" selected>All</option>
    </select>
  </div>

  <div>
    <label for="trainerHubFilter">Trainer Hub Filter:</label>
    <select id="trainerHubFilter" multiple title="Select trainer hubs"></select>
  </div>

  <div>
    <label for="zoomHub">Zoom to Hub:</label>
    <select id="zoomHub" title="Select a trainer hub to zoom">
      <option value="">-- Select Hub --</option>
    </select>
  </div>

  <div id="toggles" class="toggles-row">
    <label class="toggle-inline" title="Show staffed trainer hubs">
      <span class="text">Staffed hubs</span>
      <input type="checkbox" id="toggleHubs" checked role="switch" aria-label="Show staffed hubs" />
      <span class="tgl-slider" aria-hidden="true"></span>
    </label>

    <label class="toggle-inline" title="Show coverage radius circles">
      <span class="text">Coverage radius</span>
      <input type="checkbox" id="toggleRadius" checked role="switch" aria-label="Show coverage radius" />
      <span class="tgl-slider" aria-hidden="true"></span>
    </label>

    <div class="radius-group">
      <span class="radius-title">Radius:</span>
      <input type="range" id="radiusMiles" min="25" max="150" step="5" value="75" />
      <span id="radiusLabel">75 mi</span>
    </div>

    <label class="toggle-inline" title="Allow changing the default 75mi radius">
      <span class="text">Custom radius</span>
      <input type="checkbox" id="allowCustomRadius" role="switch" aria-label="Allow custom radius" />
      <span class="tgl-slider" aria-hidden="true"></span>
    </label>

    <label class="toggle-inline" title="Show placeholder open hubs">
      <span class="text">Open hubs</span>
      <input type="checkbox" id="showOpenHubs" checked role="switch" aria-label="Show open hubs" />
      <span class="tgl-slider" aria-hidden="true"></span>
    </label>
  </div>

  <div class="quick-actions">
    <button id="uncoveredChip" class="chip" title="Toggle uncovered-only">Uncovered only</button>
    <button id="outsideChip" class="chip" title="Only stores outside all visible hubs">Outside all hubs</button>
    <button id="inViewChip" class="chip" title="Only stores currently in map view">In view only</button>
    <button id="copyLinkBtn" title="Copy a URL with current filters">Copy link</button>
    <button id="exportHubsCSV" title="Export visible hubs with counts">Export Hubs CSV</button>
    <button id="exportKpiCsv" title="Export KPI counts and uncovered %">Export KPIs CSV</button>
  </div>

  <div>
    <button id="resetFilters">Reset Filters</button>
    <button id="fitToResults">Fit to Results</button>
  </div>

  <div>
    <button id="exportFilteredCSV">Export Filtered Stores CSV</button>
    <button id="printMap">Print Store List</button>
  </div>

  <div id="filterCount" style="font-weight:bold; margin-left:15px; min-width:180px;">Showing 0 of 0 stores</div>
  <span id="inViewCount" style="margin-left:8px;color:#555"></span>

  <div id="kpiStrip" class="kpi-strip" aria-live="polite"></div>
</div>

<div id="hubCount" style="padding:0 15px 6px; color:#333; font-size:14px;"></div>

<div id="map"></div>

<!-- Overlay + Hub panel -->
<div id="hubOverlay" aria-hidden="true" hidden></div>

<div id="hubPanel" role="dialog" aria-modal="true" aria-live="polite">
  <header>
    <span class="title">Hub</span>
    <button id="hubPanelClose" class="close" title="Close panel" aria-label="Close panel">Close</button>
  </header>
  <div class="body">
    <div class="summary"></div>
    <button id="exportHubPanelCsv">Export stores CSV</button>
    <div class="list"></div>
    <div class="footer">
      <button id="hubPanelCloseFooter" class="close" title="Close panel" aria-label="Close panel">Close</button>
    </div>
  </div>
</div>

<!-- Busy -->
<div id="busyMask" class="busy-mask" hidden><div class="spinner"></div></div>

<!-- Print panel -->
<div id="printable">
  <h2 id="printTitle">Store List</h2>
  <table id="printTable">
    <thead>
      <tr>
        <th>Store #</th><th>Store Name</th><th>Address</th><th>City</th><th>State</th>
        <th>Coverage</th><th>Trainer City</th><th>Area Manager</th><th>Regional Manager</th>
      </tr>
    </thead>
    <tbody id="printableBody"></tbody>
  </table>
</div>

<!-- Legend -->
<div class="legend" id="legend">
  <h4>Legend</h4>
  <div class="legend-item"><div class="legend-color" style="background:blue"></div>Premium + Acosta</div>
  <div class="legend-item"><div class="legend-color" style="background:green"></div>Premium Only</div>
  <div class="legend-item"><div class="legend-color" style="background:orange"></div>Acosta Only</div>
  <div class="legend-item"><div class="legend-color" style="background:red"></div>Uncovered</div>
  <div class="legend-item"><span class="legend-color" style="background:#6a1b9a"></span>Staffed Hub</div>
  <div class="legend-item"><span class="legend-color" style="background:#9e9e9e"></span>Open Hub</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(async function(){
  /* ---------- Config ---------- */
  const coverageColors = {
    "Premium + Acosta": "blue",
    "Premium Only": "green",
    "Acosta Only": "orange",
    "Uncovered": "red"
  };
  const NEXT_WIN_UNCOV_THRESHOLD = 35; // mark open hubs as "Next win" if >= this many uncovered stores in radius

  /* ---------- Hubs (open+staffed) ---------- */
  const trainerHubs = [
    // OPEN (sample)
    { id:"belle_vernon_pa", name:"Belle Vernon, PA (Open)", coords:[40.12507,-79.8664], status:"open", person:null },
    { id:"blair_ne", name:"Blair, NE (Open)", coords:[41.5461,-96.1202], status:"open", person:null },
    { id:"centennial_co", name:"Centennial, CO (Open)", coords:[39.62732,-104.779], status:"open", person:null },
    // ... (keep the rest of your open hubs here)
    // STAFFED (formerly 'accepted')
    { id:"granite_falls_nc_walker", name:"Granite Falls, NC - Lisa Walker", coords:[35.80049406642459,-81.40580339729192], status:"accepted", person:"Lisa Walker" },
    { id:"clarksville_tn_salvato", name:"Clarksville, TN - Nicholas Salvato", coords:[36.58887925062968,-87.34016705996005], status:"accepted", person:"Nicholas Salvato" },
    // ... (keep the rest of your staffed hubs here)
  ];
  trainerHubs.forEach(h => { h.latRad = h.coords[0]*Math.PI/180; h.lngRad = h.coords[1]*Math.PI/180; });

  /* ---------- State ---------- */
  let allStores = [];
  let filteredStores = [];
  let hubsMarkers = [];
  let coverageCircles = [];
  const storeMarkersMap = new Map();
  let currentOpenPopup = null;
  let lastHubsToShow = [];
  let prevCoverageSelection = null;
  let outsideOnly = false;
  let inViewOnly = false;
  let kpiSnapshot = { counts:{}, total:0, pctUncov:0 };

  /* ---------- Utils ---------- */
  function debounce(fn, delay=150){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay); }; }
  const debouncedOnFilterChange = debounce(onFilterChange,150);

  function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
  function toRad(a){ return a*Math.PI/180; }
  function getDistanceMiles(lat1, lon1, lat2, lon2, lat1Rad, lon1Rad, lat2Rad, lon2Rad){
    const R = 3958.8;
    const φ1 = lat1Rad ?? toRad(lat1), λ1 = lon1Rad ?? toRad(lon1);
    const φ2 = lat2Rad ?? toRad(lat2), λ2 = lon2Rad ?? toRad(lon2);
    const dφ = φ2-φ1, dλ = λ2-λ1;
    const a = Math.sin(dφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
    return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
  }

  /* ---------- Data ---------- */
  try{
    const resp = await fetch('store_data.json');
    if(!resp.ok) throw new Error('Failed to load store_data.json');
    const raw = await resp.json();
    allStores = raw.map(s => ({
      ...s,
      city: (s.city||"").trim().toLowerCase(),
      cityDisplay: (s.city||"").trim(),
      state: (s.state||"").trim(),
      trainerCity: (s.trainerCity||"").trim(),
      storeNumber: String(s.storeNumber),
      latRad: (s.latitude??0)*Math.PI/180,
      lngRad: (s.longitude??0)*Math.PI/180,
    }));
  }catch(err){ alert(err.message); return; }

  /* ---------- Map ---------- */
  const map = L.map('map').setView([39.5,-98.35],5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'© OpenStreetMap contributors'}).addTo(map);
  const markers = L.markerClusterGroup(); map.addLayer(markers);
  map.on('moveend zoomend', updateInViewCount);

  function iconForHub(hub){
    const cls = hub.status === "accepted" ? "hub-staffed" : "hub-open";
    return L.divIcon({
      className:"",
      html:`<div class="hub-icon ${cls}" title="${escapeHtml(hub.name)}"></div>`,
      iconSize:[22,22], iconAnchor:[11,11], popupAnchor:[0,-10]
    });
  }

  /* ---------- DOM ---------- */
  const coverageFilter = document.getElementById('coverageFilter');
  const regionalFilter = document.getElementById('regionalFilter');
  const areaFilter = document.getElementById('areaFilter');
  const trainerHubFilter = document.getElementById('trainerHubFilter');
  const zoomHubSelect = document.getElementById('zoomHub');

  const toggleHubsCheckbox = document.getElementById('toggleHubs');     // Staffed hubs
  const showOpenHubsCheckbox = document.getElementById('showOpenHubs'); // Open hubs
  const toggleRadiusCheckbox = document.getElementById('toggleRadius');

  const radiusInput = document.getElementById('radiusMiles');
  const radiusLabel = document.getElementById('radiusLabel');
  const allowCustom = document.getElementById('allowCustomRadius');

  const searchBox = document.getElementById('searchBox');
  const searchClearBtn = document.getElementById('searchClearBtn');
  const suggestionsBox = document.getElementById('searchSuggestions');

  const uncoveredChip = document.getElementById('uncoveredChip');
  const outsideChip   = document.getElementById('outsideChip');
  const inViewChip    = document.getElementById('inViewChip');

  const copyLinkBtn   = document.getElementById('copyLinkBtn');
  const exportHubsBtn = document.getElementById('exportHubsCSV');

  /* ---------- Build filters ---------- */
  function populateSelect(selectElem, optionsSet){
    [...selectElem.options].forEach(o => { if (o.value!=="All") selectElem.removeChild(o); });
    optionsSet.forEach(opt => {
      const option = document.createElement('option'); option.value = opt; option.textContent = opt;
      selectElem.appendChild(option);
    });
  }
  const regionalSet = new Set(allStores.map(s=>s.regionalManager));
  const areaSet     = new Set(allStores.map(s=>s.areaManager));
  populateSelect(regionalFilter, regionalSet);
  populateSelect(areaFilter, areaSet);

  function populateHubControls(){
    // Zoom list: ALWAYS list all hubs
    zoomHubSelect.innerHTML = '<option value="">-- Select Hub --</option>';
    trainerHubs.forEach(hub => {
      const opt = document.createElement('option');
      opt.value = JSON.stringify(hub.coords);
      opt.textContent = hub.name;
      zoomHubSelect.appendChild(opt);
    });
    // Filter multi-select: list all hubs; we will *optionally* gray/hide when no stores in range
    trainerHubs.forEach(hub => {
      const opt = document.createElement('option');
      opt.value = hub.name; opt.textContent = hub.name; trainerHubFilter.appendChild(opt);
    });
  }
  populateHubControls();

  /* ---------- Radius behavior ---------- */
  if (allowCustom) allowCustom.checked = false;
  if (radiusInput){ radiusInput.disabled = true; radiusInput.value = 75; }
  if (radiusLabel) radiusLabel.textContent = '75 mi';
  const getRadiusMiles = () => (allowCustom && allowCustom.checked ? (parseInt(radiusInput.value,10)||75) : 75);

  if (radiusInput) radiusInput.addEventListener('input', () => {
    radiusLabel.textContent = `${getRadiusMiles()} mi`;
    if (zoomHubSelect.value){ try{ fitToHubArea(JSON.parse(zoomHubSelect.value)); }catch{} }
    debouncedOnFilterChange(); saveState();
  });
  if (allowCustom) allowCustom.addEventListener('change', () => {
    radiusInput.disabled = !allowCustom.checked;
    radiusLabel.textContent = `${getRadiusMiles()} mi`;
    if (zoomHubSelect.value){ try{ fitToHubArea(JSON.parse(zoomHubSelect.value)); }catch{} }
    debouncedOnFilterChange(); saveState();
  });

  /* ---------- Filter logic ---------- */
  function typeAllowed(hub){
    return (hub.status==='accepted' && toggleHubsCheckbox.checked) ||
           (hub.status==='open'     && showOpenHubsCheckbox.checked);
  }
  function findNearestAllowedHub(store){
    let best=null, bestD=Infinity;
    for (const h of trainerHubs){
      if (!typeAllowed(h)) continue;
      const d = getDistanceMiles(h.coords[0],h.coords[1],store.latitude,store.longitude,h.latRad,h.lngRad,store.latRad,store.lngRad);
      if (d<bestD){bestD=d;best=h;}
    }
    return { hub:best, miles:bestD };
  }

  function filterStores(){
    const selectedCoverage = Array.from(coverageFilter.selectedOptions).map(o=>o.value);
    const selectedRegional = Array.from(regionalFilter.selectedOptions).map(o=>o.value);
    const selectedArea     = Array.from(areaFilter.selectedOptions).map(o=>o.value);

    const zoomCoords = zoomHubSelect.value ? [JSON.parse(zoomHubSelect.value)] : [];
    const chosenHubCoords = zoomCoords.length
      ? zoomCoords
      : Array.from(trainerHubFilter.selectedOptions)
          .map(o => (trainerHubs.find(h => h.name === o.value) || {}).coords)
          .filter(Boolean);

    const bounds = map.getBounds();

    filteredStores = allStores.filter(store => {
      const covMatch  = selectedCoverage.includes('All') || selectedCoverage.includes(store.coverageType);
      const regMatch  = selectedRegional.includes('All') || selectedRegional.includes(store.regionalManager);
      const areaMatch = selectedArea.includes('All') || selectedArea.includes(store.areaManager);

      // in-view only chip
      if (inViewOnly && !bounds.contains([store.latitude, store.longitude])) return false;

      // hub radius constraint if a hub selection is active
      const r = getRadiusMiles();
      const hubConstraintOK = !chosenHubCoords.length || chosenHubCoords.some(([lat,lng]) =>
        getDistanceMiles(lat,lng,store.latitude,store.longitude,undefined,undefined,store.latRad,store.lngRad) <= r
      );

      // outside all hubs chip (respect typeAllowed toggles)
      let outsideOK = true;
      if (outsideOnly){
        for (const h of trainerHubs){
          if (!typeAllowed(h)) continue;
          const d = getDistanceMiles(h.coords[0],h.coords[1],store.latitude,store.longitude,h.latRad,h.lngRad,store.latRad,store.lngRad);
          if (d <= r){ outsideOK = false; break; }
        }
      }

      return covMatch && regMatch && areaMatch && hubConstraintOK && outsideOK;
    });
  }

  /* ---------- Map rendering ---------- */
  function addLazyLoadedMarkers(stores){
    markers.clearLayers(); storeMarkersMap.clear();
    const bounds = map.getBounds();
    const bufferLat = 50/69;
    const extended = L.latLngBounds(
      [bounds.getSouth()-bufferLat, bounds.getWest()-bufferLat],
      [bounds.getNorth()+bufferLat, bounds.getEast()+bufferLat]
    );

    stores.filter(s => extended.contains([s.latitude,s.longitude])).forEach(store => {
      const nearest = findNearestAllowedHub(store);
      const breakdown = ''; // per-store popup keeps it simple

      const marker = L.circleMarker([store.latitude,store.longitude],{
        radius:6, color:coverageColors[store.coverageType]||'gray',
        fillColor:coverageColors[store.coverageType]||'gray', fillOpacity:.85, weight:1
      }).bindPopup(`
        <strong>Store #${escapeHtml(store.storeNumber)}</strong><br>
        ${escapeHtml(store.storeName)}<br>
        ${escapeHtml(store.address)}<br>
        ${escapeHtml(store.cityDisplay)}, ${escapeHtml(store.state)}<br>
        Coverage: <b>${escapeHtml(store.coverageType)}</b><br>
        Trainer City: ${escapeHtml(store.trainerCity)}<br>
        Area: ${escapeHtml(store.areaManager)}<br>
        Regional: ${escapeHtml(store.regionalManager)}<br>
        ${nearest.hub ? `Nearest hub: ${escapeHtml(nearest.hub.name)} (${nearest.miles.toFixed(1)} mi)` : 'No visible hub nearby'}
      `);

      markers.addLayer(marker);
      storeMarkersMap.set(store.storeNumber.replace(/^0+/, ''), marker);
    });
  }

  function updateKPI(){
    const c = { "Premium + Acosta":0,"Premium Only":0,"Acosta Only":0,"Uncovered":0 };
    filteredStores.forEach(s => { c[s.coverageType] = (c[s.coverageType]||0)+1; });
    const total = filteredStores.length || 1;
    const pctUn = Math.round((c["Uncovered"]/total)*1000)/10;

    const chip = (color,label,val)=>`
      <span class="kpi-chip"><span class="kpi-dot" style="background:${color}"></span>
      <span class="label">${label}</span><span class="value">${val}</span></span>`;
    const el = document.getElementById('kpiStrip');
    el.innerHTML = [
      chip('blue','Premium + Acosta', c['Premium + Acosta']||0),
      chip('green','Premium Only', c['Premium Only']||0),
      chip('orange','Acosta Only', c['Acosta Only']||0),
      chip('red','Uncovered', c['Uncovered']||0),
      `<span class="kpi-pct">Uncovered: <strong>${isFinite(pctUn)?pctUn:0}%</strong></span>`
    ].join('');
    kpiSnapshot = { counts:c, total:filteredStores.length, pctUncov:pctUn };
  }

  function getStoresCoveredByHub(hub){
    const r = getRadiusMiles();
    return filteredStores.filter(s => getDistanceMiles(hub.coords[0],hub.coords[1],s.latitude,s.longitude,hub.latRad,hub.lngRad,s.latRad,s.lngRad) <= r);
  }

  function openHubPanel(hub){
    const panel = document.getElementById('hubPanel');
    const overlay = document.getElementById('hubOverlay');
    const list = getStoresCoveredByHub(hub);

    // breakdown counts
    const byCov = { "Premium + Acosta":0, "Premium Only":0, "Acosta Only":0, "Uncovered":0 };
    list.forEach(s => byCov[s.coverageType] = (byCov[s.coverageType]||0)+1);

    panel.querySelector('.title').textContent = hub.name;
    panel.querySelector('.summary').innerHTML =
      `${list.length} stores within ${getRadiusMiles()} mi` +
      `<div style="margin-top:6px;font-size:12px;color:#444">
        <b>Breakdown</b> — P+A: ${byCov["Premium + Acosta"]||0}, P-only: ${byCov["Premium Only"]||0},
        A-only: ${byCov["Acosta Only"]||0}, Uncov: ${byCov["Uncovered"]||0}
      </div>`;

    panel.querySelector('.list').innerHTML = list.slice(0,800).map(s =>
      `<div class="row">#${escapeHtml(s.storeNumber)} — ${escapeHtml(s.cityDisplay)}, ${escapeHtml(s.state)} — ${escapeHtml(s.coverageType)}</div>`
    ).join('');

    panel.style.display = 'block';
    overlay.hidden = false; overlay.setAttribute('aria-hidden','false');

    const btn = document.getElementById('exportHubPanelCsv');
    btn.onclick = () => exportStoresCsv(list, `stores_for_${hub.id}`);
  }

  function closeHubPanel(){
    const panel = document.getElementById('hubPanel');
    const overlay = document.getElementById('hubOverlay');
    if (panel) panel.style.display = 'none';
    if (overlay){ overlay.hidden = true; overlay.setAttribute('aria-hidden','true'); }
  }
  document.getElementById('hubPanelClose').addEventListener('click', closeHubPanel);
  document.getElementById('hubPanelCloseFooter').addEventListener('click', closeHubPanel);
  document.getElementById('hubOverlay').addEventListener('click', closeHubPanel);
  document.addEventListener('keydown', e => { if (e.key==='Escape'){ const p=document.getElementById('hubPanel'); if (p&&p.style.display==='block') closeHubPanel(); }});

  function addTrainerHubsAndCircles(hubsToShow){
    hubsMarkers.forEach(m => map.removeLayer(m));
    coverageCircles.forEach(c => map.removeLayer(c));
    hubsMarkers = []; coverageCircles = [];

    const rMiles = getRadiusMiles();
    hubsToShow.forEach(hub => {
      const within = getStoresCoveredByHub(hub);
      const uncovered = within.filter(s=>s.coverageType==='Uncovered').length;
      const byCov = { "Premium + Acosta":0,"Premium Only":0,"Acosta Only":0,"Uncovered":0 };
      within.forEach(s => byCov[s.coverageType]=(byCov[s.coverageType]||0)+1);

      const statusKey = hub.status === 'accepted' ? 'staffed' : 'open';
      const nextWin = (hub.status==='open' && uncovered >= NEXT_WIN_UNCOV_THRESHOLD);
      const badge = `<span class="hub-badge ${statusKey}">${statusKey.toUpperCase()}</span>${nextWin ? ' <span class="hub-badge next">NEXT WIN</span>' : ''}`;
      const person = hub.person ? ` &nbsp;•&nbsp; <strong>${escapeHtml(hub.person)}</strong>` : "";

      const popupHtml = `
        <b>${escapeHtml(hub.name)}</b>${person}<br>
        ${badge}<br>
        <div style="margin-top:6px">
          <b>${within.length}</b> in ${rMiles} mi &nbsp;|&nbsp;
          P+A: ${byCov["Premium + Acosta"]||0} · P: ${byCov["Premium Only"]||0} · A: ${byCov["Acosta Only"]||0} · U: ${byCov["Uncovered"]||0}
        </div>
        <div style="margin-top:6px">
          <a href="#" data-hub="${hub.id}" class="open-panel">Open list</a>
        </div>
      `;

      const hubMarker = L.marker(hub.coords,{icon:iconForHub(hub)}).bindPopup(popupHtml).addTo(map);
      hubsMarkers.push(hubMarker);

      const circle = L.circle(hub.coords,{
        radius:rMiles*1609.34, color:'purple', weight:1, fillOpacity:.1, dashArray:'5,10'
      }).addTo(map);
      coverageCircles.push(circle);

      function highlight(on){ circle.setStyle({weight:on?3:1, fillOpacity:on?.18:.1}); if(on && circle.bringToFront) circle.bringToFront(); }
      hubMarker.on('mouseover', () => highlight(true));
      hubMarker.on('mouseout',  () => highlight(false));
      circle.on('mouseover', () => highlight(true));
      circle.on('mouseout',  () => highlight(false));
      hubMarker.on('click', () => openHubPanel(hub));
      circle.on('click', () => openHubPanel(hub));
    });

    // Delegate click for "Open list" link inside hub popup
    map.on('popupopen', (e) => {
      const link = e.popup._contentNode.querySelector('a.open-panel');
      if (link){
        link.addEventListener('click', (ev) => {
          ev.preventDefault();
          const id = link.getAttribute('data-hub');
          const hub = trainerHubs.find(h => h.id === id);
          if (hub) openHubPanel(hub);
        }, { once:true });
      }
    });
  }

  function updateTrainerHubFilter(){
    // contextual enable/disable (optional)
    const hubsWithStores = new Set();
    trainerHubs.forEach(hub => {
      const coversAny = filteredStores.some(store =>
        getDistanceMiles(hub.coords[0], hub.coords[1], store.latitude, store.longitude, hub.latRad, hub.lngRad, store.latRad, store.lngRad) <= getRadiusMiles()
      );
      if (coversAny) hubsWithStores.add(hub.name);
    });
    [...trainerHubFilter.options].forEach(option => {
      if (!option.value) return;
      const show = hubsWithStores.has(option.value);
      option.disabled = !show;
      option.style.display = show ? '' : 'none';
      if (!show) option.selected = false;
    });
    // Do NOT touch zoomHubSelect — it always lists all hubs.
  }

  function fitToHubArea(hubCoords){
    const r = getRadiusMiles();
    const inRadius = filteredStores.filter(s => getDistanceMiles(hubCoords[0],hubCoords[1],s.latitude,s.longitude) <= r);
    if (inRadius.length){
      const latLngs = inRadius.map(s => [s.latitude,s.longitude]); latLngs.push(hubCoords);
      map.fitBounds(L.latLngBounds(latLngs),{padding:[30,30]});
    } else {
      map.setView(hubCoords, 11);
    }
  }

  /* ---------- Counts/UI ---------- */
  function updateFilterCount(){
    document.getElementById('filterCount').textContent = `Showing ${filteredStores.length} of ${allStores.length} stores`;
  }
  function updateInViewCount(){
    const el = document.getElementById('inViewCount'); if (!el) return;
    if (!filteredStores.length){ el.textContent=''; return; }
    const b = map.getBounds(); let n=0; for (const s of filteredStores) if (b.contains([s.latitude,s.longitude])) n++;
    el.textContent = ` | In view: ${n}`;
  }

  /* ---------- Main refresh ---------- */
  async function onFilterChange(){
    const mask = document.getElementById('busyMask'); mask.hidden = false;
    try{
      // 1) filter + markers
      filterStores();
      addLazyLoadedMarkers(filteredStores);
      updateInViewCount(); updateFilterCount(); updateKPI();

      // 2) contextual trainer hub filter
      updateTrainerHubFilter();

      // 3) choose hubs to show (ALL that match toggles)
      const includeStaffed = toggleHubsCheckbox.checked;
      const includeOpen    = showOpenHubsCheckbox.checked;
      const hubsToShow = trainerHubs.filter(h => (h.status==='accepted' && includeStaffed) || (h.status==='open' && includeOpen));

      // compute covered counts (for export)
      lastHubsToShow = hubsToShow.map(h => ({
        ...h,
        coveredCount: getStoresCoveredByHub(h).length
      }));

      // 4) hub counter + render
      const staffedCount = hubsToShow.filter(h => h.status==='accepted').length;
      const openCount    = hubsToShow.filter(h => h.status==='open').length;
      const hubCountEl = document.getElementById('hubCount');
      hubCountEl.innerHTML = `Hubs shown: <span style="color:#6a1b9a;font-weight:700">${staffedCount} staffed</span> / <span style="color:#9e9e9e;font-weight:700">${openCount} open</span>`;

      addTrainerHubsAndCircles(hubsToShow);

      // 5) respect radius toggle
      if (!toggleRadiusCheckbox.checked) coverageCircles.forEach(c => map.removeLayer(c));
    } finally {
      requestAnimationFrame(()=>{ mask.hidden = true; });
    }
  }

  /* ---------- Events ---------- */
  regionalFilter.addEventListener('change', () => {
    const selectedRegionals = Array.from(regionalFilter.selectedOptions).map(o=>o.value);
    if (selectedRegionals.includes('All')) {
      populateSelect(areaFilter, areaSet);
    } else {
      const filteredAreas = new Set(allStores.filter(s => selectedRegionals.includes(s.regionalManager)).map(s=>s.areaManager));
      populateSelect(areaFilter, filteredAreas);
    }
    areaFilter.querySelector('option[value="All"]').selected = true;
    onFilterChange();
  });
  areaFilter.addEventListener('change', debouncedOnFilterChange);
  trainerHubFilter.addEventListener('change', debouncedOnFilterChange);
  coverageFilter.addEventListener('change', debouncedOnFilterChange);
  showOpenHubsCheckbox.addEventListener('change', debouncedOnFilterChange);
  toggleHubsCheckbox.addEventListener('change', debouncedOnFilterChange);
  toggleRadiusCheckbox.addEventListener('change', () => {
    if (toggleRadiusCheckbox.checked) coverageCircles.forEach(c => c.addTo(map));
    else coverageCircles.forEach(c => map.removeLayer(c));
  });

  zoomHubSelect.addEventListener('change', () => {
    if (zoomHubSelect.value){
      const coords = JSON.parse(zoomHubSelect.value); fitToHubArea(coords);
    } else { map.setView([39.5,-98.35],5); }
    debouncedOnFilterChange(); saveState();
  });

  document.getElementById('resetFilters').addEventListener('click', () => {
    // coverage -> All
    for (const o of coverageFilter.options) o.selected = (o.value==="All");
    // managers -> All
    ['regionalFilter','areaFilter'].forEach(id => {
      const sel=document.getElementById(id); Array.from(sel.options).forEach(o => o.selected=(o.value==="All"));
    });
    // hub filters cleared
    trainerHubFilter.selectedIndex = -1; zoomHubSelect.value = "";
    // radius back to locked 75
    allowCustom.checked = false; radiusInput.disabled = true; radiusInput.value = 75; radiusLabel.textContent = '75 mi';
    // toggles
    toggleHubsCheckbox.checked = true; toggleRadiusCheckbox.checked = true; showOpenHubsCheckbox.checked = true;
    // chips
    uncoveredChip.classList.remove('chip-active'); outsideChip.classList.remove('chip-active'); inViewChip.classList.remove('chip-active');
    outsideOnly = false; inViewOnly = false; prevCoverageSelection = null;

    map.setView([39.5,-98.35],5);
    onFilterChange(); saveState();
  });

  function fitToResults(){
    if (!filteredStores.length) return;
    const latLngs = filteredStores.map(s => [s.latitude,s.longitude]);
    map.fitBounds(L.latLngBounds(latLngs),{padding:[20,20]});
  }
  document.getElementById('fitToResults').addEventListener('click', fitToResults);

  // Chips
  uncoveredChip.addEventListener('click', () => {
    const active = uncoveredChip.classList.toggle('chip-active');
    if (active){
      prevCoverageSelection = Array.from(coverageFilter.selectedOptions).map(o=>o.value);
      Array.from(coverageFilter.options).forEach(o => o.selected = (o.value==='Uncovered'));
    } else if (prevCoverageSelection && prevCoverageSelection.length){
      Array.from(coverageFilter.options).forEach(o => o.selected = prevCoverageSelection.includes(o.value));
      prevCoverageSelection = null;
    }
    debouncedOnFilterChange(); saveState();
  });
  outsideChip.addEventListener('click', () => {
    outsideOnly = outsideChip.classList.toggle('chip-active');
    debouncedOnFilterChange(); saveState();
  });
  inViewChip.addEventListener('click', () => {
    inViewOnly = inViewChip.classList.toggle('chip-active');
    debouncedOnFilterChange(); saveState();
  });

  // Copy link
  function getUIState(){
    return {
      v:1,
      coverage:Array.from(coverageFilter.selectedOptions).map(o=>o.value),
      regional:Array.from(regionalFilter.selectedOptions).map(o=>o.value),
      area:Array.from(areaFilter.selectedOptions).map(o=>o.value),
      hubs:Array.from(trainerHubFilter.selectedOptions).map(o=>o.value),
      zoomHub:zoomHubSelect.value,
      toggles:{ showHubs:toggleHubsCheckbox.checked, showRadius:toggleRadiusCheckbox.checked, showOpen:showOpenHubsCheckbox.checked },
      search:searchBox.value,
      radius:{ allowCustom:allowCustom.checked, value:radiusInput.value },
      chips:{ outsideOnly, inViewOnly, uncovered:uncoveredChip.classList.contains('chip-active') }
    };
  }
  function applyStateFromObject(s){
    function restoreMulti(select, values){ if(!select||!values) return; Array.from(select.options).forEach(o => o.selected = values.includes(o.value)); }
    restoreMulti(coverageFilter, s.coverage);
    restoreMulti(regionalFilter, s.regional);
    restoreMulti(areaFilter, s.area);
    restoreMulti(trainerHubFilter, s.hubs);
    if (s.zoomHub) zoomHubSelect.value = s.zoomHub;
    if (s.toggles){
      if ('showHubs' in s.toggles) toggleHubsCheckbox.checked = s.toggles.showHubs;
      if ('showRadius' in s.toggles) toggleRadiusCheckbox.checked = s.toggles.showRadius;
      if ('showOpen' in s.toggles) showOpenHubsCheckbox.checked = s.toggles.showOpen;
    }
    if (typeof s.search === 'string') searchBox.value = s.search;
    if (s.radius){ allowCustom.checked = !!s.radius.allowCustom; radiusInput.disabled = !allowCustom.checked; if (s.radius.value) radiusInput.value = s.radius.value; radiusLabel.textContent = `${getRadiusMiles()} mi`; }
    if (s.chips){
      outsideOnly = !!s.chips.outsideOnly; inViewOnly = !!s.chips.inViewOnly;
      if (s.chips.uncovered) uncoveredChip.classList.add('chip-active');
      if (outsideOnly) outsideChip.classList.add('chip-active');
      if (inViewOnly) inViewChip.classList.add('chip-active');
    }
  }
  function loadStateFromHash(){
    if (!location.hash.startsWith('#s=')) return false;
    try{ const s = JSON.parse(decodeURIComponent(location.hash.slice(3))); applyStateFromObject(s); return true; }
    catch{ return false; }
  }
  function saveState(){ localStorage.setItem('trainerMapState', JSON.stringify(getUIState())); }
  function loadState(){
    const raw = localStorage.getItem('trainerMapState'); if (!raw) return;
    try{ const s = JSON.parse(raw); applyStateFromObject(s); }catch{}
  }

  copyLinkBtn.addEventListener('click', async () => {
    const hash = '#s=' + encodeURIComponent(JSON.stringify(getUIState()));
    const url = location.origin + location.pathname + hash;
    try{ await navigator.clipboard.writeText(url); alert('Link copied to clipboard.'); }
    catch{ prompt('Copy this link:', url); }
  });

  // Export hubs CSV
  exportHubsBtn.addEventListener('click', () => {
    if (!lastHubsToShow.length){ alert('No hubs to export.'); return; }
    const headers = ['Hub Name','Status','Person','Latitude','Longitude','Radius (mi)','Covered Stores (filtered)'];
    const rows = [headers.join(',')];
    lastHubsToShow.forEach(h => {
      const [lat,lng] = h.coords;
      rows.push([`"${h.name.replace(/"/g,'""')}"`, (h.status==='accepted'?'staffed':'open'), `"${(h.person||'').replace(/"/g,'""')}"`, lat, lng, getRadiusMiles(), h.coveredCount].join(','));
    });
    const csv = rows.join('\n'); const blob = new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='hubs.csv'; a.click(); URL.revokeObjectURL(url);
  });

  // Export KPIs
  document.getElementById('exportKpiCsv').addEventListener('click', () => {
    const c = kpiSnapshot.counts || {};
    const headers = ['Premium + Acosta','Premium Only','Acosta Only','Uncovered','Total','Uncovered %'];
    const row = [ c['Premium + Acosta']||0, c['Premium Only']||0, c['Acosta Only']||0, c['Uncovered']||0, kpiSnapshot.total||0, kpiSnapshot.pctUncov||0 ];
    const csv = headers.join(',') + '\n' + row.join(',');
    const blob = new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='kpis.csv'; a.click(); URL.revokeObjectURL(url);
  });

  // Export filtered stores
  document.getElementById('exportFilteredCSV').addEventListener('click', () => {
    if (!filteredStores.length){ alert('No filtered stores to export.'); return; }
    const headers = ['Store Number','Store Name','Address','City','State','Coverage Type','Trainer City','Area Manager','Regional Manager'];
    const q = v => `"${String(v ?? '').replace(/"/g,'""')}"`;
    const rows = [headers.join(',')].concat(filteredStores.map(s => [q(s.storeNumber),q(s.storeName),q(s.address),q(s.cityDisplay),q(s.state),q(s.coverageType),q(s.trainerCity),q(s.areaManager),q(s.regionalManager)].join(',')));
    const blob = new Blob(["\uFEFF"+rows.join('\n')],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`filtered_stores_${filteredStores.length}.csv`; a.click(); URL.revokeObjectURL(url);
  });

  // Print list
  document.getElementById('printMap').addEventListener('click', () => {
    if (!filteredStores.length){ alert('No stores to print.'); return; }
    const tbody = document.getElementById('printableBody');
    const title = document.getElementById('printTitle');
    tbody.innerHTML = filteredStores.map(s => `
      <tr>
        <td>${escapeHtml(s.storeNumber)}</td>
        <td>${escapeHtml(s.storeName)}</td>
        <td>${escapeHtml(s.address)}</td>
        <td>${escapeHtml(s.cityDisplay)}</td>
        <td>${escapeHtml(s.state)}</td>
        <td>${escapeHtml(s.coverageType)}</td>
        <td>${escapeHtml(s.trainerCity)}</td>
        <td>${escapeHtml(s.areaManager)}</td>
        <td>${escapeHtml(s.regionalManager)}</td>
      </tr>`).join('');
    title.textContent = `Store List — ${filteredStores.length} of ${allStores.length}`;
    const panel = document.getElementById('printable'); panel.style.display='block';
    setTimeout(()=>{ window.print(); panel.style.display='none'; }, 50);
  });

  // Search autosuggest
  let selectedSuggestionIndex = -1, suggestionResults = [];
  function closeSuggestions(){ suggestionsBox.style.display='none'; selectedSuggestionIndex=-1; suggestionResults=[]; }
  function populateSuggestions(term){
    const t = term.toLowerCase().trim();
    if (!t){ closeSuggestions(); onFilterChange(); return; }
    suggestionResults = allStores.filter(store => {
      const noLead = store.storeNumber.replace(/^0+/,'');
      return noLead === t || store.storeNumber.toLowerCase().includes(t) || store.city.toLowerCase().includes(t) || store.cityDisplay.toLowerCase().includes(t);
    }).slice(0,20);
    if (!suggestionResults.length){ closeSuggestions(); return; }
    suggestionsBox.innerHTML = '';
    suggestionResults.forEach((store, idx) => {
      const div = document.createElement('div');
      div.textContent = `#${store.storeNumber} - ${store.storeName} (${store.cityDisplay}, ${store.state})`;
      div.dataset.index = idx; div.addEventListener('click', () => selectSuggestion(idx)); suggestionsBox.appendChild(div);
    });
    suggestionsBox.style.display='block'; selectedSuggestionIndex=-1;
  }
  function selectSuggestion(index){
    if (index<0 || index>=suggestionResults.length) return;
    const store = suggestionResults[index];
    searchBox.value = `#${store.storeNumber} - ${store.storeName} (${store.cityDisplay})`;
    closeSuggestions();
    filteredStores = [store]; addLazyLoadedMarkers(filteredStores); updateInViewCount(); updateFilterCount();
    const key = store.storeNumber.replace(/^0+/, ''); const marker = storeMarkersMap.get(key);
    if (marker){ map.setView(marker.getLatLng(), 14); if (currentOpenPopup) currentOpenPopup.closePopup(); marker.openPopup(); currentOpenPopup = marker; }
  }
  searchBox.addEventListener('input', () => populateSuggestions(searchBox.value));
  searchBox.addEventListener('keydown', e => {
    if (suggestionsBox.style.display==='none') return;
    if (e.key==='ArrowDown'){ e.preventDefault(); if (selectedSuggestionIndex < suggestionResults.length-1){ selectedSuggestionIndex++; highlightSuggestion(selectedSuggestionIndex); } }
    else if (e.key==='ArrowUp'){ e.preventDefault(); if (selectedSuggestionIndex>0){ selectedSuggestionIndex--; highlightSuggestion(selectedSuggestionIndex); } }
    else if (e.key==='Enter'){ e.preventDefault(); if (selectedSuggestionIndex>=0) selectSuggestion(selectedSuggestionIndex); else if (suggestionResults.length) selectSuggestion(0); }
    else if (e.key==='Escape'){ closeSuggestions(); }
  });
  function highlightSuggestion(i){ [...suggestionsBox.children].forEach(c => c.classList.remove('highlighted')); if (i>=0 && i<suggestionsBox.children.length) suggestionsBox.children[i].classList.add('highlighted'); }
  searchClearBtn.addEventListener('click', () => { searchBox.value=''; closeSuggestions(); zoomHubSelect.value=''; map.setView([39.5,-98.35],5); onFilterChange(); searchBox.focus(); });

  document.addEventListener('click', e => { if (!searchBox.contains(e.target) && !suggestionsBox.contains(e.target)) closeSuggestions(); });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    const tag = document.activeElement?.tagName;
    if (tag==='INPUT' || tag==='SELECT' || tag==='TEXTAREA') return;
    if (e.key==='r') document.getElementById('resetFilters').click();
    if (e.key==='f') fitToResults();
    if (e.key==='h'){ toggleHubsCheckbox.checked=!toggleHubsCheckbox.checked; debouncedOnFilterChange(); saveState(); }
    if (e.key==='o'){ showOpenHubsCheckbox.checked=!showOpenHubsCheckbox.checked; debouncedOnFilterChange(); saveState(); }
    if (e.key==='c'){ toggleRadiusCheckbox.checked=!toggleRadiusCheckbox.checked; debouncedOnFilterChange(); saveState(); }
    if (e.key==='/'){ e.preventDefault(); searchBox.focus(); }
    if (e.key==='z'){ e.preventDefault(); zoomHubSelect.focus(); }
  });

  // Persist state on change
  ;['coverageFilter','regionalFilter','areaFilter','trainerHubFilter'].forEach(id => document.getElementById(id).addEventListener('change', saveState));
  zoomHubSelect.addEventListener('change', saveState);
  showOpenHubsCheckbox.addEventListener('change', saveState);
  toggleHubsCheckbox.addEventListener('change', saveState);
  toggleRadiusCheckbox.addEventListener('change', saveState);
  if (searchBox) searchBox.addEventListener('input', saveState);

  // Load state (hash > localStorage)
  const usedHash = loadStateFromHash(); if (!usedHash) loadState();
  if (![...coverageFilter.options].some(o=>o.selected)){ const allOpt = coverageFilter.querySelector('option[value="All"]'); if (allOpt) allOpt.selected = true; }

  // Initial render
  onFilterChange();
})();
</script>
</body>
</html>
