<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Premium Retail Trainer Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  :root{
    --blue:#2f71ff; --violet:#6a1b9a; --gray:#9ea3a8; --ring:#d0d7de;
    --pa:#6c5ce7; --p:#2ecc71; --a:#f39c12; --u:#e74c3c;
    --bg:#fff; --fg:#111; --muted:#6b7280; --border:#e5e7eb; --panel:#fff;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  body{display:flex;flex-direction:column;min-width:320px}

  .topbar{position:sticky; top:0; background:var(--panel); display:flex;flex-wrap:wrap;gap:10px;align-items:center; padding:8px 10px;border-bottom:1px solid #eef0f3;z-index:10; box-shadow:0 4px 14px rgba(0,0,0,.04)}
  .search-wrap{display:flex;gap:8px;align-items:center;min-width:280px;flex:1}
  .searchbox{position:relative;flex:1}
  .searchbox input{width:100%;border:1px solid #d0d7de;border-radius:10px;padding:10px 12px 10px 64px;font-size:14px;background:var(--bg);color:var(--fg)}
  .badge-left{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:12px;font-weight:800;letter-spacing:.3px;background:#eef6ff;color:#0b5bd3;border:1px solid #cfe6ff;border-radius:999px;padding:3px 8px;display:none}
  .badge-left.show{display:inline-block}
  .results{position:absolute;left:0;right:0;top:calc(100% + 6px);background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.18);display:none;z-index:20;max-height:360px;overflow:auto}
  .results.show{display:block}
  .res{display:flex;gap:10px;padding:10px;cursor:pointer;align-items:flex-start}
  .res:hover{background:#f6f8fa}
  #searchResults .res.active{ background:#e7f0ff }
  .res .kind{flex:0 0 auto;font-size:11px;font-weight:800;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:#374151;background:var(--panel)}
  .res .text .sub{color:var(--muted);font-size:12px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .btn{border:1px solid #d0d7de;background:var(--panel);border-radius:10px;padding:8px 10px;font-weight:600;cursor:pointer;color:var(--fg); box-shadow:0 2px 8px rgba(0,0,0,.04)}
  .btn.link{border-color:transparent;text-decoration:underline}
  .toggle{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:var(--panel);white-space:nowrap}
  .toggle input{width:16px;height:16px;accent-color:var(--blue)}
  .range{display:flex;align-items:center;gap:8px;white-space:nowrap}
  .range small{color:var(--muted)}

  .pillbar{display:flex;gap:6px;flex-wrap:wrap;padding:6px 10px}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #d0d7de;border-radius:999px;padding:6px 10px;background:var(--panel);color:var(--fg);cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.04)}
  .pill .dot{width:10px;height:10px;border-radius:50%}

  .filters{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:10px;padding:8px 10px;border-top:1px solid #eef0f3;border-bottom:1px solid #eef0f3;background:var(--panel); border-radius:12px; margin:6px 10px; box-shadow:0 6px 20px rgba(0,0,0,.06)}
  .picker{display:flex;flex-direction:column;gap:6px}
  .picker input{padding:6px 8px;font-size:13px;border:1px solid #d0d7de;border-radius:8px;background:var(--bg);color:var(--fg)}
  select[multiple]{height:110px;border:1px solid #d0d7de;border-radius:8px;padding:6px 8px;background:var(--bg);color:var(--fg)}

  .summary{display:flex;gap:10px;align-items:center;padding:6px 10px;border-bottom:1px solid #eef0f3;background:var(--panel)}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:var(--panel)}
  .dot{width:10px;height:10px;border-radius:50%}
  .muted{color:var(--muted);margin-left:auto}

  .mapwrap{position:relative;flex:1;min-height:460px;display:flex;overflow:hidden}
  #map{flex:1}
  .sidepanel{width:380px;max-width:90vw;flex:0 0 380px;background:var(--panel);border-left:1px solid var(--border);box-shadow:-4px 0 18px rgba(0,0,0,.12);display:none;flex-direction:column;z-index:6}
  .sidepanel.show{display:flex}
  .sp-head{padding:10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
  .sp-head h3{margin:0;font-size:16px;line-height:1.2;flex:1}
  .sp-body{padding:10px;display:flex;flex-direction:column;gap:10px;height:calc(100vh - 220px);overflow:hidden}
  .sp-actions{display:flex;gap:8px;flex-wrap:wrap}
  .sp-counts{display:flex;gap:8px;flex-wrap:wrap}
  .sp-chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:3px 8px}
  .sp-toggles{display:flex;gap:8px;flex-wrap:wrap}
  .sp-quick{display:flex;gap:6px;flex-wrap:wrap}
  .sp-list{flex:1;min-height:160px;border:1px solid var(--border);border-radius:8px;padding:0;display:flex;flex-direction:column;overflow:auto; box-shadow: inset 0 0 0 2px rgba(0,0,0,.02)}
  .sp-list input{margin:8px;border:1px solid var(--border);border-radius:8px;padding:6px 8px}
  .sp-rows{position:relative;height:0} /* height set dynamically */
  .row{position:absolute;left:0;right:0;height:96px;display:flex;gap:8px;align-items:flex-start;padding:10px;border-bottom:1px solid var(--border);cursor:pointer;background:var(--panel)}
  .row:hover{background:#f6f8fa}
  .row .num{min-width:62px;font-variant-numeric:tabular-nums;color:var(--muted)}
  .row .cov{width:8px;height:8px;border-radius:50%}
  .row .title{font-weight:700;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .row .addr{color:var(--muted);font-size:12px;line-height:1.25;white-space:normal;overflow:visible;text-overflow:clip}
  .row.active{ background:#eef6ff; }


  .floating{position:absolute;left:10px;top:10px;z-index:402;display:flex;gap:8px;flex-wrap:wrap}
  .floating .btn,.floating .toggle{padding:6px 8px;font-size:12px}

  .legend{position:absolute;top:10px;right:10px;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:8px 10px;box-shadow:0 6px 18px rgba(0,0,0,.12);z-index:401}

  .sandbox{position:absolute;left:10px;bottom:10px;z-index:402;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:none}

  .dropdown-menu{position:absolute;right:0;top:calc(100% + 4px);background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:6px;z-index:5;max-height:70vh;overflow:auto;box-sizing:border-box;display:none;min-width:240px}

  .busy{position:fixed;inset:0;background:rgba(255,255,255,.5);display:flex;align-items:center;justify-content:center;z-index:9999}
  .busy[hidden]{display:none}
  .spin{width:36px;height:36px;border-radius:50%;border:4px solid rgba(0,0,0,.15);border-top-color:var(--blue);animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  .marker-cluster.marker-pa div{background:var(--pa);border:2px solid #fff}
  .marker-cluster.marker-p  div{background:var(--p); border:2px solid #fff}
  .marker-cluster.marker-a  div{background:var(--a); border:2px solid #fff}
  .marker-cluster.marker-u  div{background:var(--u); border:2px solid #fff}
  .hub{width:20px;height:20px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.25)}
  .hub.staffed{background:var(--violet)}
  .hub.open{background:#9ea3a8}
  .hl{width:22px;height:22px;border-radius:50%;border:2px solid #111;background:rgba(0,0,0,.05);box-shadow:0 0 0 1px rgba(0,0,0,.25)}

  /* Help modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:5000}
  .modal.show{display:flex}
  .card{background:#fff;border-radius:12px;max-width:780px;width:92vw;box-shadow:0 20px 50px rgba(0,0,0,.25);border:1px solid var(--border)}
  .card header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
  .card header h3{margin:0;font-size:18px;flex:1}
  .card .body{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .kbd{display:inline-block;border:1px solid #cfd3d7;border-bottom-width:3px;border-radius:6px;padding:2px 6px;font-weight:700;background:#fff}
  @media (max-width:720px){ .card .body{grid-template-columns:1fr;} }
  @media (max-width: 1100px){ .filters{grid-template-columns:repeat(2,minmax(220px,1fr));} }
  @media (max-width: 640px){ .filters{grid-template-columns:1fr;} }
</style>
</head>
<body>

<div class="topbar">
  <div class="search-wrap" title="Type a store #, city/state, or hub name. Tip: type ‚Äònear‚Äô for nearby stores.">
    <div class="searchbox">
      <span id="searchBadge" class="badge-left">STORE</span>
      <input id="searchBox" type="text" placeholder="Type a store #, city/state, hub name‚Ä¶ (tip: 'near')" autocomplete="off" aria-label="Search store or city" />
      <div id="searchResults" class="results" role="listbox"></div>
    </div>
    <button id="searchClear" class="btn" type="button" title="Clear search">Clear</button>
  </div>

  <label class="toggle" title="Show staffed hubs"><input id="showStaffed" type="checkbox" checked />Staffed hubs</label>
  <label class="toggle" title="Show open hubs"><input id="showOpen" type="checkbox" checked />Open hubs</label>

  <div class="range" title="Hub radius used for lists, rings, overlap">
    <span>Radius</span>
    <input id="radius" type="range" min="25" max="150" step="5" value="75" />
    <b id="radiusLbl">75</b><small>mi</small>
  </div>

  <button id="fitBtn" class="btn" type="button" title="Fit map to filtered stores">Fit to Results</button>
  <button id="homeBtn" class="btn" type="button" title="Reset to starting view (keeps filters)">Home</button>
  <button id="resetBtn" class="btn" type="button" title="Reset all filters and view">Reset</button>

  <!-- Export -->
  <div class="dropdown" id="exportDrop" style="position:relative">
    <button class="btn" type="button" title="Download CSV of filtered stores or panel list">Export ‚ñæ</button>
    <div class="dropdown-menu">
      <button id="exportStores" class="btn" type="button" style="display:block;width:100%;margin:4px 0" title="Export all filtered stores on the map">
        Export filtered stores (CSV)
      </button>
      <label class="toggle" style="margin:6px 4px;display:flex"><input id="autoReset" type="checkbox" />Auto-reset after export/print</label>
    </div>
  </div>

  <!-- Saved Views -->
  <div class="dropdown" id="viewsDrop" style="position:relative">
    <button class="btn" type="button" title="Save or recall views">Views ‚ñæ</button>
    <div class="dropdown-menu" id="viewsMenu">
      <button id="viewSave" class="btn" type="button" style="display:block;width:100%;margin:4px 0">Save current view‚Ä¶</button>
      <div style="border-top:1px solid var(--border);margin:6px 0"></div>
      <div id="viewList" style="min-width:220px"></div>
    </div>
  </div>

  <button id="helpBtn" class="btn" type="button" title="Quick tips and shortcuts">Help</button>
</div>

<!-- Presets -->
<div class="pillbar" id="presetBar">
  <div id="presetUncov" class="pill" title="Uncovered + Rings + Heatmap">
    <span class="dot" style="background:var(--u)"></span> Preset: Uncovered focus
  </div>
  <div id="presetHubs" class="pill" title="Show only stores within any visible hub radius">
    üü¶ Preset: Hubs coverage
  </div>
  <div id="snapBtn" class="pill" title="Copy a shareable URL">üîó Save snapshot link</div>
</div>

<!-- Active filter chips -->
<div class="pillbar" id="activeChips"></div>

<!-- Filters -->
<div class="filters" title="Use these to narrow stores; search also matches store # and city/state.">
  <div class="picker">
    <input id="covSearch" type="text" placeholder="Search coverage‚Ä¶" />
    <select id="covFilter" multiple>
      <option value="All" selected>All</option>
      <option>Premium + Acosta</option>
      <option>Premium Only</option>
      <option>Acosta Only</option>
      <option>Uncovered</option>
    </select>
  </div>
  <div class="picker">
    <input id="rmSearch" type="text" placeholder="Filter regional managers‚Ä¶" />
    <select id="rmFilter" multiple><option value="All" selected>All</option></select>
  </div>
  <div class="picker">
    <input id="amSearch" type="text" placeholder="Filter area managers‚Ä¶" />
    <select id="amFilter" multiple><option value="All" selected>All</option></select>
  </div>
  <div class="picker">
    <input id="hubSearch" type="text" placeholder="Filter hubs‚Ä¶" />
    <select id="hubFilter" multiple></select>
  </div>
</div>

<div id="dataStatus" style="padding:6px 10px;color:var(--fg);font-size:12px"></div>

<div class="summary" id="summary">
  <span class="chip"><span class="dot" style="background:var(--pa)"></span>P+A: <b id="k_pa">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--p)"></span>Premium: <b id="k_p">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--a)"></span>Acosta: <b id="k_a">0</b></span>
  <span class="chip"><span class="dot" style="background:var(--u)"></span>Uncov: <b id="k_u">0</b></span>
  <span class="chip">Total: <b id="k_total">0</b></span>
  <span class="chip">Hubs ‚Äî <b id="k_staffed">0</b> staffed / <b id="k_open">0</b> open</span>
  <span class="muted" id="inView">In view: 0</span>
</div>

<div class="mapwrap">
  <div id="map" role="region" aria-label="Coverage Map"></div>

  <div class="floating">
    <label class="toggle" title="Density of stores"><input id="tgHeat" type="checkbox" />Heatmap</label>
    <label class="toggle" title="Show hub radius circles"><input id="tgRings" type="checkbox" />Hub radii</label>
    <label class="toggle" title="Highlight stores covered by 2+ hubs"><input id="tgOverlap" type="checkbox" />Overlap</label>
    <label class="toggle" title="Pin hubs to compare coverage"><input id="tgCompare" type="checkbox" />Compare</label>
    <label class="toggle" title="Filter: only stores inside any visible hub radius"><input id="tgWithin" type="checkbox" />Within hubs</label>
    <label class="toggle" title="Turn clustering on/off (useful when zoomed in)"><input id="tgCluster" type="checkbox" checked />Cluster</label>
    <button id="panelBtn" class="btn" type="button" title="Show/Hide side panel">Panel</button>
    <button id="sandboxBtn" class="btn" type="button" title="Test a new hub location">New-hub sandbox</button>
  </div>

  <div class="legend" id="legend" style="display:none">
    <h4>Legend</h4>
    <div class="row"><span class="dot" style="background:var(--pa)"></span> Premium + Acosta</div>
    <div class="row"><span class="dot" style="background:var(--p)"></span> Premium Only</div>
    <div class="row"><span class="dot" style="background:var(--a)"></span> Acosta Only</div>
    <div class="row"><span class="dot" style="background:var(--u)"></span> Uncovered</div>
    <div class="row"><span class="hl"></span> overlap / compare highlight</div>
    <button id="legendClose" class="btn" type="button" style="margin-top:6px;padding:4px 8px;font-size:12px">Hide</button>
  </div>

  <div class="sandbox" id="sandboxPanel">
    <h4>New-hub Sandbox</h4>
    <div>Drag the blue circle marker to test a hub.</div>
    <div style="margin-top:6px"><b>Radius:</b> <input id="sandboxR" type="range" min="25" max="150" step="5" value="75"> <b id="sandboxRlbl">75</b> mi</div>
    <div id="sandboxStats" style="margin-top:8px;font-size:13px"></div>
    <div style="margin-top:8px"><small>Click ‚ÄúNew-hub sandbox‚Äù again to close.</small></div>
  </div>

  <div class="sidepanel" id="sidepanel">
    <div class="sp-head">
      <h3 id="spTitle">Hub</h3>
      <button id="spCollapse" class="btn" type="button" title="Collapse panel">‚ü®</button>
      <button id="spPinBtn" class="btn" type="button" title="Pin for compare">Pin</button>
      <button id="spClose" class="btn" type="button" title="Close panel">Close</button>
    </div>
    <div class="sp-body">
      <div id="spMeta" class="sp-meta" style="font-size:13px"></div>
      <div class="sp-actions">
        <button id="spZoom" class="btn" type="button" title="Fit map to this hub's radius">Zoom to radius</button>
        <button id="spExport" class="btn" type="button" title="Download CSV of this list">Export list (CSV)</button>
        <button id="spPrint" class="btn" type="button" title="Print this list">Print store list</button>
      </div>
      <div class="sp-toggles">
        <label class="toggle" title="Show only uncovered stores in this panel"><input id="spOnlyUncov" type="checkbox" />Uncovered only</label>
      </div>
      <div class="sp-quick" title="Change hub radius quickly">
        Radius: 
        <button class="btn" type="button" data-r="50">50</button>
        <button class="btn" type="button" data-r="75">75</button>
        <button class="btn" type="button" data-r="100">100</button><small> mi</small>
      </div>
      <div id="spCounts" class="sp-counts"></div>
      <div class="sp-list" id="spListWrap">
        <input id="spSearch" type="text" placeholder="Search stores in list‚Ä¶" />
        <div id="spRows" class="sp-rows"></div>
      </div>
    </div>
  </div>
</div>

<!-- Help modal -->
<div class="modal" id="helpModal" aria-modal="true" role="dialog">
  <div class="card">
    <header>
      <h3>Help & Shortcuts</h3>
      <button id="helpClose" class="btn" type="button">Close</button>
    </header>
    <div class="body">
      <div>
        <h4>Keyboard</h4>
        <p><span class="kbd">Ctrl</span> / <span class="kbd">‚åò</span> + <span class="kbd">K</span> ‚Äî Focus search</p>
        <p><span class="kbd">‚Üë</span> <span class="kbd">‚Üì</span> + <span class="kbd">Enter</span> ‚Äî Pick search result</p>
        <p><span class="kbd">H</span> ‚Äî Home (map only)</p>
        <p><span class="kbd">F</span> ‚Äî Focus side-panel search (when open)</p>
      </div>
      <div>
        <h4>Tips</h4>
        <ul>
          <li>Type <b>near</b> to suggest nearby stores.</li>
          <li>Use <b>Within hubs</b> to see only stores covered by visible hubs.</li>
          <li>Pin hubs to compare coverage; <b>Overlap</b> highlights shared stores.</li>
          <li>Side panel shows counts & metrics; click a store to zoom to it.</li>
          <li>Use <b>Views</b> to save/restore your favorite setups.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div id="busy" class="busy" hidden><div class="spin"></div></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/kdbush@3.0.0/kdbush.min.js"></script>
<script src="https://unpkg.com/geokdbush@3.0.0/geokdbush.umd.js"></script>
<script>
(async function(){
  const COLORS = {
    "Premium + Acosta": getCSS('--pa'),
    "Premium Only":     getCSS('--p'),
    "Acosta Only":      getCSS('--a'),
    "Uncovered":        getCSS('--u')
  };
  const DEFAULT_RADIUS = 75;
  const POPUP_PAD = [30, 30];
  const LS_STATE = 'prt_state_v6';
  const LS_VIEWS = 'prt_views_v1';
  const HOME_VIEW = { center:[39.5,-98.35], zoom:5 };
  const AUTO_RESET = ()=> id('autoReset')?.checked;

  const hubs = [
    { id:"belle_vernon_pa", name:"Belle Vernon, PA (Open)", coords:[40.12507,-79.8664], status:"open", person:null },
    { id:"centennial_co",   name:"Centennial, CO (Open)",   coords:[39.62732,-104.779], status:"open", person:null },
    { id:"houston_tx",      name:"Houston, TX (Open)",      coords:[29.8535,-95.5095],  status:"open", person:null },
    { id:"kansas_city_mo",  name:"Kansas City, MO (Open)",  coords:[39.04512,-94.4429], status:"open", person:null },
    { id:"wilmington_oh",   name:"Wilmington, OH (Open)",   coords:[39.44499,-83.8244], status:"open", person:null },
    { id:"granite_falls_nc_walker", name:"Granite Falls, NC ‚Äî Lisa Walker", coords:[35.800494,-81.405803], status:"accepted", person:"Lisa Walker" },
    { id:"clarksville_tn_salvato",  name:"Clarksville, TN ‚Äî Nicholas Salvato", coords:[36.588879,-87.340167], status:"accepted", person:"Nicholas Salvato" },
    { id:"orange_park_fl_hall",     name:"Orange Park, FL ‚Äî Sabrina Hall", coords:[30.186756,-81.718887], status:"accepted", person:"Sabrina Hall" },
    { id:"olive_branch_ms_brown",   name:"Olive Branch, MS ‚Äî Annette Brown", coords:[34.926688,-89.894859], status:"accepted", person:"Annette Brown" },
    { id:"riverview_fl_santos",     name:"Riverview, FL ‚Äî Richard Santos", coords:[27.8661,-82.3265], status:"accepted", person:"Richard Santos" }
  ];

  let allStores = [];
  let kdIndex = null;
  let filteredStores = [];
  const markerByStore = new Map();
  const targetLayer = L.layerGroup();
  const ringLayer   = L.layerGroup();
  const highlightLayer = L.layerGroup();
  const heatLayerHolder = { layer:null };
  let compareMode = false;
  let pinnedHubs = [];
  let targetPin = null;
  let searchIdx = [];
  let resIndex = -1;

  let spHub = null; let spRows = []; let spFilter = ''; let spOnlyUncov=false;
  const rowH = 64; // (A) taller row height for two-line clamp

  const debouncedRun = (()=>{ let t; return ()=>{ clearTimeout(t); t=setTimeout(runFilter,90); }; })();

  const map = L.map('map', { zoomControl:true, inertia:true }).setView(HOME_VIEW.center, HOME_VIEW.zoom);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'¬© OpenStreetMap'}).addTo(map);

  // Clustered + plain layers (toggle)
  const markers = L.markerClusterGroup({
    disableClusteringAtZoom: 12,
    spiderfyOnMaxZoom:false,
    maxClusterRadius: z => z >= 9 ? 50 : 70,
    iconCreateFunction: clusterIconByDominantCoverage,
    chunkedLoading: true,
    chunkInterval: 50,
    chunkDelay: 25
  });
  const plainMarkers = L.layerGroup();
  map.addLayer(markers); // default clustered
  targetLayer.addTo(map);
  ringLayer.addTo(map);
  highlightLayer.addTo(map);

  // Cluster breakdown tooltip + zoom-to-bounds
  markers.on('clustermouseover', (e)=>{
    const cts = coverageCounts(e.layer.getAllChildMarkers());
    const total = Object.values(cts).reduce((a,b)=>a+b,0)||1;
    const pct = k => Math.round((cts[k]||0)*100/total);
    const html = `
      <div style="font-size:12px">
        <div><b>${total}</b> stores</div>
        <div><span class="dot" style="background:${COLORS["Premium + Acosta"]}"></span> P+A: <b>${cts["Premium + Acosta"]||0}</b> (${pct("Premium + Acosta")}%)</div>
        <div><span class="dot" style="background:${COLORS["Premium Only"]}"></span> Premium: <b>${cts["Premium Only"]||0}</b> (${pct("Premium Only")}%)</div>
        <div><span class="dot" style="background:${COLORS["Acosta Only"]}"></span> Acosta: <b>${cts["Acosta Only"]||0}</b> (${pct("Acosta Only")}%)</div>
        <div><span class="dot" style="background:${COLORS["Uncovered"]}"></span> Uncovered: <b>${cts["Uncovered"]||0}</b> (${pct("Uncovered")}%)</div>
      </div>`;
    e.layer.bindTooltip(html, {direction:'top', offset:[0,-12], opacity:0.95, sticky:true}).openTooltip();
  });
  markers.on('clustermouseout', (e)=>{ e.layer.closeTooltip(); });
  markers.on('clusterclick', (e)=>{ map.fitBounds(e.layer.getBounds()); });

  map.on('moveend zoomend', ()=>{
    updateInViewCount();
    if (id('tgHeat').checked) requestIdleCallback?.(updateHeat) ?? updateHeat();
    saveState();
  });

  const STATUS = id('dataStatus'); const busy = id('busy');
  const legend = id('legend'); id('legendClose').onclick = ()=> legend.style.display='none';

  const searchBox = id('searchBox'), searchBadge = id('searchBadge'), searchResults = id('searchResults');
  id('searchClear').onclick = ()=>{ searchBox.value=''; searchBadge.classList.remove('show'); hideResults(); clearTarget(); runFilter(); };

  const showStaffed = id('showStaffed');
  const showOpen    = id('showOpen');
  const radius      = id('radius');  const radiusLbl   = id('radiusLbl');
  const tgHeat = id('tgHeat'), tgRings=id('tgRings'), tgOverlap=id('tgOverlap'), tgCompare=id('tgCompare'), tgWithin=id('tgWithin'), tgCluster=id('tgCluster');

  const covFilter = id('covFilter'); const covSearch = id('covSearch');
  const rmFilter  = id('rmFilter');  const rmSearch  = id('rmSearch');
  const amFilter  = id('amFilter');  const amSearch  = id('amSearch');
  const hubFilter = id('hubFilter'); const hubSearch = id('hubSearch');

  const presetUncov = id('presetUncov'); const presetHubs = id('presetHubs');
  const activeChips = id('activeChips');

  on('input', radius,   ()=>{ radiusLbl.textContent = radius.value; debouncedRun(); updateRings(); if (tgOverlap.checked) drawOverlap(); if (sandboxMarker) refreshSandbox(); saveState(); if (spHub) openSidepanel(spHub); });
  on('change', showStaffed, ()=>{ debouncedRun(); saveState(); });
  on('change', showOpen,    ()=>{ debouncedRun(); saveState(); });

  on('input', covSearch, ()=> filterSelect(covFilter, covSearch.value));
  on('input', rmSearch,  ()=> filterSelect(rmFilter,  rmSearch.value));
  on('input', amSearch,  ()=> filterSelect(amFilter,  amSearch.value));
  on('input', hubSearch, ()=> filterSelect(hubFilter, hubSearch.value));

  on('change', covFilter, ()=>{ debouncedRun(); saveState(); renderChips(); });
  on('change', rmFilter,  ()=>{ cascadeAM(); debouncedRun(); autoFitForRM(); saveState(); renderChips(); });
  on('change', amFilter,  ()=>{ cascadeHubs(); debouncedRun(); saveState(); renderChips(); });
  on('change', hubFilter, ()=>{ debouncedRun(); saveState(); renderChips(); });

  presetUncov.addEventListener('click', ()=>{
    setMulti(covFilter, ['Uncovered']);
    id('tgRings').checked = true;
    id('tgHeat').checked  = true;
    runFilter(); updateRings(); updateHeat(); fitToResults(); saveState(); renderChips();
  });
  presetHubs.addEventListener('click', ()=>{
    tgWithin.checked = true;
    runFilter(); updateRings(); saveState(); renderChips();
  });

  id('fitBtn').onclick = ()=>{ fitToResults(); saveState(); };
  id('homeBtn').onclick = ()=>{ map.setView(HOME_VIEW.center, HOME_VIEW.zoom); };
  id('resetBtn').onclick = ()=>{ resetAll(); runFilter(); saveState(); renderChips(); };

  // Export menu
  const exportDrop = id('exportDrop'); const menu = exportDrop.querySelector('.dropdown-menu');
  exportDrop.querySelector('button').onclick = ()=>{ toggleDropdown(menu); };
  on('click', document.body, (e)=>{ if (!exportDrop.contains(e.target)) menu.style.display='none'; }, true);
  id('exportStores').onclick  = ()=>{ exportStoresCsv(); if(AUTO_RESET()) { resetAll(); runFilter(); renderChips(); } };

  // Views menu
  const viewsDrop = id('viewsDrop'); const viewsMenu = id('viewsMenu'); const viewList = id('viewList');
  viewsDrop.querySelector('button').onclick = ()=> toggleDropdown(viewsMenu);
  on('click', document.body, (e)=>{ if (!viewsDrop.contains(e.target)) viewsMenu.style.display='none'; }, true);
  id('viewSave').onclick = saveCurrentView;
  rebuildViewsMenu();

  const k = { pa:id('k_pa'), p:id('k_p'), a:id('k_a'), u:id('k_u'), total:id('k_total'), staffed:id('k_staffed'), open:id('k_open'), inView:id('inView') };

  tgHeat.onchange = ()=>{ if (tgHeat.checked) updateHeat(); else clearHeat(); saveState(); };
  tgRings.onchange= ()=>{ updateRings(); saveState(); };
  tgOverlap.onchange= ()=>{ if (tgOverlap.checked) drawOverlap(); else highlightLayer.clearLayers(); saveState(); };
  tgCompare.onchange= ()=>{ compareMode = tgCompare.checked; pinnedHubs=[]; highlightLayer.clearLayers(); alert(compareMode ? 'Compare mode on: click hub markers to pin them.' : 'Compare mode off.'); saveState(); };
  tgWithin.onchange = ()=>{ runFilter(); saveState(); };
  tgCluster.onchange= ()=>{ refreshLayerMode(); };

  // Snapshot + Help
  id('snapBtn').onclick = saveSnapshot;
  id('helpBtn').onclick = ()=> id('helpModal').classList.add('show');
  id('helpClose').onclick = ()=> id('helpModal').classList.remove('show');
  id('helpModal').addEventListener('click', (e)=>{ if(e.target.id==='helpModal') e.currentTarget.classList.remove('show'); });

  // Keyboard
  window.addEventListener('keydown',(e)=>{
    if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); searchBox.focus(); searchBox.select(); }
    if (e.key.toLowerCase() === 'h'){ map.setView(HOME_VIEW.center, HOME_VIEW.zoom); }
    if (e.key.toLowerCase() === 'f' && sidepanel.classList.contains('show')){ spSearch.focus(); spSearch.select(); }
  });

  // Side panel refs
  const sidepanel = id('sidepanel');
  const spTitle = id('spTitle'); const spMeta = id('spMeta'); const spCounts = id('spCounts');
  const spRowsEl = id('spRows'); const spSearch = id('spSearch'); const spWrap = id('spListWrap');
  const spClose = id('spClose'); const spExport = id('spExport'); const spZoom = id('spZoom'); const spPinBtn = id('spPinBtn'); const spPrint = id('spPrint'); const spOnlyUncovEl = id('spOnlyUncov'); const spCollapse = id('spCollapse');
  spClose.onclick = ()=> hideSidepanel();
  spCollapse.onclick = ()=> hideSidepanel();
  spSearch.addEventListener('input', ()=>{ spFilter = spSearch.value.trim().toLowerCase(); renderSidepanelList(); });
  spExport.onclick = ()=>{ exportSidepanelCsv(); if(AUTO_RESET()){ resetAll(); runFilter(); renderChips(); } };
  spPrint.onclick  = ()=>{ printSidepanelList(); if(AUTO_RESET()){ resetAll(); runFilter(); renderChips(); } };
  spZoom.onclick   = ()=> zoomHubRadius();
  spPinBtn.onclick = ()=> togglePinFromPanel();
  spWrap.addEventListener('scroll', ()=>{ requestAnimationFrame(renderVirtualSlice); });
  spOnlyUncovEl.onchange = ()=>{ spOnlyUncov = spOnlyUncovEl.checked; renderSidepanelList(); };
  // radius preset chips
  document.querySelectorAll('.sp-quick .btn[data-r]').forEach(b=>{
    b.addEventListener('click', ()=>{
      radius.value = b.dataset.r; radiusLbl.textContent=b.dataset.r;
      runFilter(); updateRings(); if (spHub) openSidepanel(spHub); saveState();
    });
  });
  // floating panel toggle
  id('panelBtn').onclick = ()=>{ if(sidepanel.classList.contains('show')) hideSidepanel(); else if(spHub) openSidepanel(spHub); };

  // ---------- Load data ----------
  showBusy(true); let spinnerFailSafe = setTimeout(()=>showBusy(false), 7000);
  try {
    const url = './store_data.json?v=' + Date.now();
    STATUS.textContent = `Loading ${url} ‚Ä¶`;
    const resp = await fetch(url, { cache:'no-store' });
    if (!resp.ok) throw new Error(`HTTP ${resp.status} fetching ${url}`);
    const text = await resp.text();
    let raw;
    try { raw = JSON.parse(text.replace(/^\uFEFF/,'')); }
    catch(e){ console.error('Bad JSON start:', text.slice(0,200)); throw new Error('Invalid JSON in store_data.json'); }
    if (!Array.isArray(raw)) throw new Error('store_data.json must be a JSON array');

    allStores = normalizeStores(raw);
    kdIndex = new KDBush(allStores, p=>p.lng, p=>p.lat);

    STATUS.textContent = `Loaded ${allStores.length.toLocaleString()} stores`;

    populateRM(allStores); populateAM(allStores); cascadeAM(); cascadeHubs();
    id('hubFilter').innerHTML = hubs.map(h=>`<option>${escape(h.name)}</option>`).join('');

    buildSearchIndex();

    if (!tryLoadSnapshot()){ tryLoadLocal(); }

    runFilter(); renderChips();
  } catch(err){
    STATUS.innerHTML = `<span style="color:#b42318;font-weight:600">Data load error:</span> ${escape(err?.message || String(err))}`;
    console.error(err);
  } finally { clearTimeout(spinnerFailSafe); showBusy(false); }

  // ---------- Search ----------
  function buildSearchIndex(){
    searchIdx = allStores.map(s => ({
      kind:'STORE', store:s, lat:s.lat, lng:s.lng,
      text: (`store ${s.storeNumberStr} ${s.storeName||''} ${s.address||''} ${s.city} ${s.state} ${s.coverageType||''} ${s.areaManager||''} ${s.regionalManager||''}`).toLowerCase()
    }));
  }
  function clearTarget(){ if (targetPin){ targetLayer.removeLayer(targetPin); targetPin=null; } }
  const targetIcon = L.divIcon({className:'', html:'<div style="background:#2f71ff;border:2px solid #fff;border-radius:50%;width:18px;height:18px;box-shadow:0 0 0 1px rgba(0,0,0,.25)"></div>', iconSize:[18,18], iconAnchor:[9,9]});
  const hoverIcon  = L.divIcon({className:'', html:'<div class="hl"></div>', iconSize:[22,22], iconAnchor:[11,11]});
  let hoverMarker=null;
  function showHover(lat,lng){ if(hoverMarker) highlightLayer.removeLayer(hoverMarker); hoverMarker=L.marker([lat,lng],{icon:hoverIcon}).addTo(highlightLayer); }
  function hideHover(){ if(hoverMarker){ highlightLayer.removeLayer(hoverMarker); hoverMarker=null; } }

  function storePopupHTML(s){
    const r = Number(radius.value)||DEFAULT_RADIUS;
    const visH = hubs.filter(h => (h.status==='accepted'?showStaffed.checked:showOpen.checked));
    let nearest = null, best = 1e9;
    visH.forEach(h=>{ const d = distMiles(s.lat,s.lng,h.coords[0],h.coords[1]); if(d<best){best=d;nearest=h;} });
    const badge = `<span style="padding:2px 6px;border-radius:999px;border:1px solid var(--border);background:${COLORS[s.coverageType]||'#eee'}22">${escape(s.coverageType||'')}</span>`;
    return `
      <div style="font-size:13px;line-height:1.35;min-width:220px">
        <div style="font-weight:800;margin-bottom:4px">Store ${escape(s.storeNumberStr)} ‚Äî ${escape(s.storeName||'')}</div>
        <div>${escape(s.address||'')}</div>
        <div>${escape(s.city||'')}, ${escape(s.state||'')}</div>
        <div style="margin:6px 0">${badge}</div>
        <div><b>Trainer City:</b> ${escape(s.trainerCity||'')}</div>
        <div><b>Area Manager:</b> ${escape(s.areaManager||'')}</div>
        <div><b>Regional Manager:</b> ${escape(s.regionalManager||'')}</div>
        ${nearest?`<div style="margin-top:6px"><b>Nearest hub:</b> ${escape(nearest.name)} ‚Ä¢ ${best.toFixed(1)} mi</div>`:''}
        <div style="color:var(--muted);margin-top:6px">Lat: ${Number(s.lat).toFixed(4)}, Lng: ${Number(s.lng).toFixed(4)}</div>
      </div>`;
  }

  function hideResults(){ searchResults.classList.remove('show'); searchResults.innerHTML=''; searchResults._data=[]; resIndex=-1; }
  function showResults(list){
    if (!list.length){ hideResults(); return; }
    searchResults.innerHTML = list.map((r,i)=>`
      <div class="res" data-i="${i}" role="option" title="Open this result">
        <div class="kind">${r.kind}</div>
        <div class="text">
          <div>${escape(r.label)}</div>
          ${r.kind==='STORE'
            ? `<div class="sub">${escape(r.store.address||'')} ¬∑ ${escape(r.store.city||'')}, ${escape(r.store.state||'')} ¬∑ ${escape(r.store.coverageType||'')}</div>`
            : (r.kind==='NEAR' ? `<div class="sub">${escape(r.store.address||'')} ¬∑ ${escape(r.store.city||'')}, ${escape(r.store.state||'')}</div>` : '')
          }
        </div>
      </div>`).join('');
    searchResults.classList.add('show');
    Array.from(searchResults.querySelectorAll('.res')).forEach(el=>{
      el.addEventListener('mouseenter', ()=>{ const d = searchResults._data[Number(el.dataset.i)]; if(d && d.lat) showHover(d.lat,d.lng); });
      el.addEventListener('mouseleave', hideHover);
      el.addEventListener('click', ()=>{ const d = searchResults._data[Number(el.dataset.i)]; selectResult(d); });
    });
    searchResults._data = list; resIndex=-1;
  }
  function toResFromStore(s,score,kind='STORE'){ return { kind, store:s, label:`Store ${s.storeNumberStr} ‚Äî ${s.storeName||''}, ${s.city}, ${s.state}`, lat:s.lat, lng:s.lng, score }; }
  function toCityRes(city,state,lat,lng,score){ return { kind:'CITY', label:`${city}, ${state}`, lat, lng, score }; }
  function smartNearest(center,limit=5){
    const arr = allStores.map(s => [distMiles(center.lat,center.lng,s.lat,s.lng), s]).sort((a,b)=>a[0]-b[0]).slice(0,limit).map((x,i)=>toResFromStore(x[1], 80-i,'NEAR'));
    return arr;
  }
  function handleSearchInput(){
    if (!allStores.length){ hideResults(); return; }
    const qraw = (searchBox.value||'').trim();
    const q = qraw.toLowerCase();
    if (!q){ showResults(smartNearest(map.getCenter(), 8)); searchBadge.classList.remove('show'); return; }
    if (q==='near' || q==='near me'){ showResults(smartNearest(map.getCenter(),8)); return; }
    const items = [];
    const num = q.match(/^\s*(\d{3,6})\s*$/); // quick jump if only digits
    if (num){
      const s = allStores.find(x => x.storeNumberStr === num[1]);
      if (s){ selectResult(toResFromStore(s, 120)); return; }
    }
    const numInside = q.match(/\b(\d{3,6})\b/);
    if (numInside){
      const s = allStores.find(x => x.storeNumberStr === numInside[1]);
      if (s) items.push(toResFromStore(s, 120));
    }
    if (searchIdx && searchIdx.length){
      searchIdx.forEach(it => { if (it.text.includes(q)) items.push(toResFromStore(it.store, 70)); });
    }
    const sExact = allStores.find(x => (`${x.city}, ${x.state}`).toLowerCase() === q);
    if (sExact) items.unshift(toCityRes(sExact.city, sExact.state, sExact.lat, sExact.lng, 90));
    hubs.forEach(h=>{ if (h.name.toLowerCase().includes(q)) items.push({ kind:'HUB', label:h.name, lat:h.coords[0], lng:h.coords[1], score:60 }); });
    const seen=new Set(), out=[];
    items.sort((a,b)=>b.score-a.score).forEach(it=>{
      const k=it.kind+'|'+it.label+'|'+it.lat+'|'+it.lng;
      if(!seen.has(k)){ seen.add(k); out.push(it); }
    });
    showResults(out.slice(0,60));
  }
  searchBox.addEventListener('input', handleSearchInput);
  searchBox.addEventListener('keydown', (e)=>{
    const items = searchResults._data || [];
    if (e.key === 'ArrowDown'){ e.preventDefault(); resIndex = Math.min(items.length-1,resIndex+1); highlightResult(); }
    if (e.key === 'ArrowUp'){ e.preventDefault(); resIndex = Math.max(0,resIndex-1); highlightResult(); }
    if (e.key === 'Enter'){ 
      e.preventDefault();
      if (resIndex>=0 && items[resIndex]) selectResult(items[resIndex]);
      else if(items.length===1) selectResult(items[0]); // open only result on Enter
    }
    if (e.key === 'Escape'){ hideResults(); }
  });

  function highlightResult(){
    Array.from(searchResults.querySelectorAll('.res')).forEach((el,i)=>{
      el.classList.toggle('active', i===resIndex);
      if(i===resIndex){
        el.scrollIntoView({block:'nearest'});
        const d=searchResults._data[i]; if(d && d.lat) showHover(d.lat,d.lng);
      }
    });
  }
  // Always open a popup when a result is picked
  function selectResult(d){
    hideResults(); hideHover();
    if(!d) return;

    if(d.kind==='STORE' || d.kind==='NEAR'){
      const s = d.store;
      map.setView([d.lat,d.lng], 12, {animate:true,padding:POPUP_PAD});
      openStorePopup(s);
      return;
    }

    if(d.kind==='CITY' || d.kind==='HUB'){
      map.setView([d.lat,d.lng], 10, {animate:true,padding:POPUP_PAD});
      showPinPopup([d.lat,d.lng], `
        <div style="font-size:13px;line-height:1.35;min-width:220px">
          <div style="font-weight:800;margin-bottom:4px">${escape(d.label)}</div>
          <div style="color:var(--muted)">Lat: ${Number(d.lat).toFixed(4)}, Lng: ${Number(d.lng).toFixed(4)}</div>
        </div>
      `);
      return;
    }
  }
 function openStorePopup(store){
  const ll = L.latLng(store.lat, store.lng);
  const padRight = sidepanel.classList.contains('show') ? 420 : 20; // keep popup visible when panel is open
  const panOpts = { paddingTopLeft:[20,20], paddingBottomRight:[padRight,20] };

  const m = markerByStore.get(store.storeNumberStr);

  // Helper: open popup and pan inside view
  const doOpen = (marker) => {
    marker.openPopup();
    map.panInside(marker.getLatLng(), panOpts);
  };

  // Clustered marker? ensure it is visible, then open.
  if (m) {
    if (tgCluster.checked) {
      markers.zoomToShowLayer(m, () => doOpen(m));
    } else {
      doOpen(m);
    }
  } else {
    // Fallback pin (should be rare)
    showPinPopup(ll, storePopupHTML(store));
    map.panInside(ll, panOpts);
  }
}

  function showPinPopup(latlng, html){
    if(!targetPin){ targetPin = L.marker(latlng,{icon:targetIcon}).addTo(targetLayer); }
    else { targetPin.setLatLng(latlng); }
    const p = L.popup({autoClose:true, closeOnClick:true, maxWidth:320}).setLatLng(latlng).setContent(html);
    p.openOn(map);
  }

  // ---------- Filtering + Rendering ----------
  function runFilter(){
    markerByStore.clear();
    if(tgCluster.checked){
      markers.clearLayers();
    }else{
      plainMarkers.clearLayers();
    }
    filteredStores = allStores.filter(storeFilter);
    const ms = filteredStores.map(s=>{
      const m=L.circleMarker([s.lat,s.lng],{
        radius:5,weight:1,fillOpacity:.9,
        color:'#fff', fillColor:COLORS[s.coverageType]||'#999'
      });
      m.store = s;
      m.bindPopup(storePopupHTML(s));
      markerByStore.set(s.storeNumberStr,m);
      return m;
    });
    if(tgCluster.checked){ markers.addLayers(ms); } else { plainMarkers.addLayer(L.layerGroup(ms)); }
    updateCounts();
    updateInViewCount();
    if (id('tgHeat').checked) updateHeat();
  }

  function storeFilter(s){
    if(!showStaffed.checked && s.coveredBy==='staffed') return false;
    if(!showOpen.checked    && s.coveredBy==='open') return false;
    const covVals = Array.from(covFilter.selectedOptions).map(o=>o.value);
    if(!covVals.includes('All') && !covVals.includes(s.coverageType)) return false;
    const rmVals = Array.from(rmFilter.selectedOptions).map(o=>o.value);
    if(!rmVals.includes('All') && !rmVals.includes(s.regionalManager)) return false;
    const amVals = Array.from(amFilter.selectedOptions).map(o=>o.value);
    if(!amVals.includes('All') && !amVals.includes(s.areaManager)) return false;
    const hubVals= Array.from(hubFilter.selectedOptions).map(o=>o.value);
    if(hubVals.length && !hubVals.includes(s.trainerCity||'')) return false;
    if(tgWithin.checked){
      const r=Number(radius.value)||DEFAULT_RADIUS;
      let inside=false;
      hubs.forEach(h=>{
        if((h.status==='accepted'?showStaffed.checked:showOpen.checked)){
          if(distMiles(s.lat,s.lng,h.coords[0],h.coords[1])<=r) inside=true;
        }
      });
      if(!inside) return false;
    }
    return true;
  }

  function updateCounts(){
    const cts=coverageCounts((tgCluster.checked? markers.getLayers() : plainMarkers.getLayers()[0]?.getLayers?.() || []).map(m=>m));
    k.pa.textContent=cts["Premium + Acosta"]||0;
    k.p.textContent =cts["Premium Only"]||0;
    k.a.textContent =cts["Acosta Only"]||0;
    k.u.textContent =cts["Uncovered"]||0;
    k.total.textContent=filteredStores.length;
    k.staffed.textContent=hubs.filter(h=>h.status==='accepted').length;
    k.open.textContent   =hubs.filter(h=>h.status==='open').length;
  }
  function updateInViewCount(){
    const b=map.getBounds();
    const inV=filteredStores.filter(s=>b.contains([s.lat,s.lng])).length;
    k.inView.textContent=`In view: ${inV}`;
  }

  // ---------- Heatmap ----------
  function updateHeat(){
    clearHeat();
    const pts=filteredStores.map(s=>[s.lat,s.lng,0.6]);
    heatLayerHolder.layer=L.heatLayer(pts,{radius:18,blur:22,maxZoom:10});
    map.addLayer(heatLayerHolder.layer);
  }
  function clearHeat(){ if(heatLayerHolder.layer){ map.removeLayer(heatLayerHolder.layer); heatLayerHolder.layer=null; } }

  // ---------- Rings + Overlap ----------
  function updateRings(){
    ringLayer.clearLayers();
    if(!tgRings.checked) return;
    const r=Number(radius.value)||DEFAULT_RADIUS;
    hubs.forEach(h=>{
      if((h.status==='accepted'?showStaffed.checked:showOpen.checked)){
        const c=L.circle(h.coords,{radius:r*1609,color:'#333',weight:1,fill:false,opacity:.4});
        ringLayer.addLayer(c);
      }
    });
  }

  function drawOverlap(){
    highlightLayer.clearLayers();
    if(!tgOverlap.checked) return;
    const r=Number(radius.value)||DEFAULT_RADIUS;
    filteredStores.forEach(s=>{
      let cnt=0;
      hubs.forEach(h=>{
        if((h.status==='accepted'?showStaffed.checked:showOpen.checked)){
          if(distMiles(s.lat,s.lng,h.coords[0],h.coords[1])<=r) cnt++;
        }
      });
      if(cnt>=2){
        const m=L.circleMarker([s.lat,s.lng],{radius:7,color:'#111',weight:2,fillOpacity:0.2});
        highlightLayer.addLayer(m);
      }
    });
  }

  // ---------- Utility helpers ----------
  function id(x){ return document.getElementById(x); }
  function on(ev,el,fn,capture){ el.addEventListener(ev,fn,capture||false); }
  function getCSS(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
  function escape(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function distMiles(lat1,lng1,lat2,lng2){ const R=3958.8; const toRad=d=>d*Math.PI/180; const dLat=toRad(lat2-lat1); const dLon=toRad(lng2-lng1); const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
  function coverageCounts(markersArr){ const out={}; markersArr.forEach(m=>{ const s=m?.store; if(!s) return; out[s.coverageType]=(out[s.coverageType]||0)+1; }); return out; }
  function toggleDropdown(menu){ menu.style.display=menu.style.display==='block'?'none':'block'; }
  function setMulti(sel,arr){ Array.from(sel.options).forEach(o=>{o.selected=arr.includes(o.value);}); }
  function filterSelect(selectEl, q){
    const query = (q||'').toLowerCase();
    Array.from(selectEl.options).forEach(opt=>{
      if (opt.value === 'All') { opt.hidden = false; return; }
      const txt = (opt.textContent||'').toLowerCase();
      opt.hidden = query && !txt.includes(query);
    });
  }
  function clusterIconByDominantCoverage(cluster){
    const children = cluster.getAllChildMarkers();
    const counts = { 'Premium + Acosta':0,'Premium Only':0,'Acosta Only':0,'Uncovered':0 };
    children.forEach(m=>{ const s = m.store; if(!s) return; counts[s.coverageType] = (counts[s.coverageType]||0) + 1; });
    let dom = 'Uncovered', max = -1;
    for(const k in counts){ if(counts[k] > max){ max = counts[k]; dom = k; } }
    const cls =
      dom === 'Premium + Acosta' ? 'marker-pa' :
      dom === 'Premium Only'     ? 'marker-p'  :
      dom === 'Acosta Only'      ? 'marker-a'  : 'marker-u';
    const html = `<div><span>${children.length}</span></div>`;
    return L.divIcon({ html, className:`marker-cluster ${cls}`, iconSize:[40,40] });
  }

  // ---------- Data normalization ----------
  function normalizeStores(raw){
    return raw.map((r,i)=>{
      const lat = +(
        r.lat ?? r.Lat ?? r.latitude ?? r.Latitude ?? r.Center_Lat
      );
      const lng = +(
        r.lng ?? r.Lng ?? r.lon ?? r.Lon ?? r.longitude ?? r.Longitude ?? r.Center_Lon
      );
      const storeNumber =
        r.storeNumber ?? r.StoreNumber ?? r['Store #'] ?? r['Store#'] ?? r.Store ?? r['Store'] ?? r.store_id ?? r.Store_ID ?? r.SiteID ?? r['Site ID'] ?? r.Site_Id ?? r['Store Number'] ?? r.StoreNo ?? r.Store_No;
      const storeNumberStr = (storeNumber ?? i+1).toString();

      const coverageType = r.coverageType ?? r.Coverage_Type ?? r.CoverageType ?? r.Coverage ?? r['Coverage Type'] ?? 'Uncovered';
      const storeName    = r.storeName ?? r['Job Description'] ?? r.Store_Name ?? r.StoreName ?? r['Store Name'] ?? '';
      const address      = r.Address ?? r.address ?? '';
      const city         = r.City ?? r.city ?? '';
      const state        = r.State ?? r.state ?? r.ST ?? '';
      const areaManager  = r.AreaManager ?? r['Area Manager'] ?? r.AM ?? r['AM'] ?? r.areaManager ?? '';
      const regionalManager = r.RegionalManager ?? r['Regional Manager'] ?? r.RM ?? r['RM'] ?? r.regionalManager ?? '';
      const trainerCity  = r.Assigned_Premium ?? r.Trainer_City ?? r.TrainerCity ?? r['Trainer City'] ?? r.trainerCity ?? r.Nearest_Premium ?? '';

      return {
        lat, lng,
        storeNumberStr,
        storeName, address, city, state,
        coverageType,
        areaManager, regionalManager,
        trainerCity,
        coveredBy: trainerCity ? 'staffed' : 'open'
      };
    }).filter(s => Number.isFinite(s.lat) && Number.isFinite(s.lng));
  }

  // ---------- Hub markers ----------
  const hubLayer = L.layerGroup().addTo(map);
  const hubIcon = (status)=> L.divIcon({
    className:'', iconSize:[20,20], iconAnchor:[10,10],
    html:`<div class="hub ${status==='accepted'?'staffed':'open'}" title="${status==='accepted'?'Staffed':'Open'}"></div>`
  });

  function rebuildHubMarkers(){
    hubLayer.clearLayers();
    const vis = hubs.filter(h => (h.status==='accepted'?showStaffed.checked:showOpen.checked));
    vis.forEach(h=>{
      const m = L.marker(h.coords, { icon:hubIcon(h.status), title:h.name });
      m.on('click', ()=> {
        if(compareMode){ pinHub(h); }
        openSidepanel(h);
      });
      m.addTo(hubLayer);
    });
  }
  rebuildHubMarkers();

  // ---------- RM/AM population ----------
  function populateRM(stores){
    const set = new Set(stores.map(s=>s.regionalManager).filter(Boolean));
    rmFilter.innerHTML = `<option value="All" selected>All</option>` + Array.from(set).sort().map(x=>`<option>${escape(x)}</option>`).join('');
  }
  function populateAM(stores){
    const set = new Set(stores.map(s=>s.areaManager).filter(Boolean));
    amFilter.innerHTML = `<option value="All" selected>All</option>` + Array.from(set).sort().map(x=>`<option>${escape(x)}</option>`).join('');
  }
  function cascadeAM(){
    const rms = new Set(Array.from(rmFilter.selectedOptions).map(o=>o.value));
    if(rms.has('All')){ populateAM(allStores); return; }
    const set = new Set(allStores.filter(s=>rms.has(s.regionalManager)).map(s=>s.areaManager).filter(Boolean));
    amFilter.innerHTML = `<option value="All" selected>All</option>` + Array.from(set).sort().map(x=>`<option>${escape(x)}</option>`).join('');
  }
  function cascadeHubs(){
    const rms = new Set(Array.from(rmFilter.selectedOptions).map(o=>o.value));
    const ams = new Set(Array.from(amFilter.selectedOptions).map(o=>o.value));
    let stores = allStores.slice();
    if(!rms.has('All')) stores = stores.filter(s=>rms.has(s.regionalManager));
    if(!ams.has('All')) stores = stores.filter(s=>ams.has(s.areaManager));
    const set = new Set(stores.map(s=>s.trainerCity).filter(Boolean));
    hubFilter.innerHTML = Array.from(set).sort().map(x=>`<option>${escape(x)}</option>`).join('');
  }

  // ---------- Chips / Autofit ----------
  function renderChips(){
    const chips = [];
    const covVals = Array.from(covFilter.selectedOptions).map(o=>o.value);
    const rmVals  = Array.from(rmFilter.selectedOptions).map(o=>o.value);
    const amVals  = Array.from(amFilter.selectedOptions).map(o=>o.value);
    const hubVals = Array.from(hubFilter.selectedOptions).map(o=>o.value);
    if(!covVals.includes('All')) chips.push(`Coverage: ${covVals.join(', ')}`);
    if(!rmVals.includes('All'))  chips.push(`RM: ${rmVals.join(', ')}`);
    if(!amVals.includes('All'))  chips.push(`AM: ${amVals.join(', ')}`);
    if(hubVals.length)           chips.push(`Hubs: ${hubVals.join(', ')}`);
    if(tgWithin.checked)         chips.push(`Within hubs`);
    activeChips.innerHTML = chips.map(c=>`<span class="chip">${escape(c)}</span>`).join('');
  }
  function autoFitForRM(){ if(filteredStores.length){ fitToResults(); } }
  function fitToResults(){
    if(!filteredStores.length) return;
    const b = L.latLngBounds(filteredStores.map(s=>[s.lat,s.lng]));
    map.fitBounds(b.pad(0.15));
  }
    function refreshLayerMode(){
    // toggle between clustered and plain layers (re-render for simplicity)
    if(tgCluster.checked){
      map.removeLayer(plainMarkers);
      if(!map.hasLayer(markers)) map.addLayer(markers);
    }else{
      map.removeLayer(markers);
      if(!map.hasLayer(plainMarkers)) map.addLayer(plainMarkers);
    }
    runFilter();
  }

  // ---------- Export (CSV) ----------
  function exportStoresCsv(){
    if(!filteredStores.length){ alert('No stores to export.'); return; }
    const headers = ['StoreNumber','StoreName','Address','City','State','CoverageType','AreaManager','RegionalManager','TrainerCity','Lat','Lng'];
    const rows = filteredStores.map(s=>[
      s.storeNumberStr, s.storeName, s.address, s.city, s.state, s.coverageType, s.areaManager, s.regionalManager, s.trainerCity, s.lat, s.lng
    ]);
    downloadCsv('filtered_stores.csv', [headers, ...rows]);
  }
  function exportSidepanelCsv(){
    if(!spHub){ alert('Open a hub first.'); return; }
    const list = getStoresForHub(spHub);
    const headers = ['Hub','Radius(mi)','StoreNumber','StoreName','Address','City','State','CoverageType','AreaManager','RegionalManager','NearestHubMi','Lat','Lng'];
    const r = Number(radius.value)||DEFAULT_RADIUS;
    const rows = list.map(x=>[
      spHub.name, r, x.storeNumberStr, x.storeName, x.address, x.city, x.state, x.coverageType, x.areaManager, x.regionalManager, x._dist?.toFixed(1)||'', x.lat, x.lng
    ]);
    downloadCsv(slug(`${spHub.name}_stores.csv`), [headers, ...rows]);
  }
  function downloadCsv(filename, rows){
    const esc = (v)=> `"${String(v??'').replace(/"/g,'""')}"`;
    const csv = rows.map(r=>r.map(esc).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
  }
  function slug(s){ return s.toLowerCase().replace(/\s+/g,'_').replace(/[^\w\-]+/g,'').slice(0,80); }

  // ---------- Sidepanel ----------
  function openSidepanel(hub){
    spHub = hub;
    sidepanel.classList.add('show');
    spTitle.textContent = hub.name;
    spMeta.innerHTML = `<div>Coords: ${hub.coords[0].toFixed(4)}, ${hub.coords[1].toFixed(4)}</div>`;
    renderSidepanelCounts();
    spFilter = ''; spSearch.value='';
    renderSidepanelList(true);
    setTimeout(()=> spSearch.focus(), 0);

  }
  function hideSidepanel(){
    spHub = null; sidepanel.classList.remove('show');
    spRows = []; spRowsEl.innerHTML=''; spRowsEl.style.height='0px';
  }
  function renderSidepanelCounts(){
    const list = getStoresForHub(spHub);
    const cts = { 'Premium + Acosta':0,'Premium Only':0,'Acosta Only':0,'Uncovered':0 };
    list.forEach(s=>{ cts[s.coverageType]=(cts[s.coverageType]||0)+1; });
    spCounts.innerHTML = `
      <div class="sp-chip"><span class="dot" style="background:${COLORS['Premium + Acosta']}"></span> ${cts['Premium + Acosta']||0}</div>
      <div class="sp-chip"><span class="dot" style="background:${COLORS['Premium Only']}"></span> ${cts['Premium Only']||0}</div>
      <div class="sp-chip"><span class="dot" style="background:${COLORS['Acosta Only']}"></span> ${cts['Acosta Only']||0}</div>
      <div class="sp-chip"><span class="dot" style="background:${COLORS['Uncovered']}"></span> ${cts['Uncovered']||0}</div>
      <div class="sp-chip">Total: ${list.length}</div>
    `;
  }
  function getStoresForHub(h){
    if(!h) return [];
    const r = Number(radius.value)||DEFAULT_RADIUS;
    const list = filteredStores
      .map(s => {
        const d = distMiles(s.lat,s.lng,h.coords[0],h.coords[1]);
        if(d<=r){ s._dist=d; return s; }
        return null;
      })
      .filter(Boolean);
    return (spOnlyUncov ? list.filter(s=>s.coverageType==='Uncovered') : list)
            .sort((a,b)=>a._dist-b._dist);
  }
  function renderSidepanelList(reset=false){
    if(!spHub) return;
    const list = getStoresForHub(spHub).filter(s=>{
      if(!spFilter) return true;
      const t = `${s.storeNumberStr} ${s.storeName||''} ${s.address||''} ${s.city||''} ${s.state||''} ${s.coverageType||''}`.toLowerCase();
      return t.includes(spFilter);
    });
    spRows = list;
    const H = rowH * list.length;
    spRowsEl.style.height = H + 'px';
    if(reset){ spWrap.scrollTop = 0; }
    renderVirtualSlice();
  }
  function renderVirtualSlice(){
    const scrollTop = spWrap.scrollTop;
    const viewH = spWrap.clientHeight;
    const start = Math.max(0, Math.floor(scrollTop / rowH) - 10);
    const end = Math.min(spRows.length, Math.ceil((scrollTop + viewH) / rowH) + 10);
    const frag = document.createDocumentFragment();
    for(let i=start;i<end;i++){
      const s = spRows[i];
      const y = i * rowH;
      const el = document.createElement('div');
      el.className = 'row';
      el.style.transform = `translateY(${y}px)`;
      el.innerHTML = `
        <div class="num">#${escape(s.storeNumberStr)}</div>
        <div class="cov" style="background:${COLORS[s.coverageType]||'#999'}"></div>
        <div style="flex:1;min-width:0">
          <div class="title">${escape(s.storeName||'')}</div>
          <div class="addr">${escape(s.address||'')}, ${escape(s.city||'')}, ${escape(s.state||'')}</div>
        </div>
        <div style="min-width:70px;text-align:right">${s._dist?.toFixed(1)??''} mi</div>
      `;
      el.title = `#${s.storeNumberStr} ‚Ä¢ ${s.storeName || ''}\n${(s.address||'')}, ${s.city||''}, ${s.state||''} ‚Ä¢ ${s._dist?.toFixed(1)??''} mi`;

      // click = zoom + popup
      // click = highlight row + zoom + popup
el.addEventListener('click', ()=>{
  // 1) clear highlight from any previously visible row elements
  Array.from(spRowsEl.children).forEach(c => c.classList.remove('active'));
  // 2) mark this one active
  el.classList.add('active');

  // 3) center the map and open the store popup
  map.setView([s.lat,s.lng], 12, {animate:true, padding:POPUP_PAD});
  openStorePopup(s);
});

// hover = highlight on map
el.addEventListener('mouseenter', ()=> showHover(s.lat,s.lng));
el.addEventListener('mouseleave', hideHover);
frag.appendChild(el);
}
spRowsEl.innerHTML = '';
spRowsEl.appendChild(frag);

  }
  function zoomHubRadius(){
    if(!spHub) return;
    const r=Number(radius.value)||DEFAULT_RADIUS;
    const c = L.circle(spHub.coords,{radius:r*1609});
    map.fitBounds(c.getBounds().pad(0.1));
  }
  function togglePinFromPanel(){ if(spHub) pinHub(spHub); }
  function pinHub(h){
    if(!compareMode) return alert('Enable Compare to pin hubs.');
    const idx = pinnedHubs.findIndex(x=>x.id===h.id);
    if(idx>=0){ pinnedHubs.splice(idx,1); drawPinned(); return; }
    pinnedHubs.push(h); drawPinned();
  }
  function drawPinned(){
    highlightLayer.clearLayers();
    if(!pinnedHubs.length) return;
    const r=Number(radius.value)||DEFAULT_RADIUS;
    pinnedHubs.forEach(h=>{
      const c=L.circle(h.coords,{radius:r*1609,color:'#111',weight:2,fill:false,opacity:.9});
      highlightLayer.addLayer(c);
    });
  }

  // ---------- Printing ----------
function printSidepanelList(){
  if(!spHub){ alert('Open a hub first.'); return; }
  const list = getStoresForHub(spHub);
  const rows = list.map(s=>`
    <tr>
      <td>${escape(s.storeNumberStr)}</td>
      <td>${escape(s.storeName||'')}</td>
      <td>${escape(s.address||'')}</td>
      <td>${escape(s.city||'')}</td>
      <td>${escape(s.state||'')}</td>
      <td>${escape(s.coverageType||'')}</td>
      <td style="text-align:right">${s._dist?.toFixed(1)??''}</td>
    </tr>`).join('');

  const win = window.open('', '_blank');
  win.document.write(`
    <html><head><title>${escape(spHub.name)} ‚Äî Store List</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:16px}
      table{border-collapse:collapse;width:100%}
      th,td{border:1px solid #ccc;padding:6px 8px;font-size:12px}
      th{background:#f6f8fa;text-align:left}
    </style>
    </head><body>
    <h2>${escape(spHub.name)} ‚Äî Stores within ${Number(radius.value)||DEFAULT_RADIUS} mi</h2>
    <table>
      <thead><tr><th>#</th><th>Name</th><th>Address</th><th>City</th><th>State</th><th>Coverage</th><th>Mi</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <script>window.print()<\/script>
    </body></html>`);
  win.document.close();
}


  // ---------- Views (save/restore) ----------
  function saveCurrentView(){
    const name = prompt('Name this view:');
    if(!name) return;
    const v = captureState();
    const views = JSON.parse(localStorage.getItem(LS_VIEWS) || '[]');
    views.push({ name, v });
    localStorage.setItem(LS_VIEWS, JSON.stringify(views));
    rebuildViewsMenu();
    alert('Saved.');
  }
  function rebuildViewsMenu(){
    const views = JSON.parse(localStorage.getItem(LS_VIEWS) || '[]');
    viewList.innerHTML = views.map((it,idx)=>`
      <div style="display:flex;align-items:center;gap:8px;padding:6px">
        <button class="btn" data-load="${idx}" style="flex:1">${escape(it.name)}</button>
        <button class="btn" data-del="${idx}" title="Delete">‚úï</button>
      </div>`).join('');
    viewList.querySelectorAll('[data-load]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const views = JSON.parse(localStorage.getItem(LS_VIEWS) || '[]');
        const it = views[Number(b.dataset.load)];
        if(it){ applyState(it.v); }
      });
    });
    viewList.querySelectorAll('[data-del]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const views = JSON.parse(localStorage.getItem(LS_VIEWS) || '[]');
        views.splice(Number(b.dataset.del),1);
        localStorage.setItem(LS_VIEWS, JSON.stringify(views));
        rebuildViewsMenu();
      });
    });
  }

  // ---------- Snapshot link ----------
  function saveSnapshot(){
    const v = captureState();
    const s = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(v)))));
    const url = location.origin + location.pathname + '?s=' + s;
    navigator.clipboard?.writeText(url);
    alert('Snapshot URL copied to clipboard.');
  }
  function tryLoadSnapshot(){
    const p = new URLSearchParams(location.search);
    const s = p.get('s');
    if(!s) return false;
    try{
      const json = JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(s)))));
      applyState(json);
      return true;
    }catch(e){ console.warn('Bad snapshot', e); return false; }
  }

  // ---------- Local storage state ----------
  function saveState(){
    const v = captureState();
    localStorage.setItem(LS_STATE, JSON.stringify(v));
  }
  function tryLoadLocal(){
    const txt = localStorage.getItem(LS_STATE);
    if(!txt) return false;
    try{
      const v = JSON.parse(txt);
      applyState(v);
      return true;
    }catch(e){ console.warn('Bad LS state', e); return false; }
  }
  function captureState(){
    return {
      view: { center: map.getCenter(), zoom: map.getZoom() },
      toggles: {
        staffed: showStaffed.checked, open: showOpen.checked,
        heat: tgHeat.checked, rings: tgRings.checked, overlap: tgOverlap.checked,
        compare: tgCompare.checked, within: tgWithin.checked, cluster: tgCluster.checked
      },
      radius: Number(radius.value)||DEFAULT_RADIUS,
      filters: {
        cov: Array.from(covFilter.selectedOptions).map(o=>o.value),
        rm:  Array.from(rmFilter.selectedOptions).map(o=>o.value),
        am:  Array.from(amFilter.selectedOptions).map(o=>o.value),
        hub: Array.from(hubFilter.selectedOptions).map(o=>o.value)
      }
    };
  }
  function applyState(v){
    if(!v) return;
    if(v.view){ map.setView([v.view.center.lat, v.view.center.lng], v.view.zoom); }
    if(v.toggles){
      showStaffed.checked = !!v.toggles.staffed;
      showOpen.checked    = !!v.toggles.open;
      tgHeat.checked      = !!v.toggles.heat;
      tgRings.checked     = !!v.toggles.rings;
      tgOverlap.checked   = !!v.toggles.overlap;
      tgCompare.checked   = !!v.toggles.compare; compareMode = tgCompare.checked;
      tgWithin.checked    = !!v.toggles.within;
      tgCluster.checked   = v.toggles.cluster!==false; // default true
      refreshLayerMode();
    }
    if(v.radius){ radius.value=v.radius; radiusLbl.textContent=v.radius; }
    if(v.filters){
      setMulti(covFilter, (v.filters.cov?.length?v.filters.cov:['All']));
      setMulti(rmFilter,  (v.filters.rm?.length?v.filters.rm:['All']));
      cascadeAM();
      setMulti(amFilter,  (v.filters.am?.length?v.filters.am:['All']));
      cascadeHubs();
      if(v.filters.hub?.length){
        hubFilter.innerHTML = v.filters.hub.map(x=>`<option selected>${escape(x)}</option>`).join('');
      }
    }
    rebuildHubMarkers();
    runFilter();
    renderChips();
    if(tgHeat.checked) updateHeat(); else clearHeat();
    updateRings();
    if(tgOverlap.checked) drawOverlap();
  }

  function resetAll(){
    showStaffed.checked = true; showOpen.checked = true;
    tgHeat.checked=false; clearHeat();
    tgRings.checked=false; ringLayer.clearLayers();
    tgOverlap.checked=false; highlightLayer.clearLayers();
    tgCompare.checked=false; compareMode=false; pinnedHubs=[];
    tgWithin.checked=false;
    tgCluster.checked=true; refreshLayerMode();
    radius.value=DEFAULT_RADIUS; radiusLbl.textContent=DEFAULT_RADIUS;
    setMulti(covFilter, ['All']);
    setMulti(rmFilter,  ['All']); cascadeAM();
    setMulti(amFilter,  ['All']); cascadeHubs();
    hubFilter.innerHTML='';
    rebuildHubMarkers();
    map.setView(HOME_VIEW.center, HOME_VIEW.zoom);
  }

  // ---------- Busy UI ----------
  function showBusy(v){ if(v){ busy.removeAttribute('hidden'); } else { busy.setAttribute('hidden',''); } }

  // ---------- Sandbox (new hub testing) ----------
  let sandboxMarker=null, sandboxCircle=null;
  id('sandboxBtn').onclick = ()=>{
    const panel = id('sandboxPanel');
    if(panel.style.display==='block'){ // close
      panel.style.display='none';
      if(sandboxMarker){ map.removeLayer(sandboxMarker); sandboxMarker=null; }
      if(sandboxCircle){ map.removeLayer(sandboxCircle); sandboxCircle=null; }
      return;
    }
    panel.style.display='block';
    const center = map.getCenter();
    sandboxMarker = L.marker(center, { draggable:true, icon:targetIcon }).addTo(map);
    sandboxCircle = L.circle(center, { radius:(Number(id('sandboxR').value)||75)*1609, color:'#2f71ff', weight:1, fill:false }).addTo(map);
    sandboxMarker.on('move', e=>{ sandboxCircle.setLatLng(e.latlng); refreshSandbox(); });
    id('sandboxR').oninput = ()=>{ id('sandboxRlbl').textContent = id('sandboxR').value; refreshSandbox(); };
    refreshSandbox();
  };
  function refreshSandbox(){
    if(!sandboxMarker || !sandboxCircle) return;
    const latlng = sandboxMarker.getLatLng();
    const r = Number(id('sandboxR').value)||75;
    sandboxCircle.setRadius(r*1609);
    const inside = filteredStores.filter(s=> distMiles(s.lat,s.lng,latlng.lat,latlng.lng) <= r );
    const cts = { 'Premium + Acosta':0,'Premium Only':0,'Acosta Only':0,'Uncovered':0 };
    inside.forEach(s=>{ cts[s.coverageType]=(cts[s.coverageType]||0)+1; });
    id('sandboxStats').innerHTML = `
      <div><b>${inside.length}</b> stores within ${r} mi</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
        <span class="sp-chip"><span class="dot" style="background:${COLORS['Premium + Acosta']}"></span> ${cts['Premium + Acosta']||0}</span>
        <span class="sp-chip"><span class="dot" style="background:${COLORS['Premium Only']}"></span> ${cts['Premium Only']||0}</span>
        <span class="sp-chip"><span class="dot" style="background:${COLORS['Acosta Only']}"></span> ${cts['Acosta Only']||0}</span>
        <span class="sp-chip"><span class="dot" style="background:${COLORS['Uncovered']}"></span> ${cts['Uncovered']||0}</span>
      </div>`;
  }

  // ---------- Final touches ----------
  [showStaffed, showOpen].forEach(el => el.addEventListener('change', ()=>{ rebuildHubMarkers(); updateRings(); if(tgOverlap.checked) drawOverlap(); }));
  updateRings(); if(tgOverlap.checked) drawOverlap();

})(); 
</script>
</body>
</html>
